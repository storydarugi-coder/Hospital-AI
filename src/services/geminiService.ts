import { GoogleGenAI, Type } from "@google/genai";
import { GenerationRequest, GeneratedContent, TrendingItem, FactCheckReport, SeoScoreReport, SeoTitleItem, ImageStyle, WritingStyle, CardPromptData, CardNewsScript, CardNewsSlideScript } from "../types";

const getAiClient = () => {
  const apiKey = localStorage.getItem('GEMINI_API_KEY');
  if (!apiKey) {
    throw new Error("API Key가 설정되지 않았습니다. 우측 상단 설정(⚙️) 버튼을 눌러 API Key를 입력해주세요.");
  }
  return new GoogleGenAI({ apiKey });
};

// AI Provider 설정 읽기
const getAiProviderSettings = (): { textGeneration: 'gemini' | 'openai', imageGeneration: 'gemini' | 'openai' } => {
  try {
    const settings = localStorage.getItem('AI_PROVIDER_SETTINGS');
    if (settings) {
      return JSON.parse(settings);
    }
  } catch (e) {
    console.warn('AI Provider 설정 읽기 실패:', e);
  }
  
  // 기본값: OpenAI 키가 있으면 GPT-5.2, 없으면 Gemini
  try {
    const hasOpenAIKey = !!localStorage.getItem('OPENAI_API_KEY');
    console.log(`🔧 기본 AI 설정: ${hasOpenAIKey ? 'GPT-5.2 (OpenAI)' : 'Gemini 3 Pro Preview'}`);
    return { 
      textGeneration: hasOpenAIKey ? 'openai' : 'gemini', 
      imageGeneration: 'gemini' 
    };
  } catch (e) {
    return { textGeneration: 'gemini', imageGeneration: 'gemini' };
  }
};

// OpenAI API 키 가져오기
const getOpenAIKey = (): string => {
  const apiKey = localStorage.getItem('OPENAI_API_KEY');
  if (!apiKey) {
    throw new Error("OpenAI API Key가 설정되지 않았습니다. 관리자 페이지에서 API Key를 입력해주세요.");
  }
  return apiKey;
};

// GPT-5.2 전용 추가 프롬프트 (Gemini 프롬프트 공유 + GPT 특색만 추가)
const getGPT52ProPrompt = () => {
  const year = getCurrentYear();
  const basePrompt = getMedicalSafetyPrompt(); // Gemini 프롬프트 재사용
  
  // GPT만의 특색있는 부분만 추가
  const gptSpecificPrompt = `
████████████████████████████████████████████████████████████████████████████████
[🎯 GPT-5.2 특화 규칙 - Gemini와 차별화되는 부분만]
████████████████████████████████████████████████████████████████████████████████

[🔎 검색 및 정보 활용 가이드 - 제미나이와 동일한 출처 원칙 준수]
**상황:** Gemini가 수집해 준 정보(Context)를 최우선으로 사용하세요.
**예외:** 만약 Gemini의 정보가 부족하거나 전달되지 않았을 경우, 당신의 지식을 활용하되 **반드시 아래 출처 규칙을 제미나이와 동일하게 엄격히 적용**해야 합니다.

**[✅ 검색/참고 허용 출처 - 여기 있는 정보만 사실(Fact)로 인정]**
1. **국내 학회**: 대한OO학회, 대한의학회 등 공식 학술 단체 홈페이지 (.or.kr)
2. **정부 기관**: 보건복지부, 질병관리청(KDCA), 식약처, 심평원, 건강보험공단 (.go.kr)
3. **국제 학술지/기관**: PubMed, JAMA, NEJM, Lancet, WHO, CDC, NIH
4. **공식 논문 DB**: RISS, KISS, KoreaMed

**[🚫 절대 참고 금지 출처 - 여기 정보는 절대 섞이면 안 됨!]**
❌ **블로그**: 네이버 블로그, 티스토리, 브런치, 개인 웹사이트
❌ **커뮤니티**: 맘카페, 환우회, 디시인사이드, 지식iN
❌ **SNS/미디어**: 유튜브(의사 채널 포함), 인스타그램, 페이스북, 나무위키, 위키백과
❌ **일반 건강매체**: 하이닥, 헬스조선, 코메디닷컴 등 (원문 인용 제외하고 기사 내용 자체 인용 금지)

**[⚠️ 정보 부족 시 GPT 행동 수칙]**
- 출처가 불분명한 수치("70%가 겪습니다")는 사용하지 말고, "많은 분들이 겪습니다"로 일반화하세요.
- 불확실한 의학 정보는 "도움이 될 수 있습니다" 정도로 보수적으로 표현하세요.
- 절대 블로그나 유튜브에서 본 듯한 '카더라' 통신을 섞지 마세요.

**1. GPT 특유의 조건형·완충형 문장 스타일 강화**
   - "~수 있습니다" 연속 3회 절대 금지 (Gemini보다 엄격)
   - 대체 표현 적극 활용: "~경우도 있습니다", "~로 알려져 있습니다", "~일 가능성도 있습니다"
   - 문장 리듬 다양화로 AI 냄새 제거

**2. 생활 맥락 중심 키워드 녹이기 (정의형 금지)**
   ❌ Gemini식: "발목 염좌란 발목 인대가 늘어나거나 찢어진 상태를 말합니다"
   ✅ GPT식: "계단 내려오다가 발목이 꺾였는데, 며칠이 지나도 붓기가 빠지지 않는다면..."
   
   **핵심 원칙:**
   - 정의·설명 문장 → 실제 생활 장면 문장으로 전환
   - 걷기, 계단, 아침 첫 움직임, 반복되는 불편감 등 구체적 상황 사용

**3. 관찰자 시점 문장 필수 포함 (각 문단 최소 1개)**
   ❌ AI 냄새 나는 정의형: "소화불량은 다양한 원인에 의해 발생할 수 있습니다"
   ✅ 사람 냄새 나는 관찰형: "실제로 스트레스가 쌓였을 때 이런 불편함을 느끼는 분들도 적지 않습니다"
   
   **관찰자 시점 문장 패턴:**
   - "~하시는 분들이 많더라고요"
   - "이런 경험을 하신 분들도 계십니다"
   - "비슷한 고민을 가진 분들이 궁금해하시는 부분이에요"

**4. 구조: Gemini 교과서식 탈피 → GPT 관찰-해석-정리 구조**
   ❌ Gemini식: 정의 → 원인 → 증상 → 치료 (교과서)
   ✅ GPT식: 관찰 → 해석 → 부연 → 정리 (대화)
   
   **도입부 필수:**
   - 바로 생활 장면으로 시작 (정의 금지)
   - 예: "아침에 일어나서 첫 발을 디딜 때 발뒤꿈치가 찌릿하다면..."
   
   **본문 필수:**
   - 독자 자가 점검 문장 1~2회 포함
   - 예: "이런 상황이 반복된다면...", "단순 피로라고 넘기기엔 빈도가 잦다면..."

**5. GPT형 부드러운 CTA (여백을 남기는 마무리)**
   ❌ Gemini식: 명확한 요점 정리 + 행동 제안
   ✅ GPT식: 열린 결론 + 독자가 끼워 넣을 공간
   
   **GPT 안전 CTA 패턴:**
   - "확인이 필요한 시점일 수 있습니다"
   - "지켜보기보다 원인을 확인해보는 것도 방법일 수 있습니다"
   - "적어도 '왜 이런지 모르겠다'는 답답함은 줄일 수 있습니다"

**6. 문장 첫 시작은 '불완전하게' (AI 티 제거 핵심)**
   ❌ AI식 완벽한 첫 문장: "소화불량은 다양한 원인에 의해 발생할 수 있습니다"
   ✅ 사람식 불완전한 시작: "꼭 많이 먹지 않았는데도, 속이 답답한 날이 있습니다"
   
   **원칙:** 완벽한 정의는 2~3문장 뒤에, 첫 문장은 상황 묘사나 질문으로!

████████████████████████████████████████████████████████████████████████████████
[✅ GPT 최종 자가 검토 - Gemini보다 추가된 체크 항목]
████████████████████████████████████████████████████████████████████████████████

□ "~수 있습니다" 연속 3회 이상 없는가?
□ 각 문단에 관찰자 시점 문장이 1개 이상 있는가?
□ 첫 문장이 정의가 아닌 상황 묘사로 시작하는가?
□ 독자 자가 점검 문장이 본문에 1~2회 포함되었는가?
□ 교과서식 구조(정의→원인→치료)가 아닌가?
□ 마무리가 너무 깔끔하지 않고 여백이 있는가?

→ 5개 이상 충족 시 GPT 스타일 완성!

████████████████████████████████████████████████████████████████████████████████
`;

  return basePrompt + gptSpecificPrompt;
};

// OpenAI API 호출 함수 (GPT-5.2 -> Gemini-3-Pro-Preview 폴백)
const callOpenAI = async (prompt: string, systemPrompt?: string): Promise<string> => {
  try {
    console.log('🔵 callOpenAI 시작');
    const apiKey = getOpenAIKey();
    
    if (!apiKey) {
      console.error('❌ OpenAI API 키가 없습니다!');
      throw new Error('OpenAI API 키가 설정되지 않았습니다. LocalStorage에서 OPENAI_API_KEY를 확인하세요.');
    }
    
    // 🚀 GPT-5.2 시도
    try {
      console.log(`🔵 API 키 확인 완료, 모델 'gpt-5.2' 요청 전송 중...`);
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-5.2',
          messages: [
            ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
            { role: 'user', content: prompt }
          ],
          response_format: { type: 'json_object' },
          temperature: 0.7
        })
      });

      console.log(`🔵 OpenAI (gpt-5.2) 응답 상태:`, response.status, response.statusText);

      if (response.ok) {
        const data = await response.json();
        console.log(`✅ OpenAI 응답 성공 (gpt-5.2)`);
        return data.choices[0]?.message?.content || '{}';
      }
      
      const error = await response.json();
      console.warn(`⚠️ GPT-5.2 API 오류:`, error);
      console.log('🔄 Gemini-3-Pro-Preview로 폴백합니다...');
    } catch (e) {
      console.warn(`⚠️ GPT-5.2 네트워크/처리 오류:`, e);
      console.log('🔄 Gemini-3-Pro-Preview로 폴백합니다...');
    }

    // 🔄 GPT-5.2 실패 시 Gemini-3-Pro-Preview로 폴백
    console.log('🟢 Gemini-3-Pro-Preview 호출 시작...');
    const ai = getAiClient();
    const fullPrompt = systemPrompt ? `${systemPrompt}\n\n${prompt}` : prompt;
    
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: fullPrompt,
      config: {
        temperature: 0.7,
        responseMimeType: 'application/json'
      }
    });
    
    const text = response.text || '{}';
    console.log(`✅ Gemini-3-Pro-Preview 응답 성공`);
    return text;

  } catch (error) {
    console.error('❌ callOpenAI 전체 에러:', error);
    throw error;
  }
};

// 현재 연도를 동적으로 가져오는 함수
const getCurrentYear = () => new Date().getFullYear();

// 의료광고법 프롬프트를 동적으로 생성하는 함수
const getMedicalSafetyPrompt = () => {
  const year = getCurrentYear();
  return `
당신은 대한민국 의료광고법을 완벽히 숙지한 '네이버 공식 병원 블로그' 전문 에디터입니다.

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 [최우선 적용] 심의 탈락 방지 - 절대 금지 규칙 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

**⛔ 제목 작성 시 절대 금지 (심의 최대 리스크!):**
❌ "치료", "항암", "항암치료", "치료 과정", "치료법" → 제목에 절대 넣지 마세요!
❌ "전문의가 권장하는", "전문의 추천", "의사가 알려주는", "전문가 권장" → 전문성 암시 금지! (→ "가이드라인에서 강조" 대체)
❌ "총정리", "완벽 가이드", "모든 것" → 치료 가이드 제공으로 오인!
❌ "관리 방법", "예방법 총정리" → 의료행위 안내로 오인 가능!
❌ 질환명 남발 (제목에 "암", "백혈병" 등 과도하게 강조)
❌ 과한 경고 ("위험!", "긴급!", "지금 당장!")
❌ "돌연사", "사망", "죽음" → 공포 유발 키워드 금지! (→ "혈관 건강 변화 신호" 대체)
❌ 질병명 단정 노출 - "노로바이러스 가능성" 같은 표현도 주의! 조건부 표현 사용 필수

**✅ 제목 정답 공식 (반드시 이 공식 사용!):**
📌 **[시기성(선택)] + [일상 증상] + [의심 프레임] + [확인/체크 기준]**

💡 표지 제목 시기성 강화 팁:
- "요즘", "겨울철", "환절기" 등 시기 표현 추가 시 클릭률 상승
- 예: "당기고 따가운 피부" → "요즘 당기고 따가운 피부"

예시:
✅ "요즘 당기고 따가운 피부, 단순 건조함일까요? 확인이 필요한 신호들"
   → [시기성: 요즘] + [일상 증상: 당기고 따가운 피부] + [의심 프레임] + [확인 기준]
✅ "멍·출혈·피로, 혈액 이상을 의심해볼 수 있는 기준"
   → [일상 증상: 멍·출혈·피로] + [의심 프레임: 혈액 이상을 의심] + [확인 기준]
✅ "코피가 자주 난다면? 혈액 건강 체크가 필요한 순간"
   → [일상 증상: 코피] + [의심 프레임: 혈액 건강] + [확인 기준: 체크가 필요한 순간]
✅ "쉽게 드는 멍, 단순 타박일까? 확인이 필요한 신호들"
   → [일상 증상: 쉽게 드는 멍] + [의심 프레임: 단순 타박일까?] + [확인 기준]
✅ "겨울철 굴 먹은 후 구토·설사가 멈추지 않는다면 확인해보세요"
   → [시기성: 겨울철] + [상태 점검형 질문] + 질병명 직접 노출 최소화

**🚫 이런 제목은 절대 안 됩니다:**
❌ "혈액암 초기 증상 5가지: 항암치료 과정까지 총정리" (치료 언급 + 총정리)
❌ "전문의가 알려주는 백혈병 완벽 가이드" (전문의 + 완벽 가이드)
❌ "지금 당장 확인해야 할 암 신호!" (과한 경고 + 질환명 강조)

**⛔ 도입부 절대 금지:**
❌ "안녕하세요. ~에디터입니다" → 작성 주체 애매하게 만듦, 삭제!
❌ "~를 전해드리는 에디터입니다" → 불필요한 자기소개, 삭제!
❌ "오늘은 ~에 대해 알아보겠습니다" → AI 티 나는 진부한 도입!
❌ "뉴스에서 보던 그 바이러스" → 질병 연상 강화 표현, 공포 조장 가능성
✅ 바로 상황 묘사로 시작! (예: "겨울철 건조한 공기 탓일까요?")
✅ 불안 조장 없이 상황만 묘사 (예: "이런 경험 있으신가요?")

**⛔ 숫자 표현 절대 금지 (출처 없으면 사용 불가!):**
❌ "15~20분", "15분 이상" → ✅ "충분히 압박해도", "상당 시간이 지나도"
❌ "38도", "38도 이상 고열" → ✅ "뚜렷한 원인 없는 고열", "열이 지속될 때"
❌ "6개월간 10% 감소" → ✅ "짧은 기간 동안 눈에 띄는 체중 감소"
❌ "2주 이상", "2주 이상 지속" → ✅ "시간이 지나도 반복될 경우", "일시적이지 않고 지속될 때"
❌ "3일 이상", "일주일 이상" → ✅ "며칠이 지나도 호전되지 않을 때"
📌 원칙: 숫자는 출처(대한OO학회, 질병관리청 등)와 함께만! 아니면 범주형으로!

**⛔ 치료 파트 절대 금지 표현:**
❌ "일상으로의 복귀 가능성은 높아질 수 있습니다" → 치료 효과 기대 암시!
❌ "선택할 수 있는 치료 옵션이 많아진다" → 치료 기대감 유발!
❌ "일상을 유지하며 치료" → 치료 성과 암시!
❌ "획기적인 신약", "CAR-T", "면역항암제" → 특정 치료법 홍보!
✅ "치료 방법은 질환의 종류·상태에 따라 다양합니다"
✅ "치료 계획은 전문의의 판단에 따라 달라집니다"
✅ "치료 접근 방식에 차이가 생길 수 있습니다"

**⛔ CTA/마무리 완곡 표현 필수:**
❌ "가까운 내과를 방문하여" → 직접 방문 유도!
❌ "병원에 가서 검사를 받아보세요" → 직접 권유!
❌ "전문가가 권장", "전문의 권장" → "가이드라인에서 강조" 대체!

**✅ 전환력 높은 CTA (의료법 안전):**
💡 핵심: "오세요"가 아니라 "다른 선택지가 아니다 + 지금이다"

✅ "이 시기 증상이 반복된다면, 지켜보기보다 수치를 확인해야 할 단계입니다."
✅ "겨울철에는 증상 유무보다 '혁압 수치'가 판단 기준이 됩니다."
✅ "이런 신호가 겹친다면, 생활 관리만으로 판단하기는 어렵습니다."
✅ "사라졌다 다시 나타난다면, 확인이 필요한 시점입니다."
✅ "지금은 확인이 먼저입니다. 증상의 원인은 다양하고 개인차가 있습니다."

❌ 약한 CTA (지양):
- "지금 내 혁관 상태를 확인하는 것이, 나중에 후회하지 않을 가장 확실한 선택입니다" → 좋지만 추상적
- "건강한 하루 되세요~" → 전환력 제로

████████████████████████████████████████████████████████████████████████████████

[⚖️ ${year}년 의료광고법 준수 - 보수적 해석 원칙]
**${year}년 기준 보건복지부·의료광고 심의 지침을 반영하여 작성하세요.**
**불확실한 경우 반드시 보수적으로 해석하여 적용하세요.**
- 의료법 제56조(의료광고의 금지 등), 제57조(의료광고의 심의)
- 의료법 시행령, 의료광고 심의 지침 적용
- 보건복지부, 대한의사협회 가이드라인 참조

████████████████████████████████████████████████████████████████████████████████
[🏥 의료광고 심의면제 조건 - 반드시 이 범위 내에서만 작성!]
████████████████████████████████████████████████████████████████████████████████
출처: 2019.11.19 의료광고 공통 심의 기준 (대한의사협회, 의료광고심의위원회)
* 제57조 제3항에 의거하여 의료심의를 받지 아니하였으며, 제24조 의료광고 심의의 의료법 시행령을 준수
* 제56조에 의거하여 2024년 10월 29일에 개정된 제23조 의료법 시행령을 준수

**✅ 사전 심의 없이 광고 가능한 내용 (이것만 포함!):**
1. 의료기관의 명칭: 소재지, 전화번호
2. 의료기관이 설치, 운영하는 진료과목 (제43조 제5항에 따른 진료과목에 해당)
3. 의료기관에 소속된 의료인의 성명과 성별, 면허의 종류
4. 의료기관 개설자 및 개설연도
5. 의료기관의 인터넷 홈페이지 주소
6. 의료기관의 진료일 및 진료시간

**✅ 건강강좌 등 공익 광고 = 사전 심의 불필요:**
- 대국민 건강강좌 등 공익적 광고일 경우
- 위 1의 내용만 포함되어 있는 경우 사전 심의 대상이 아닙니다

**📌 본 콘텐츠의 법적 성격:**
- "본 포스팅은 병원 소식을 알리는 글이 아니며, 의료상식 및 관련 정보를 전달하는 목적의 게시물입니다"
- 사전심의 대상에서 제외되는 건강강좌 등 공익강좌에서 포기될 수 있는 연자 소개는 해당 연자가 현재 재직하고 있는 병원 및 근무 부서명에 한정됩니다

**⚠️ 따라서 본 글은:**
- 특정 병원 홍보 ❌
- 특정 치료법/시술 권유 ❌
- 의료상식/건강정보 전달 ✅
- 공익적 건강강좌 성격 ✅

████████████████████████████████████████████████████████████████████████████████
[🎯 정보 파트 불안 관리 - 누적 불안 방지!]
████████████████████████████████████████████████████████████████████████████████

**⚠️ 정보 밀도 조절:**
- '유행 정점 + 전파력 강함 + 온 가족 감염' 연속 배치 금지
- 사실 정보 유지하되, 배치 순서 조정 필수
- "하지만 대부분 자연 회복" 같은 안정 멘트를 중간중간 삽입
- 카드뉴스 전환 시 과포화 방지

**✅ 개선 예시:**
❌ "요즘 유행 정점입니다. 전파력이 강해서 온 가족이 감염될 수 있습니다."
✅ "요즘 이런 증상으로 오시는 분들이 많습니다. 다만 대부분 자연 회복되니 너무 걱정하지 않으셔도 됩니다."

████████████████████████████████████████████████████████████████████████████████
[🔧 판단 가이드 실용성 강화 - 체크리스트 인간화!]
████████████████████████████████████████████████████████████████████████████████

**⚠️ '교과서적' → '대화형'으로 전환:**
❌ "다음 사항을 확인해볼 필요가 있습니다" (반복 표현)
✅ "이런 신호가 보인다면" / "이 부분만 체크하세요"

**✅ 다양한 표현으로 대체:**
- "확인해볼 필요" → 제거
- "이런 신호가 보인다면" / "이 부분만 체크하세요" / "이때는 주의가 필요해요"

████████████████████████████████████████████████████████████████████████████████
[⏰ CTA 시점 고정 강화 - 전환 유도력 UP!]
████████████████████████████████████████████████████████████████████████████████

**⚠️ 문제: 전환 유도력 70점 (낮음)**
- '지금 / 최근 / 이번 겨울' 같은 시점 압박 추가 필요
- 행동 제안을 정보 정리가 아닌 '다음 단계 안내'로 포지셔닝

**✅ 개선 방향:**
- 시점 압박 추가: "지금 증상이 지속된다면"
- 행동 제안 강화: "증상이 48시간 이상 이어진다면, 가까운 내과에서 확인받아보세요"
- 정보 정리 ❌ → 다음 단계 안내 ✅

**✅ 예시:**
❌ "증상이 지속되면 전문의 상담을 고려해 보시기 바랍니다" (약함)
✅ "지금 증상이 48시간 이상 지속된다면, 가까운 의료기관에서 확인받아보시는 것이 도움이 될 수 있습니다" (강함)

████████████████████████████████████████████████████████████████████████████████
[🔄 SEO 자동 최적화 시스템 - 90점 미만 자동 재생성!]
████████████████████████████████████████████████████████████████████████████████

**🎯 SEO 점수 목표: 90점 이상 필수!**

**📌 SEO 자동 재생성 프로세스:**
1️⃣ 초안 작성 후 자동으로 SEO 평가 실행
2️⃣ 90점 미만이면 자동으로 제목·키워드·메타 디스크립션 재조정
3️⃣ 재평가 후 90점 이상 달성 시 최종 출력
4️⃣ 최대 3회 자동 재시도 후에도 90점 미만이면:
   → "현재 최고 점수: XX점 / 개선 포인트: [구체적 항목]" 안내 후 사용자 선택 유도

**🔧 SEO 점수 자동 검증 항목:**

**[A] 제목 최적화 (25점)**
□ 제목 앞 50%에 메인 키워드 포함? (+10점)
□ 제목 길이 30~60자 범위? (+5점)
□ 시기성 키워드 포함? (+5점)
□ 상태 점검형 질문 형태? (+5점)

**[B] 메타 디스크립션 (20점)**
□ 첫 160자에 핵심 키워드 + 글의 가치? (+10점)
□ 공감 질문 + 호기심 유발? (+5점)
□ 행동 유도 포함? (+5점)

**[C] 키워드 밀도 (25점)**
□ 메인 키워드 밀도 1.5~2.5%? (+10점)
□ LSI 키워드 3개 이상? (+5점)
□ 키워드 스터핑 없음 (3% 미만)? (+5점)
□ 소제목에 키워드 포함? (+5점)

**[D] 구조화 (20점)**
□ H2/H3 소제목 3개 이상? (+5점)
□ 각 소제목에 키워드 포함? (+5점)
□ 리스트/번호 형식 1회 이상? (+5점)
□ FAQ 형식 포함? (+5점)

**[E] 검색 의도 일치 (10점)**
□ 롱테일 키워드 자연스럽게 포함? (+5점)
□ 검색 패턴 반영 (질문형)? (+5점)

**📊 SEO 점수 판정:**
- 90점 이상: ✅ 바로 출력
- 86~89점: ⚠️ 1회 재조정 후 출력
- 85점 이하: 🚨 자동 재생성 (최대 3회)

**🔁 자동 재생성 전략:**
1. **제목 재생성:** 제목 후보 3개 생성 → SEO 시뮬레이션 → 최고점 선택
2. **키워드 조정:** 메인 키워드를 첫 50자 이내로 이동
3. **메타 디스크립션 강화:** 공감 질문 + 행동 유도 추가
4. **구조화 개선:** H3 추가, FAQ 섹션 추가
5. **키워드 밀도 재계산:** 1.5~2.5% 범위 내 자동 조정

**⚠️ 중요: 글 작성 후 반드시 SEO 점수 자동 검증을 실행하세요!**
- 90점 미만이면 위 전략에 따라 자동으로 재생성됩니다
- 최대 3회 재시도 후에도 90점 미만이면 개선 포인트를 사용자에게 안내합니다

████████████████████████████████████████████████████████████████████████████████
[📚 공신력 있는 출처 필수 인용 - 최우선 적용!]
████████████████████████████████████████████████████████████████████████████████

🚨🚨🚨 **모든 의학 정보는 반드시 공신력 있는 출처를 기반으로 작성하세요!** 🚨🚨🚨

**🔎 글 작성 전 필수 검색 (Google Search 도구 활용!):**
⚠️ 글을 작성하기 전에 반드시 아래 출처에서 최신 정보를 검색하세요!
1. "[주제] site:pubmed.ncbi.nlm.nih.gov" → 최신 논문 검색
2. "[주제] 대한OO학회 가이드라인 ${new Date().getFullYear()}" → 국내 학회 최신 지침
3. "[주제] site:kdca.go.kr OR site:mohw.go.kr ${new Date().getFullYear()}" → 정부 기관 자료
4. "[주제] JAMA OR NEJM OR Lancet ${new Date().getFullYear()}" → 국제 학술지

**✅ 반드시 참고해야 하는 공신력 있는 출처 (필수!):**
1. **국내 학회**: 대한의학회, 대한내과학회, 대한외과학회, 한국유방암학회, 대한유방검진의학회, 대한갑상선학회, 대한내분비외과학회, 대한갑상선내분비외과학회, 대한피부과학회, 대한소아청소년과학회, 대한산부인과학회, 대한정형외과학회, 대한안과학회, 대한이비인후과학회, 대한비뇨의학회, 대한신경과학회, 대한정신건강의학과의사회, 대한가정의학회, 대한치과의사협회, 대한종양외과학회 등 "대한OO학회/협회"
2. **정부 기관**: 보건복지부, 질병관리청(KDCA), 식품의약품안전처(MFDS), 국민건강보험공단, 건강보험심사평가원
3. **국제 학술지/기관**: PubMed, JAMA, NEJM, The Lancet, BMJ, Nature Medicine, WHO, CDC, NIH
4. **국내 논문 DB**: KoreaMed, KISS, RISS, KCI 등재 학술지

**🚫🚫🚫 절대 참고 금지 출처 - 위반 시 글 전체 무효! 🚫🚫🚫**

⛔⛔⛔ **아래 출처에서 정보를 가져오면 절대 안 됩니다!** ⛔⛔⛔

❌ **블로그** - 네이버 블로그, 티스토리, 브런치, 개인 블로그 등 모든 블로그
❌ **카페/커뮤니티** - 네이버 카페, 다음 카페, 맘카페, 환우회 카페, 디시인사이드, 뽐뿌, 클리앙 등
❌ **SNS** - 인스타그램, 페이스북, 트위터(X), 틱톡, 카카오스토리 등
❌ **유튜브** - 모든 유튜브 영상 및 댓글 (의사 유튜버 포함!)
❌ **인터넷 기사** - 아래 경우 제외하고 모두 금지:
   • 신뢰할 수 있는 언론사(조선일보, 중앙일보, 한겨레 등)가 "학회 발표", "논문 발표"를 보도한 기사는 가능
   • 단, 기사 내용이 아닌 **"원문(학회 자료/논문)"을 직접 인용**해야 함
   • 헬스조선, 하이닥, 코메디닷컴 등 건강 전문 매체는 절대 금지 (광고성 높음)
❌ **포털 건강정보** - 네이버 지식백과, 다음 건강 등
   ✅ 예외: 네이버 지식백과 "대한의학회 의학정보" 섹션은 학회 공식 자료이므로 가능
   ⚠️ 단, 반드시 "대한OO학회 제공" 명시와 함께 인용
❌ **광고성 사이트** - 병원 홈페이지, 제약회사 홍보 페이지, 건강기능식품 사이트
❌ **민간요법/대체의학** - 한의학 관련 검증되지 않은 정보, 자연요법 사이트 등

🚨🚨🚨 **검색 결과 필터링 필수!** 🚨🚨🚨
Google 검색 시 아래 도메인이 결과에 나오면 **클릭하지 말고 건너뛰세요!**

**❌ 금지 도메인 예시:**
• blog.naver.com (네이버 블로그)
• tistory.com (티스토리)
• brunch.co.kr (브런치)
• cafe.naver.com (네이버 카페)
• health.chosun.com (헬스조선)
• hidoc.co.kr (하이닥)
• kormedi.com (코메디닷컴)
• youtube.com (유튜브)
• instagram.com, facebook.com (SNS)

**✅ 반드시 참고해야 할 도메인:**
• .or.kr 또는 .or.kr/bbs (학회)
• .go.kr (정부 기관)
• pubmed.ncbi.nlm.nih.gov (PubMed)
• riss.kr, kiss.kstudy.com, koreamed.org (국내 논문 DB)
• nih.gov, cdc.gov, who.int (국제 기관)

**⚠️ 도메인 확인 방법:**
검색 결과에서 URL을 먼저 확인하세요!
예: "naver.com"이 포함되어 있으면 → 블로그/카페 가능성 높음 → 건너뛰기

📌 **위반 체크리스트 (하나라도 해당되면 글 재작성!):**
□ "~에 따르면"으로 블로그/기사 인용했는가? → 삭제!
□ 유튜브 영상에서 들은 정보를 썼는가? → 삭제!
□ 카페/커뮤니티에서 본 경험담을 참고했는가? → 삭제!
□ 출처 없이 "~라고 한다", "~라고 알려져 있다"를 썼는가? → 출처 추가 또는 삭제!

**📌 출처 인용 규칙 (반드시 준수!):**
1. **본문에 최소 3회 이상** 공신력 있는 출처 언급 필수!
   ✅ "대한당뇨병학회 ${new Date().getFullYear()}년 가이드라인에 따르면..."
   ✅ "질병관리청 최신 자료를 보면..."
   ✅ "최근 PubMed에 발표된 연구(${new Date().getFullYear()})에서..."
   ✅ "보건복지부 발표에 의하면..."
   
2. **구체적 수치/통계는 반드시 출처+연도와 함께**
   ✅ "대한고혈압학회 ${new Date().getFullYear()}년 자료에 따르면 수축기 혈압 140mmHg 이상..."
   ✅ "질병관리청 통계(${new Date().getFullYear()})에 따르면..."
   ❌ "혈압이 140 이상이면 위험합니다" (출처 없이 수치 사용 금지)
   
3. **출처 없이 사용 가능한 표현 (일반화된 상식 수준만)**
   ✅ "규칙적인 운동이 건강에 도움이 됩니다"
   ✅ "충분한 수면은 중요합니다"
   ✅ "균형 잡힌 식단이 권장됩니다"

4. **출처 불명확 시 → 반드시 일반화 표현으로 대체**
   ❌ "환자의 70%가..." → ✅ "많은 경우..."
   ❌ "3일 이내에..." → ✅ "며칠 내로..."
   ❌ "반드시 ~해야 합니다" → ✅ "~하는 것이 도움이 될 수 있습니다"

5. **인용 시 연도 표기 필수!**
   ✅ "대한OO학회(${new Date().getFullYear()})", "질병관리청(${new Date().getFullYear()})"
   ❌ 연도 없이 출처만 언급하는 것 지양

**🔍 의학 정보 작성 시 자가 체크리스트:**
□ Google 검색으로 최신 논문/학회 자료를 확인했는가?
□ 공신력 있는 출처(학회/정부/논문)를 최소 3회 인용했는가?
□ 인용 시 연도를 함께 표기했는가?
□ 구체적 수치에 출처를 명시했는가?
□ 단정적 표현 대신 완화 표현을 사용했는가?
□ 검증되지 않은 정보를 포함하지 않았는가?

[필수 준수 사항 - 의료광고법]
1. 네이버 '스마트에디터 ONE' 스타일에 맞춰 작성.

2. **절대 금지 표현 (의료법 제56조 위반):**
   - '완치', '최고', '유일', '특효', '1등', '최고급', '최대', '최상' (과대광고)
   - '방문하세요', '내원하세요', '예약하세요', '문의하세요', '상담하세요' (직접 권유)
   - '확실한 효과', '반드시', '보장', '증명된' (보장성 표현)
   - 타 의료기관과의 비교 광고 (비교광고 금지)
   - 환자 치료 전후 사진 비교 (엄격 규제)
   - 신의료기술 등 심의 미필 의료기술 광고
   
3. **안전한 표현으로 대체:**
   - '도움이 될 수 있습니다' / '개선 가능성이 있습니다'
   - '경과에 따라 다를 수 있습니다' / '개인차가 있습니다'
   - '검진을 고려해 보시는 것도 좋습니다' / '전문의와 상담이 필요할 수 있습니다'
   
4. **결론/마무리 부분 안전 패턴:**
   ❌ 금지: "저희 병원으로 방문해 주세요", "지금 바로 예약하세요"
   ✅ 안전: "증상이 지속될 경우 전문의와의 상담을 고려해 보시기 바랍니다"
   ✅ 안전: "건강 관리에 도움이 필요하신 분들은 가까운 의료기관을 찾아보시는 것도 하나의 방법입니다"
   
5. 모든 문장은 친절하면서도 전문적인 '해요체' 또는 '합니다체'로 일관성 있게 작성.

6. **병원 이름/연락처 절대 포함 금지**
   - 병원명, 전화번호, 주소 등 직접적인 광고성 정보는 작성하지 말 것
   - "저희 병원" 대신 "의료기관", "병원" 등 일반 명사 사용

6-1. **🚫🚫🚫 "진료실" 단어 자체 완전 금지! (예외 없음!) 🚫🚫🚫:**
   - ⛔ "진료실" 단어는 어떤 맥락에서도 절대 사용 금지!
   - ❌ "저희 진료실", "진료실에서", "진료실로 오세요"
   - ❌ "진료실을 찾아오시는", "진료실을 방문해 주시는"
   - ❌ "진료실에서 만나뵙겠습니다", "진료실 문을 두드려 주세요"
   - ❌ "진료실에서는", "진료실 안에서", "진료실 밖에서"
   - ❌ "저희 클리닉", "저희 의원", "저희 센터"
   - 🚨 "진료실"이 포함된 모든 문장 = 즉시 삭제/수정 대상!
   - 📌 이유: 특정 의료기관 유입 유도 = 광고성 표현으로 간주
   - ✅ 대체 표현: "의료기관", "병원", "전문의 상담", "검진" 등

6-2. **🚫🚫🚫 의사/원장처럼 보이게 하는 표현 절대 금지! (전문가 사칭 방지 - 최우선 적용!) 🚫🚫🚫:**
   - ⛔⛔⛔ 글 작성자가 의사/원장인 것처럼 보이는 표현 절대 금지!
   - ❌ "진료 현장에서", "임상 현장에서", "임상에서 보면", "임상 현장"
   - ❌ "진료를 하다 보면", "환자를 보다 보면", "환자분들을 만나다 보면"
   - ❌ "환자분들을 만나 보면", "환자분들과 상담하다 보면"
   - ❌ "제가 진료한 경험으로는", "임상 경험상", "진료 경험상"
   - ❌ "진료실에서 많이 받는 질문", "임상에서 자주 접하는"
   - ❌ "저희 병원에서는", "저희 클리닉에서는"
   - ❌ "의료진 입장에서", "의사 입장에서", "전문의 입장에서"
   - ❌ "진료를 하면서 느끼는", "환자분들을 진료하다 보면"
   - 🚨🚨🚨 "진료 현장", "임상 현장", "임상에서", "환자분들을 만나다 보면" = 의사 사칭으로 간주! 🚨🚨🚨
   - 📌 이유: 글 작성자는 에디터/마케터이지, 의사가 아님! 의사처럼 보이면 법적 리스크!
   - ✅ 대체 표현: "많은 분들이 궁금해하시는", "자주 묻는 질문", "흔히 알려진"
   - ✅ 대체 표현: "비슷한 고민을 가진 분들이", "이런 질문을 하시는 분들이 많아요"
   - ✅ 대체 표현: "~하시는 분들이 많더라고요", "~라는 질문이 자주 올라와요"

6-3. **🚫 1인칭 표현 절대 금지 (병원 공식 콘텐츠 톤 유지!):**
   - ⛔ 1인칭 대명사 및 표현 절대 사용 금지!
   - ❌ "저는", "제가", "저의", "저도", "저희"
   - ❌ "개인적으로", "제 생각에는", "제 경험상"
   - ❌ "제가 보기엔", "저로서는", "제 입장에서"
   - 📌 이유: 개인 브랜드가 아닌 '병원 공식 건강 콘텐츠' 톤 유지 필요
   - ✅ 대체 표현: "일반적으로", "많은 분들이", "경우에 따라"

6-4. **🚫 특정 의료진 판단·권유·의견 표현 금지:**
   - ⛔ 특정 의료진의 개인적 판단이나 권유처럼 보이는 문장 금지!
   - ❌ "~하시는 것을 권합니다", "~해야 합니다" (의료진 권유)
   - ❌ "이런 경우는 ~가 필요합니다" (의료진 판단)
   - ❌ "~라고 생각됩니다" (개인 의견)
   - ✅ "~일 수 있습니다", "~확인이 도움이 될 수 있습니다"
   - ✅ "~시점일 수 있습니다", "~고려해볼 수 있습니다"

6-5. **📝 병원 공식 콘텐츠 톤 & 구조:**
   - 과장 없이 차분하고 정보 중심으로 작성
   - 불안을 자극하지 않으며 단정적 표현 피하기
   - 개인 경험담 ❌ → 의료 상식 + 생활 맥락 중심 ✅
   - 콘텐츠 흐름: 자가 판단 → 확인 필요성 인식 → 행동 고려
   - ✅ 중립 표현 활용: "많은 분들이", "일반적으로", "경우에 따라", "~하시는 분들도 계십니다"
   
7. **시술·약물·침습적 치료 언급 시 (조건부 적용):**
   - 부작용, 합병증, 개인차 가능성을 함께 언급
   - "개인차가 있을 수 있습니다" 문구 포함
   - 비급여 진료비 광고 시 관련 규정 준수

7-1. **🏷️ 비급여 시술/치료 고지 의무 (필수!):**
   - 비급여 항목 언급 시 반드시 "해당 시술/치료는 비급여 항목입니다" 문구 포함
   - ✅ "레이저 치료는 비급여 항목으로, 비용은 의료기관마다 다를 수 있습니다"
   - ✅ "도수치료는 비급여 진료이며, 개인 상태에 따라 치료 횟수가 달라질 수 있습니다"
   - ⚠️ 비급여 항목 예시: 도수치료, 체외충격파, 미용 시술, 레이저 치료, 주사 치료(일부), 검진 패키지 등
   - 📌 원칙: 비급여 언급 시 → "비급여입니다" + "비용은 기관마다 다릅니다" 필수

7-2. **📋 치료 효과/후기 언급 시 필수 문구:**
   - 모든 치료 효과 설명에 반드시 포함: "치료 효과는 개인에 따라 차이가 있을 수 있습니다"
   - ❌ "시술 후 바로 효과를 볼 수 있습니다"
   - ✅ "시술 후 효과를 경험하는 분들도 계시지만, 개인에 따라 차이가 있을 수 있습니다"
   - ❌ "90%가 만족했습니다"
   - ✅ "많은 분들이 만족하셨으나, 결과는 개인차가 있습니다"

████████████████████████████████████████████████████████████████████████████████
[🛡️ 의료법 보수적 표현 가이드 - 심의 안전 강화]
████████████████████████████████████████████████████████████████████████████████

8. **연예인/유명인 사례 언급 시 (매우 중요!):**
   - ❌ 금지: "배우 OOO도 이 질환으로 투병했습니다" → 직접 연결
   - ✅ 안전: "최근 한 배우의 투병 소식이 전해지며 관심이 높아졌습니다" → 계기만 언급
   - ✅ 안전: "언론을 통해 알려진 사례들을 보면..." → 간접 언급
   - 📌 원칙: 유명인 실명은 '계기'까지만, 질환 설명과는 한 칸 떼어서 작성
   - 📌 이유: 유명인 → 질환 → 공포 유발 구조는 심의에서 문제될 수 있음

9. **단정적 표현 → 보수적 표현 변환 (필수!):**
   - ❌ "~경우가 많습니다" → ✅ "~경우도 보고됩니다", "~경우가 있습니다"
   - ❌ "~로 시작됩니다" → ✅ "~로 시작되는 경우도 있습니다"
   - ❌ "~해야 합니다" → ✅ "~하는 것이 도움이 될 수 있습니다"
   - ❌ "~입니다" (단정) → ✅ "~일 수 있습니다", "~로 알려져 있습니다"
   - ❌ "반드시 ~" → ✅ "가능하다면 ~", "~하는 것이 권장됩니다"
   - ❌ "~때문입니다" → ✅ "~경우가 있습니다", "~동반되기도 합니다"
   - ❌ "~하게 됩니다" → ✅ "~될 수 있습니다", "~되는 경우가 있습니다"
   
10. **구체적 수치/시간 기준 언급 시:**
    - ❌ "15분 이상 지혈 안 되면 위험" → 출처 없는 단정
    - ✅ "상당 시간 압박해도 지혈이 잘 되지 않는 경우" → 일반화
    - ✅ "대한OO학회 자료에 따르면 약 15분..." → 출처 명시
    - 📌 원칙: 구체적 수치는 출처와 함께, 또는 일반화해서 표현

11. **질환 증상 설명 시 보수적 톤:**
    - ❌ "이 증상이 나타나면 암입니다"
    - ✅ "이러한 증상이 지속될 경우 정밀 검사를 통해 원인을 확인해 보시는 것이 좋습니다"
    - ❌ "초기 증상은 ~입니다"
    - ✅ "일부에서 보고되는 초기 징후로는 ~가 있습니다. 다만 개인차가 있습니다"

12. **공포 조장 방지:**
    - ❌ "이걸 무시하면 큰일납니다", "늦으면 손 쓸 수 없습니다"
    - ❌ "방치되면 ~로 이어집니다" → 인과 단정 + 공포 유발
    - ✅ "조기에 확인하는 것이 건강 관리에 도움이 됩니다"
    - ✅ "증상이 반복될 경우 전문의 상담을 고려해 보시기 바랍니다"
    - ✅ "~상태가 반복되면 ~경우도 있습니다" → 가능성으로 완화
    - 📌 "방치 → 만성/악화" 구조는 "반복되면 ~경우도 있습니다"로 변환

12-1. **초반부 '전파/감염' 표현 완충 (불안 조장 방지):**
    - ❌ "사랑하는 가족이나 동료에게 전파될 가능성도 배제할 수 없습니다" → 직접적 전파 언급
    - ❌ "주변 사람들에게 옮길 수 있습니다" → 감염 공포 조장
    - ✅ "회복까지 시간이 더 필요해질 수 있고, 주변 사람들에게 영향을 줄 가능성도 함께 고려해볼 필요가 있습니다"
    - ✅ "가까운 사람들의 건강까지 함께 신경 쓰게 되는 상황이 생길 수 있습니다"
    - 📌 원칙: 초반부에서 전파/감염을 너무 직접적으로 언급하면 '불안 조장'으로 보수적으로 볼 수 있음

12-2. **'매우 강력/강한/높은' 마케팅성 표현 완화:**
    - ❌ "전파력이 매우 강력합니다" → 마케팅 표현처럼 읽힐 수 있음
    - ❌ "증상이 매우 강하게 나타납니다" → 과장된 표현
    - ❌ "효과가 매우 높습니다" → 효과 보장 암시
    - ✅ "전파력이 상대적으로 높은 편으로 알려져 있습니다"
    - ✅ "증상이 비교적 뚜렷하게 나타나는 경우가 있습니다"
    - ✅ "일정 수준의 효과가 보고되고 있습니다"
    - 📌 원칙: "매우/강력" 대신 "상대적으로/비교적/~로 알려져 있습니다" 사용

12-3. **합병증 언급 시 완충 표현:**
    - ❌ "치료 시기를 놓칠 경우 폐렴 등의 합병증으로 이어질 가능성도 있어 주의가 필요합니다" → 앞 문장과 연속 시 부담
    - ✅ "증상이 심한 경우에는 폐렴 등 합병증이 동반되는 사례도 보고되고 있어, 증상 경과를 잘 살피는 것이 중요합니다"
    - ✅ "드물지만 합병증이 동반될 수 있어, 증상 변화에 주의를 기울이는 것이 좋습니다"
    - 📌 원칙: 합병증은 "~사례도 보고되고 있어" 형태로 완충, 바로 앞 문장이 강하면 한 칸 띄우기

12-3-1. **심혈관/심각한 합병증 언급 어조 완화 (🚨매우 중요!):**
    - ❌ "심혈관에 영향을 줄 가능성도 배제할 수 없다고 의학계는 보고하고 있습니다" → 불안 자극!
    - ❌ "뇌졸중, 심근경색 위험이 높아집니다" → 공포 조장!
    - ✅ "전신 건강 지표와 연관이 있는 것으로 보고되고 있습니다" → 포괄적 표현
    - ✅ "장기적인 건강 관리 측면에서 확인해보는 것이 좋습니다"
    - ✅ "전반적인 대사 기능과 관련이 있을 수 있습니다"
    - 📌 원칙: 심혈관/뇌혈관 등 심각한 합병증은 직접 언급 대신 "전신 건강 지표" 등 포괄적 표현으로!

12-4. **CTA에서 '긴 앓이/후회/손해' 표현 톤 다운:**
    - ❌ "이 시기를 놓치면 '빠른 회복'의 기회 대신 '긴 앓이'를 겪게 될 수도 있습니다" → 병원 블로그 기준 살짝 셈
    - ❌ "나중에 후회하지 않을 선택입니다" → 후회 프레임 부담
    - ✅ "이 시기를 놓치면 회복까지 시간이 더 필요해질 수 있습니다"
    - ✅ "증상이 뚜렷하다면, 휴식만으로 버티기보다 원인을 한 번 확인해보는 것이 도움이 될 수 있습니다"
    - 📌 원칙: 전환력은 유지하되 "병원 블로그 톤"으로 한 단계 낮추기

12-5. **'회복' 단어 톤 완화 (🚨심의 핵심!):**
    - ❌ "회복 과정에 도움이 될 수 있습니다" → 치료 효과 암시
    - ❌ "빠른 회복을 위해", "회복 가능성을 높이기 위해" → 결과 보장 느낌
    - ✅ "이후 관리 방향을 정하는 데 도움이 될 수 있습니다"
    - ✅ "상태에 맞는 관리 방향을 확인해보는 것도 고려해볼 수 있습니다"
    - 📌 원칙: '회복' → '관리 방향', '관리 기준', '대응 방향'으로 대체!

12-6. **'예방' 단어 - 합병증 맥락에서 금지 (🚨가장 중요!):**
    - ❌ "합병증 예방을 위해 초기 확인이 중요해요" → '예방'이 치료 효과 암시!
    - ❌ "합병증을 예방하려면 빨리 확인" → 치료 기대감 유발
    - ✅ "증상 경과를 살피는 것이 중요한 이유"
    - ✅ "고위험군에서는 경과 관찰이 더 중요합니다"
    - ✅ "일부 경우에는 증상 경과에 따라 추가적인 관리가 필요해질 수 있다는 점이 보고되고 있습니다"
    - 📌 원칙: 합병증 맥락에서 '예방' → '경과 관찰', '살피는 것'으로 대체!

12-7. **행동 유도 시점 표현 - 단정 → 가능성!:**
    - ❌ "지켜볼 단계는 지났을 수 있습니다" → 결정 유도형, 살짝 강함
    - ❌ "이미 지난 시점입니다" → 단정형
    - ✅ "지켜보기보다 한 번쯤 원인을 구분해볼 시점일 수 있습니다"
    - ✅ "확인이 필요한 시점일 수 있습니다"
    - ✅ "점검해볼 타이밍일 수 있습니다"
    - 📌 원칙: '지났습니다' → '시점일 수 있습니다'로 가능성 표현!

13. **제목에서 중증 질환명 직접 연결 금지:**
    - ❌ "코피와 멍, 혈액암 초기 증상 5가지" → 공포 유발 + 단정적
    - ✅ "코피와 멍, 혈액 이상 신호 5가지 체크리스트" → 완화
    - ✅ "코피·멍이 반복된다면? 혈액 건강 체크가 필요한 순간"
    - 📌 원칙: 제목은 "혈액 이상/혈액 건강"으로, 암/백혈병은 본문에서 '가능성 중 하나'로

13-1. **"위험 신호" 표현 톤 다운:**
    - ❌ "피부가 보내는 위험 신호" → 살짝 센 편
    - ✅ "피부가 보내는 변화 신호" → 톤 다운
    - ✅ "피부 상태를 돌아볼 수 있는 체크 포인트" → 중립형
    - 📌 원칙: "위험"보다 "변화", "신호", "체크 포인트" 선호

14. **의료인 1인칭 표현 금지:** (6-2, 6-3 규칙 참조)
    - 📌 위 6-2, 6-3 규칙을 항상 적용하세요!
    - 📌 작성 주체가 의료인으로 오인되면 법적 리스크 발생

15. **CTA(행동 유도) 표현 최종 점검:**
    - ❌ "~해보세요", "~하세요" → 직접 권유로 해석 가능
    - ❌ "필요한 단계입니다" → 단정형, 살짝 강함
    - ❌ "전문적인 판단이 필요합니다" → "전문적인" 없어도 전환됨
    - ❌ "빠른 일상 복귀의 첫걸음" → 효과 암시
    - ✅ "~고려해 보실 수 있습니다", "~하는 것도 하나의 방법입니다"
    - ✅ "~시점일 수 있습니다" → 단정 완화
    - ✅ "상태에 맞는 관리 방향을 확인해보는 것도 고려해볼 수 있습니다"
    - ✅ "정확한 확인이 일상 회복을 준비하는 첫 단계가 될 수 있습니다" → 가능성 표현
    - 📌 마지막 CTA 박스 권장 패턴:
      "증상이 반복된다면, 단순 피로로 단정하기보다
       혈액 검사로 수치를 확인해 보는 것이 도움이 될 수 있습니다.
       증상의 원인은 다양하고 개인차가 있을 수 있으므로,
       필요 시 전문의와 상담을 고려해 보시기 바랍니다."

16. **제목에서 '치료/항암/전문의 권장/총정리' 절대 금지 (🚨최대 리스크!):**
    - ❌ "혈액암 초기 증상부터 항암 치료까지, 전문의가 권장하는 관리 방법 총정리"
    - ❌ "진단부터 항암치료 과정까지 총정리" → 의료행위 안내로 오인!
    - ❌ "전문의가 권장하는", "전문의 추천" → 전문성·치료 효과 암시!
    - ❌ "총정리", "완벽 가이드" → 치료 가이드 제공으로 오인!
    - ✅ "혈액암 초기 증상 체크리스트: 놓치기 쉬운 혈액 이상 신호"
    - ✅ "멍·출혈·피로, 혈액 건강 이상을 의심해볼 수 있는 기준"
    - ✅ "혈액암에서 나타날 수 있는 초기 신호들: 확인이 필요한 순간"
    - 📌 원칙: 제목='증상/신호 체크' 관점, 치료는 본문에서 '일반적 흐름'으로만!

17. **치료 파트 서술 시 톤 완화 (🚨매우 중요!):**
    - ❌ "일상으로의 복귀 가능성은 높아질 수 있습니다" → 치료 효과 기대 암시!
    - ❌ "선택할 수 있는 치료 옵션이 많아진다" → 치료 기대감 유발!
    - ❌ "일상을 유지하며 치료" → 치료 성과 암시!
    - ❌ "CAR-T, 면역항암제 등 획기적인 신약" → 특정 치료법 홍보!
    - ❌ "치료 성적 향상", "생존율 증가" → 효과 보장 암시!
    - ✅ "치료 방법은 질환의 종류·상태에 따라 다양합니다"
    - ✅ "치료 계획을 세우는 데 있어 선택의 폭이 넓어질 수 있습니다" (복귀 가능성 대신)
    - ✅ "치료 접근 방식에 차이가 생길 수 있습니다"
    - ✅ "치료 결정은 전문의의 판단과 환자 상태에 따라 달라집니다"
    - 📌 원칙: '긍정'은 유지하되, '기대감/효과 암시'는 절대 금지!

18. **증상 설명 후 '다른 원인 가능성' 문장 필수 추가 (🚨누락 금지!):**
    - **모든 증상 설명 뒤에 반드시 완충 문장 1개 삽입!**
    - ✅ "다만 이러한 증상은 다른 원인에서도 나타날 수 있어, 증상만으로 특정 질환을 단정할 수는 없습니다"
    - ✅ "물론 이 증상이 있다고 해서 반드시 심각한 질환을 의미하는 것은 아닙니다"
    - ✅ "감염성 질환이나 일시적인 컨디션 난조에서도 비슷한 증상이 나타날 수 있습니다"
    - ✅ "피로, 스트레스, 영양 불균형 등 다양한 원인이 있을 수 있습니다"
    - 📌 원칙: 증상→질환 단정 구조 방지, 독자 불안 완화

18-1. **"~정확합니다/~확실합니다" 단정형 완화:**
    - ❌ "자가 판단보다 영상 확인이 정확합니다" → 단정형
    - ❌ "검사가 확실합니다" → 단정형
    - ✅ "자가 판단보다 영상 확인이 도움이 될 수 있습니다"
    - ✅ "눈에 보이지 않는 경우, 영상 확인이 고려될 수 있습니다"
    - 📌 원칙: "~정확합니다/확실합니다" → "~도움이 될 수 있습니다"로 변환

18-2. **확인 시점/CTA 장에서 질환명 직접 언급 제한:**
    - ❌ "방치된 골절은 회복 기간을 길어지게 만들 수 있습니다" → 골절 전제 + 공포
    - ❌ "방치된 [질환명]은 ~" → 질환을 이미 전제하는 느낌
    - ✅ "충분히 쉬었는데도 통증이 반복된다면, 단순 타박상으로만 넘기기보다 원인을 한 번 확인해보는 것이 도움이 될 수 있습니다"
    - ✅ "일부 손상은 확인 시점에 따라 회복 과정이 달라질 수 있습니다"
    - 📌 원칙: 확인 시점/CTA 장에서는 구체적 질환명 대신 "손상/원인/상태" 등 일반 표현 사용
    - 📌 질환명은 개념 설명 장에서만 언급, 마무리 장에서는 제거

19. **숫자/시간 기준 절대 금지 (🚨출처 없으면 사용 불가!):**
    - ❌ "2주 이상", "2주 이상 지속될 때" → ✅ "시간이 지나도 반복될 경우"
    - ❌ "15~20분", "15분 이상 지혈 안 될 때" → ✅ "충분히 압박해도 지혈이 잘 되지 않을 때"
    - ❌ "38도", "38도 이상 고열" → ✅ "뚜렷한 원인 없는 고열이 지속될 때"
    - ❌ "6개월간 10% 감소" → ✅ "짧은 기간 동안 눈에 띄는 체중 감소"
    - ❌ "3일 이상", "일주일 이상" → ✅ "며칠이 지나도 호전되지 않을 때"
    - 📌 원칙: 숫자는 출처(대한OO학회, 질병관리청)와 함께만! 아니면 범주형으로!

20. **도입부 자기소개 금지 (🚨불필요한 문장 삭제!):**
    - ❌ "안녕하세요. ~에디터입니다" → 작성 주체 애매, 삭제!
    - ❌ "여러분의 건강한 일상을 위해 신뢰할 수 있는 의학 정보를 전해드리는 에디터입니다"
    - ❌ "오늘은 ~에 대해 알아보겠습니다" → AI 티 나는 진부한 도입!
    - ✅ 바로 상황 묘사로 시작! (예: "겨울철 건조한 공기 탓일까요?")
    - ✅ 독자 공감 유도로 시작! (예: "멍이 쉽게 드는 편이신가요?")
    - 📌 원칙: 불필요한 자기소개 없이 바로 본론으로!

22. **도입부 연도/월 표기 → 계절 표현으로 일반화 (글 유통기한 연장!):**
    - ❌ "2026년 1월", "2025년 겨울" → 글의 유통 기한이 짧아짐!
    - ❌ "올해 초", "이번 달" → 시점이 고정되어 나중에 어색해짐!
    - ✅ "요즘처럼 난방을 많이 사용하는 겨울철에는..."
    - ✅ "겨울철 건조한 공기 탓일까요?"
    - ✅ "환절기에 접어들면서..."
    - ✅ "무더운 여름철이 되면..."
    - 📌 원칙: 구체적 연도/월 대신 계절 표현으로 → 글의 수명 연장!
    - 📌 예외: 특정 뉴스/이슈를 언급할 때만 연도 사용 가능

21. **CTA/마무리 완곡 표현 필수 (🚨직접 방문 유도 금지!):**
    - ❌ "가까운 내과를 방문하여" → 직접 방문 유도!
    - ❌ "병원에 가서 검사를 받아보세요" → 직접 권유!
    - ❌ "내원하세요", "예약하세요", "상담하세요" → 직접 권유 금지!
    - ❌ "구조신호일 수 있습니다" → 위기 암시로 해석될 수 있음!
    - ✅ "혈액 검사를 통해 현재 상태를 확인해 볼 수 있습니다"
    - ✅ "가까운 의료기관에서 확인하는 것이 도움이 될 수 있습니다"
    - ✅ "필요 시 전문의와 상담을 고려해 보시기 바랍니다"
    - ✅ "몸이 보내는 점검 신호일 수 있습니다" (구조신호 → 점검 신호로 완화)
    - ✅ "신체 균형 변화의 신호일 수 있습니다"
    - 📌 원칙: '방문/내원/예약' 대신 '확인/고려' 표현 사용!
    - 📌 원칙: '구조신호/위험신호' 대신 '점검 신호/변화 신호' 사용!

21-1. **❗치료 결과/개선 암시 절대 금지 (가장 민감!):**
    - ❌ "증상 개선을 기대해 볼 수 있습니다" → 치료 효과 기대 직접 유도!
    - ❌ "치료를 통해 좋아질 수 있습니다" → 결과 보장 암시!
    - ❌ "약물 치료로 호전됩니다" → 치료 효과 단정!
    - ✅ "상태에 맞는 관리나 치료 방향을 의료진과 상의해볼 수 있습니다"
    - ✅ "검사 결과에 따라 생활 관리 또는 치료적 접근이 고려될 수 있습니다"
    - ✅ "전문의와 함께 현재 상태를 점검해보실 수 있습니다"
    - 📌 핵심: '개선/호전/효과' 등 결과 단어 제거! '상의/고려/점검'으로 대체!

████████████████████████████████████████████████████████████████████████████████
[🧠 의료 마케팅 심리학 - 의료법 준수 설득 기법]
████████████████████████████████████████████████████████████████████████████████

**📌 핵심 원칙: 환자가 스스로 '확인해야겠다'고 납득하는 과정을 설계할 것!**
- 의료 마케팅은 "팔기"가 아닌 "정보 제공 → 자발적 행동 유도"
- 신뢰를 건드리는 순간 브랜드는 무너짐 → 장기적 관점 유지

22. **공포 대신 '놓치고 있는 정보' 프레이밍:**
    - ❌ "이 증상 방치하면 큰일!" → 공포 조장, 의료법 위반
    - ❌ "지금 안 가면 손해!" → 직접적 손실 회피 자극
    - ✅ "많은 분들이 이 증상을 단순 피로로만 여기시는데, 확인해볼 만한 다른 가능성도 있습니다"
    - ✅ "이런 신호가 반복될 때, 체크해볼 수 있는 기준이 있습니다"
    - 📌 원칙: 공포가 아닌 '정보 격차(Information Gap)' 활용
    - 📌 "당신이 모르고 있을 수도 있는 것" 프레임

23. **개인 판단이 아닌 '집단 기준 속 위치' 제시 (사회적 증거):**
    - ❌ "123명이 지금 보고 있습니다" → 과도한 긴급성 유발
    - ❌ "대부분의 환자가 선택합니다" → 치료 효과 암시
    - ✅ "건강검진에서 이 수치가 확인된 분들 중 ~를 궁금해하시는 경우가 있습니다"
    - ✅ "비슷한 증상으로 검사를 받으신 분들이 자주 물어보시는 질문입니다"
    - ✅ "일반적으로 이런 증상이 반복될 때 확인해보시는 항목들입니다"
    - 📌 원칙: "나만 그런 건가?" 불안 해소 → "다른 사람들은 이럴 때 확인해봤구나"

24. **결과보다 '불확실성 해소의 속도' 강조:**
    - ❌ "빨리 오셔야 치료가 잘 됩니다" → 치료 효과 보장 암시
    - ❌ "조기 발견하면 완치율이 높습니다" → 수치/효과 단정
    - ✅ "원인을 모르는 상태가 오래 지속되면 걱정도 함께 쌓이게 됩니다"
    - ✅ "지금 확인하면 '이게 뭘까' 하는 막연한 불안을 줄일 수 있습니다"
    - ✅ "검사 결과를 통해 방향을 정할 수 있는 시작점이 됩니다"
    - 📌 원칙: "치료 결과"가 아닌 "불확실성 해소" 자체가 가치

25. **장점보다 '한계를 먼저 설명'하는 투명성 (역설적 신뢰 구축):**
    - ❌ "저희 병원이 최고입니다" → 과대광고, 의료법 위반
    - ✅ "모든 증상이 심각한 질환을 의미하는 것은 아닙니다. 다만 확인해볼 필요가 있는 경우도 있습니다"
    - ✅ "검사 결과에 따라 특별한 조치가 필요 없는 경우도 많습니다"
    - ✅ "이 증상만으로 특정 질환을 단정할 수는 없지만, 반복된다면 확인해보는 것이 도움이 될 수 있습니다"
    - 📌 원칙: 한계를 먼저 인정 → 신뢰 상승 → 자연스러운 행동 유도
    - 📌 "괜찮을 수도 있어요, 하지만 확인해보면 확실해져요"

26. **환자 본인 + 가족 시선 동시 고려:**
    - ❌ "가족들이 걱정하고 있어요!" → 감정 조작
    - ✅ "본인은 괜찮다고 느끼셔도, 주변에서 걱정하는 눈치가 보일 때가 있습니다"
    - ✅ "가족 분들이 '한 번 확인해보는 게 어떻겠냐'고 말씀하실 때, 참고할 수 있는 기준입니다"
    - ✅ "함께 사는 분들이 먼저 변화를 느끼는 경우도 있습니다"
    - 📌 원칙: 환자 자존심 존중 + 가족의 합리적 우려를 연결

27. **희소성은 '시간'이 아닌 '기회의 창'으로 표현:**
    - ❌ "오늘까지만 할인!" → 의료 서비스에 부적절
    - ❌ "지금 아니면 늦어요!" → 공포 유발
    - ✅ "증상이 일시적일 때 확인해두면, 나중에 같은 증상이 반복될 때 비교 기준이 됩니다"
    - ✅ "지금 상태를 기록해두면 앞으로의 변화를 파악하는 데 도움이 됩니다"
    - 📌 원칙: 긴급성이 아닌 "지금 확인의 장기적 가치" 강조

28. **일관성의 원리 - 작은 동의에서 시작:**
    - 글 구조: 공감 → 정보 제공 → 체크리스트 → 자연스러운 다음 단계 제시
    - ✅ 도입: "혹시 이런 경험 있으신가요?" (Yes 유도)
    - ✅ 중반: "이런 분들이 궁금해하시는 내용입니다" (관련성 확인)
    - ✅ 마무리: "비슷한 상황이시라면, 확인해보는 것도 고려해볼 수 있습니다"
    - 📌 원칙: 작은 "그렇다"가 다음 "그렇다"를 이끌어냄

**🎯 의료 마케팅 메시지 최종 체크리스트:**
□ 공포 대신 정보 격차를 활용했는가?
□ 집단 기준/사회적 맥락을 제시했는가?
□ 결과보다 불확실성 해소를 강조했는가?
□ 한계를 먼저 인정하여 신뢰를 구축했는가?
□ 환자와 가족 시선을 모두 고려했는가?
□ 긴급성 대신 장기적 가치를 제시했는가?
□ 작은 동의부터 시작하는 구조인가?

████████████████████████████████████████████████████████████████████████████████
[🔍 네이버 SEO 최적화 - 검색 노출 극대화]
████████████████████████████████████████████████████████████████████████████████

**29. 첫 문장(메타 설명) 최적화 - 검색 결과 미리보기 결정!**
- 네이버는 첫 160자를 검색 결과 설명으로 표시
- ✅ "코피가 자주 나고 멍이 잘 드시나요? 단순 피로가 아닌 혈액 건강 이상 신호일 수 있습니다. 확인이 필요한 증상들을 정리했습니다."
- ❌ "안녕하세요. 오늘은 혈액 건강에 대해 알아보겠습니다." (키워드 없음, 클릭 유도 약함)
- 📌 공식: [증상 키워드] + [의문/호기심 유발] + [글의 가치 제시]

**30. 제목 키워드 배치 - 앞쪽에 핵심 키워드!**
- 네이버 검색은 제목 앞부분 키워드에 가중치 부여
- ✅ "코피 멈추지 않을 때, 혈액 건강 체크 포인트"
- ❌ "건강 정보: 알아두면 좋은 코피 관련 상식"
- 📌 원칙: 핵심 키워드는 제목 앞 50% 내 배치

**31. 소제목(H2/H3) 키워드 최적화:**
- 각 섹션 제목에 검색 키워드 자연스럽게 포함
- ✅ "코피가 자주 나는 원인" / "멍이 쉽게 드는 이유" / "혈액검사 항목 안내"
- ❌ "1. 첫 번째 증상" / "2. 두 번째 포인트" (키워드 없음)
- 📌 소제목만 봐도 글 내용 파악 가능하게!

**32. 롱테일 키워드 활용 - 실제 검색어 패턴 반영:**
- 사용자가 실제로 검색하는 문장형 키워드 활용
- ✅ "코피 자주 나는 이유", "멍 잘 드는 원인", "혈액검사 언제 받아야"
- ✅ "~하면 ~인가요?", "~할 때 ~해야 하나요?" 패턴
- 📌 본문에 자연스럽게 녹여서 검색 매칭률 상승

**33. 이미지 ALT 텍스트 SEO:**
- 이미지 설명에 키워드 포함 필수
- ✅ "혈액검사 결과지를 확인하는 의사와 환자 상담 장면"
- ✅ "코피 지혈 방법을 설명하는 일러스트"
- ❌ "image1", "사진", "이미지" (SEO 효과 없음)
- 📌 이미지가 무엇인지 + 키워드 조합

**34. 내부 링크 구조 (연관 글 연결):**
- 같은 주제의 다른 글 자연스럽게 언급
- ✅ "혈액 건강에 대해 더 알고 싶으시다면, 관련 정보를 참고해 보실 수 있습니다"
- 📌 체류 시간 증가 → 네이버 알고리즘 긍정 평가

**35. FAQ 형식 활용 - 검색 의도 직접 매칭:**
- 자주 묻는 질문 형식으로 섹션 구성
- ✅ "Q. 코피가 자주 나면 병원에 가야 하나요?"
- ✅ "Q. 멍이 쉽게 드는 건 왜 그런가요?"
- 📌 네이버 '지식iN' 검색 패턴과 매칭 → 노출 확률 상승

**36. 글 길이 최적화:**
- 네이버 블로그 최적 길이: 1,500~3,000자 (공백 포함)
- 너무 짧으면 정보 부족으로 판단, 너무 길면 이탈률 증가
- 📌 핵심 정보 밀도 높게, 불필요한 서론 최소화

**🔍 네이버 SEO 최종 체크리스트:**
□ 첫 160자에 핵심 키워드와 글의 가치가 담겼는가?
□ 제목 앞부분에 검색 키워드가 배치되었는가?
□ 소제목(H2/H3)에 키워드가 포함되었는가?
□ 실제 검색 패턴(롱테일 키워드)을 활용했는가?
□ 이미지 ALT에 키워드가 포함되었는가?
□ FAQ 형식으로 검색 의도에 직접 답변했는가?
□ 글 길이가 1,500~3,000자 범위인가?

████████████████████████████████████████████████████████████████████████████████
[⏱️ 체류시간 극대화 전략 - VIEW 상위권의 핵심!]
████████████████████████████████████████████████████████████████████████████████

**🚨 핵심 원리: 네이버는 체류시간이 긴 글 = 좋은 글로 판단!**
- 체류시간 = 독자가 글에 머무는 시간
- 체류시간 ↑ → C-Rank/D.I.A 점수 ↑ → VIEW 상위노출

**37. 첫 3줄의 법칙 - 스크롤 유도의 핵심! (🚨가장 중요!):**
- 독자는 첫 3줄(약 100자) 안에 "이 글을 읽을지" 결정함
- ❌ "안녕하세요. 오늘은 ~에 대해 알아보겠습니다" → 이탈!
- ❌ "많은 분들이 ~에 대해 궁금해하십니다" → 지루함!
- ✅ 충격/공감/질문으로 시작:
  - "멍이 유난히 잘 드시나요? 혹시 '원래 그런 체질이야'라고 넘기셨나요?"
  - "코피가 15분이 지나도 멈추지 않았던 경험, 있으신가요?"
  - "피로가 며칠째 풀리지 않는다면, 단순 컨디션 난조가 아닐 수 있습니다"
- 📌 공식: [공감 질문] + [반전/의외성] + [읽어야 할 이유]

**38. 질문형 소제목으로 궁금증 연쇄 유발:**
- 소제목을 질문형으로 → 답을 찾기 위해 계속 스크롤
- ❌ "1. 원인" / "2. 증상" / "3. 치료" → 교과서식, 지루함
- ✅ 질문형 소제목:
  - "왜 나만 멍이 잘 드는 걸까?"
  - "이 증상, 병원에 가야 할까?"
  - "검사는 언제 받는 게 좋을까?"
  - "혈액검사에서 꼭 확인해야 할 항목은?"
- 📌 원칙: 소제목만 봐도 "답이 궁금해서" 스크롤하게 만들기

**39. 시각 요소로 스크롤 속도 조절:**
- 텍스트만 있으면 빠르게 스크롤 → 체류시간 ↓
- ✅ 체류시간 늘리는 시각 요소:
  - 📊 표(Table): 비교/정리 정보를 표로 제시
  - 📝 체크리스트: □ 형식으로 자가 점검 유도
  - 💬 인용문/강조박스: 핵심 문장을 시각적으로 분리
  - 🔢 번호 리스트: 순서가 있는 정보는 넘버링
  - 📸 이미지: 섹션마다 최소 1개 (상/중/하 배치)
- 📌 원칙: 3~4문단마다 시각 요소 1개 삽입

**40. "더 알아보기" 궁금증 유발 문장:**
- 섹션 끝에 다음 섹션 예고 → 스크롤 유도
- ✅ "그렇다면 이런 증상이 나타났을 때, 어떤 검사를 받아야 할까요?"
- ✅ "원인을 알았으니, 이제 확인 방법을 살펴보겠습니다"
- ✅ "아래에서 자가 체크리스트로 확인해보세요"
- 📌 원칙: 섹션 끝 = 다음 섹션의 예고편

**41. 글 중간에 "자가 체크리스트" 삽입:**
- 독자가 직접 체크하면서 시간 소비 → 체류시간 ↑
- ✅ 예시:
  "📋 혈액 건강 자가 체크리스트
   □ 멍이 쉽게 들고 잘 낫지 않는다
   □ 코피가 자주 나고 지혈이 오래 걸린다
   □ 특별한 이유 없이 피로감이 지속된다
   □ 잇몸에서 피가 자주 난다
   → 2개 이상 해당 시 혈액검사 고려"
- 📌 원칙: 체크리스트는 글 중간(50~70% 지점)에 배치

**42. 스크롤 유도 문장 패턴:**
- ✅ "아래에서 자세히 설명드릴게요"
- ✅ "구체적인 기준은 다음과 같습니다"
- ✅ "실제 사례를 보면 더 이해가 쉽습니다"
- ✅ "마지막에 정리해둔 체크리스트도 참고해 보세요"
- 📌 원칙: 독자에게 "계속 읽을 이유"를 계속 제공

**⏱️ 체류시간 체크리스트:**
□ 첫 3줄이 공감/질문/충격으로 시작하는가?
□ 소제목이 질문형으로 궁금증을 유발하는가?
□ 3~4문단마다 시각 요소(표/리스트/이미지)가 있는가?
□ 글 중간에 자가 체크리스트가 있는가?
□ 섹션 끝에 다음 내용 예고 문장이 있는가?
□ 전체 구조가 "계속 읽고 싶게" 설계되었는가?

████████████████████████████████████████████████████████████████████████████████
[🤖 AI 브리핑(AEO) 대응 전략 - 2025년 12월 네이버 대변화!]
████████████████████████████████████████████████████████████████████████████████

**🚨 배경: 2025년 12월, 네이버 검색에 AI 브리핑 본격 도입!**
- AI가 검색 결과를 요약해서 상단에 표시
- AI에게 "인용될 수 있는 글" = 노출 급상승
- 기존 SEO만으로는 부족! → AEO(AI Engine Optimization) 필수

**43. AI가 인용하는 "명확한 답변 문장" 필수 삽입:**
- AI는 질문에 대한 "명확한 답변 1~2문장"을 찾아서 인용
- ❌ 두루뭉술한 설명만 있는 글 → AI가 인용 불가
- ✅ 질문 바로 아래에 50~100자 핵심 답변 배치:
  - Q: "코피가 자주 나면 병원에 가야 하나요?"
  - A: "코피가 15분 이상 지혈되지 않거나, 한 달에 3회 이상 반복된다면 혈액검사를 고려해볼 수 있습니다."
- 📌 공식: [질문형 소제목] → [1~2문장 핵심 답변] → [상세 설명]

**44. AI가 신뢰하는 "출처 명시" 패턴:**
- AI는 출처가 있는 정보를 더 신뢰하고 인용함
- ✅ 출처 명시 패턴:
  - "대한혈액학회에 따르면, ~"
  - "질병관리청 자료를 보면, ~"
  - "최근 발표된 연구에서는 ~"
- ✅ 출처 + 수치 조합:
  - "건강보험심사평가원 통계에 따르면, 연간 약 OO만 명이 ~"
- 📌 원칙: 의학 정보에는 최소 2회 이상 공신력 있는 출처 인용

**45. FAQ 형식 = AI 브리핑 최적화의 핵심:**
- AI는 "Q&A 형식"을 가장 잘 인식하고 인용함
- ✅ FAQ 섹션 필수 포함:
  "❓ 자주 묻는 질문
   
   Q. 멍이 쉽게 드는 건 왜 그런가요?
   A. 혈소판 수치 저하, 혈액응고 기능 이상, 비타민 부족 등이 원인일 수 있습니다.
   
   Q. 혈액검사는 어디서 받나요?
   A. 가까운 내과나 건강검진센터에서 기본 혈액검사(CBC)를 받을 수 있습니다."
- 📌 원칙: 글 하단에 FAQ 2~4개 필수 배치

**46. AI가 좋아하는 "구조화된 정보":**
- AI는 구조화된 정보(리스트, 표, 단계별 설명)를 잘 인식
- ✅ 구조화 패턴:
  - "3가지 주요 원인: 1) ~, 2) ~, 3) ~"
  - "확인 방법 4단계: ① ~ ② ~ ③ ~ ④ ~"
  - 표(Table) 형식의 비교 정보
- ❌ 긴 문단으로만 된 설명 → AI가 핵심 추출 어려움
- 📌 원칙: 핵심 정보는 리스트/표/단계로 구조화

**47. "정의형 문장"으로 AI 인용 유도:**
- AI는 "~는 ~입니다" 형태의 정의 문장을 잘 인용함
- ✅ 정의형 문장 패턴:
  - "혈소판은 혈액 응고에 관여하는 혈액 세포입니다"
  - "CBC 검사는 적혈구, 백혈구, 혈소판 수치를 확인하는 기본 혈액검사입니다"
  - "빈혈은 혈액 내 적혈구 또는 헤모글로빈이 정상보다 낮은 상태를 말합니다"
- 📌 원칙: 주요 개념마다 1문장 정의 포함

**48. AI 브리핑 상단 노출을 위한 글 구조:**
- ✅ 권장 구조:
  1) 도입: 공감/질문으로 시작 (2~3줄)
  2) 핵심 답변: 글의 결론을 먼저 제시 (50~100자)
  3) 상세 설명: 원인/증상/확인방법 등 (본문)
  4) 구조화 정보: 리스트/표/체크리스트
  5) FAQ: 자주 묻는 질문 2~4개
  6) 마무리: 요약 + 완곡한 CTA
- 📌 핵심: "결론 먼저, 설명은 나중에" (역피라미드 구조)

**49. AI가 걸러내는 "저품질 신호" 피하기:**
- ❌ AI가 신뢰하지 않는 패턴:
  - 출처 없는 수치/통계
  - 과장된 표현 ("무조건", "반드시", "100%")
  - 광고성 문구 ("지금 바로", "최고의")
  - 중복/반복 키워드 남발
  - AI가 생성한 티가 나는 문체 (두루뭉술, 반복적)
- ✅ AI가 신뢰하는 패턴:
  - 공신력 있는 출처 인용
  - 구체적이고 명확한 정보
  - 전문적이면서 이해하기 쉬운 설명
  - 실제 경험/사례 기반 내용

**🤖 AI 브리핑(AEO) 체크리스트:**
□ 질문형 소제목 바로 아래 50~100자 핵심 답변이 있는가?
□ 공신력 있는 출처가 최소 2회 이상 인용되었는가?
□ FAQ 섹션(Q&A 2~4개)이 글 하단에 있는가?
□ 핵심 정보가 리스트/표/단계로 구조화되었는가?
□ 주요 개념에 정의형 문장(~는 ~입니다)이 포함되었는가?
□ 글 구조가 역피라미드(결론 먼저)로 되어 있는가?
□ AI 저품질 신호(출처 없는 수치, 과장 표현)가 없는가?

████████████████████████████████████████████████████████████████████████████████
[🎯 VIEW 상위권 최종 통합 체크리스트]
████████████████████████████████████████████████████████████████████████████████

**📊 C-Rank + D.I.A + 체류시간 + AEO 통합 점검:**

[기본 SEO - 7항목]
□ 첫 160자에 핵심 키워드 + 글의 가치
□ 제목 앞부분에 핵심 키워드 배치
□ 소제목(H2/H3)에 키워드 포함
□ 롱테일 키워드(검색 패턴) 활용
□ 이미지 ALT에 키워드 포함
□ FAQ 형식으로 검색 의도 매칭
□ 글 길이 1,500~3,000자

[체류시간 - 6항목]
□ 첫 3줄 공감/질문/충격 시작
□ 질문형 소제목
□ 3~4문단마다 시각 요소
□ 중간에 자가 체크리스트
□ 섹션 끝 다음 내용 예고
□ 계속 읽고 싶은 구조

[AI 브리핑(AEO) - 7항목]
□ 소제목 아래 50~100자 핵심 답변
□ 출처 2회 이상 인용
□ FAQ 2~4개
□ 리스트/표/단계 구조화
□ 정의형 문장 포함
□ 역피라미드 구조
□ 저품질 신호 없음

**🏆 VIEW 상위권 달성 기준:**
- 기본 SEO: 7개 중 6개 이상 ✅
- 체류시간: 6개 중 5개 이상 ✅
- AI 브리핑: 7개 중 5개 이상 ✅
→ 총 20개 중 16개 이상 충족 시 VIEW 상위권 가능성 높음!
`;
};

// 기존 호환성을 위한 상수 (실제 사용 시 getMedicalSafetyPrompt() 호출)
const MEDICAL_SAFETY_SYSTEM_PROMPT = getMedicalSafetyPrompt();

// =============================================
// 🎨 공통 이미지 프롬프트 상수 (중복 제거) - export 포함
// =============================================

// 카드뉴스 레이아웃 규칙 - 텍스트가 이미지 안에 포함된 완성형 카드!
// ⚠️ 중요: 이 프롬프트는 영어로 작성 - 한국어 지시문이 이미지에 렌더링되는 버그 방지!
export const CARD_LAYOUT_RULE = `[CARD IMAGE GENERATION RULE]
Render Korean text DIRECTLY into the image pixels.
Do NOT show these instructions in the image.
Only render the actual content text (subtitle, mainTitle, description).`;

// Hospital AI 고유 레이아웃 - 브라우저 창 프레임 스타일 (첫 생성 시 항상 적용)

// =============================================
// 🧩 프레임/스타일/텍스트 블록 분리 (중요)
// - FRAME: 레이아웃/프레임만. (스타일 단어 금지: photo/3D/illustration 등)
// - STYLE: 렌더링/질감/기법만. (프레임 단어 최소화)
// - TEXT: 카드에 들어갈 문구만
// =============================================

// 기본 프레임: 보라색 테두리 + 흰색 배경 (참고 이미지 사용)
// ⚠️ 영어로 작성 - 한국어 지시문이 이미지에 렌더링되는 버그 방지
const CARD_FRAME_RULE = `
[FRAME LAYOUT - FOLLOW REFERENCE IMAGE EXACTLY]
Copy the EXACT frame layout from the reference image:
- Border color: #787fff (lavender purple/violet) around the edges
- White content area inside the border
- Rounded corners
- Clean minimal design
Keep the same frame thickness, padding, and proportions as reference.
`;

// 참고 프레임 이미지가 있을 때: 프레임/레이아웃만 복제
// ⚠️ 영어로 작성 - 한국어 지시문이 이미지에 렌더링되는 버그 방지
const FRAME_FROM_REFERENCE_COPY = `
[FRAME LAYOUT]
Copy EXACTLY the frame/layout/text placement from the reference image.
IGNORE the illustration/subject/content inside the reference - replace with new topic.
`;

// 참고 프레임 이미지 + 색상 변경 모드(레이아웃 유지)
// ⚠️ 영어로 작성 - 한국어 지시문이 이미지에 렌더링되는 버그 방지
const FRAME_FROM_REFERENCE_RECOLOR = `
[FRAME LAYOUT]
Keep the frame/layout/text placement from reference image as much as possible.
Adjust overall color tone to match the requested background color.
IGNORE the illustration/subject/content inside the reference - replace with new topic.
`;

// 스타일 블록: 버튼별로 단 하나만 선택
const PHOTO_STYLE_RULE = `
[STYLE - 실사 촬영 (PHOTOREALISTIC PHOTOGRAPHY)]
🚨🚨🚨 최우선 규칙: 반드시 실제 사진처럼 보여야 합니다! 🚨🚨🚨

✅ 필수 스타일 키워드 (모두 적용!):
- photorealistic, real photograph, DSLR camera shot, 35mm lens
- natural lighting, soft studio lighting, professional photography
- shallow depth of field, bokeh background, lens blur
- realistic skin texture, real fabric texture, authentic materials
- high resolution, 8K quality, professional stock photo style

✅ 피사체 표현:
- 실제 한국인 인물 (의료진, 환자 등)
- 실제 병원/의료 환경
- 실제 의료 장비, 진료 도구
- 자연스러운 표정과 포즈

✅ 분위기:
- professional, trustworthy, clean, modern
- 밝고 깨끗한 병원 느낌
- 신뢰감 있는 의료 환경

⛔⛔⛔ 절대 금지 (이것들은 사용하지 마세요!):
- 3D render, 3D illustration, Blender, Cinema4D
- cartoon, anime, vector art, flat illustration
- clay render, isometric, infographic style
- digital art, painting, watercolor, sketch
- 파스텔톤 일러스트, 귀여운 캐릭터

※ 프레임(브라우저 창 상단바/버튼)만 그래픽 요소로 유지, 나머지는 모두 실사!
`;

const ILLUSTRATION_3D_STYLE_RULE = `
[STYLE - 3D 일러스트 (3D ILLUSTRATION)]
⚠️ 필수: 친근하고 부드러운 3D 일러스트 스타일!
- 렌더링: 3D rendered illustration, Blender/Cinema4D style, soft 3D render
- 조명: soft studio lighting, ambient occlusion, gentle shadows
- 질감: smooth plastic-like surfaces, matte finish, rounded edges
- 색상: 밝은 파스텔 톤, 파란색/흰색/연한 색상 팔레트
- 캐릭터: cute stylized characters, friendly expressions, simple features
- 배경: clean gradient background, soft color transitions
- 분위기: friendly, approachable, modern, educational
⛔ 절대 금지: photorealistic, real photo, DSLR, realistic texture, photograph
`;

const MEDICAL_3D_STYLE_RULE = `
[STYLE - 의학 3D (MEDICAL 3D RENDER)]
⚠️ 필수: 전문적인 의학/해부학 3D 일러스트 스타일!
- 렌더링: medical 3D illustration, anatomical render, scientific visualization
- 조명: clinical lighting, x-ray style glow, translucent organs
- 피사체: 인체 해부학, 장기 단면도, 뼈/근육/혈관 구조, 의료 도구
- 질감: semi-transparent organs, detailed anatomical structures
- 색상: 의료용 색상 팔레트 (파란색, 흰색, 빨간색 혈관/동맥)
- 레이블: anatomical labels, educational diagram style
- 분위기: clinical, professional, educational, trustworthy
⛔ 절대 금지: cute cartoon, photorealistic photo, realistic human face
`;

const CUSTOM_STYLE_RULE = (prompt: string) => `
[STYLE]
${prompt}
`;

// promptText에서 서로 충돌하는 키워드/섹션을 제거(특히 photo에서 [일러스트] 같은 것)
const normalizePromptTextForImage = (raw: string): string => {
  if (!raw) return '';
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);

  // 🔧 중복 제거: CARD_LAYOUT_RULE 전체 블록 및 관련 지시문 제거
  const dropPatterns: RegExp[] = [
    /브라우저\s*창\s*프레임\s*스타일\s*카드뉴스/i,
    /^\[일러스트\]/i,
    /^\[스타일\]/i,
    /^\s*CARD_LAYOUT_RULE\s*:/i,
    // CARD_LAYOUT_RULE 내용 제거 (generateSingleImage에서 다시 추가됨)
    /^\[CARD IMAGE GENERATION RULE\]/i,
    /^Render Korean text DIRECTLY into the image/i,
    /^Do NOT show these instructions in the image/i,
    /^Only render the actual content text/i,
  ];

  const cleaned = lines
    .filter(l => !dropPatterns.some(rx => rx.test(l)))
    .join('\n')
    .trim();

  return cleaned;
};

const buildStyleBlock = (style: ImageStyle, customStylePrompt?: string): string => {
  // 🎨 커스텀 프롬프트가 있으면 최우선 적용! (재생성 시에도 유지)
  if (customStylePrompt && customStylePrompt.trim()) {
    console.log('✏️ 커스텀 스타일 적용:', customStylePrompt.substring(0, 50));
    return CUSTOM_STYLE_RULE(customStylePrompt.trim());
  }
  
  // 🚨 photo/medical 스타일 선택 시 고정 스타일 적용
  if (style === 'photo') {
    console.log('📸 실사 사진 스타일 적용');
    return PHOTO_STYLE_RULE;
  }
  if (style === 'medical') {
    console.log('🫀 의학 3D 스타일 적용');
    return MEDICAL_3D_STYLE_RULE;
  }
  
  // 기본: 3D 일러스트
  return ILLUSTRATION_3D_STYLE_RULE;
};

const buildFrameBlock = (referenceImage?: string, copyMode?: boolean): string => {
  if (!referenceImage) return CARD_FRAME_RULE;
  return copyMode ? FRAME_FROM_REFERENCE_COPY : FRAME_FROM_REFERENCE_RECOLOR;
};

// 공통 규칙 (간결화)
const IMAGE_TEXT_RULES = `[규칙] 한국어만, 광고/로고/해시태그 금지`;

// 기본 스타일 프롬프트 - 한국어로 통일!
export const DEFAULT_STYLE_PROMPTS: Record<string, string> = {
  illustration: '3D 렌더 일러스트, Blender 스타일, 부드러운 스튜디오 조명, 파스텔 색상, 둥근 형태, 친근한 캐릭터 디자인, 깔끔한 그라데이션 배경',
  medical: '의학 3D 일러스트, 해부학적 렌더링, 과학적 시각화, 임상 조명, 상세한 장기 구조, 교육용 다이어그램, 전문 의료 스타일',
  photo: '실사 DSLR 사진, 자연스러운 부드러운 조명, 얕은 피사계심도, 사실적인 질감, 전문 병원 환경, 신뢰감 있는 분위기',
  custom: '사용자 지정 스타일'
};

// 스타일 이름 (UI 표시용)
export const STYLE_NAMES = {
  illustration: '3D 일러스트',
  medical: '의학 3D',
  photo: '실사 사진'
};

// 짧은 스타일 키워드 (프롬프트용) - 구체적으로 개선!
export const STYLE_KEYWORDS = {
  illustration: '3D 렌더 일러스트, Blender 스타일, 부드러운 조명, 파스텔 색상, 친근한 캐릭터, 깔끔한 배경',
  medical: '의학 3D 일러스트, 해부학적 구조, 장기 단면도, 임상 조명, 교육용 다이어그램, 전문적 분위기',
  photo: '실사 사진, DSLR 촬영, 자연스러운 조명, 얕은 피사계심도, 전문 병원 환경, 사실적 질감'
};

// =============================================
// 📝 공통 텍스트 상수 (중복 제거)
// =============================================

// 콘텐츠 설명 (카드뉴스/블로그 공통)
const CONTENT_DESCRIPTION = `이 콘텐츠는 의료정보 안내용 카드뉴스이며,
네이버 병원 블로그 및 SNS에 사용됩니다.
의료광고법을 준수하며, 직접적인 방문·예약 유도는 금지합니다.`;

// 의료 면책 조항 (HTML)
const MEDICAL_DISCLAIMER = `본 콘텐츠는 의료 정보 제공 및 병원 광고를 목적으로 합니다.<br/>개인의 체질과 건강 상태에 따라 치료 결과는 차이가 있을 수 있으며, 부작용이 발생할 수 있습니다.`;

// 글 스타일별 프롬프트 (의료법 100% 준수) - 함수로 변경하여 현재 연도 동적 반영
const getWritingStylePrompts = (): Record<WritingStyle, string> => {
  const year = new Date().getFullYear();
  return {
  // 📚 전문가형: 의학 지식 깊이 강조하되 권위적이지 않은 전문성
  expert: `
[🚨 스타일 선택 규칙]
'전문가형' 스타일을 적용합니다. 전문성은 유지하되 권위적이거나 강요하는 톤은 피합니다.

[글쓰기 스타일: 전문가형 📚]
- 목표: "신뢰할 수 있는 정보를 알기 쉽게 전달"
- 톤: 전문적이면서도 친근한 설명, 강요 없는 제안

[🎯 핵심 테크닉]

1. **도입부: 관찰에서 시작하는 인사이트**
   ❌ "오늘은 당뇨에 대해 알아보겠습니다."
   ❌ "대한당뇨병학회에서 발표한 자료를 보면..." (첫 문장부터 인용 X)
   ✅ "공복혈당은 정상인데 식후에 유독 피곤함을 느끼는 분들이 있어요. 의외로 이런 경우가 많더라고요."
   ✅ "검사 결과지를 받아들고 '이게 무슨 뜻이지?' 싶었던 적 있으시죠?"

2. **근거 인용 - 자연스럽게 녹이기** (2회 이내, 강조 X)
   ❌ "대한OO학회 가이드라인에 따르면..." (딱딱한 인용)
   ✅ "최근 가이드라인에서 눈에 띄는 변화가 있었어요. 식후 혈당 관리를 더 강조하기 시작한 거죠."
   ✅ "연구 결과들을 보면 이런 경향이 나타나는데요..."
   ✅ "실제로 이런 케이스가 생각보다 흔해요."
   ⚠️ 인용은 정보의 신뢰도를 높이는 도구일 뿐, 권위를 내세우는 수단이 아님

3. **의학 용어 - 설명이 아닌 대화로**
   ❌ "인슐린 저항성이란 인슐린이 제대로 작동하지 않는 상태를 말합니다."
   ✅ "인슐린 저항성, 이 단어 들어보셨을 거예요. 쉽게 말해서 인슐린이 있어도 잘 안 듣는 상태예요."
   ✅ "당화혈색소라고 하면 어렵게 느껴지는데, 3개월 평균 혈당이라고 생각하시면 돼요."

4. **정보 전달 관점 - 권위 없이 신뢰감 있게** (⚠️ 6-2, 6-3 규칙 필수 적용!)
   ✅ "이 부분에서 오해하시는 분들이 많더라고요."
   ✅ "솔직히 처음엔 헷갈리기 쉬운 개념이에요."
   ✅ "조금만 일찍 알았으면... 하고 아쉬워하시는 분들이 계세요."

5. **정보 전달 - 나열보다 흐름**
   ❌ 번호 매긴 체크리스트 나열
   ✅ 하나의 이야기처럼 정보를 연결
   ✅ "여기서 한 가지 더 알아두면 좋은 게 있어요."
   ✅ "그런데 이게 전부가 아니에요. 사실 더 중요한 건..."
`,

  // 💗 공감형: 독자 경험 중심, "이거 내 얘기네!" 반응 유도
  empathy: `
[🚨 스타일 선택 규칙 - 최우선 적용]
아래 '공감형' 스타일만 선택해 적용하며, 다른 스타일(전문가형/전환형)의 문체·표현은 사용하지 마세요.

[글쓰기 스타일: 공감형 💗]
- 목표: 독자가 "이거 내 얘기네!"라고 느끼게 만들기
- 톤: 따뜻하고 이해심 있는 친구 같은 톤

[🎯 핵심 테크닉 - 반드시 적용]

1. **도입부: 구체적 상황 묘사로 시작** (필수!)
   ❌ "오늘은 겨울철 피부 건조에 대해 알아보겠습니다."
   ✅ "히터 켜고 자고 일어나면 얼굴이 땅기는 느낌, 한 번쯤 겪어보셨을 거예요."
   ✅ "샤워하고 나와서 5분만 지나도 온몸이 가려워지는 경험, 있으시죠?"
   ✅ "아침에 거울 보다가 '어? 내 피부가 왜 이래?' 싶었던 적 있으시죠?"

2. **구체적 상황/행동 예시 삽입** (최소 3개 이상)
   - 시간대: "아침 세안 후", "퇴근 후", "샤워 직후", "잠들기 전"
   - 장소: "히터 앞에서", "사무실 에어컨 아래서", "지하철 안에서"
   - 행동: "무의식적으로 긁다가", "보습제 바르는데 따가워서", "화장이 들뜨길래"
   
3. **실패/예외 사례 포함** (AI 냄새 제거)
   ✅ "모든 보습제가 다 맞는 건 아니에요. 세라마이드 제품 발랐다가 오히려 따가웠던 분들도 계세요."
   ✅ "근데 솔직히, 이거 알면서도 잘 안 되는 게 현실이잖아요."
   ✅ "병원에서 권하는 대로 했는데 별로 효과를 못 느끼는 분들도 계세요. 개인차가 있으니까요."

4. **강약 조절 - 모든 문장이 같은 톤 금지**
   - 강조: "이건 진짜 중요해요", "꼭 기억해 두세요"
   - 약화: "근데 사실...", "솔직히 말하면...", "물론 개인차는 있지만"
   - 공감: "맞아요, 귀찮죠", "알아요, 쉽지 않죠"

5. **반복 표현 금지 - 다양한 표현 사용**
   ❌ "~에 도움이 될 수 있습니다" 반복 금지
   ✅ 대체 표현: "효과를 보시는 분들이 많아요", "해볼 만한 가치가 있어요", "의외로 괜찮더라고요"
`,

  // 🎯 전환형: 자연스러운 인식 변화 유도 (의료법 준수)
  conversion: `
[🚨 스타일 선택 규칙]
'전환형' 스타일을 적용합니다. 행동 강요가 아닌 자연스러운 인식 변화를 유도합니다.

[글쓰기 스타일: 전환형 🎯]
- 목표: "아, 나도 한번 확인해볼까?" 라는 생각이 자연스럽게 들게 하기
- 톤: 정보 제공 + 시점 제시 (강요 없이)

[🎯 핵심 테크닉]

1. **도입부: 관찰로 시작, 질문으로 연결**
   ❌ "당뇨 전 단계인데 모르고 지나치는 사람이 절반이 넘습니다." (공포 조장)
   ✅ "물을 많이 마셔서 화장실을 자주 간다고 생각했는데, 돌이켜보니 그게 아니었다는 분들이 있어요."
   ✅ "피곤해서 그렇겠지, 하고 넘기다가 우연히 발견되는 경우가 생각보다 많더라고요."
   
2. **정보 격차 활용** (공포 대신 궁금증)
   ❌ "지금 안 하면 후회합니다" / "놓치면 큰일납니다"
   ✅ "이 부분을 모르시는 분들이 의외로 많아요."
   ✅ "알고 있으면 다르게 대처할 수 있는 정보가 있어요."
   ✅ "같은 증상이어도 원인에 따라 관리법이 달라지거든요."

3. **시점 제시 - 판단은 독자에게**
   ❌ "검사를 받으세요" / "확인하세요" (명령형)
   ✅ "이런 신호가 겹치기 시작하면 확인해볼 타이밍일 수 있어요."
   ✅ "증상이 사라졌다가 다시 나타난다면, 그때가 확인 시점에 가깝습니다."
   ✅ "자가 판단으로 넘기기 애매해지는 순간이 있어요."

4. **마무리: 열린 결론**
   ❌ "꼭 기억하세요" / "반드시 확인하세요"
   ✅ "적어도 '왜 이런지 모르겠다'는 답답함은 줄일 수 있어요."
   ✅ "확인해두면 다음에 비슷한 증상이 왔을 때 비교 기준이 생기거든요."
   ✅ "물론 아무것도 아닐 수도 있어요. 그래도 한 번쯤 확인해보는 게 마음이 편하죠."

5. **전환 유도 - 부드럽게**
   ❌ "많은 분들이 검진을 받습니다" (압박)
   ✅ "비슷한 고민을 가진 분들이 궁금해하시는 부분이에요."
   ✅ "이런 경우에 어떻게 하면 좋을지 한 번 정리해봤어요."
`
  };
};

// =============================================
// 📝 글쓰기 스타일 공통 규칙 (중복 제거 + AI 냄새 최소화)
// =============================================

// 글 스타일별 금지 표현 체크 (공통) - 함수로 변경하여 현재 연도 동적 반영
const getWritingStyleCommonRules = (): string => {
  const year = new Date().getFullYear();
  return `
████████████████████████████████████████████████████████████████████████████████
[📖 글 유형별 스타일 구분 - 핵심 원칙]
████████████████████████████████████████████████████████████████████████████████

**🔵 TYPE A: 에세이형 (관찰→해석→정리)**
- 시선 방향: 내면/경험 쪽을 향함
- 구조: 관찰 → 해석 → 정리 (자연스러운 흐름)
- 톤: 단정 안 함, 가능성 열어둠, 여백 있음
- 핵심 태도: "같이 생각해보자"
- 마무리: 약간 덜 멋있음, 독자가 끼워 넣을 공간 남김
- 적합: 일반 건강 정보, 생활 습관, 계절 건강 팁

**🟠 TYPE B: 정보 전달형 (전문 칼럼)**
- 시선 방향: 정보 전달 목적 명확
- 구조: 핵심 정보 → 근거 → 적용 포인트 (간결하게)
- 톤: 신뢰감 있되 강요 없음, 권위적이지 않은 전문성
- 핵심 태도: "알아두면 좋을 정보"
- 마무리: 행동보다 인식 변화 유도
- 적합: 질환 정보, 검사 안내, 의학 지식

**[📌 두 스타일의 핵심 차이]**
| 구분 | TYPE A (에세이형) | TYPE B (정보 전달형) |
|------|------------------|--------------------|
| 첫 문장 | 상황 묘사/질문 | 핵심 정보/인사이트 |
| 감정 표현 | 자연스러운 공감 | 정보 전달의 도구로만 |
| 독자 관계 | 함께 생각하는 동료 | 신뢰할 수 있는 안내자 |
| 결론 | 열린 마무리 | 명확한 요점 정리 |

████████████████████████████████████████████████████████████████████████████████
[🚫 AI 냄새 제거 - 절대 피해야 할 패턴]
████████████████████████████████████████████████████████████████████████████████

**❌ 이런 문장은 즉시 삭제하거나 변경:**
- "~가 핵심입니다" / "핵심은 ~입니다"
- "~를 기억하세요" / "꼭 기억해 주세요"
- "중요한 것은 ~입니다"
- "결론적으로" / "정리하자면" / "요약하면"
- 매 문단 끝에 요약 문장
- 번호 매긴 체크리스트 남발 (1. 2. 3. 4. 5...)
- "오늘은 ~에 대해 알아보겠습니다"
- "~해 보시는 건 어떨까요?"

**❌ 구조적으로 AI스러운 패턴:**
- 문단마다 기능이 너무 명확 (도입-정의-비교-경고-정리)
- 모든 가능성을 빠짐없이 나열
- 감정이 항상 정보 전달 장치로만 사용됨
- 독자에게 "지금 판단해야 한다"는 메시지 반복

**✅ 사람다운 글의 특징 (이렇게 쓰세요!):**
- 관찰 → 해석 → 정리로 자연스럽게 흐름
- "같이 생각해보자"는 태도
- 문장이 숨을 쉬고, 여백이 있음
- 결론을 서둘러 주지 않음
- 독자가 자기 경험을 끼워 넣을 공간이 있음

[🎣 후킹 심리학 기법 - 도입부 적용]

1. **호기심 갭** - 알고 싶게 만들기
   ✅ "대부분 모르고 있는 사실인데요..."
   ✅ "왜 아무도 이 얘기 안 할까요?"

2. **질문형 오프닝** - 독자를 대화에 끌어들이기
   ✅ "혹시 이런 경험 있으세요?"
   ✅ "이거... 저만 그런 거 아니죠?"

3. **반전/의외성** - 기존 상식 뒤집기
   ✅ "사실 이건 완전히 반대예요"
   ✅ "그동안 잘못 알고 계셨을 수도 있어요"

[📌 본문 전체 심리학 기법 - 계속 적용]

1. **사회적 증거** - 중간중간 삽입
   ✅ "요즘 이런 분들이 정말 많더라고요"
   ✅ "실제로 많은 분들이 공감하시는 부분인데요"

2. **손실 회피** - 적절히 활용
   ✅ "미루다 보면 놓치기 쉬운 타이밍이 있어요"
   ✅ "나중에 '그때 할걸' 하시는 분들 꽤 계시거든요"

3. **권위 활용** - 신뢰감 구축
   ✅ "전문의들이 공통적으로 강조하는 부분이에요"
   ✅ "최근 연구에서도 확인된 내용인데요"

4. **일관성 원리** - 작은 행동 유도
   ✅ "오늘 딱 하나만 해보세요"
   ✅ "1분이면 확인할 수 있어요"

[🔍 SEO 최적화 필수 - 네이버 상위 노출용]

**★★★ SEO 핵심 규칙 ★★★**

1. **제목(H3) SEO 최적화**
   - 핵심 키워드를 제목 앞부분에 배치
   - 검색 의도에 맞는 질문형/해결형 제목
   ✅ "겨울철 피부건조 원인과 해결법"
   ✅ "당뇨 초기증상 5가지 체크리스트"
   ❌ "피부에 대해 알아봅시다"

2. **키워드 자연스럽게 반복**
   - 핵심 키워드 본문에 5-8회 자연스럽게 포함
   - 동의어/유사어 함께 사용 (LSI 키워드)
   ✅ "피부건조" + "건조한 피부" + "피부 수분" + "보습"
   ✅ "당뇨" + "혈당" + "당뇨병" + "혈당관리"

3. **소제목(H3) 구조화**
   - 검색 키워드 포함한 소제목 3-5개
   - "원인", "증상", "치료법", "예방법" 등 검색 의도 반영
   
4. **첫 문단에 핵심 키워드**
   - 첫 100자 안에 메인 키워드 필수 포함
   - 검색 결과 미리보기에 노출되는 부분

5. **리스트/넘버링 활용**
   - "3가지 방법", "5가지 증상" 등 숫자 활용
   - <ul><li> 태그로 구조화 (스니펫 노출 유리)

6. **해시태그 SEO**
   - 검색량 높은 키워드 우선 배치
   - 롱테일 키워드 포함
   ✅ #피부건조 #겨울철피부관리 #피부보습 #건조한피부 #피부건강

████████████████████████████████████████████████████████████████████████████████
[🚀 2025-2026 네이버 SEO 핵심 실전 가이드 - 상위노출 결정 요소!]
████████████████████████████████████████████████████████████████████████████████

**🔴🔴🔴 가장 중요한 SEO 3대 요소 🔴🔴🔴**

**[1] 🎯 키워드 밀도 & 배치 전략 (SEO 점수 40% 결정!)**

📌 **키워드 밀도 황금 공식:**
- 메인 키워드: 본문에서 1.5~2.5% 밀도 (1000자당 15~25회 언급)
- 서브 키워드: 본문에서 0.5~1% 밀도
- ⚠️ 3% 이상 = 키워드 스터핑으로 판정 → 노출 불이익!

📌 **키워드 배치 위치별 가중치:**
1. 제목 첫 10자 → 가중치 ×5
2. 첫 문단 (도입부 150자) → 가중치 ×3
3. 소제목 (H2/H3) → 가중치 ×2
4. 마지막 문단 → 가중치 ×1.5
5. 이미지 alt 텍스트 → 가중치 ×1.2

📌 **필수 적용 규칙:**
- ✅ 제목 앞 50%에 메인 키워드 필수!
- ✅ 첫 문장에 메인 키워드 자연스럽게 포함!
- ✅ 각 소제목(H3)에 관련 키워드 1개 이상!
- ✅ 마지막 문단에서 메인 키워드로 마무리!
- ❌ 같은 키워드 2문장 연속 사용 금지 (스터핑 판정!)

📌 **LSI 키워드 (동시 출현 단어) 활용:**
- 피부건조 → 보습, 수분, 건조함, 각질, 촉촉함, 수분크림
- 당뇨 → 혈당, 인슐린, 당화혈색소, 혈당조절, 공복혈당
- 고혈압 → 혈압, 수축기, 이완기, 혈압관리, 저염식
- 📌 메인 키워드당 LSI 키워드 3~5개 함께 사용!

**[2] 🏗️ 글 구조 최적화 (SEO 점수 30% 결정!)**

📌 **네이버 선호 글 구조 템플릿:**
\`\`\`
[도입부 - 150자 이내]
- 공감 질문 + 메인 키워드 포함
- "~하신 적 있으신가요?" 패턴

[소제목1] OOO의 원인 / OOO가 생기는 이유
- 본문 300~500자
- 서브 키워드 2~3회 포함

[소제목2] OOO의 증상 / 이런 증상이 나타난다면
- 본문 300~500자
- 리스트 형식 (<ul><li>) 활용

[소제목3] OOO 확인 방법 / 언제 확인이 필요할까
- 본문 300~500자
- FAQ 형식 활용

[마무리 - 100자 이내]
- 핵심 정리 + 메인 키워드로 마무리
\`\`\`

📌 **소제목 SEO 최적화 공식:**
- ✅ "[키워드] + 원인/증상/방법" 형태
- ✅ "~하는 이유", "~할 때 확인할 것" 검색 패턴 반영
- ❌ "1. 첫 번째", "2. 두 번째" (키워드 없음)
- ❌ "중요한 것", "알아야 할 점" (검색 의도 불일치)

📌 **문단 구조 최적화:**
- 한 문단 = 3~5문장 (너무 길면 이탈률 증가)
- 문단 사이 충분한 여백 (가독성)
- 핵심 문장은 **굵게** 강조

**[3] 📊 검색 의도 일치 (SEO 점수 30% 결정!)**

📌 **검색 의도 4가지 유형:**
1. **정보형**: "~이란?", "~원인", "~증상" → 정의/설명 중심
2. **해결형**: "~방법", "~해결", "~치료" → 솔루션 중심
3. **비교형**: "~vs~", "~차이", "~구분" → 비교 분석 중심
4. **확인형**: "~일까?", "~해야 하나요?" → Q&A 형식 중심

📌 **검색 의도별 글 구조:**
- 정보형 → 정의 → 원인 → 증상 → 마무리
- 해결형 → 문제 제기 → 해결책 나열 → 적용 방법
- 비교형 → A설명 → B설명 → 차이점 정리 → 선택 기준
- 확인형 → 질문 제기 → 답변 → 추가 FAQ

📌 **실제 검색어 패턴 반영 (롱테일 키워드):**
- ✅ "코피 자주 나는 이유"
- ✅ "멍 잘 드는 원인"
- ✅ "피부건조 심할때 어떻게"
- ✅ "당뇨 초기증상 뭐가 있나요"
- 📌 본문에 이런 질문형 문장을 자연스럽게 포함!

████████████████████████████████████████████████████████████████████████████████
[📈 네이버 스니펫 노출 최적화 - 클릭률 2배 상승 전략!]
████████████████████████████████████████████████████████████████████████████████

📌 **스니펫 노출 조건:**
1. 명확한 질문에 대한 명확한 답변 구조
2. 50~160자 이내의 핵심 요약
3. 리스트/번호 형식 사용

📌 **스니펫 최적화 예시:**
✅ 검색어: "당뇨 초기증상"
→ 글 내용: "당뇨 초기증상으로는 다음 5가지가 대표적입니다. 첫째, 갈증과 잦은 소변. 둘째, 원인 모를 체중 감소. 셋째, 쉽게 느끼는 피로감..."

📌 **FAQ 스니펫 최적화:**
\`\`\`
Q. 피부건조가 심할 때 어떻게 해야 하나요?
A. 피부건조가 심할 때는 먼저 보습제 사용 빈도를 높이는 것이 좋습니다. 
   세안 후 3분 이내에 보습제를 바르면 수분 증발을 막을 수 있습니다.
\`\`\`

████████████████████████████████████████████████████████████████████████████████
[🔥 SEO 최종 체크리스트 - 작성 완료 후 필수 확인!]
████████████████████████████████████████████████████████████████████████████████

**[A] 키워드 체크:**
□ 제목 앞 50%에 메인 키워드가 있는가?
□ 첫 문장(150자 이내)에 메인 키워드가 있는가?
□ 키워드 밀도가 1.5~2.5% 범위인가? (1000자당 15~25회)
□ LSI 키워드(동의어)를 3개 이상 사용했는가?
□ 같은 키워드가 2문장 연속 나오지 않는가?

**[B] 구조 체크:**
□ 소제목(H3)이 3개 이상 있는가?
□ 각 소제목에 키워드가 포함되어 있는가?
□ 글 길이가 1,500~3,000자 범위인가?
□ 리스트/번호 형식을 1회 이상 사용했는가?
□ 마지막 문단에서 키워드로 마무리했는가?

**[C] 검색 의도 체크:**
□ 검색 의도(정보/해결/비교/확인)에 맞는 구조인가?
□ 롱테일 키워드(질문형)가 자연스럽게 포함되었는가?
□ FAQ 형식이 1회 이상 포함되었는가?

**[D] 스니펫 최적화 체크:**
□ 핵심 답변이 50~160자로 요약되어 있는가?
□ 리스트 형식이 명확하게 구조화되어 있는가?

**→ 15개 중 12개 이상 OK면 = SEO 최적화 완료!**

████████████████████████████████████████████████████████████████████████████████
[🎯 E-E-A-T SEO 가이드 - 2025 구글/네이버 핵심 알고리즘]
████████████████████████████████████████████████████████████████████████████████

**E-E-A-T = Experience(경험) + Expertise(전문성) + Authoritativeness(권위) + Trustworthiness(신뢰)**

**1. 🧑‍⚕️ Experience (경험) - 실제 경험 강조**
   - 신뢰할 수 있는 정보 기반 경험 강조
   ✅ "많은 분들이 이런 질문을 하십니다"
   ✅ "자주 접하는 사례인데요"
   ✅ "비슷한 고민을 하시는 분들이 많습니다"
   ❌ "인터넷에서 찾아보니" (경험 없음)
   
**2. 📚 Expertise (전문성) - 전문 지식 입증**
   - 의학적 근거와 전문 용어 적절히 활용
   ✅ "의학적으로 이 상태를 'OOO'라고 부르는데요"
   ✅ "기전을 간단히 설명드리면..."
   ✅ "해부학적으로 보면..."
   - 전문의/학회 관점 언급
   ✅ "대한OO학회 가이드라인에 따르면..."
   ✅ "전문의들이 공통적으로 권장하는 방법은..."

**3. 🏛️ Authoritativeness (권위) - 신뢰할 수 있는 출처**
   - 공신력 있는 기관/학회 인용 필수
   ✅ "질병관리청 자료에 따르면..."
   ✅ "대한의학회에서 발표한 연구 결과..."
   ✅ "보건복지부 권고 기준으로..."
   - 통계 사용 시 출처+연도 필수 (현재 연도 기준 최신 자료!)
   ✅ "${year}년 또는 ${year-1}년 국민건강영양조사에 따르면..." (최신 자료 우선)
   ✅ "${year}년 대한OO학회 최신 가이드라인..."
   ❌ "통계에 따르면 70%가..." (출처/연도 없음)
   ⚠️ 통계/자료는 반드시 현재(${year}년) 기준 최신 것만 인용! 2년 이상 된 자료는 "~년 기준" 명시 필수

**4. 🔒 Trustworthiness (신뢰) - 정직하고 투명한 정보**
   - 한계점과 불확실성 솔직히 언급
   ✅ "아직 의학적으로 명확히 밝혀지지 않은 부분도 있습니다"
   ✅ "연구마다 결과가 다소 다르게 나타나기도 합니다"
   - 개인차 인정
   ✅ "모든 분께 동일하게 적용되지는 않습니다"
   - 상업적 의도 최소화
   ✅ 정보 제공 목적 강조, 판매/유도 최소화

**📌 E-E-A-T 체크리스트 (작성 완료 후 확인):**
□ 진료/임상 경험이 자연스럽게 녹아있는가?
□ 전문 용어와 의학적 설명이 포함되어 있는가?
□ 공신력 있는 출처(학회/정부)가 2회 이상 인용되었는가?
□ 통계 사용 시 출처와 연도가 명시되어 있는가?
□ 불확실성과 개인차를 솔직히 언급했는가?

[🎯 마케팅 글 핵심 - 예약 전환율 높이기 (의료법 100% 준수 + 보수적 해석 원칙)]

**★★★ 최우선: 불확실한 의학 정보는 보수적으로 해석 ★★★**
- 골든타임, 비가역성, 예후 등 의학적 표현 → 출처 확인 가능한 경우에만 사용
- 출처 활용 시: 보건복지부, 질병관리청, 대한OO학회, 국민건강보험공단
- **출처 불명확 시: 일반적인 배제형 CTA만 사용 (구체적 수치/시간 금지)**

**★★★ CTA 핵심 공식: "오세요"가 아니라 "다른 선택지는 아니다 + 지금이다" ★★★**

**[CTA 3대 핵심 장치 - 출처 확인 후 사용]**

1. **⏰ 시간 조건** - '나중'이라는 선택지 제거
   ⚠️ 구체적 시간(48시간, 24시간 등)은 출처 확인 가능한 경우에만 사용
   ⚠️ 출처 불명확 시: 구체적 시간 대신 일반화 표현 사용
   
   ✅ 출처 없어도 안전한 표현 (기본값으로 사용):
   - "이런 증상이 **갑자기** 나타났다면"
   - "**이 시점부터는** 지켜보기보다 확인이 필요합니다"
   - "증상이 시작된 **시점에서** 확인하느냐, 미루느냐"
   
   ✅ 출처 확인 가능한 경우에만:
   - "**골든타임 OO시간** 이내에" (학회/공식 가이드라인 명시)
   
   ❌ 금지: 출처 없이 구체적 시간 임의 작성

2. **🔒 비가역성** - 보수적 해석 원칙 적용
   ⚠️ "회복 어려움", "되돌릴 수 없음" 등은 출처 확인 가능한 경우에만 사용
   ⚠️ 불확실하면 일반화 표현으로 대체
   
   ✅ 출처 확인 가능한 경우에만:
   - "대한OO학회에 따르면, 초기 치료가 예후에 중요한 영향을 미칩니다"
   - "OO은 회복이 어려운 경우가 많은 것으로 알려져 있습니다" (출처 명시)
   
   ✅ 출처 불명확 시 안전한 표현 (기본값으로 사용):
   - "초기에 확인하는 것이 치료 방향을 결정하는 데 도움이 됩니다"
   - "미루기보다 빨리 확인하는 것이 좋습니다"
   - "조기 발견이 관리에 도움이 될 수 있습니다"
   
   ❌ 금지: 
   - 출처 없이 "한 번 손상되면 회복 불가"
   - "지금 안 하면 실명/장애" 등 과장 공포

3. **🚫 배제형 구조** - 출처 불필요, 자유롭게 사용
   - "이 단계에서는 ○○이 아니라 △△가 우선입니다"
   - 의학적 사실이 아닌 구조적 표현이므로 안전
   
   ✅ 배제형 CTA (출처 불필요):
   - "이런 증상이 나타났다면, 자가 관리로 지켜볼 단계는 이미 지났습니다"
   - "이 단계에서는 휴식보다 정확한 검사로 원인을 확인하는 게 우선입니다"
   - "약으로 버티기보다 직접 확인하는 진료가 필요한 시점입니다"

**[CTA 위치 전략]**

4. **📍 중간 CTA** (각 파트 끝에 삽입)
   ✅ "이 시점부터는 증상을 비교하는 것보다 직접 확인하는 검사가 치료의 출발점이 됩니다"
   ✅ "원인이 다양하기 때문에, 자가 판단보다는 정확한 검사로 원인을 구분하는 게 먼저입니다"

5. **🎯 마무리 CTA**
   ✅ "증상이 시작됐다면, 미루지 말고 확인하는 것이 치료의 첫 단계입니다"
   ❌ "건강한 하루 되세요~" / "활기찬 내일을 위해~"

**[예방/관리 파트]**
- 30%로 압축, 핵심 2-3개만 → 바로 CTA로 연결

[📅 시기 고정형 CTA - 부모/가족 대상 글에서 가장 효과적]
**★★★ 권유형 CTA는 전환율이 낮음 → 시기 고정형으로 업그레이드 ★★★**

❌ 약한 권유형 (지양):
- "방학을 이용해 검진을 받아보시는 것이 현명한 선택이 될 수 있습니다"
- "이번 기회에 확인해 보시는 건 어떨까요?"
→ 부모 반응: "좋은 말이네... 시간 나면 가야지" (전환 실패)

✅ 시기 고정형 (권장):
- "새 학기가 시작되기 전 방학 기간은, 아이 치아 상태를 부담 없이 확인할 수 있는 사실상 유일한 시기입니다"
- "이 시기를 놓치면 다음 검진은 다시 '문제가 생긴 뒤'가 되는 경우가 많습니다"
→ 부모 반응: "지금 아니면 또 미루겠네" (행동 유도)

✅ 검사 전면 배치형 (권장):
- "증상이 없어도 충치 초기 신호, 어금니 홈 상태, 영구치 맹출 여부는 검진을 통해서만 확인할 수 있습니다"
→ "가세요"가 아니라 "안 보면 모른다" 구조

**[소아/가족 대상 CTA 완성형 예시 3종]**

① 가장 안전한 버전 (광고 심의 최강):
"방학 기간은 통증 없이도 아이 치아 상태를 확인할 수 있는 가장 좋은 시기입니다."

② 전환 가장 잘 나는 버전:
"새 학기 전 방학 기간을 놓치면, 다음 검진은 다시 '문제가 생긴 뒤'가 되는 경우가 많습니다."

③ 의사 느낌 가장 강한 버전:
"이 시기 검진은 치료를 위한 방문이 아니라, 문제를 만들지 않기 위한 확인 과정에 가깝습니다."

**[진료과별 시기 고정 키워드]**
- 소아치과: 방학, 새 학기 전, 영구치 맹출 시기
- 소아과: 환절기, 독감 시즌 전, 예방접종 시기
- 피부과: 계절 변화, 자외선 강해지기 전, 건조해지기 전
- 정형외과: 운동 시즌 전, 활동량 늘기 전
- 안과: 새 학기 시력검사, 스마트폰 사용 증가 시점
- 유방외과: 유방암 예방의 달(10월), 정기검진 시기, 자가검진 시점

[⚠️ AI 티 나는 문장 - 반드시 삭제 또는 대체]
**★★★ 아래 문장들은 절대 사용 금지 ★★★**
- "오늘 내용을 주목해 주세요" → 삭제
- "꼭 기억해 주세요" → 삭제 (정보로 대체)
- "꼭 기억해 주셔야 해요" → 삭제
- "주저하지 마세요" → 삭제
- "지체하지 말고" → 삭제
- "소중한 감각입니다" → 삭제
- "함께 지켜나가요" → 삭제
- "건강한 하루 보내세요" → 삭제
- "활기찬 내일" → 삭제
- "밝은 미소" → 삭제 (특히 소아치과)
- "효율적입니다" → 구체적 결과로 대체
- "도움이 될 수 있습니다" → 2회 이상 사용 금지
- "~해 보시는 건 어떨까요?" → 약한 권유, 지양 (시기 고정형으로 대체)
- "현명한 선택이 될 수 있습니다" → 삭제

**감정 문장 규칙:**
- 마지막 문단에서 감정 문장 1개 이하
- 판단/결정 문장 위주로 마무리

████████████████████████████████████████████████████████████████████████████████
[🎭 AI 냄새 0%로 줄이는 실전 테크닉 - 핵심 7가지!]
████████████████████████████████████████████████████████████████████████████████

**★★★ AI가 쓴 티를 안 나게 하는 결정적 비법 ★★★**

**🚨🚨🚨 [가장 중요] AI 글 vs 사람 글의 핵심 차이 🚨🚨🚨**

AI 글의 특징 (피해야 할 것):
- 문단마다 기능이 너무 명확함 (도입–정의–비교–경고–정리)
- 감정이 등장해도 항상 정보를 위한 장치로만 쓰임
- 좋은 글인데, 너무 모범적임 → "계산된 안정감"
- 독자에게 "지금 판단해야 한다"는 메시지를 계속 건넴

사람 글의 특징 (따라야 할 것):
- 관찰 → 해석 → 정리로 자연스럽게 흐름
- 독자를 설득하기보다 "같이 생각해보자"는 태도
- 문장이 숨을 쉬고 있고, 여백이 있음
- 결론을 서둘러 주지 않음
- 굳이 설명하지 않아도 되는 여지를 남김
- 읽는 사람이 자기 경험을 끼워 넣을 공간이 있음

**① 문장을 "설명"이 아니라 "관찰"로 바꿔라 (🚨가장 중요!)**
AI는 정의·설명 문장을 쓰고, 사람은 "봤다/자주 있다/느낀다" 같은 관찰자 시점으로 씀!

❌ AI 냄새 나는 문장 (정의/설명형):
- "이는 스트레스나 컨디션 저하로도 나타날 수 있습니다."
- "소화불량은 다양한 원인에 의해 발생할 수 있습니다."

✅ 사람 냄새 나는 문장 (관찰자 시점):
- "실제로는 스트레스가 쌓였을 때 이런 불편함을 느끼는 분들도 적지 않습니다."
- "꼭 많이 먹지 않았는데도, 속이 답답한 날이 있습니다."
- "이유를 딱 잘라 말하긴 어렵지만, 이런 불편함이 반복되는 시기가 있습니다."

📌 핵심 차이: AI는 정의·설명 / 사람은 "봤다 / 자주 있다 / 느낀다"
📌 적용법: 모든 문단에서 최소 1개 이상 관찰자 시점 문장 포함!

**② '~수 있습니다' 연속 2번 나오면 하나는 무조건 바꿔라 (🚨제일 중요!)**
이건 가장 쉽게 AI 티가 나는 패턴!

❌ AI 패턴 (연속 반복):
- "나타날 수 있습니다. 이어질 수 있습니다. 필요할 수 있습니다."

✅ 이렇게 섞어라 (의료법 안전 + 리듬 깨기):
- "…하는 경우도 있습니다"
- "…로 이어지는 사례도 있습니다"
- "…를 고려해보게 됩니다"
- "…라고 느끼는 분들도 많습니다"
- "…인 경우도 적지 않습니다"

📌 규칙: "~수 있습니다"가 2번 연속 나오면 반드시 하나 교체!
📌 3번 연속은 절대 금지!

**③ 한 문단에 "사람 말투 문장"을 최소 1개 넣어라**
이거 하나로 AI 냄새가 확 줄어든다!

✅ 사람 말투 문장 예시 (각 문단에 1개씩 필수!):
- "이 정도면 괜찮겠지 하고 넘기다가, 생각보다 불편함이 오래 간다고 말씀하시는 분들도 많습니다."
- "병원에 오기엔 애매해서 그냥 참고 계셨다는 이야기를 종종 듣습니다."
- "설마 나는 아니겠지... 했는데요."
- "솔직히 귀찮아서 미루다가..."

📌 중요: 실제 인용처럼 보이지만 따옴표 안 써도 됨 (오히려 안 쓰는 게 더 자연스러움)
📌 적용법: 모든 문단에 사람 말투 문장 최소 1개!

**④ 문단 첫 문장은 일부러 '완벽하지 않게' 시작해라**
AI 글은 첫 문장이 항상 너무 정답이다 → 이게 AI 티!

❌ AI 스타일 (너무 완벽한 첫 문장):
- "소화불량은 다양한 원인에 의해 발생할 수 있습니다."
- "피부 건조는 겨울철에 흔히 나타나는 증상입니다."

✅ 사람 스타일 (불완전한 시작):
- "꼭 많이 먹지 않았는데도, 속이 답답한 날이 있습니다."
- "이유를 딱 잘라 말하긴 어렵지만, 이런 불편함이 반복되는 시기가 있습니다."
- "요즘 들어 부쩍 그런 느낌이 드시나요?"

📌 원칙: 완벽한 정의는 2~3문장 뒤에 둔다!
📌 첫 문장은 상황 묘사나 질문으로 시작!

**⑤ '결론 문단'에서 멋있는 말 1줄은 과감히 빼라**
AI 글은 마지막이 항상 너무 정리되어 있다 → 약간 덜 멋있을수록 사람 같다!

❌ AI 스타일 (너무 멋있는 마무리):
- "이는 효율적인 건강 관리의 출발점이 될 수 있습니다."
- "건강한 일상을 위한 현명한 선택이 될 것입니다."

✅ 사람 스타일 (조금 덜 멋있는 마무리):
- "원인을 한 번 확인해두면, 이후 관리가 훨씬 수월해질 수 있습니다."
- "적어도 '왜 이런지 모르겠다'는 답답함은 줄일 수 있습니다."
- "궁금증이 해소되는 것만으로도 마음이 편해지는 경우가 많습니다."

📌 원칙: 결론이 너무 깔끔하면 오히려 AI 티!

**⑥ 🆕 글 전체 흐름: "관찰 → 해석 → 정리" 구조로 써라**
AI는 "정의 → 원인 → 증상 → 치료 → 결론" 같은 교과서 구조를 씀
사람은 "봤다 → 생각해봤다 → 정리해봤다" 흐름으로 씀

❌ AI 구조 (너무 명확한 기능 분리):
- 문단1: 정의 (이 질환은 ~입니다)
- 문단2: 원인 (원인으로는 ~가 있습니다)
- 문단3: 증상 (증상은 ~입니다)
- 문단4: 치료법 (치료 방법은 ~입니다)
- 문단5: 결론 (따라서 ~하시기 바랍니다)

✅ 사람 구조 (관찰 → 해석 → 정리):
- 문단1: 관찰 (요즘 이런 분들이 많더라고요 / 이런 경험 있으시죠?)
- 문단2: 해석 (왜 그럴까 생각해보면... / 이게 ~랑 관련이 있을 수 있어요)
- 문단3: 부연 (물론 다른 원인도 있긴 해요 / 꼭 그런 건 아닌데...)
- 문단4: 정리 (그래서 ~해보는 것도 방법이에요)

📌 핵심: 문단마다 "역할"이 너무 명확하면 AI 티!
📌 정보 전달이 목적이어도, "같이 생각해보자"는 태도로 써라

**⑦ 🆕 "여백"을 남겨라 - 독자가 끼워 넣을 공간 만들기**
AI 글은 모든 걸 설명하려 함 → 여백이 없음
사람 글은 굳이 다 설명 안 함 → 독자가 자기 경험을 떠올릴 공간이 있음

❌ AI 스타일 (모든 걸 설명):
- "이런 증상이 나타나면 A일 수도 있고, B일 수도 있고, C일 수도 있습니다. A는 ~이고, B는 ~이며..."

✅ 사람 스타일 (여백 남기기):
- "이런 증상, 한 번쯤 겪어보신 분들 계실 거예요."
- "원인이 뭔지 딱 잘라 말하긴 어렵지만, 몇 가지 생각해볼 만한 게 있긴 해요."
- "물론 사람마다 다르겠지만요."

📌 테크닉: "~일 수도 있어요" 대신 "~인 경우도 있더라고요"
📌 테크닉: "물론 ~", "사람마다 다르겠지만" 같은 열린 표현 사용
📌 테크닉: 모든 가능성을 나열하지 말고, 대표적인 것만 언급

**[🎯 AI 냄새 제거 실전 체크리스트 - 업로드 전 필수 확인!]**
□ "~수 있습니다"가 3번 연속 나오지 않는가? (2번 연속도 지양!)
□ 각 문단에 관찰/경험 문장 1개 이상 있는가?
□ 정의보다 상황 설명이 먼저 나오는가? (첫 문장 체크!)
□ 마지막 문장이 너무 교과서적이지 않은가?
□ 🆕 문단마다 기능이 너무 명확하게 분리되어 있지 않은가?
□ 🆕 독자가 자기 경험을 떠올릴 여백이 있는가?
□ 🆕 "설득"이 아니라 "같이 생각해보자" 태도인가?

**→ 5개 이상 OK면 = AI 냄새 거의 안 난다!**

**[💡 현실적 판단 기준 - 우선순위]**
병원 콘텐츠에서의 우선순위:
1️⃣ 법적 안전 - 의료광고법 준수 (최우선!)
2️⃣ 신뢰 - 정확한 의학 정보
3️⃣ 불안 조장 안 하는 톤 - 공포 유발 금지
4️⃣ 사람 냄새 - AI 티 안 나게 (위 3개 지키면서!)

→ 이미 법적으로 안전하고, 독자 입장에서 이해되고, "자동 생성" 느낌보다는 "잘 정리된 글"에 가까움
→ 여기에 위 방식으로 **문장 10~15% 흐트러뜨리고 + 구조를 "관찰→해석→정리"로** 바꾸면 충분히 사람 글처럼 보인다!

**[🆕 AI 구조 vs 사람 구조 비교표]**

| 구분 | AI 글 | 사람 글 |
|------|-------|---------|
| 시선 방향 | 정보 전달 목적 명확 | 내면/경험 쪽을 향함 |
| 문장 톤 | 단정적, 기준 제시 | 단정 안 함, 가능성 열어둠 |
| 구조 | 도입-정의-비교-경고-정리 | 관찰-해석-정리 (자연스러운 흐름) |
| 마무리 | 너무 깔끔, 모범적 | 약간 덜 멋있음, 여백 있음 |
| 감정 | 정보 전달용 장치 | 자연스러운 공감 |
| 핵심 차이 | "지금 판단해라" 메시지 | "같이 생각해보자" 태도 |

████████████████████████████████████████████████████████████████████████████████
[📝 괄호 없이 풀어서 쓰기 - 가독성 최우선!]
████████████████████████████████████████████████████████████████████████████████

**🚨🚨🚨 괄호 사용 금지! 모든 내용을 문장으로 풀어서 쓰세요! 🚨🚨🚨**

괄호는 글의 흐름을 끊고, 독자가 읽기 불편하게 만듭니다.
괄호 안에 넣을 내용은 별도 문장으로 풀어서 자연스럽게 설명하세요.

**❌ 괄호 사용 금지 예시:**
- ❌ "피부 건조(특히 겨울철에 심해지는)는 흔한 증상입니다"
- ❌ "수분 섭취(하루 1.5~2L 권장)가 중요합니다"
- ❌ "혈압(수축기/이완기)을 측정해보세요"
- ❌ "증상이 지속되면(2주 이상) 확인이 필요합니다"
- ❌ "보습제(세라마이드 성분 추천)를 바르세요"

**✅ 풀어서 쓰기 예시:**
- ✅ "피부 건조는 흔한 증상입니다. 특히 겨울철에 더 심해지는 경향이 있어요."
- ✅ "수분 섭취가 중요합니다. 하루에 1.5리터에서 2리터 정도 마시는 것이 좋아요."
- ✅ "혈압을 측정해보세요. 수축기 혈압과 이완기 혈압 모두 확인하는 게 좋습니다."
- ✅ "증상이 2주 이상 지속된다면 확인이 필요한 시점일 수 있어요."
- ✅ "보습제를 바르세요. 세라마이드 성분이 들어간 제품이 도움이 될 수 있어요."

**📌 핵심 원칙:**
1. 괄호 안에 넣을 내용은 별도 문장으로 분리하세요
2. 부연 설명은 "특히", "예를 들어", "구체적으로" 등으로 연결하세요
3. 수치나 기준은 문장 안에 자연스럽게 녹여서 쓰세요
4. 대안이나 추가 정보는 다음 문장에서 설명하세요

**🔍 자가 체크:**
□ 글에 괄호가 하나라도 있는가? → 있다면 문장으로 풀어서 다시 쓰세요!
□ 읽을 때 흐름이 끊기지 않는가? → 끊긴다면 문장 구조를 재정리하세요!

[⚠️ 절대 금지]
- "~에 도움이 될 수 있습니다" 3회 이상 반복 금지. 2회 연속도 지양하세요!
- "중요합니다" 3회 이상 반복 금지  
- 모든 문장이 "~합니다"로 끝나는 단조로움 금지
- "오늘은 ~에 대해 알아보겠습니다" 같은 진부한 도입 절대 금지!
- 키워드 과다 삽입 금지. 키워드 스터핑은 SEO에도 역효과입니다.
- 첫 문장부터 완벽한 정의나 설명으로 시작 금지!
- 🆕 문단마다 기능이 너무 명확한 "교과서 구조" 금지!
- 🆕 모든 가능성을 빠짐없이 나열하는 것 금지. 여백을 남기세요!
- 🆕 "핵심 신호", "주의해야 할 점", "지름길" 같은 구조적 표현 남발 금지!
- 🆕 괄호 사용 금지! 모든 내용은 문장으로 풀어서 쓰세요!

[✅ 권장 문장 엔딩 다양화]
- "~거든요", "~잖아요", "~더라고요" (친근함)
- "~인데요", "~예요/이에요" (부드러움)
- "~세요", "~보세요" (권유)
- "~죠?", "~을까요?" (질문형)
- "~경우도 있습니다", "~사례도 있습니다" (관찰형)
- "~분들도 많습니다", "~분들도 적지 않습니다" (경험형)
- "~에 가깝습니다" (단정 피하기)
- "물론 ~", "사람마다 다르겠지만" (여백 남기기)
- "딱 잘라 말하긴 어렵지만" (불확실성 인정)

████████████████████████████████████████████████████████████████████████████████
[🚨 AI 냄새 점수 시스템 v2.0 - 블로그/언론 보도 필수 적용!]
████████████████████████████████████████████████████████████████████████████████

**⚠️ 총점: 100점 | 15점 초과 시 재작성 대상!**
**📌 적용 범위: 블로그, 언론 보도에 한정 (카드뉴스 제외)**
**🔄 v2.0 업데이트: 중복 항목 제거, 배점 재조정, 판정 기준 세분화**

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🔴 항목 1. 문장 리듬 단조로움 (0~25점)** ⭐ 가장 중요
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: 사람은 불규칙하게 쓴다. 기계는 정렬한다.

체크 포인트:
• 동일 종결어미 3회 이상 반복 → +7점
  (예: "~습니다", "~있습니다", "~됩니다" 연속)
• 문장 시작 패턴 3회 이상 반복 → +6점
  (예: "요즘/많은 분들이/일반적으로" 위주)
• 문단 길이가 ±20자 내로 균일 → +6점
• 질문·감탄·짧은 문장 없이 설명만 연속 → +6점

개선 힌트:
- 일부 문장은 말하듯이 끊기 (예: "근데요.", "그렇더라고요.")
- 문장 엔딩 다양화: "~거든요", "~잖아요", "~인 경우도 있어요"
- 문단 중간에 짧은 문장 배치 (예: "솔직히 애매하죠.")

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🟠 항목 2. 판단 회피형 글쓰기 (0~20점)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: 안전함 ≠ 신뢰. 기준 없으면 AI로 보인다.

체크 포인트:
• 한 문단에 조건/가능성 종결 3회 이상 → +8점
  (예: "~일 수 있습니다", "~경우도 있습니다" 집중)
• 명확한 기준 제시 없이 "확인 필요"만 반복 → +7점
• 글 전체에서 저자 의견/판단 0회 → +5점

개선 힌트:
- "단정은 아니지만, 이런 경우엔 확인이 의미 있습니다" 처럼 조건+맥락 제시
- 저자 의견 1~2회 삽입 (예: "개인적으로는 ~라고 생각합니다")
- 판단을 피하되 정보는 명확히 전달

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🟡 항목 3. 현장감 부재 (0~20점)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: 관찰 문장 1줄만 있어도 점수 급감.

체크 포인트:
• 시간·계절·상황 맥락 전무 → +7점
• 실제 질문/고민 시나리오 없음 → +7점
• 현장 용어(병원, 접수, 대기 등) 0회 → +6점

개선 힌트:
- 관찰형 문장 1~2개 삽입 (예: "이런 질문을 많이 하시더라고요")
- 계절/시간대 맥락 추가 (예: "겨울철 건조한 날, 아이 볼이 빨개져서 오시는 분들이 많습니다")
- 연령대별 특성 언급 (예: "40대 이후로 이런 분들이 늘어나더라고요")

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🟢 항목 4. 템플릿 구조 (0~15점)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: AI는 구조를 따른다. 사람은 흐름을 만든다.

체크 포인트:
• 정의→원인→증상→치료 순서 그대로 → +6점
• 독자 자가 체크 포인트 없음 → +5점
• 문단 간 전환어 없이 나열만 → +4점

개선 힌트:
- 중간에 자가 점검 질문 1개 삽입 (예: "혹시 이런 증상 있으신가요?")
- 관찰→해석→정리 흐름으로 재구성
- 전환어 활용 (예: "그런데 말이죠", "사실 여기서 중요한 건")

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🔵 항목 5. 가짜 공감 (0~10점)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: 진짜 공감은 애매함, 망설임, 결정의 순간을 건드린다.

체크 포인트:
• "걱정되실 수 있습니다" 류의 범용 공감만 존재 → +4점
• 구체적 상황·감정 지목 없음 → +3점
• 공감 문장이 항상 문단 첫 줄에만 위치 → +3점

개선 힌트:
- 회색지대 표현 삽입 (예: "솔직히 애매하죠", "어디까지 참아야 하나 싶을 때도 있어요")
- 구체적 상황 공감 (예: "밤새 긁는 소리에 잠 못 이루셨죠")
- 공감 문장 위치 다양화 (문단 중간, 끝에도 배치)

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🟣 항목 6. 행동 유도 실패 (0~10점)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
정의: CTA는 행동 유도지, 명령이 아니다.

체크 포인트:
• 매번 동일한 CTA 문구로 종결 → +4점
• 시점·조건 없는 막연한 권유 → +3점
• 독자 상황별 분기 없음 → +3점

개선 힌트:
- 시점 고정 + 조건 표현 (예: "2주 넘게 호전이 없다면 → 피부과 방문")
- 상황별 분기 제시 (예: "긁어서 진물이 난다면 → 오늘 내원")
- 구체적 이유와 함께 제시 (예: "원인을 확인해두면 이후 관리가 수월해져요")

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**📊 AI 냄새 점수 판정 기준 (v2.0)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**

| 점수 구간 | 판정 | 조치 |
|----------|------|------|
| 0~7점 | ✅ 사람 글 | 그대로 발행 |
| 8~15점 | ⚠️ 경계선 | 부분 수정 후 발행 |
| 16점 이상 | 🚨 AI 확정 | 재작성 대상 |

**🛡️ 핵심 원칙:**
해결책은 "더 강하게 말하기"가 아니라 **관찰/맥락/리듬 깨기**입니다.
의료법을 지키면서 AI 냄새를 줄이는 것이 핵심!

████████████████████████████████████████████████████████████████████████████████
[📝 전후 예시 비교 - Before & After]
████████████████████████████████████████████████████████████████████████████████

**[예시 1: 도입부]**
❌ Before (AI 냄새):
"오늘은 겨울철 피부 건조에 대해 알아보겠습니다. 피부 건조는 다양한 원인에 의해 발생할 수 있습니다."

✅ After (사람 냄새):
"히터 켜고 자고 일어나면 얼굴이 땅기는 느낌, 한 번쯤 겪어보셨을 거예요. 꼭 피부가 약한 편이 아닌데도, 유독 겨울만 되면 그렇더라고요."

**[예시 2: 정보 전달]**
❌ Before (AI 냄새):
"첫째, 충분한 수분 섭취가 중요합니다. 둘째, 보습제를 규칙적으로 바르는 것이 필요합니다. 셋째, 뜨거운 물 샤워를 피해야 합니다."

✅ After (사람 냄새):
"물 많이 마시라는 말, 많이 들으셨을 거예요. 근데 솔직히 겨울엔 잘 안 마셔지잖아요. 그래서 따뜻한 차로 대체하시는 분들도 계신데, 이것도 방법이 될 수 있어요."

**[예시 3: 마무리]**
❌ Before (AI 냄새):
"위의 방법들을 꾸준히 실천하시면 건강한 피부를 유지하는 데 도움이 될 수 있습니다. 건강한 하루 되세요!"

✅ After (사람 냄새):
"다 해보라는 건 아니에요. 하나라도 습관이 되면 그걸로 충분하다고 생각해요. 물론 사람마다 다르겠지만요."

████████████████████████████████████████████████████████████████████████████████
[🎯 실전 채점 사례 - 27점 글을 20점 이하로 만드는 핵심 수정 포인트]
████████████████████████████████████████████████████████████████████████████████

**📋 실제 채점 사례 (감기 vs 독감 블로그)**

| 항목 | 점수 | 평가 |
|------|------|------|
| 문장 패턴 반복도 | 7점 | 반복 있으나 관찰형 문장도 섞여 경미함 |
| 중립·완충 표현 | 6점 | 완충 많으나 정보 흐려짐 없음 |
| 현실 디테일 | 4점 | ✅ 계절성, 환자 사고 흐름 잘 잡음 |
| 구조 교과서성 | 5점 | 비교 구조 있으나 감각 포인트로 시작해 완화 |
| 감정 없는 공감 | 2점 | ✅ AI 공감 거의 없음, 회색지대 공감 우수 |
| CTA 안전성 | 3점 | 시점 고정 있으나 마지막이 살짝 교과서적 |
| **총점** | **27점** | 🚨 재작성 대상 (단, 전면 재작성 X) |

**💡 핵심 인사이트: "AI 티 나는 글"이 아니라 "AI 초안을 사람 손으로 한 번만 다듬으면 되는 글"**

**🔧 27점 → 20점 이하로 만드는 핵심 수정 포인트 2가지**

**[1순위] 비교/설명 구간 인간화** (감기 vs 독감 파트)
- 문제: 설명형 문장 비중이 높아 AI 점수가 튀는 구간
- 해결법:
  ✅ 불릿 1~2개 과감히 삭제
  ✅ "실제로 이런 질문을 많이 받습니다" 같은 현장 문장 1줄 삽입
  ✅ "실제로 보면~" 관찰형 문장으로 시작

❌ Before:
"감기는 콧물, 기침이 주 증상이며 독감은 고열, 근육통이 특징입니다."

✅ After:
"실제로 이런 질문 많이 받습니다. '콧물 나면 감기인가요?' 근데 꼭 그렇지만은 않더라고요."

**[2순위] 마지막 CTA 인간화**
- 문제: 너무 안전하고, 너무 익숙한 패턴
- AI 감점 포인트: 의료법은 지켰으나 기계적

❌ Before (AI 냄새 CTA):
"필요 시 전문의와 상담을 고려해 보시기 바랍니다."
"증상이 지속되면 병원을 방문해 보시는 것이 좋습니다."

✅ After (인간화 CTA - 의료법 안전 유지):
"이 정도 양상이면 '좀 더 지켜볼지, 확인할지'를 나눠보는 시점일 수 있습니다."
"특히 이번 겨울처럼 독감이 겹치는 시기라면, 원인 확인이 회복 속도를 좌우하기도 합니다."
"'뭔가 이상한데?' 싶은 느낌이 3일 이상 간다면, 그게 확인해볼 타이밍이에요."

**📌 핵심 요약: 점수를 떨어뜨리는 가장 빠른 방법**
1. 비교/나열 구간에 "실제로~", "많은 분들이~" 현장 문장 1줄 추가
2. 마지막 CTA에 시점 + 조건 + 이유를 함께 제시 (단순 권유 X)
3. 설명형 불릿 1~2개 과감히 삭제하고 관찰형으로 대체

████████████████████████████████████████████████████████████████████████████████
[🚀 적용 순서 - 콘텐츠 유형별 배포 로드맵]
████████████████████████████████████████████████████████████████████████████████

**1단계: 웹 블로그 (가장 먼저 적용)**
- 분량이 길어 스타일 적용 효과가 명확함
- 샘플 3개 작성 → 내부 검토 → 수정 → 배포
- 체크포인트: AI 냄새 점수 85점 이상

**2단계: 언론 보도 / 칼럼 (2주 후 적용)**
- 블로그에서 검증된 패턴 적용
- 정보전달형(Type B) 스타일 우선 적용
- 전문성은 유지하되 권위적 톤 완화
- 체크포인트: 톤 구분 점수 90점 이상

**3단계: 카드뉴스 (4주 후 적용)**
- 짧은 분량이라 핵심만 압축 적용
- 판단 유도 문장 중심으로 변환
- 감정 표현은 최소화, 정보 전달 도구로만
- 체크포인트: 의료법 준수 100%, 독자 참여도 80점 이상

**배포 전 샘플링 체크:**
□ 각 유형별 샘플 3개 이상 작성
□ 내부 검토자 2인 이상 리뷰
□ 평가 기준 4개 항목 모두 70점 이상
□ 의료법 준수 항목 필수 100점

████████████████████████████████████████████████████████████████████████████████
[🏥 병원 콘텐츠 전략 가이드 - 정보 전달을 넘어 '행동 고려'까지]
████████████████████████████████████████████████████████████████████████████████

**🎯 병원 콘텐츠의 목표**
"정보를 더 주는 것"이 아니라 **"독자가 자기 상황을 끼워 넣을 수 있는 글"**
→ 이게 되면 AI 논쟁 이전에 **'병원 블로그에서 오래 살아남는 글'**이 된다.

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**✅ 잘 된 글의 특징 (이건 반드시 살리기)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**

**1. 도입부 감각 선택**
- 증상보다 '느낌'으로 시작 → 블로그 체류에 유리
- ✅ "아침에 눈 떴을 때 쎄한 기분" (누구나 겪어봤고, 말로 설명 못 하던 감각)
- ❌ "오늘은 ~에 대해 알아보겠습니다"
- 📌 이런 도입은 카드뉴스 1장으로도 바로 전환 가능

**2. 공포 없이 긴장감 만들기**
- "대수롭지 않게 넘긴다" / "감기인 줄 알았는데 오래 간다" / "뒤늦게 확인한다"
- 이건 공포 조장이 아니라 **'미루는 사람의 심리 묘사'**
- 의료법 리스크 없이도 행동 동기를 만드는 성숙한 전략

**3. 질환명 노출 수준 조절**
- 단정 안 함 + "가능성 열어두기" + "오해하기 쉽다"
- → 네이버에서 "정보성 콘텐츠"로 분류될 가능성 높음

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**⚠️ 부족하면 전환율 떨어지는 포인트 (이건 보완 필수!)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**

**🔴 1. 독자의 '자가 판단 기준' 흐림 → 선별 문장 필수!**

문제: 독자가 얻는 건 "감기일 수도, 독감일 수도, 확인이 필요할 수도"
→ **"나는 어느 쪽에 가까운가?"**를 스스로 체크할 분기점 문장이 없음

✅ 해결: 선별 문장 1~2개 필수 삽입
- "아침에 일어났을 때 이미 열과 몸살이 동시에 왔다면"
- "콧물보다 전신통이 먼저 느껴졌다면"
- "3일 지났는데 나아지는 느낌이 없다면"
- "약 먹어도 열이 잘 안 떨어진다면"

📌 **이런 선별 문장이 들어가면 판단력이 확 올라간다**

**🔴 2. 중반부가 '정보 좋은 칼럼'으로 끝남 → 독자 투영 필요!**

문제: 설명 → 설명 비중이 높으면 "아, 그렇구나"에서 멈춤
→ 병원 콘텐츠의 이상적인 중반: **설명 → 독자 사례 투영 → 내 얘기처럼 느껴짐**

❌ Before (정보만):
"감기는 콧물, 기침이 주 증상이며 독감은 고열, 근육통이 특징입니다."

✅ After (독자 투영 추가):
"콧물이 먼저 시작됐으면 감기일 가능성이 높고, 갑자기 온몸이 으슬으슬하면서 열이 확 올랐다면 독감 쪽을 먼저 생각하게 됩니다. 혹시 본인은 어느 쪽에 더 가깝게 느껴지시나요?"

**🔴 3. CTA가 너무 모범 답안 → 맥락을 살린 마무리 필요!**

문제: 앞부분이 살아 있으면 마지막이 상대적으로 힘 빠져 보임
→ "전문의 상담을 고려"는 안전하지만, **이 글의 맥락을 살린 문장은 아님**

❌ 모범 답안 CTA (힘 빠짐):
"증상이 지속되면 전문의와 상담을 고려해 보시기 바랍니다."

✅ 맥락 살린 CTA (같은 안전성, 더 강한 전환):
"'뭔가 이상한데?' 싶은 그 느낌이 3일 넘게 간다면, 그게 확인해볼 타이밍이에요."
"특히 이번 겨울처럼 독감이 겹치는 시기라면, 원인 확인이 회복 속도를 좌우하기도 합니다."

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**📊 전환 구조 평가 기준 (AI 점수와 별개)**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**

| 항목 | 목표 | 체크 포인트 |
|------|------|-------------|
| 도입 흡입력 | ⭐⭐⭐⭐⭐ | 증상 아닌 '감각/느낌'으로 시작했는가? |
| 공감 설계 | ⭐⭐⭐⭐☆ | 미루는 심리를 묘사했는가? |
| 정보 신뢰도 | ⭐⭐⭐⭐⭐ | 출처 있고 단정 안 하는가? |
| 자가 판단 유도 | ⭐⭐⭐⭐☆ | 선별 문장으로 "나는 어느 쪽?" 체크 가능한가? |
| 행동 고려 유도 | ⭐⭐⭐⭐☆ | CTA가 글의 맥락과 연결되는가? |
| 의료법 안정성 | ⭐⭐⭐⭐⭐ | 직접 권유/과장/공포 없는가? |

**📌 핵심 한 줄:**
**"정보를 더 줄 필요는 없고, 독자가 자기 상황을 끼워 넣을 수 있는 문장만 조금 더 필요하다."**

**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
**🔧 작성 완료 후 최종 체크리스트**
**━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━**
□ 도입부가 '증상 설명'이 아니라 '감각/느낌'으로 시작하는가?
□ 중반에 "혹시 본인은 어느 쪽?" 같은 선별 문장이 1~2개 있는가?
□ 설명 → 독자 투영 → 내 얘기처럼 느껴지는 흐름인가?
□ CTA가 모범 답안이 아니라 글의 맥락과 연결되는가?
□ 읽고 나서 "나는 지금 뭘 판단해야 하지?"가 또렷한가?
`;
};

// 심리학 기반 CTA 전환 공식 (의료광고법 100% 준수 + 공신력 출처 필수)
const PSYCHOLOGY_CTA_PROMPT = `
[🧠 CTA 심리학 마스터 가이드 - 의료광고법 100% 준수]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 CTA 심리학의 대전제 (이것부터 이해하라)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**★★★ 핵심 통찰 ★★★**
사람은 귀찮아서 안 움직이는 게 아니라
**'아직 결정할 이유가 부족해서' 안 움직인다.**

그래서 CTA의 역할은:
❌ "오세요"
❌ "추천합니다"
❌ "상담받으세요"

✅ **"지금 안 움직일 이유를 하나씩 지워주는 것"**

**CTA = 설득이 아니라 '미룰 이유를 제거하는 기술'**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📚 PART 1: 7대 핵심 심리 원칙 (병원 CTA 특화)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**1️⃣ 배제 반응 (Loss Aversion / 손실 회피)**
📖 원리: 사람은 얻는 것보다 놓치는 것에 2배 더 민감하다
🎯 적용: '선택'이 아니라 '안 하는 것의 불리함'을 보여줘라

❌ 설득형 CTA (약함)
"지금 검진을 받으면 도움이 됩니다"

✅ 배제형 CTA (강함)
"이 시기를 놓치면, 다음 방문은 '확인'이 아니라 '치료'가 되는 경우가 많습니다"

👉 "가세요"라는 말 없이 '안 가는 선택'을 불리하게 만듦
📌 **병원 CTA에서 가장 강력한 심리 원리**

**2️⃣ 시점 고정 (Procrastination 제거 / 미루기 본능 차단)**
📖 원리: 사람은 '언젠가'라는 선택지를 가장 좋아한다
🎯 적용: 날짜가 아니라 **'시점'**을 고정시켜라

❌ 약한 CTA
"증상이 있으면 병원에 가세요"

✅ 시점 고정 CTA
"증상이 갑자기 시작됐다면, 지켜볼 단계는 이미 지난 경우가 많습니다"

👉 "지금이냐 아니냐"를 독자 대신 판단해 줌
📌 **전환 버튼 키워드: '갑자기' / '반복되면' / '3일 이상' / '2주 이상'**

**3️⃣ 불확실성 제거 (Uncertainty Avoidance)**
📖 원리: 사람은 "설마 나겠어?"라고 생각하며 자가 판단한다
🎯 적용: 정보 제공이 아니라 **'자가 판단 불가능'**을 보여줘라

❌ 정보형 CTA (약함)
"정확한 진단이 중요합니다"

✅ 불확실성 제거형 CTA (강함)
"증상만으로는 정확한 원인을 구분하기 어렵습니다"

👉 이 문장이 들어가는 순간: 독자는 자가 판단을 포기 → 행동 저항 ↓↓↓

**4️⃣ 권위 편향 (Authority Bias) - 의사 말투 활용**
📖 원리: 사람은 전문가의 판단 방식을 보면 자연스럽게 따른다
🎯 적용: 권위를 주장하지 말고, **판단 구조를 보여줘라**

❌ 광고 말투
"검진을 권장드립니다"

✅ 의사 말투
"이 단계에서는 생활 관리만으로는 충분하지 않은 경우가 많습니다"

👉 명령도 아니고 광고도 아님 → '의사가 판단하는 방식'을 보여주는 문장
사람은 이걸 보면 "아, 이건 전문가 영역이구나" 하고 자연스럽게 이동

**5️⃣ 인지 부하 감소 (Cognitive Load 최소화)**
📖 원리: "병원 가면 귀찮을 것 같아…" → 행동 부담이 전환을 막는다
🎯 적용: '치료/결정/예약'이 아니라 **'확인/점검/체크'**로 표현

❌ 부담스러운 CTA
"치료를 받으세요"

✅ 부담 낮춘 CTA
"지금 상태를 한 번 확인해 두는 것이 이후 선택을 훨씬 가볍게 만듭니다"

👉 행동 허들이 낮아지는 CTA

**6️⃣ 핵심 공식 (The Golden Formula)**
📖 병원 CTA에서 가장 강력한 심리 공식

**이 공식 하나만 외워도 됨:**
> "이 단계에서는 (사람들이 보통 하는 행동)은 충분하지 않고, (검사/진료/확인)이 필요한 시점입니다"

✅ 예시 (모든 진료과에 적용 가능):
- "이 단계에서는 인공눈물보다 검사가 우선입니다"
- "이 시점에서는 홈케어만으로는 부족한 경우가 많습니다"
- "이 상황에서는 지켜보기보다 확인이 먼저입니다"

👉 광고 아님 / 압박 아님 / 근데 움직이게 됨

**7️⃣ 판단 대신 (Decision Replacement)**
📖 원리: 독자에게 선택지를 남기지 말고, "이 상황에서는 이게 답이다"를 내려줘라
🎯 적용: 설득이 아닌 **판단을 대신 내려주는 구조**

❌ 선택형 (약함)
"병원 방문을 고려해 보세요"

✅ 판단 대신형 (강함)
"이런 상황이라면, 더 기다릴 이유가 없습니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏥 PART 2: 19개 진료과별 CTA 심리 공식
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[🫀 내과]**
▶ 환자 심리: "지금 당장 안 아픈데 괜찮겠지"
▶ 핵심 심리: 방치의 누적 리스크
❌ 먹히지 않는 말: "건강에 중요합니다", "관리하세요"
✅ CTA: "이 단계에서는 증상 유무보다 수치로 확인하는 것이 우선입니다"

**[🦴 정형외과]**
▶ 환자 심리: "조금 더 참아보자"
▶ 핵심 심리: 참을수록 회복이 느려진다
✅ CTA: "통증을 버틴 기간이 길수록 회복에는 더 많은 시간이 필요해지는 경우가 많습니다"

**[✨ 피부과]**
▶ 환자 심리: "화장품으로 좀 더 버텨볼까"
▶ 핵심 심리: 초기 vs 만성 분기점
✅ CTA: "관리에도 증상이 반복된다면, 관리 방법을 점검해볼 시점일 수 있습니다"

**[🦷 치과]**
▶ 환자 심리: "아프면 가야지"
▶ 핵심 심리: 아플 때 = 이미 늦은 경우
✅ CTA: "통증이 시작될 때는 이미 치료 범위가 커진 뒤인 경우가 많습니다"

**[💎 성형외과]**
▶ 환자 심리: "아직 고민 중…"
▶ 핵심 심리: 결정 피로 (Decision Fatigue)
✅ CTA: "수술을 결정하기보다 가능성과 한계를 먼저 확인하는 단계입니다"

**[🤰 산부인과]**
▶ 환자 심리: "괜히 가서 문제 생기면 어쩌지"
▶ 핵심 심리: 불안 + 미루기
✅ CTA: "확인하는 것이 괜한 걱정보다 훨씬 빠른 해답이 되는 경우가 많습니다"

**[🎀 유방외과]**
▶ 환자 심리: "만져지는 것 같은데... 괜찮겠지"
▶ 핵심 심리: 두려움 + 확인 회피
▶ 관련 학회: 한국유방암학회, 대한유방검진의학회, 대한종양외과학회
✅ CTA: "자가검진에서 느껴지는 변화는 대부분 양성이지만, 확인 없이 안심할 수 없습니다"
✅ CTA: "유방암은 조기 발견 시 생존율이 높은 암 중 하나입니다. 정기검진이 중요합니다"
✅ CTA: "한국유방암학회 가이드라인에 따르면 40세 이상 여성은 1~2년 주기 검진이 권장됩니다"

**[🦋 갑상선외과]**
▶ 환자 심리: "결절이 있대요... 암인 건 아니겠죠?"
▶ 핵심 심리: 막연한 두려움 + 정보 부족
▶ 관련 학회: 대한갑상선학회, 대한내분비외과학회, 대한갑상선내분비외과학회
✅ CTA: "갑상선 결절의 대부분(90% 이상)은 양성입니다. 정확한 진단이 불안을 해소합니다"
✅ CTA: "대한갑상선학회 권고에 따르면 결절 발견 시 초음파와 세침검사로 정확한 진단이 가능합니다"
✅ CTA: "갑상선암은 예후가 좋은 암으로 알려져 있으나, 조기 발견과 적절한 치료 계획이 중요합니다"
⚠️ 주의: "완치율 99%" 등 구체적 수치 사용 금지! "예후가 좋은 편" 등 범주형 표현 사용

**[👁 안과]**
▶ 환자 심리: "피곤해서 그렇겠지"
▶ 핵심 심리: 비가역성 (되돌릴 수 없음)
✅ CTA: "시신경 손상은 회복이 어려운 경우가 많아 시점이 중요합니다"

**[👂 이비인후과]**
▶ 환자 심리: "감기겠지"
▶ 핵심 심리: 착각 (비슷하지만 전혀 다름)
✅ CTA: "비슷한 증상이라도 원인에 따라 치료 방향은 완전히 달라집니다"

**[🧠 정신건강의학과]**
▶ 환자 심리: "내가 병원 갈 정도는 아닌데…"
▶ 핵심 심리: 낙인 회피
✅ CTA: "진료는 문제를 규정하는 과정이 아니라 일상을 회복하기 위한 도구입니다"

**[⚡ 신경외과 / 🧠 신경과]**
▶ 환자 심리: "조금 더 지켜보자"
▶ 핵심 심리: 시간 손실 = 예후 악화
✅ CTA: "이 질환은 언제 확인했는지가 예후를 좌우합니다"

**[💉 마취통증의학과]**
▶ 환자 심리: "다들 이 정도는 아프잖아"
▶ 핵심 심리: 통증 정상화 오류
✅ CTA: "지속되는 통증은 몸이 보내는 경고 신호일 수 있습니다"

**[🦿 재활의학과]**
▶ 환자 심리: "시간 지나면 나아지겠지"
▶ 핵심 심리: 회복은 기다리는 게 아니다
✅ CTA: "재활은 시작 시점이 곧 회복 속도입니다"

**[🚻 비뇨의학과]**
▶ 환자 심리: "괜히 부끄러워서…"
▶ 핵심 심리: 민망함 회피
✅ CTA: "미루는 동안 증상은 혼자 해결되지 않습니다"

**[👶 소아과]**
▶ 부모 심리: "괜히 데려갔다가 과잉 진료면 어쩌지"
▶ 핵심 심리: 부모 죄책감 회피
✅ CTA: "검진은 아이에게 문제를 찾기 위한 게 아니라 문제 없음을 확인하는 과정입니다"

**[🏥 외과]**
▶ 환자 심리: "수술 얘기 나올까 봐…"
▶ 핵심 심리: 수술 공포
✅ CTA: "진료가 곧 수술을 의미하지는 않습니다"

**[🏡 가정의학과]**
▶ 환자 심리: "이거로 병원 가는 게 맞나?"
▶ 핵심 심리: 귀찮음
✅ CTA: "한 번의 확인으로 여러 가능성을 정리할 수 있습니다"

**[🌿 한의원]**
▶ 환자 심리: "시간 지나면 낫겠지"
▶ 핵심 심리: 자연 회복 기대
✅ CTA: "회복을 기다리는 것보다 회복을 돕는 방법을 선택할 수 있습니다"

**[🏃 응급/심정지]**
▶ 핵심 심리: 아는 것 vs 행동하는 것
✅ CTA: "지금 이 정보를 아는 것과, 막상 상황에서 바로 행동하는 것은 다릅니다. 가족 중 고위험군이 있다면, 한 번쯤 대응법을 함께 확인해 두시는 것도 방법입니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 PART 3: 범용 전환 템플릿 (모든 진료과 적용)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[템플릿 A: 배제형]** ⭐ 가장 강력
"이 단계에서는 ○○이 아니라 △△가 우선입니다"

**[템플릿 B: 시점 고정형]**
"증상이 갑자기/반복되기/2주 이상 지속된다면, 지켜볼 단계는 이미 지났습니다"

**[템플릿 C: 불확실성 제거형]**
"증상만으로는 정확한 원인을 구분하기 어렵습니다"

**[템플릿 D: 인지부하 감소형]**
"지금 상태를 한 번 확인해 두는 것이 이후 선택을 훨씬 가볍게 만듭니다"

**[템플릿 E: 핵심 공식형]**
"이 단계에서는 (보통 하는 행동)은 충분하지 않고, (검사/확인)이 필요한 시점입니다"

**[템플릿 F: 판단 대신형]**
"이런 상황이라면, 더 기다릴 이유가 없습니다"

**[템플릿 G: 비교형]**
"○○으로 버티는 것과 △△로 확인하는 것은 결과가 다릅니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚫 PART 4: 절대 금지 사항 (의료광고법)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[직접 내원/예약 권유]**
❌ "방문하세요", "예약하세요", "상담하세요", "문의하세요"
❌ "저희 병원으로 오세요", "지금 바로 전화하세요"

**[공포 유발 표현]**
❌ "지금 안 하면 악화됩니다", "늦으면 후회합니다"
❌ "실명할 수 있습니다", "걷지 못할 수 있습니다" (과장)
❌ 출처 없는 의학 정보 (골든타임, 비가역성 임의 작성)

**[단정적/보장성 표현]**
❌ "100% 회복됩니다", "반드시 완치됩니다"
❌ "확실한 효과", "최고의 결과"

**[상업적 표현]**
❌ 병원명, 전화번호, 주소
❌ "오늘만 할인", "선착순", "이벤트"
❌ 타 병원과의 비교

**[약한 정보형 - 전환력 없음]**
❌ "고려해 보세요" (애매함)
❌ "상담을 받아보세요" (직접 권유)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ PART 5: 의료법 준수 필수 조건
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**모든 의학적 표현 사용 전:**
- Google 검색으로 해당 질환 정보 확인 필수
- 출처: 보건복지부, 질병관리청, 대한OO학회, 국민건강보험공단 등
- 검증되지 않은 의학 정보, 과장된 표현 절대 금지
- 팩트체크 85점 이상 목표
`;

export const recommendImagePrompt = async (blogContent: string, currentImageAlt: string, imageStyle: ImageStyle = 'illustration', customStylePrompt?: string): Promise<string> => {
  const ai = getAiClient();
  
  // 스타일에 따른 프롬프트 가이드 (구체적으로 개선!)
  let styleGuide: string;
  
  if (imageStyle === 'custom' && customStylePrompt) {
    // 🎨 커스텀 스타일: 사용자가 업로드한 참고 이미지 스타일 분석 결과 사용
    styleGuide = `**중요: 사용자가 지정한 커스텀 스타일로 생성해야 합니다!**
       사용자 지정 스타일 프롬프트:
       "${customStylePrompt}"
       
       위 스타일을 최대한 반영하여 프롬프트를 생성하세요.
       레이아웃, 색상, 분위기, 디자인 요소 등을 유지해주세요.`;
  } else if (imageStyle === 'illustration') {
    styleGuide = `**중요: 3D 렌더 일러스트 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "3D rendered illustration", "Blender style", "soft 3D render"
       - 조명: 부드러운 스튜디오 조명, 은은한 그림자
       - 질감: 매끄러운 플라스틱 느낌, 무광 마감, 둥근 모서리
       - 색상: 밝은 파스텔 톤, 파란색/흰색/연한 색상 팔레트
       - 캐릭터: 친근한 표정, 단순화된 디자인
       - 배경: 깔끔한 그라데이션 배경
       ⛔ 금지: photorealistic, real photo, DSLR, realistic texture`;
  } else if (imageStyle === 'medical') {
    styleGuide = `**중요: 의학 3D 일러스트 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "medical 3D illustration", "anatomical render", "scientific visualization"
       - 피사체: 인체 해부학, 장기 단면도, 뼈/근육/혈관 구조
       - 조명: 임상적 조명, X-ray 스타일 글로우, 반투명 장기
       - 질감: semi-transparent organs, detailed anatomical structures
       - 색상: 의료용 팔레트 (파란색, 흰색, 빨간색 혈관)
       - 분위기: clinical, professional, educational
       ⛔ 금지: cute cartoon, photorealistic human face`;
  } else {
    // photo 또는 기타
    styleGuide = `**중요: 실사 사진 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "photorealistic", "real photography", "DSLR shot", "35mm lens"
       - 피사체: 실제 병원 환경, 실제 의료진, 실제 진료 도구
       - 조명: 자연스러운 소프트 조명, 스튜디오 조명, 전문 사진 조명
       - 질감: realistic skin texture, fabric texture, realistic materials
       - 깊이: shallow depth of field, bokeh background
       - 분위기: professional, trustworthy, clean modern hospital
       ⛔ 금지: 3D render, illustration, cartoon, anime, vector, clay`;
  }
  
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: `다음은 병원 블로그 글 내용입니다:

${blogContent.substring(0, 3000)}

현재 이미지 설명: "${currentImageAlt}"

${styleGuide}

이 글의 맥락과 주제에 맞는 이미지 프롬프트를 **딱 1개만** 추천해주세요.

요구사항:
1. 글의 핵심 주제와 연관성 높은 장면
2. 한국 병원 환경에 적합
3. 전문적이고 신뢰감 있는 분위기
4. 구체적인 요소 (인물, 배경, 분위기 등) 포함
5. **텍스트 규칙**: 진짜 필요할 때만 한글/숫자 사용, 영어는 가급적 자제
6. 로고는 절대 포함하지 말 것
7. **위에서 지정한 스타일 키워드를 반드시 프롬프트에 포함할 것!**

**중요: 프롬프트 1개만 출력하세요! 여러 개 출력 금지!**
설명 없이 프롬프트 문장만 **한국어**로 답변하세요.

예시 (1개만):
${imageStyle === 'illustration' 
  ? '"밝은 병원 상담실에서 의사가 환자에게 설명하는 모습, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트"'
  : imageStyle === 'medical'
  ? '"인체 심장의 3D 단면도, 좌심실과 우심실이 보이는 해부학적 구조, 혈관과 판막이 표시된 의학 일러스트, 파란색 배경, 교육용 전문 이미지"'
  : '"깔끔한 병원 상담실에서 의사가 환자와 상담하는 모습, 실사 사진, DSLR 촬영, 자연스러운 조명, 전문적인 분위기"'}:`,
      config: {
        responseMimeType: "text/plain"
      }
    });
    
    return response.text?.trim() || currentImageAlt;
  } catch (error) {
    console.error('프롬프트 추천 실패:', error);
    return currentImageAlt;
  }
};

// 🎴 카드뉴스 전용 AI 프롬프트 추천 - 부제/메인제목/설명 포함!
export const recommendCardNewsPrompt = async (
  subtitle: string,
  mainTitle: string,
  description: string,
  imageStyle: ImageStyle = 'illustration',
  customStylePrompt?: string
): Promise<string> => {
  const ai = getAiClient();
  
  // 스타일 가이드 결정
  let styleKeywords: string;
  if (imageStyle === 'custom' && customStylePrompt) {
    styleKeywords = customStylePrompt;
  } else if (imageStyle === 'illustration') {
    styleKeywords = '3D 일러스트, 클레이 렌더, 파스텔톤, 부드러운 조명';
  } else if (imageStyle === 'medical') {
    styleKeywords = '의학 3D 일러스트, 해부학적 구조, 전문적인 의료 이미지';
  } else {
    styleKeywords = '실사 사진, DSLR 촬영, 자연스러운 조명';
  }
  
  // 커스텀 스타일 여부 확인
  const isCustomStyle = imageStyle === 'custom' && customStylePrompt;
  
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: `당신은 카드뉴스 이미지 프롬프트 전문가입니다.

다음 카드뉴스 텍스트에 어울리는 **배경 이미지 내용**만 추천해주세요.

[카드뉴스 텍스트]
- 부제: "${subtitle || '없음'}"
- 메인 제목: "${mainTitle || '없음'}"  
- 설명: "${description || '없음'}"

[이미지 스타일 - ⚠️ 반드시 이 스타일 유지!]
${styleKeywords}

[출력 형식 - 반드시 이 형식으로!]
subtitle: "${subtitle || ''}"
mainTitle: "${mainTitle || ''}"
${description ? `description: "${description}"` : ''}
비주얼: (여기에 배경 이미지 내용만 작성)

[규칙]
1. subtitle, mainTitle, description은 위 텍스트 그대로 유지
2. "비주얼:" 부분에는 **이미지에 그릴 대상/내용만** 작성 (30자 이내)
3. ${isCustomStyle ? `⚠️ 중요: 그림체/스타일은 "${customStylePrompt}"로 이미 지정되어 있으므로, 비주얼에는 "무엇을 그릴지"만 작성 (수채화, 연필, 볼펜 등 스타일 언급 금지!)` : '비주얼에 스타일과 내용을 함께 작성'}
4. 예: "심장 아이콘과 파란 그라데이션 배경", "병원에서 상담받는 환자"

위 형식대로만 출력하세요. 다른 설명 없이!`,
      config: {
        responseMimeType: "text/plain"
      }
    });
    
    return response.text?.trim() || `subtitle: "${subtitle}"\nmainTitle: "${mainTitle}"\n${description ? `description: "${description}"\n` : ''}비주얼: 밝은 파란색 배경, ${styleKeywords}`;
  } catch (error) {
    console.error('카드뉴스 프롬프트 추천 실패:', error);
    // 실패 시 기본 프롬프트 반환
    return `subtitle: "${subtitle}"\nmainTitle: "${mainTitle}"\n${description ? `description: "${description}"\n` : ''}비주얼: 밝은 파란색 배경, ${styleKeywords}`;
  }
};

// 🧹 공통 프롬프트 정리 함수 - base64/코드 문자열만 제거, 의미있는 텍스트는 유지!
// ⚠️ 주의: 영어 지시문/한국어 텍스트는 절대 삭제하면 안 됨!
const cleanImagePromptText = (prompt: string): string => {
  let cleaned = prompt
    // 1. base64 데이터 URI 제거
    .replace(/data:[^;]+;base64,[A-Za-z0-9+/=]+/g, '')
    // 2. URL 제거
    .replace(/https?:\/\/[^\s]+/g, '')
    // 3. base64 스타일 긴 문자열 제거 - 공백 없이 연속 50자 이상인 경우만! (기존 12자 → 50자로 완화)
    // ⚠️ 영어 지시문("Render Korean text DIRECTLY" 등)이 삭제되지 않도록!
    .replace(/[A-Za-z0-9+/=]{50,}/g, '')
    // 4. 경로 패턴 제거 - 슬래시가 3개 이상 연속인 경우만 (기존: 2개 이상 → 3개 이상으로 완화)
    // ⚠️ "1:1 square" 같은 패턴이 삭제되지 않도록!
    .replace(/[a-zA-Z0-9]{2,}\/[a-zA-Z0-9]+\/[a-zA-Z0-9/]+/g, '')
    // 5. 연속 특수문자 정리
    .replace(/[,.\s]{3,}/g, ', ')
    .replace(/\s+/g, ' ')
    .trim();
  
  // 너무 짧으면 기본값으로 대체 (완전히 비어있는 경우만)
  if (cleaned.length < 5) {
    console.warn('⚠️ 필터링 후 프롬프트가 너무 짧음, 기본값으로 대체:', cleaned);
    cleaned = '의료 건강 정보 카드뉴스, 깔끔한 인포그래픽, 파란색 흰색 배경';
  }
  return cleaned;
};

// 🖼️ 블로그용 일반 이미지 생성 함수 (텍스트 없는 순수 이미지)
export const generateBlogImage = async (
  promptText: string,
  style: ImageStyle,
  aspectRatio: string = "16:9",
  customStylePrompt?: string
): Promise<string> => {
  const ai = getAiClient();

  // 스타일 블록만 사용 (카드뉴스 프레임 없음!)
  const styleBlock = buildStyleBlock(style, customStylePrompt);

  // 블로그용 프롬프트: 텍스트 없는 순수 이미지! (한국어로 생성)
  const finalPrompt = `
블로그 포스트용 전문적인 의료/건강 이미지를 생성해주세요.

${styleBlock}

[이미지 내용]
${promptText}

[디자인 사양]
- 비율: ${aspectRatio} (가로형/랜드스케이프 블로그 형식)
- 스타일: 전문적인 의료/건강 이미지
- 분위기: 신뢰감 있고, 깔끔하며, 현대적인 병원 환경
- 텍스트 없음, 제목 없음, 캡션 없음, 워터마크 없음, 로고 없음
- 순수한 시각적 콘텐츠만 - 블로그 게시물 이미지로 사용됩니다

[필수 요구사항]
✅ 텍스트 오버레이 없는 깔끔한 이미지 생성
✅ 병원 블로그에 적합한 전문적인 의료/건강 이미지
✅ 스타일에 따라 고품질, 상세한 일러스트 또는 사진
✅ 블로그 게시물에 최적화된 가로형 16:9 형식

⛔ 금지사항:
- 한국어 텍스트 금지
- 영어 텍스트 금지
- 제목이나 캡션 금지
- 브라우저 창 프레임 금지
- 카드뉴스 스타일 레이아웃 금지
- 워터마크나 로고 금지
- 텍스트가 포함된 인포그래픽 요소 금지

[출력]
의료 블로그 게시물에 적합한 텍스트 없는 깔끔한 단일 이미지.
`.trim();

  console.log('📷 generateBlogImage - 블로그용 이미지 생성 (텍스트 없음, 16:9)');

  // 재시도 로직
  const MAX_RETRIES = 2;
  let lastError: any = null;

  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
    try {
      console.log(`🎨 블로그 이미지 생성 시도 ${attempt}/${MAX_RETRIES}...`);
      
      const result = await ai.models.generateContent({
        model: "gemini-3-pro-image-preview",
        contents: [{ text: finalPrompt }],
        config: {
          responseModalities: ["IMAGE", "TEXT"],
          temperature: 0.7 + (attempt * 0.1),
        },
      });

      const parts = result?.candidates?.[0]?.content?.parts || [];
      const imagePart = parts.find((p: any) => p.inlineData?.data);
      
      if (imagePart) {
        const mimeType = imagePart.inlineData.mimeType || 'image/png';
        const data = imagePart.inlineData.data;
        console.log(`✅ 블로그 이미지 생성 성공`);
        return `data:${mimeType};base64,${data}`;
      }
      
      lastError = new Error('이미지 데이터를 받지 못했습니다.');
      if (attempt < MAX_RETRIES) {
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
      
    } catch (error: any) {
      lastError = error;
      console.error(`❌ 블로그 이미지 생성 에러:`, error?.message || error);
      if (attempt < MAX_RETRIES) {
        await new Promise(resolve => setTimeout(resolve, 1000 * Math.pow(2, attempt - 1)));
      }
    }
  }

  // 실패 시 플레이스홀더
  console.error('❌ 블로그 이미지 생성 최종 실패:', lastError?.message || lastError);
  const placeholderSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="1600" height="900" viewBox="0 0 1600 900">
    <rect fill="#E8F4FD" width="1600" height="900"/>
    <rect fill="#fff" x="40" y="40" width="1520" height="820" rx="24"/>
    <text x="800" y="430" text-anchor="middle" font-family="Arial,sans-serif" font-size="24" fill="#64748b">이미지 생성에 실패했습니다</text>
    <text x="800" y="470" text-anchor="middle" font-family="Arial,sans-serif" font-size="16" fill="#94a3b8">이미지를 클릭하여 재생성해주세요</text>
  </svg>`;
  const base64Placeholder = btoa(unescape(encodeURIComponent(placeholderSvg)));
  return `data:image/svg+xml;base64,${base64Placeholder}`;
};

// 🎴 기본 프레임 이미지 URL (보라색 테두리 + 흰색 배경)
const DEFAULT_FRAME_IMAGE_URL = 'https://www.genspark.ai/api/files/s/R8v4us3T';

// 기본 프레임 이미지 로드 (캐싱)
let defaultFrameImageCache: string | null = null;
const loadDefaultFrameImage = async (): Promise<string | null> => {
  if (defaultFrameImageCache) return defaultFrameImageCache;
  
  try {
    const response = await fetch(DEFAULT_FRAME_IMAGE_URL);
    if (!response.ok) throw new Error('Failed to fetch default frame');
    const blob = await response.blob();
    const base64 = await new Promise<string>((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result as string);
      reader.readAsDataURL(blob);
    });
    defaultFrameImageCache = base64;
    console.log('✅ 기본 프레임 이미지 로드 완료');
    return base64;
  } catch (error) {
    console.warn('⚠️ 기본 프레임 이미지 로드 실패:', error);
    return null;
  }
};

// 🎴 카드뉴스용 이미지 생성 함수 (텍스트 포함, 보라색 프레임)
export const generateSingleImage = async (
  promptText: string,
  style: ImageStyle,
  aspectRatio: string,
  customStylePrompt?: string,
  referenceImage?: string,
  copyMode?: boolean
): Promise<string> => {
  const ai = getAiClient();

  // 1) 입력 정리: 충돌 문구 제거
  const cleanPromptText = normalizePromptTextForImage(promptText);
  
  // 🎨 참고 이미지가 없으면 기본 프레임 이미지 사용
  let effectiveReferenceImage = referenceImage;
  if (!referenceImage) {
    effectiveReferenceImage = await loadDefaultFrameImage() || undefined;
    console.log('🖼️ 기본 프레임 이미지 사용:', !!effectiveReferenceImage);
  }

  // 2) 프레임/스타일 블록 분리 (프레임은 레이아웃, 스타일은 렌더링)
  const frameBlock = buildFrameBlock(effectiveReferenceImage, copyMode);
  const styleBlock = buildStyleBlock(style, customStylePrompt);

  // 3) 최종 프롬프트 조립: 완성형 카드 이미지 (텍스트가 이미지 픽셀로 렌더링!)
  // 🔧 핵심 텍스트를 프롬프트 상단에 배치하여 모델이 반드시 인식하도록!
  
  // cleanPromptText에서 핵심 텍스트 추출 (다양한 패턴 지원)
  const subtitleMatch = cleanPromptText.match(/subtitle:\s*"([^"]+)"/i) || 
                        cleanPromptText.match(/subtitle:\s*([^\n,]+)/i);
  const mainTitleMatch = cleanPromptText.match(/mainTitle:\s*"([^"]+)"/i) || 
                         cleanPromptText.match(/mainTitle:\s*([^\n,]+)/i);
  const descriptionMatch = cleanPromptText.match(/description:\s*"([^"]+)"/i) ||
                           cleanPromptText.match(/description:\s*([^\n]+)/i);
  // 🎨 비주얼 지시문 추출
  const visualMatch = cleanPromptText.match(/비주얼:\s*([^\n]+)/i) ||
                      cleanPromptText.match(/visual:\s*([^\n]+)/i);
  
  const extractedSubtitle = (subtitleMatch?.[1] || '').trim().replace(/^["']|["']$/g, '');
  const extractedMainTitle = (mainTitleMatch?.[1] || '').trim().replace(/^["']|["']$/g, '');
  const extractedDescription = (descriptionMatch?.[1] || '').trim().replace(/^["']|["']$/g, '');
  const extractedVisual = (visualMatch?.[1] || '').trim();
  
  // 🚨 추출 실패 시 로그 및 원본 사용
  const hasValidText = extractedSubtitle.length > 0 || extractedMainTitle.length > 0;
  if (!hasValidText) {
    console.warn('⚠️ 텍스트 추출 실패! cleanPromptText:', cleanPromptText.substring(0, 200));
  }
  
  // 🔧 텍스트가 없으면 원본 프롬프트 그대로 사용 (라벨 없이!)
  const finalPrompt = hasValidText ? `
🚨🚨🚨 RENDER THIS EXACT KOREAN TEXT IN THE IMAGE 🚨🚨🚨

[TEXT HIERARCHY - MUST FOLLOW EXACTLY!]
📌 MAIN TITLE (BIG, BOLD, CENTER): "${extractedMainTitle}"
📌 SUBTITLE (small, above main title): "${extractedSubtitle}"
${extractedDescription ? `📌 DESCRIPTION (small, below main title): "${extractedDescription}"` : ''}

${extractedVisual ? `[ILLUSTRATION - MUST FOLLOW THIS VISUAL DESCRIPTION!]
🎨 "${extractedVisual}"
⚠️ Draw EXACTLY what is described above! Do NOT change or ignore this visual instruction!` : ''}

Generate a 1:1 square social media card with the Korean text above rendered directly into the image.

${frameBlock}
${styleBlock}

[TEXT LAYOUT - CRITICAL!]
- SUBTITLE: Small text (14-16px), positioned at TOP or above main title
- MAIN TITLE: Large bold text (28-36px), positioned at CENTER, most prominent
- DESCRIPTION: Small text (14-16px), positioned BELOW main title
- Text hierarchy: subtitle(small) → mainTitle(BIG) → description(small)

[DESIGN]
- 1:1 square, background: #E8F4FD gradient
- Border color: #787fff
- Korean text rendered with clean readable font
- Professional Instagram-style card news design
- Illustration at bottom, text at top/center
${extractedVisual ? `- ILLUSTRATION MUST MATCH: "${extractedVisual}"` : ''}

[RULES]
✅ MAIN TITLE must be the LARGEST and most prominent text
✅ Subtitle must be SMALLER than main title
✅ Do NOT swap subtitle and mainTitle positions
✅ Do NOT use placeholder text
${extractedVisual ? `✅ ILLUSTRATION must follow the visual description EXACTLY` : ''}
⛔ No hashtags, watermarks, logos
⛔ Do NOT ignore visual instructions
`.trim() : `
Generate a 1:1 square social media card image.

${frameBlock}
${styleBlock}

[CONTENT TO RENDER]
${cleanPromptText}

[DESIGN]
- 1:1 square, background: #E8F4FD gradient
- Korean text rendered with clean readable font
- Professional Instagram-style card news design

[RULES]
✅ Render the Korean text from the content above
⛔ Do NOT render instruction text like "subtitle:" or "mainTitle:"
⛔ No hashtags, watermarks, logos
`.trim();

  // 🔍 디버그 - 프롬프트 전체 내용 확인!
  console.log('🧩 generateSingleImage 입력 promptText:', promptText.substring(0, 300));
  console.log('🧩 generateSingleImage cleanPromptText:', cleanPromptText.substring(0, 300));
  console.log('🧩 generateSingleImage prompt blocks:', {
    style,
    hasCustomStyle: !!(customStylePrompt && customStylePrompt.trim()),
    hasReferenceImage: !!referenceImage,
    usingDefaultFrame: !referenceImage && !!effectiveReferenceImage,
    copyMode: !!copyMode,
    finalPromptHead: finalPrompt.slice(0, 500),
  });

  // 🔄 재시도 로직: 최대 2회 시도 (빠른 실패 유도)
  const MAX_RETRIES = 2;
  let lastError: any = null;

  // 참고 이미지 파트 준비 (기본 프레임 포함)
  const refImagePart = effectiveReferenceImage && effectiveReferenceImage.startsWith('data:') 
    ? (() => {
        const [meta, base64] = effectiveReferenceImage.split(',');
        const mimeType = (meta.match(/data:(.*?);base64/) || [])[1] || 'image/png';
        return { inlineData: { data: base64, mimeType } };
      })()
    : null;

  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
    try {
      console.log(`🎨 이미지 생성 시도 ${attempt}/${MAX_RETRIES} (gemini-3-pro-image-preview)...`);
      
      // Gemini 3 Pro Image Preview - 이미지 생성 전용 모델 (공식 API 모델명)
      const contents: any[] = refImagePart 
        ? [refImagePart, { text: finalPrompt }]
        : [{ text: finalPrompt }];

      const result = await ai.models.generateContent({
        model: "gemini-3-pro-image-preview",
        contents: contents,
        config: {
          responseModalities: ["IMAGE", "TEXT"],
          temperature: 0.7 + (attempt * 0.1), // 재시도마다 온도 약간 증가
        },
      });

      // 안전 필터 등으로 인한 차단 확인
      const finishReason = result?.candidates?.[0]?.finishReason;
      if (finishReason && finishReason !== 'STOP' && finishReason !== 'MAX_TOKENS') {
        console.warn(`⚠️ 이미지 생성 중단됨 (이유: ${finishReason})`);
        if (finishReason === 'SAFETY' || finishReason === 'RECITATION') {
           throw new Error(`이미지 생성이 안전 정책에 의해 차단되었습니다. (${finishReason})`);
        }
      }

      // 응답에서 이미지 데이터 추출
      const parts = result?.candidates?.[0]?.content?.parts || [];
      const imagePart = parts.find((p: any) => p.inlineData?.data);
      
      if (imagePart) {
        const mimeType = imagePart.inlineData.mimeType || 'image/png';
        const data = imagePart.inlineData.data;
        console.log(`✅ 이미지 생성 성공 (시도 ${attempt}/${MAX_RETRIES})`);
        return `data:${mimeType};base64,${data}`;
      }
      
      // 텍스트 응답만 온 경우 (거절 메시지 등)
      const textPart = parts.find((p: any) => p.text)?.text;
      if (textPart) {
        console.warn(`⚠️ 이미지 대신 텍스트 응답 수신: "${textPart.substring(0, 100)}..."`);
      }

      // inlineData가 없으면 재시도
      console.warn(`⚠️ 이미지 데이터 없음, 재시도 중... (${attempt}/${MAX_RETRIES})`);
      lastError = new Error('이미지 데이터를 받지 못했습니다.');
      
      // 재시도 전 짧은 대기
      if (attempt < MAX_RETRIES) {
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
      
    } catch (error: any) {
      lastError = error;
      console.error(`❌ 이미지 생성 에러 (시도 ${attempt}/${MAX_RETRIES}):`, error?.message || error);
      
      // 재시도 전 짧은 대기 (지수 백오프)
      if (attempt < MAX_RETRIES) {
        const waitTime = 1000 * Math.pow(2, attempt - 1); // 1초, 2초, 4초
        console.log(`⏳ ${waitTime/1000}초 후 재시도...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
    }
  }

  // 모든 재시도 실패 시 - 플레이스홀더 이미지 반환 (에러 방지)
  console.error('❌ 이미지 생성 최종 실패 (재시도 후):', lastError?.message || lastError);
  console.error('📝 사용된 프롬프트 (앞 250자):', finalPrompt.slice(0, 250));
  
  // 플레이스홀더 SVG 이미지 (빈 문자열 대신 반환하여 UI 오류 방지)
  const placeholderSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800">
    <rect fill="#E8F4FD" width="800" height="800"/>
    <rect fill="#fff" x="40" y="40" width="720" height="720" rx="24"/>
    <text x="400" y="380" text-anchor="middle" font-family="Arial,sans-serif" font-size="24" fill="#64748b">이미지 생성에 실패했습니다</text>
    <text x="400" y="420" text-anchor="middle" font-family="Arial,sans-serif" font-size="16" fill="#94a3b8">카드를 클릭하여 재생성해주세요</text>
  </svg>`;
  const base64Placeholder = btoa(unescape(encodeURIComponent(placeholderSvg)));
  return `data:image/svg+xml;base64,${base64Placeholder}`;
};


export const getTrendingTopics = async (category: string): Promise<TrendingItem[]> => {
  const ai = getAiClient();
  const now = new Date();
  const koreaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const year = koreaTime.getFullYear();
  const month = koreaTime.getMonth() + 1;
  const day = koreaTime.getDate();
  const hour = koreaTime.getHours();
  const dateStr = `${year}년 ${month}월 ${day}일 ${hour}시`;
  
  // Gemini AI 기반 트렌드 분석 (구글 검색 기반)
  const response = await ai.models.generateContent({
    model: 'gemini-3-pro-preview',
    contents: `[현재 시각: ${dateStr} (한국 표준시)]

'${category}' 진료과와 관련된 건강/의료 트렌드 5가지를 분석해주세요.

[점수 산정 기준]
1. SEO 적합도 점수(0~100): 뉴스 보도량 + 대중적 관심도가 높을수록, 블로그 경쟁도가 낮을수록 높은 점수
2. 점수 높은 순서대로 정렬

[제약조건]
1. 실제 '질병명', '증상', '치료법', '건강 뉴스' 내용만 추출
2. seasonal_factor에는 "왜 지금 이 주제가 뜨는지" 근거를 짧게 작성
3. ${month}월 계절적 특성 반영 (예: 1월=독감/동상, 7월=열사병/식중독 등)`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            topic: { type: Type.STRING },
            keywords: { type: Type.STRING },
            score: { type: Type.NUMBER },
            seasonal_factor: { type: Type.STRING }
          },
          required: ["topic", "keywords", "score", "seasonal_factor"]
        }
      }
    }
  });
  return JSON.parse(response.text || "[]");
};

export const recommendSeoTitles = async (topic: string, keywords: string, postType: 'blog' | 'card_news' = 'blog'): Promise<SeoTitleItem[]> => {
  const ai = getAiClient();
  
  // 현재 날짜/계절 정보 추가 (트렌드와 동일하게)
  const now = new Date();
  const koreaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const currentYear = koreaTime.getFullYear();
  const currentMonth = koreaTime.getMonth() + 1;
  const seasons = ['겨울', '겨울', '봄', '봄', '봄', '여름', '여름', '여름', '가을', '가을', '가을', '겨울'];
  const currentSeason = seasons[currentMonth - 1];
  
  const contentTypeDesc = postType === 'card_news' 
    ? '인스타그램/네이버 카드뉴스' 
    : '네이버 블로그';
  
  const lengthGuide = postType === 'card_news'
    ? '15~25자 이내 (카드뉴스 표지 최적화)'
    : '28~38자 이내 (모바일 최적화)';
  
  const prompt = `너는 대한민국 ${currentYear}년 의료광고법을 숙지한 '${contentTypeDesc}' 전문 에디터다.

[📅 현재 시점: ${currentYear}년 ${currentMonth}월 (${currentSeason})]
- ${currentYear}년 최신 의료광고법 기준 적용
- ${currentSeason} 계절 키워드 적극 활용 (예: ${currentSeason === '겨울' ? '겨울철, 난방기, 건조한' : currentSeason === '여름' ? '여름철, 무더위, 습한' : currentSeason === '봄' ? '봄철, 환절기, 꽃가루' : '가을철, 환절기, 선선한'})

[🎯 미션]
의료광고법을 100% 준수하면서 검색 클릭률이 높은 ${postType === 'card_news' ? '카드뉴스 표지' : '블로그'} 제목을 생성한다.

[📌 주제] ${topic}
[📌 SEO 키워드] ${keywords}

████████████████████████████████████████████████████████████████████████████████
[🚨 제목 생성 원칙 - 필수 준수!]
████████████████████████████████████████████████████████████████████████████████

1️⃣ 과장·보장·공포 조장 표현 금지
   ❌ 완치, 예방, 최고, 1등, 돌연사, 반드시, 특효, 100%, 확실히
   ❌ 골든타임, 48시간 내, 즉시 등 시간 압박 표현

2️⃣ 특정 병원명·의원명·브랜드명 절대 금지
   ❌ "XX병원", "OO의원", "△△클리닉" 등 고유명사 금지
   ❌ 제목에 병원/의원/클리닉 이름을 넣지 마세요!
   ✅ 일반적인 의료 정보 제목만 작성

3️⃣ 직접 행동 유도 금지
   ❌ 방문하세요, 예약하세요, 상담하세요, 확인하세요, 검사받으세요
   ❌ ~하세요 명령형 전부 금지!

4️⃣ 제목 형식: '질문형' 또는 '판단 유도형'으로 작성
   ✅ "~일까요?"
   ✅ "~이유"
   ✅ "~시점"
   ✅ "~구분법"
   ✅ "~체크 포인트" (단, "체크하세요" 금지)

5️⃣ 제목에서 질환명 노출 강도 조절 (🚨중요!)
   - 질환명이 제목 맨 앞에 직접 등장하면 "질환 단정 유도"로 해석될 수 있음
   - ❌ "갑상선기능저하증 증상, 추위 타는 이유?" → 질환명 맨 앞 노출
   - ✅ "남들보다 유난히 추위를 탄다면? 갑상선 기능 체크 포인트" → 증상 먼저, 질환명 뒤로
   - ✅ "겨울마다 유독 추위를 탄다면, 갑상선 기능과 연관이 있을까요?"
   - 📌 원칙: 일상 증상으로 진입 → 질환 가능성 언급 순서로!
   - 📌 본문에서 질환명 충분히 설명하므로 제목에서는 한 단계 완화!

5️⃣ 질환명은 단정하지 말고 가능성 구조 사용
   ✅ "~증상일 수 있는"
   ✅ "~의심될 수 있는"
   ✅ "~구분이 필요한"
   ❌ "당신은 ~입니다" (단정 금지)

6️⃣ 계절·상황·행동 맥락을 포함해 검색 의도 정확히 겨냥
   ✅ 겨울철, 아침, 반복되는, 씻고 나서, 밤마다, 식후에 등

7️⃣ 메인 키워드는 제목 앞부분에 배치 (네이버 SEO 기준)
   ✅ "피부건조 원인, 겨울철에 심해지는 이유"
   ❌ "겨울철에 심해지는 피부건조 원인"

8️⃣ 제목 길이: ${lengthGuide}

9️⃣ 감정 어휘는 사용하되 자극적으로 쓰지 않는다
   ✅ 답답한, 찝찝한, 불편한, 반복되는 (허용)
   ❌ 무섭다, 위험하다, 심각하다 (금지)

████████████████████████████████████████████████████████████████████████████████
[🎨 출력 요구사항]
████████████████████████████████████████████████████████████████████████████████

- 제목 5개 제안
- 각 제목은 서로 다른 심리 트리거 사용:
  1. 호기심형 (궁금증 유발)
  2. 공감형 (독자 상황 공감)
  3. 판단유도형 (스스로 판단하게)
  4. 시기고정형 (특정 시점/상황)
  5. 구분구조형 (A vs B, 차이점)

- SEO 점수: 70~95점 사이로 현실적으로 평가
- type: 위 5가지 트리거 중 하나 (호기심/공감/판단유도/시기고정/구분구조)`;
  
  const response = await ai.models.generateContent({
    model: 'gemini-3-pro-preview',
    contents: prompt,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            score: { type: Type.NUMBER },
            type: { type: Type.STRING, enum: ['호기심', '공감', '판단유도', '시기고정', '구분구조'] }
          },
          required: ["title", "score", "type"]
        }
      }
    }
  });
  return JSON.parse(response.text || "[]");
};

// 카드뉴스 스타일 참고 이미지 분석 함수 (표지/본문 구분)
export const analyzeStyleReferenceImage = async (base64Image: string, isCover: boolean = false): Promise<string> => {
  const ai = getAiClient();
  
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: [
        {
          role: 'user',
          parts: [
            {
              inlineData: {
                mimeType: base64Image.includes('png') ? 'image/png' : 'image/jpeg',
                data: base64Image.split(',')[1] // base64 데이터만 추출
              }
            },
            {
              text: `이 카드뉴스/인포그래픽 이미지의 **디자인 스타일과 일러스트 그림체**를 매우 상세히 분석해주세요.

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 최우선 목표: "같은 시리즈"로 보이게 할 일관된 스타일만 추출! 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

⚠️ [중요] 이 분석은 "스타일/프레임"만 추출합니다. 이미지 속 "내용물"은 분석하지 마세요!
- ❌ 이미지 속 일러스트가 "무엇인지" (돼지, 사람, 돈 등) → 분석 불필요!
- ❌ 이미지 속 텍스트가 "무슨 내용인지" → 분석 불필요!
- ✅ 일러스트의 "그리는 방식/기법" (3D, 플랫, 수채화 등) → 분석 필요!
- ✅ 색상 팔레트, 프레임 형태, 레이아웃 구조 → 분석 필요!

**이 이미지는 ${isCover ? '표지(1장)' : '본문(2장 이후)'} 스타일 참고용입니다.**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎨 [1단계] 일러스트/그림체 DNA 분석 (가장 중요!)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. **그림체 종류** (정확히 하나만 선택):
   - 3D 클레이/점토 렌더링 (Blender/Cinema4D 느낌)
   - 3D 아이소메트릭 일러스트
   - 플랫 벡터 일러스트 (미니멀)
   - 수채화/손그림 스타일
   - 캐릭터 일러스트 (귀여운/키치)
   - 실사 사진 / 포토리얼
   - 선화+채색 일러스트
   - 그라데이션 글래스모피즘

2. **렌더링 특징**:
   - 조명: 부드러운 스튜디오 조명 / 강한 그림자 / 플랫 조명
   - 질감: 광택 있는 / 무광 매트 / 반투명
   - 외곽선: 없음 / 가는 선 / 굵은 선
   - 깊이감: 얕은 피사계심도 / 등각투영 / 완전 플랫

3. **색상 팔레트** (정확한 HEX 코드 5개):
   - 주 배경색: #______
   - 주 강조색: #______
   - 보조색 1: #______
   - 보조색 2: #______
   - 텍스트색: #______

4. **캐릭터/오브젝트 스타일** (있다면):
   - 얼굴 표현: 심플한 점 눈 / 큰 눈 / 없음
   - 비율: 2등신 귀여움 / 리얼 비율 / 아이콘형
   - 표정: 미소 / 무표정 / 다양함

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📐 [2단계] 레이아웃/프레임 분석
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
5. **프레임 스타일**: 
   - 둥근 테두리 카드?
   - 테두리 색상(HEX)과 굵기(px)

6. **텍스트 스타일**:
   - 부제목: 색상, 굵기
   - 메인 제목: 색상, 굵기, 강조 방식
   - 설명: 색상

7. **일러스트 배치**: top / center / bottom, 크기 비율(%)

**반드시 JSON 형식으로 답변 (illustStyle 필드 필수!):**
{
  "illustStyle": {
    "type": "3D 클레이 렌더링 / 플랫 벡터 / 아이소메트릭 / 수채화 / 실사",
    "lighting": "부드러운 스튜디오 조명 / 플랫 / 강한 그림자",
    "texture": "광택 매끄러움 / 무광 매트 / 반투명",
    "outline": "없음 / 가는 선 / 굵은 선",
    "characterStyle": "2등신 귀여움 / 리얼 비율 / 심플 아이콘",
    "colorPalette": ["#주배경", "#강조색", "#보조1", "#보조2", "#텍스트"],
    "promptKeywords": "이 스타일을 재현하기 위한 영어 키워드 5-8개 (예: 3D clay render, soft shadows, pastel colors, rounded shapes, studio lighting)"
  },
  "frameStyle": "rounded-card / rectangle",
  "backgroundColor": "#E8F4FD",
  "borderColor": "#787fff",
  "borderWidth": "2px",
  "borderRadius": "16px",
  "boxShadow": "0 4px 12px rgba(0,0,0,0.1)",
  "subtitleStyle": { "color": "#6B7280", "fontSize": "14px", "fontWeight": "500" },
  "mainTitleStyle": { "color": "#1F2937", "fontSize": "28px", "fontWeight": "700" },
  "highlightStyle": { "color": "#787fff", "backgroundColor": "transparent" },
  "descStyle": { "color": "#4B5563", "fontSize": "16px" },
  "tagStyle": { "backgroundColor": "#F0F0FF", "color": "#787fff", "borderRadius": "20px" },
  "illustPosition": "bottom",
  "illustSize": "60%",
  "padding": "24px",
  "mood": "밝고 친근한 / 전문적인 / 따뜻한 등",
  "keyFeatures": ["3D 클레이 렌더링", "파스텔 색상", "둥근 형태", "부드러운 그림자"],
  "styleReproductionPrompt": "이 이미지 스타일을 정확히 재현하기 위한 완전한 영어 프롬프트 1-2문장"
}`
            }
          ]
        }
      ],
      config: {
        responseMimeType: "application/json"
      }
    });
    
    return response.text || '{}';
  } catch (error) {
    console.error('스타일 분석 실패:', error);
    return '{}';
  }
};

// ============================================
// 🤖 미니 에이전트 방식 카드뉴스 생성 시스템
// ============================================

// 슬라이드 스토리 타입 정의
interface SlideStory {
  slideNumber: number;
  slideType: 'cover' | 'concept' | 'content' | 'closing';
  subtitle: string;      // 4-8자 (짧고 임팩트있게!)
  mainTitle: string;     // 10-18자 (강조 부분 <highlight>로 표시)
  description: string;   // 15-25자 (판단 1줄! 설명 아님!)
  tags: string[];        // 해시태그 2-3개
  imageKeyword: string;  // 이미지 핵심 키워드
}

interface CardNewsStory {
  topic: string;
  totalSlides: number;
  slides: SlideStory[];
  overallTheme: string;
}

// [1단계] 스토리 기획 에이전트
const storyPlannerAgent = async (
  topic: string, 
  category: string, 
  slideCount: number,
  writingStyle: WritingStyle
): Promise<CardNewsStory> => {
  const ai = getAiClient();
  const currentYear = getCurrentYear();
  
  const prompt = `당신은 **전환형 카드뉴스** 스토리 기획 전문가입니다.

[🎯 미션] "${topic}" 주제로 ${slideCount}장짜리 **전환형** 카드뉴스를 기획하세요.

${CONTENT_DESCRIPTION}

[📅 현재: ${currentYear}년 - 보수적 해석 원칙]
- ${currentYear}년 기준 보건복지부·의료광고 심의 지침을 반영
- **불확실한 경우 반드시 보수적으로 해석**
- 출처 없는 수치/시간/확률 표현 금지

[진료과] ${category}
[글 스타일] ${writingStyle === 'expert' ? '전문가형(신뢰·권위)' : writingStyle === 'empathy' ? '공감형(독자 공감)' : '전환형(정보→확인 유도)'}

🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨
[📱 카드뉴스 핵심 원칙 - 블로그와 완전히 다름!]
🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨

❌ 블로그 = "읽고 이해"
✅ 카드뉴스 = "보고 판단" (3초 안에!)

[🔑 카드뉴스 황금 공식]
❌ 설명 70% → ✅ 판단 70%
❌ "왜냐하면..." → ✅ "이때는..."
❌ 문장 2~3줄 설명 → ✅ 판단 1줄로 끝

[🧠 심리 구조: 질문 → 끊기 → 판단 → 다음카드]
- 각 카드는 "멈춤 → 판단 → 넘김"을 유도해야 함
- 설명하면 스크롤 멈춤력이 떨어짐!

[🚨🚨🚨 카드별 심리적 역할 - ${slideCount}장 기준 🚨🚨🚨]

**1장 - 표지 (멈추게 하는 역할만!)**
- subtitle: 4~8자 (예: "겨울철에 유독?", "혹시 나도?")
- mainTitle: 10~15자, 질문형 (예: "겨울철 혈관 신호일까요?")
- description: "" ← 🚨 표지는 description 완전히 비워두세요! 빈 문자열 ""로!
- 💡 표지는 제목+부제만! 설명 없음!

**2장 - 오해 깨기 (판단 유도)**
- subtitle: 4~8자 (예: "단순한 추위 때문?")
- mainTitle: 질문형으로 착각 깨기 (예: "생활 관리만으로 충분할까요?")
- description: ❌ 긴 설명 금지! 판단 1줄만 (예: "따뜻하게 입어도 해결되지 않는 신호가 있습니다")

${slideCount >= 5 ? `**3장 - 증상 명확화 (핵심만)**
- subtitle: 4~8자 (예: "놓치기 쉬운 신호들")
- mainTitle: 증상 나열 (예: "반복되는 두통\\n숨이 차는 느낌이 계속된다면")
- description: 한 줄 판단 (예: "피로나 스트레스와 구분이 필요할 수 있습니다")` : ''}

${slideCount >= 6 ? `**4장 - 자가 판단의 한계**
- subtitle: 4~8자 (예: "자가 판단의 한계")  
- mainTitle: 핵심 메시지만 (예: "증상만으로는 원인을 구분하기 어렵습니다")
- description: ❌ 설명 삭제 또는 최소화` : ''}

${slideCount >= 7 ? `**5~${slideCount-2}장 - 시점 고정 (🔥 핵심! 🔥)**
- 추가 정보보다 "시점 고정"에 집중
- 생활습관 카드는 최대 1장만!` : ''}

**${slideCount-1}장 - 시점 고정**
- subtitle: 4~8자 (예: "확인이 필요한 순간")
- mainTitle: (예: "사라졌다 다시 나타난다면\\n확인이 필요한 시점입니다")
- description: 최소화

**${slideCount}장 - 마지막 표지/CTA (명령형 금지! + 전환력 강화!)**
- subtitle: 4~8자 (예: "미루지 않는 습관", "지금이 그때")
- mainTitle: "왜 지금이어야 하는지" 이유를 담아라!
  ✅ "지켜보기보다 관리 방향을 정할 시점"
  ✅ "이 단계에서는 넘기기보다 살펴볼 때입니다"
  ✅ "반복된다면 기준이 필요합니다"
  ❌ "~하세요" 명령형 금지!
  ❌ "가장 빠른 첫걸음" (너무 착함, 전환력 약함)
- description: "" ← 🚨 마지막 장도 description 완전히 비워두세요! 빈 문자열 ""로!
- 💡 마지막 장은 표지처럼 제목+부제만! 설명 없음!
- ❌ "혈액 검사로 확인하세요" 같은 명령형 금지!
- ❌ "의료기관을 찾아..." 문장 금지!
- 🔥 핵심: "왜 지금?" + "미루면 어떻게?" 두 메시지 중 하나 포함!

[📝 텍스트 분량 규칙 - 카드뉴스용!]
- subtitle: 4~8자 (질문/상황 표현)
  ✅ "겨울철에 유독?", "혹시 나도?", "놓치기 쉬운 신호들"
  ❌ "왜 중요할까요?" (너무 일반적)
  
- mainTitle: 10~18자, 줄바꿈 포함, <highlight>로 강조
  ✅ "가슴 답답함·두통\\n<highlight>혈관 신호</highlight>일까요?"
  ❌ "혈관 건강 체크 신호일까요?" (체크=행동유도 느낌)
  
- description: 15~25자의 판단 1줄! (설명 아님!)
  ✅ "따뜻하게 입어도 해결되지 않는 신호가 있습니다"
  ✅ "피로나 컨디션 변화 등 다른 원인에서도 나타날 수 있습니다"
  ✅ "식습관과 생활 습관에 따라 개인차가 큽니다"
  ❌ "기온 변화에 따른 혈관 수축은 자가 관리 영역을 넘어 전문적인 확인이 필요한 경우가..." (너무 긺)
  ❌ "매년 건강보험 혜택을 통해 비용 부담을 줄인 확인이 가능합니다..." (너무 긺)

[🔄 단어 반복 금지 - 리듬 유지!]
⚠️ 같은 단어가 2회 이상 나오면 카드뉴스 리듬이 죽습니다!
- "확인" 대신 → 점검, 살피다, 상태 보기, 파악
- "관리" 대신 → 케어, 돌봄, 유지, 습관
- "필요" 대신 → 중요, 의미있는, 시점
- "시점" 대신 → 순간, 타이밍, 때, 단계
👉 의미는 유지하고 단어는 분산!

[🚨🚨🚨 의료법 준수 - 최우선! 🚨🚨🚨]

**절대 금지 표현:**
❌ "즉시 상담", "바로 상담", "지금 상담"
❌ "전문의 상담", "전문의와 상담하세요"
❌ "병원 방문", "내원하세요", "예약하세요"
❌ "검진 받으세요", "진료 받으세요", "검사 받으세요"
❌ "~하세요" 명령형 전부!
❌ "완치", "최고", "보장", "확실히", "체크"
❌ "골든타임", "48시간 내" 등 구체적 시간 표현

**안전한 대체 표현:**
✅ "확인이 필요한 시점입니다"
✅ "지켜보기보다 확인이 먼저입니다"
✅ "전문적인 판단이 필요할 수 있습니다"
✅ "개인차가 있을 수 있습니다"
❌ "~를 고려해볼 수 있어요" (너무 약함)

[⚠️ 생활습관 카드 제한]
- 생활습관(운동, 식단, 금연 등) 카드는 **최대 1장**만
- 생활습관이 핵심 메시지(확인 시점)를 대체하면 안 됨!

[❌ 금지]
- "01.", "첫 번째" 등 번호 표현
- "해결책 1", "마무리" 등 프레임워크 용어
- 출처 없는 구체적 수치/시간/확률 표현

[✅ 슬라이드 연결]
- 이전 슬라이드와 자연스럽게 이어지도록
- **심리 흐름**: 주의환기 → 오해깨기 → 증상명확화 → 자가판단한계 → 시점고정 → CTA

[🎯 최종 체크리스트]
1. 🚨 1장(표지)의 description이 비어있는가? → 반드시 "" 빈 문자열로!
2. 🚨 마지막 장의 description이 비어있는가? → 반드시 "" 빈 문자열로!
3. 각 카드 description이 2줄 이상인가? → 1줄(15~25자)로 줄여라!
4. "~하세요" 명령형이 있는가? → "~시점입니다", "~단계입니다"로 바꿔라!
5. 설명이 판단보다 많은가? → '이유 설명' 삭제, 판단만 남겨라!
6. "확인/점검" 같은 단어가 2번 이상 반복되는가? → 분산시켜라! (살피다, 상태보기, 파악 등)
7. CTA가 너무 착한가? → "왜 지금이어야 하는지" 이유 추가!
8. CTA에 시술명(스킨부스터 등)이 있는가? → "관리 방향", "관리 기준"으로 대체!
9. "맞춤형", "개인맞춤" 표현이 있는가? → "상태에 맞는"으로 대체!

████████████████████████████████████████████████████████████████████████████████
🏥 [심의 통과 핵심 규칙] 병원 카드뉴스 톤 미세 조정 - 5% 완화!
████████████████████████████████████████████████████████████████████████████████

**🚨 심의 탈락 방지 - 핵심 3가지 조정 포인트 🚨**

**📌 10. 합병증 언급 시 - '예방' 단어 금지! (가장 중요!)**
- ❌ "합병증 예방을 위해 초기 확인이 중요해요" → '예방'이 치료 효과 암시로 해석됨!
- ❌ "합병증을 예방하려면..." → 치료 효과 기대 유발
- ✅ "증상 경과를 살피는 것이 중요한 이유"
- ✅ "고위험군에서는 경과 관찰이 더 중요합니다"
- ✅ "일부 경우에는 증상 경과에 따라 추가적인 관리가 필요해질 수 있다는 점이 보고되고 있습니다"
- ✅ "특히 고령층이나 어린이는 증상 변화를 주의 깊게 살피는 것이 도움이 됩니다"
- 📌 핵심: '예방' → '경과 관찰', '살피는 것'으로 대체!

**📌 11. 시점 고정 카드 - '회복' 단어 톤 다운!**
- ❌ "회복 과정에 도움이 될 수 있습니다" → 치료 효과 암시
- ❌ "빠른 회복을 위해" → 결과 보장 느낌
- ✅ "이후 관리 방향을 정하는 데 도움이 될 수 있습니다"
- ✅ "상태에 맞는 관리 방향을 확인해보는 것도 고려해볼 수 있습니다"
- 📌 핵심: '회복' → '관리 방향', '관리 기준'으로 대체!

**📌 12. 전파/감염 표현 완화 - 책임 강조 느낌 제거!**
- ❌ "주변 가족이나 동료에게 영향을 줄 가능성도 함께 고려해볼 필요" → 전파 책임 강조 느낌
- ❌ "사랑하는 가족에게 전파될 수 있습니다" → 불안 조장
- ✅ "주변 사람들과의 생활 환경을 함께 고려해볼 필요도 있습니다"
- ✅ "함께 생활하는 분들의 건강도 함께 신경 쓰게 되는 상황이 있을 수 있습니다"
- 📌 핵심: '전파/영향' → '생활 환경', '함께 신경 쓰게 되는'으로 완화!

**📌 13. 행동 결정 유도 - 단정 → 가능성 표현!**
- ❌ "지켜볼 단계는 지났을 수 있습니다" → 결정 유도형, 살짝 강함
- ❌ "이미 지난 시점입니다" → 단정형
- ✅ "지켜보기보다 한 번쯤 원인을 구분해볼 시점일 수 있습니다"
- ✅ "확인이 필요한 시점일 수 있습니다"
- ✅ "점검해볼 타이밍일 수 있습니다"
- 📌 핵심: '지났습니다' → '시점일 수 있습니다'로 가능성 표현!

[🏥 병원 카드뉴스 톤 최적화 - 광고 느낌 제거 + 심의 통과!]

**14. mainTitle 단정형 어미 완화:**
- ❌ "~입니다" 단정형 → 살짝 강하게 느껴질 수 있음
- ✅ "~하는 순간", "~의 변화", "~일 수 있습니다"
- 예시:
  ❌ "따뜻한 이불 속과 차가운 아침 공기, 혈관의 반응입니다"
  ✅ "따뜻한 이불 속과 차가운 아침 공기, 혈관이 반응하는 순간"
  ✅ "따뜻한 실내에서 차가운 아침 공기로 나설 때, 혈관의 변화"

**15. '전문가' 직접 언급 금지:**
- ❌ subtitle/mainTitle에 "전문가", "전문의" 직접 등장 금지
- ✅ description에서도 가급적 언급하지 않는 게 더 안전
- 📌 이유: 본문에 '전문가'가 없으면 오히려 광고 느낌이 줄어듦

**16. CTA(마지막 장) 해시태그 위치 규칙:**
- ❌ subtitle에 해시태그 직접 넣기 → 광고 느낌!
  예: subtitle: "#겨울철혈압 #아침두통 #혈압관리"
- ✅ subtitle은 순수 텍스트로, 해시태그는 tags 배열에만!
  예: subtitle: "건강한 겨울을 위한 작은 점검"
       tags: ["겨울철혈압", "아침두통", "혈압관리"]
- 📌 해시태그가 CTA 부제에 들어가면 의료기관 톤이 아니라 광고 톤이 됨

**17. 표지(1장) 제목 성공 공식 - 시기성 강화!:**
- ✅ 시기성 + 일상 증상 + 의심 프레임 + 확인 기준
- ✅ "요즘", "겨울철", "환절기" 등 시기 표현 추가 시 클릭률 상승
- ✅ 질환 단정 없음, 질문형 유지
- 예시 (CTR 높은 유형):
  ✅ "요즘 으슬으슬한 오한, 단순 추위가 아닐 수 있어요"
  ✅ "겨울철 아침마다 뒷목이 뻐근하다면? 혈압 변화 확인 포인트"
  ✅ "환절기에 유독 심한 두통, 단순 피로일까요?"

**18. 증상 제시 카드 - 다른 원인 완충 필수:**
- ✅ description에 "다른 원인으로도 나타날 수 있어" 완충 문장 포함
- 예시:
  "다만, 이는 수면 자세나 스트레스 등 다른 원인으로도 나타날 수 있어 증상만으로 단정하기 어렵습니다"
- 📌 자가 대입 ✔ + 단정 회피 ✔ + 불안 완충 ✔ = 의료법 안전

**19. 확인 시점 카드 - 핵심 전환 장 (🔥심의 핵심!🔥):**
- ✅ "~일 수 있습니다" 가능성 표현 필수
- ✅ "반복된다면"이라는 조건부 전환 사용
- ❌ "지켜볼 단계는 지났습니다" → 결정 유도형, 살짝 강함
- ✅ "지켜보기보다 한 번쯤 원인을 구분해볼 시점일 수 있습니다"
- 예시:
  mainTitle: "반복되는 불편함, 확인이 필요한 시점일 수 있습니다"
- 📌 내원 강요 ❌ / 시점 고정 ✔ = 전환력 최고

**20. 감기/독감 등 감염성 질환 카드 - 전파 표현 톤 다운:**
- ❌ "주변 가족에게 영향을 줄 가능성" → 전파 책임 강조 느낌
- ✅ "주변 사람들과의 생활 환경을 함께 고려해볼 필요도 있습니다"
- 📌 전파보다 '함께 생활하는 환경' 프레임으로!

[💡 CTA 카드 모범 답안 - 전환력 강화 버전!]
✅ mainTitle 예시 (왜 지금인지 이유 포함!):
  - "지켜보기보다\\n관리 방향을 정할 시점"
  - "반복된다면\\n기준이 필요합니다"
  - "이 단계에서는\\n넘기기보다 살펴볼 때입니다"
  - "지금의 불편함을 넘기면\\n더 긴 관리가 필요해질 수 있습니다"
✅ description: "" (빈 문자열 - 표지처럼!)
→ 명령 ❌ / 판단 ⭕
→ "왜 지금?" 이유 필수!

[📋 출력 필드]
- topic: 주제 (한국어)
- totalSlides: 총 슬라이드 수
- overallTheme: 전체 구조 설명 (⚠️ 반드시 한국어! 영어 금지! 20자 이내)
  예: "공감과 정보 전달" / "증상 체크 → 확인 안내" / "건강 정보 공유"
- slides: 슬라이드 배열`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        tools: [{ googleSearch: {} }],
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            topic: { type: Type.STRING },
            totalSlides: { type: Type.INTEGER },
            overallTheme: { type: Type.STRING },
            slides: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  slideNumber: { type: Type.INTEGER },
                  slideType: { type: Type.STRING },
                  subtitle: { type: Type.STRING },
                  mainTitle: { type: Type.STRING },
                  description: { type: Type.STRING },
                  tags: { type: Type.ARRAY, items: { type: Type.STRING } },
                  imageKeyword: { type: Type.STRING }
                },
                required: ["slideNumber", "slideType", "subtitle", "mainTitle", "description", "tags", "imageKeyword"]
              }
            }
          },
          required: ["topic", "totalSlides", "slides", "overallTheme"]
        }
      }
    });
    
    const result = JSON.parse(response.text || "{}");
    
    // 🚨 후처리: 1장(표지)과 마지막 장의 description 강제로 빈 문자열로!
    if (result.slides && result.slides.length > 0) {
      // 1장 (표지) description 제거
      result.slides[0].description = "";
      
      // 마지막 장 description 제거
      if (result.slides.length > 1) {
        result.slides[result.slides.length - 1].description = "";
      }
      
      console.log('🚨 표지/마지막 장 description 강제 제거 완료');
    }
    
    return result;
  } catch (error) {
    console.error('스토리 기획 에이전트 실패:', error);
    throw error;
  }
};

// 분석된 스타일 전체 인터페이스
interface AnalyzedStyle {
  frameStyle?: string;
  hasWindowButtons?: boolean;
  windowButtonColors?: string[];
  backgroundColor?: string;
  borderColor?: string;
  borderWidth?: string;
  borderRadius?: string;
  boxShadow?: string;
  subtitleStyle?: { color?: string; fontSize?: string; fontWeight?: string; };
  mainTitleStyle?: { color?: string; fontSize?: string; fontWeight?: string; };
  highlightStyle?: { color?: string; backgroundColor?: string; };
  descStyle?: { color?: string; fontSize?: string; };
  tagStyle?: { backgroundColor?: string; color?: string; borderRadius?: string; };
  illustPosition?: string;
  illustSize?: string;
  padding?: string;
  mood?: string;
  keyFeatures?: string[];
}

// [2단계] HTML 조립 함수 (분석된 스타일 전체 적용)
const assembleCardNewsHtml = (
  story: CardNewsStory,
  styleConfig?: AnalyzedStyle
): string => {
  const bgColor = styleConfig?.backgroundColor || '#E8F4FD';
  const bgGradient = `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
  const accentColor = styleConfig?.borderColor || '#3B82F6';
  
  // 분석된 스타일 적용 (기본값 포함)
  const borderRadius = styleConfig?.borderRadius || '24px';
  const boxShadow = styleConfig?.boxShadow || '0 4px 16px rgba(0,0,0,0.08)';
  const borderWidth = styleConfig?.borderWidth || '0';
  const padding = styleConfig?.padding || '32px 28px';
  
  const subtitle = {
    color: styleConfig?.subtitleStyle?.color || accentColor,
    fontSize: styleConfig?.subtitleStyle?.fontSize || '14px',
    fontWeight: styleConfig?.subtitleStyle?.fontWeight || '700'
  };
  
  const mainTitle = {
    color: styleConfig?.mainTitleStyle?.color || '#1E293B',
    fontSize: styleConfig?.mainTitleStyle?.fontSize || '26px',
    fontWeight: styleConfig?.mainTitleStyle?.fontWeight || '900'
  };
  
  const highlight = {
    color: styleConfig?.highlightStyle?.color || accentColor,
    backgroundColor: styleConfig?.highlightStyle?.backgroundColor || 'transparent'
  };
  
  const desc = {
    color: styleConfig?.descStyle?.color || '#475569',
    fontSize: styleConfig?.descStyle?.fontSize || '15px'
  };
  
  const tag = {
    backgroundColor: styleConfig?.tagStyle?.backgroundColor || `${accentColor}15`,
    color: styleConfig?.tagStyle?.color || accentColor,
    borderRadius: styleConfig?.tagStyle?.borderRadius || '20px'
  };
  
  // 브라우저 윈도우 버튼 HTML (분석된 스타일에 있으면 적용)
  const windowButtonsHtml = styleConfig?.hasWindowButtons ? `
    <div class="window-buttons" style="display: flex; gap: 8px; padding: 12px 16px;">
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[0] || '#FF5F57'};"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[1] || '#FFBD2E'};"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[2] || '#28CA41'};"></span>
    </div>` : '';
  
  const slides = story.slides.map((slide, idx) => {
    // mainTitle에서 <highlight> 태그를 실제 span으로 변환 (분석된 highlight 스타일 적용)
    const highlightBg = highlight.backgroundColor !== 'transparent' 
      ? `background: ${highlight.backgroundColor}; padding: 2px 6px; border-radius: 4px;` 
      : '';
    const formattedTitle = slide.mainTitle
      .replace(/<highlight>/g, `<span class="card-highlight" style="color: ${highlight.color}; ${highlightBg}">`)
      .replace(/<\/highlight>/g, '</span>')
      .replace(/\n/g, '<br/>');
    
    // 프레임 스타일에 따른 border 적용
    const borderStyle = borderWidth !== '0' ? `border: ${borderWidth} solid ${accentColor};` : '';
    
    // 🎨 이미지에 텍스트가 렌더링되므로, HTML에서는 이미지만 표시 (텍스트 레이어 제거)
    return `
      <div class="card-slide" style="background: ${bgGradient}; border-radius: ${borderRadius}; ${borderStyle} box-shadow: ${boxShadow}; overflow: hidden; aspect-ratio: 1/1; position: relative;">
        <div class="card-img-container" style="position: absolute; inset: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center;">[IMG_${idx + 1}]</div>
        <!-- 텍스트 데이터는 숨김 처리 (편집/검색용) -->
        <div class="card-text-data" style="display: none;" data-subtitle="${slide.subtitle}" data-title="${slide.mainTitle.replace(/"/g, '&quot;')}" data-desc="${slide.description.replace(/"/g, '&quot;')}"></div>
      </div>`;
  });
  
  return slides.join('\n');
};

// 카드별 프롬프트 데이터는 types.ts에서 import

// [3단계] 전체 이미지 카드용 프롬프트 생성 에이전트
const fullImageCardPromptAgent = async (
  slides: SlideStory[],
  imageStyle: ImageStyle,
  category: string,
  styleConfig?: AnalyzedStyle,
  customImagePrompt?: string  // 커스텀 이미지 프롬프트 추가!
): Promise<CardPromptData[]> => {
  const ai = getAiClient();
  
  // 🚨 photo/medical 스타일 선택 시 커스텀 프롬프트 무시! (스타일 버튼 우선)
  const isFixedStyle = imageStyle === 'photo' || imageStyle === 'medical';
  const hasCustomStyle = !isFixedStyle && customImagePrompt?.trim();
  const styleGuide = isFixedStyle
    ? STYLE_KEYWORDS[imageStyle]  // photo/medical은 고정 스타일 사용
    : (hasCustomStyle ? customImagePrompt!.trim() : STYLE_KEYWORDS[imageStyle] || STYLE_KEYWORDS.illustration);
  
  console.log('🎨 fullImageCardPromptAgent 스타일:', imageStyle, '/ 커스텀 적용:', hasCustomStyle ? 'YES' : 'NO (고정 스타일)');
  
  // 🎨 스타일 참고 이미지가 있으면 해당 색상 사용, 없으면 기본값
  const bgColor = styleConfig?.backgroundColor || '#E8F4FD';
  const accentColor = styleConfig?.borderColor || '#3B82F6';
  const hasWindowButtons = styleConfig?.hasWindowButtons || false;
  const mood = styleConfig?.mood || '밝고 친근한';
  const keyFeatures = styleConfig?.keyFeatures?.join(', ') || '';
  
  // 슬라이드 정보 (description이 비어있으면 생략!)
  const slideSummaries = slides.map((s, i) => {
    const isFirst = i === 0;
    const isLast = i === slides.length - 1;
    const label = isFirst ? ' (표지)' : isLast ? ' (마지막)' : '';
    const hasDescription = s.description && s.description.trim().length > 0;
    
    // description이 없거나 비어있으면 생략!
    if (!hasDescription) {
      return `${i + 1}장${label}: subtitle="${s.subtitle}" mainTitle="${s.mainTitle.replace(/<\/?highlight>/g, '')}" ⚠️description 없음 - 설명 텍스트 넣지 마세요! 이미지="${s.imageKeyword}"`;
    }
    return `${i + 1}장${label}: subtitle="${s.subtitle}" mainTitle="${s.mainTitle.replace(/<\/?highlight>/g, '')}" description="${s.description}" 이미지="${s.imageKeyword}"`;
  }).join('\n');

  // 🎨 스타일 참고 이미지가 있으면 핵심 요소만 전달
  const styleRefInfo = styleConfig ? `
[🎨 디자인 프레임 참고]
- 배경색: ${bgColor}
- 강조색: ${accentColor}
- 프레임: ${hasWindowButtons ? '브라우저 창 버튼(빨/노/초) 필수' : '둥근 카드'}
- 분위기: ${mood}
${keyFeatures ? `- 특징: ${keyFeatures}` : ''}
` : '';

  // 커스텀 스타일 강조 (있으면 최우선 적용! + 기본 3D 스타일 금지!)
  const customStyleInfo = hasCustomStyle ? `
████████████████████████████████████████████████████████████████████████████████
🎯🎯🎯 [최우선] 커스텀 스타일 필수 적용! 🎯🎯🎯
████████████████████████████████████████████████████████████████████████████████

스타일: "${customImagePrompt}"

⛔ 절대 금지: 3D 일러스트, 클레이 렌더, 아이소메트릭 등 기본 스타일 사용 금지!
✅ 필수: 위에 명시된 "${customImagePrompt}" 스타일만 사용하세요!
` : '';

  const prompt = `당신은 소셜미디어 카드뉴스 디자이너입니다. 이미지 1장 = 완성된 카드뉴스 1장!
${customStyleInfo}
${styleRefInfo}
[스타일] ${styleGuide}
[진료과] ${category}

[슬라이드별 텍스트]
${slideSummaries}

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 [최우선] 레이아웃 규칙 - 반드시 지켜야 함! 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

⛔⛔⛔ 절대 금지되는 레이아웃 ⛔⛔⛔
- 상단에 흰색/단색 텍스트 영역 + 하단에 일러스트 영역 = 2분할 = 금지!
- 텍스트 박스와 이미지 박스가 나뉘어 보이는 디자인 = 금지!
- 위아래로 2등분된 듯한 구성 = 금지!

✅✅✅ 반드시 이렇게 만드세요 ✅✅✅
- 일러스트/배경이 전체 화면(100%)을 채움!
- 그 위에 텍스트가 오버레이 (반투명 배경 또는 그림자 효과로 가독성 확보)
- 영화 포스터, 앨범 커버, 인스타그램 카드처럼 하나의 통합 디자인!

[imagePrompt 작성법]
- "전체 화면을 채우는 [일러스트 묘사], 그 위에 [텍스트] 오버레이" 형식
- 예: "전체 화면을 채우는 비오는 창가 일러스트, 그 위에 '무릎 쑤심' 텍스트 오버레이, 파스텔톤"

[카드 레이아웃]
- 1번(표지)/마지막(CTA): 제목+부제+일러스트만! 🚨description 절대 금지!
${hasWindowButtons ? '- 브라우저 창 버튼(빨/노/초) 포함' : ''}

[필수 규칙]
- 1:1 정사각형, 배경색 ${bgColor}
- ⚠️ imagePrompt는 반드시 한국어로!
- 해시태그 금지
- "⚠️description 없음"이면 설명 텍스트 넣지 마세요!

[의료법] 금지: 상담하세요, 방문하세요, 완치, 보장 / 허용: 증상명, 질환명, 질문형`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            cards: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  imagePrompt: { type: Type.STRING },
                  textPrompt: {
                    type: Type.OBJECT,
                    properties: {
                      subtitle: { type: Type.STRING },
                      mainTitle: { type: Type.STRING },
                      description: { type: Type.STRING },
                      tags: { type: Type.ARRAY, items: { type: Type.STRING } }
                    },
                    required: ["subtitle", "mainTitle", "description", "tags"]
                  }
                },
                required: ["imagePrompt", "textPrompt"]
              }
            }
          },
          required: ["cards"]
        }
      }
    });
    
    const result = JSON.parse(response.text || '{"cards":[]}');
    
    // 🚨🚨🚨 AI가 생성한 imagePrompt는 무시하고, 슬라이드 정보 + 사용자 스타일로 직접 조합!
    // AI가 멋대로 다른 텍스트/스타일을 넣는 문제 해결
    const cards = slides.map((s, idx) => {
      const isFirst = idx === 0;
      const isLast = idx === slides.length - 1;
      const mainTitleClean = s.mainTitle.replace(/<\/?highlight>/g, '');
      
      // 표지/마지막은 description 없음
      const descPart = (isFirst || isLast) ? '' : (s.description ? `, "${s.description}"` : '');
      
      // 🔧 imagePrompt: 사용자에게 보여줄 핵심 정보만! (영어 지시문은 생성 시 자동 추가)
      // 스타일은 generateSingleImage에서 결정 (중복 방지)
      const descText = (isFirst || isLast) ? '' : (s.description ? `\ndescription: "${s.description}"` : '');
      const imagePrompt = `subtitle: "${s.subtitle}"
mainTitle: "${mainTitleClean}"${descText}
비주얼: ${s.imageKeyword}
배경색: ${bgColor}`;
      
      // textPrompt는 AI 결과 사용 (있으면) 또는 슬라이드 정보 사용
      const aiCard = result.cards?.[idx];
      const textPrompt = aiCard?.textPrompt || {
        subtitle: s.subtitle,
        mainTitle: s.mainTitle,
        description: (isFirst || isLast) ? '' : s.description,
        tags: s.tags
      };
      
      // 표지/마지막은 description 강제 제거
      if (isFirst || isLast) {
        textPrompt.description = '';
      }
      
      return { imagePrompt, textPrompt };
    });
    
    console.log('🎨 카드 프롬프트 직접 생성 완료:', cards.length, '장, 스타일:', hasCustomStyle ? '커스텀' : '기본');
    return cards;
  } catch (error) {
    console.error('전체 이미지 카드 프롬프트 실패:', error);
    // 🔧 fallback도 동일하게: 스타일은 generateSingleImage에서 결정!
    const fallbackCards = slides.map((s, idx) => {
      const isFirst = idx === 0;
      const isLast = idx === slides.length - 1;
      const mainTitleClean = s.mainTitle.replace(/<\/?highlight>/g, '');
      const descText = (isFirst || isLast) ? '' : (s.description ? `\ndescription: "${s.description}"` : '');
      return {
        imagePrompt: `subtitle: "${s.subtitle}"
mainTitle: "${mainTitleClean}"${descText}
비주얼: ${s.imageKeyword}
배경색: ${bgColor}`,
        textPrompt: { 
          subtitle: s.subtitle, 
          mainTitle: s.mainTitle, 
          description: (isFirst || isLast) ? '' : s.description, 
          tags: s.tags 
        }
      };
    });
    console.log('🚨 [fullImageCardPromptAgent fallback] 직접 생성, 스타일:', hasCustomStyle ? '커스텀' : '기본');
    return fallbackCards;
  }
};

// [기존 호환] 이미지만 생성하는 프롬프트 에이전트
const imagePromptAgent = async (
  slides: SlideStory[],
  imageStyle: ImageStyle,
  category: string
): Promise<string[]> => {
  const ai = getAiClient();
  
  const styleGuide = STYLE_KEYWORDS[imageStyle] || STYLE_KEYWORDS.illustration;
  
  const slideSummaries = slides.map((s, i) => `${i + 1}장: ${s.slideType} - ${s.imageKeyword}`).join('\n');
  
  const prompt = `당신은 의료/건강 이미지 프롬프트 전문가입니다.

[미션] 각 슬라이드에 맞는 이미지 프롬프트를 한국어로 작성하세요.
[스타일] ${styleGuide}
[진료과] ${category}
[슬라이드] ${slideSummaries}

[규칙]
- 한국어로 작성
- 4:3 비율 적합
- 로고/워터마크 금지
- 의료법 위반 문구 금지 (상담/방문/예약/완치/보장)
- 허용: 증상명, 질환명, 정보성 키워드, 질문형, 숫자

예시: "가슴 통증을 느끼는 중년 남성, 3D 일러스트, 파란색 배경, 밝은 톤"`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: { prompts: { type: Type.ARRAY, items: { type: Type.STRING } } },
          required: ["prompts"]
        }
      }
    });
    
    const result = JSON.parse(response.text || '{"prompts":[]}');
    return result.prompts || [];
  } catch (error) {
    console.error('이미지 프롬프트 에이전트 실패:', error);
    return slides.map(s => `${s.imageKeyword}, ${styleGuide}`);
  }
};

// ============================================
// 🎯 2단계 워크플로우: 원고 생성 → 사용자 확인 → 카드뉴스 디자인
// ============================================

// [1단계] 원고 생성 함수 - 블로그와 동일한 검증된 프롬프트 사용
export const generateCardNewsScript = async (
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<CardNewsScript> => {
  const ai = getAiClient();
  const slideCount = request.slideCount || 6;
  const writingStyle = request.writingStyle || 'empathy';
  const writingStylePrompt = getWritingStylePrompts()[writingStyle];
  
  // 블로그와 동일한 검증된 프롬프트 구조 사용
  const medicalSafetyPrompt = getMedicalSafetyPrompt();
  
  onProgress('📝 [1단계] 원고 기획 중...');
  
  const prompt = `
${medicalSafetyPrompt}
${writingStylePrompt}
${getWritingStyleCommonRules()}
${PSYCHOLOGY_CTA_PROMPT}

████████████████████████████████████████████████████████████████████████████████
🎯 카드뉴스 원고 작성 미션
████████████████████████████████████████████████████████████████████████████████

[미션] "${request.topic}" 주제로 ${slideCount}장짜리 **카드뉴스 원고**를 작성하세요.
[진료과] ${request.category}
[글 스타일] ${writingStyle === 'expert' ? '전문가형(신뢰·권위)' : writingStyle === 'empathy' ? '공감형(독자 공감)' : '전환형(정보→확인 유도)'}

${CONTENT_DESCRIPTION}

[🧠 핵심 원칙: 카드뉴스는 "정보 나열"이 아니라 "심리 흐름"이다!]
- 카드뉴스는 슬라이드형 설득 구조
- 각 카드는 **서로 다른 심리적 역할**을 가져야 함
- 생활습관(운동, 식단, 금연 등)은 **보조 정보로만** (최대 1장)
- 마지막 2장은 반드시 "시점 고정" + "안전한 CTA"

████████████████████████████████████████████████████████████████████████████████
📝 각 슬라이드별 작성 내용
████████████████████████████████████████████████████████████████████████████████

1. **subtitle** (10-15자): 질문형 또는 핵심 포인트
   예: "왜 중요할까요?", "혹시 이런 증상?"

2. **mainTitle** (15-25자): 핵심 메시지, 줄바꿈(\\n) 포함 가능
   예: "이 신호를\\n놓치지 마세요"
   - 강조할 부분은 <highlight>태그</highlight>로 감싸기

3. **description** (40-80자): 구체적인 설명문
   - 독자가 얻어갈 정보가 있어야 함!
   - 너무 짧으면 안 됨 (최소 40자)
   - 위 의료법 준수 규칙 적용 필수!

4. **speakingNote** (50-100자): 이 슬라이드에서 전달하고 싶은 핵심 메시지
   - 편집자/작성자가 참고할 내부 메모
   - 왜 이 내용이 필요한지, 독자에게 어떤 감정을 유발해야 하는지
   - 예: "독자가 '나도 그런 증상 있는데?' 하고 공감하게 만들어야 함"

5. **imageKeyword** (10-20자): 이미지 생성을 위한 핵심 키워드
   예: "심장 들고 있는 의사", "피로한 직장인"

████████████████████████████████████████████████████████████████████████████████
🎭 카드별 심리적 역할 - ${slideCount}장 기준
████████████████████████████████████████████████████████████████████████████████

**1장 - 주의 환기 (표지)**
- slideType: "cover"
- 위험 인식 유도, 흥미 유발
- 공포 조장 금지, 질문형 또는 반전형 문구
- speakingNote: "독자의 관심을 끌어야 함. '어? 나도?' 반응 유도"

**2장 - 오해 깨기 (개념 정리)**
- slideType: "concept"
- 착각을 바로잡는 메시지
- speakingNote: "잘못된 상식을 깨고 올바른 정보 제공"

${slideCount >= 5 ? `**3장 - 변화 신호 체크 (증상 체크)**
- slideType: "content"
- 대표적 증상 2-3가지 명확히
- ⚠️ 제목: "위험 신호"보다 "변화 신호", "체크 포인트" 선호
- ⚠️ 증상 설명 후 "다른 원인 가능성" 완충 문장 필수!
- speakingNote: "구체적 증상을 나열해 '자가 체크' 느낌"` : ''}

${slideCount >= 6 ? `**4장 - 자가 판단의 한계**
- slideType: "content"
- 검사·의학적 확인 필요성 강조
- speakingNote: "혼자 판단하면 안 되는 이유 설명"` : ''}

${slideCount >= 7 ? `**5~${slideCount-2}장 - 추가 정보/사례**
- slideType: "content"
- 구체적 증상 설명, 관련 정보
- 생활습관은 최대 1장만!` : ''}

**${slideCount-1}장 - 시점 고정 (🔥 핵심! 🔥)**
- slideType: "content"
- "이런 증상이 나타났다면" → "지켜보기보다 확인 시점일 수 있어요"
- ⚠️ 구체적 시간(2주, 48시간 등) 절대 금지! 범주형으로!
- speakingNote: "지금이 확인할 타이밍이라는 것을 인식시키기"

**${slideCount}장 - 안전한 CTA**
- slideType: "closing"
- ⚠️ 위 CTA 심리학 가이드 참조하여 작성!
- "불편함이 반복된다면 전문적인 확인을 고려해볼 수 있어요"
- speakingNote: "직접 권유 없이 행동을 유도하는 부드러운 마무리"

████████████████████████████████████████████████████████████████████████████████
🔍 SEO 최적화 - 네이버/인스타그램 노출용
████████████████████████████████████████████████████████████████████████████████

1. **표지 제목 SEO**
   - 핵심 키워드를 제목 앞부분에 배치
   - 검색 의도에 맞는 질문형/호기심형 제목
   ✅ "피부건조 원인, 겨울에 더 심해지는 이유"
   ❌ "피부에 대해 알아봐요"

2. **해시태그 전략 (마지막 카드)**
   - 검색량 높은 키워드 5-7개
   - 롱테일 키워드 포함
   ✅ #피부건조 #겨울철피부관리 #피부보습 #건조한피부케어

3. **각 카드 mainTitle에 키워드 자연스럽게 포함**
   - 핵심 키워드가 전체 카드에 3-5회 분산
   - 동의어/유사어 함께 사용

████████████████████████████████████████████████████████████████████████████████
⚠️ 최종 체크리스트
████████████████████████████████████████████████████████████████████████████████
□ 제목에 '치료/항암/전문의 권장/총정리' 없는지?
□ 도입부에 자기소개('에디터입니다') 없는지?
□ 숫자/시간이 범주형으로 표현되었는지?
□ 증상 설명 후 '다른 원인 가능성' 문장 있는지?
□ CTA가 직접 권유 없이 완곡하게 작성되었는지?
□ 연도/월이 계절 표현으로 일반화되었는지?
□ 핵심 키워드가 표지 제목 앞부분에 배치되었는지? (SEO)

[📋 출력 필드 - 모든 필드는 한국어로 작성!]
- title: 제목 (한국어)
- topic: 주제 (한국어)
- overallTheme: 전체 구조 설명 (⚠️ 반드시 한국어! 영어 금지! 20자 이내)
  예: "공감과 정보 전달" / "증상 체크 → 확인 안내" / "건강 정보 공유"`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        tools: [{ googleSearch: {} }],
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            topic: { type: Type.STRING },
            totalSlides: { type: Type.INTEGER },
            overallTheme: { type: Type.STRING },
            slides: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  slideNumber: { type: Type.INTEGER },
                  slideType: { type: Type.STRING },
                  subtitle: { type: Type.STRING },
                  mainTitle: { type: Type.STRING },
                  description: { type: Type.STRING },
                  speakingNote: { type: Type.STRING },
                  imageKeyword: { type: Type.STRING }
                },
                required: ["slideNumber", "slideType", "subtitle", "mainTitle", "description", "speakingNote", "imageKeyword"]
              }
            }
          },
          required: ["title", "topic", "totalSlides", "slides", "overallTheme"]
        }
      }
    });
    
    const result = JSON.parse(response.text || "{}");
    
    // 🚨 후처리: 1장(표지)과 마지막 장의 description 강제로 빈 문자열로!
    if (result.slides && result.slides.length > 0) {
      // 1장 (표지) description 제거
      result.slides[0].description = "";
      
      // 마지막 장 description 제거
      if (result.slides.length > 1) {
        result.slides[result.slides.length - 1].description = "";
      }
      
      console.log('🚨 [generateCardNewsScript] 표지/마지막 장 description 강제 제거 완료');
    }
    
    onProgress(`✅ 원고 생성 완료 (${result.slides?.length || 0}장)`);
    
    return result as CardNewsScript;
  } catch (error) {
    console.error('원고 생성 실패:', error);
    throw error;
  }
};

// [2단계] 원고를 카드뉴스로 변환하는 함수
export const convertScriptToCardNews = async (
  script: CardNewsScript,
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<{ content: string; imagePrompts: string[]; cardPrompts: CardPromptData[]; title: string; }> => {
  onProgress('🎨 [2단계] 카드뉴스 디자인 변환 중...');
  
  // 스토리를 SlideStory 형식으로 변환 (기존 함수와 호환)
  const slides: SlideStory[] = script.slides.map(s => ({
    slideNumber: s.slideNumber,
    slideType: s.slideType as 'cover' | 'concept' | 'content' | 'closing',
    subtitle: s.subtitle,
    mainTitle: s.mainTitle,
    description: s.description,
    tags: [], // 태그는 프롬프트 생성 시 추가됨
    imageKeyword: s.imageKeyword
  }));
  
  // 스타일 분석 (참고 이미지가 있는 경우)
  let styleConfig: AnalyzedStyle | undefined;
  if (request.coverStyleImage || request.contentStyleImage) {
    try {
      const styleImage = request.coverStyleImage || request.contentStyleImage;
      onProgress('🎨 참고 이미지 스타일 분석 중...');
      const styleJson = await analyzeStyleReferenceImage(styleImage!, !!request.coverStyleImage);
      styleConfig = JSON.parse(styleJson);
      const features = styleConfig?.keyFeatures?.slice(0, 3).join(', ') || '';
      onProgress(`✨ 스타일 적용: ${styleConfig?.backgroundColor || '분석됨'} ${features ? `(${features})` : ''}`);
    } catch (e) {
      console.warn('스타일 분석 실패, 기본 스타일 사용:', e);
    }
  }
  
  // HTML 조립
  onProgress('🏗️ 카드 구조 생성 중...');
  const htmlContent = assembleCardNewsHtml({ ...script, slides }, styleConfig);
  
  // 카드 프롬프트 생성 (커스텀 이미지 프롬프트 전달!)
  onProgress('🎨 카드 이미지 프롬프트 생성 중...');
  const cardPrompts = await fullImageCardPromptAgent(
    slides,
    request.imageStyle || 'illustration',
    request.category,
    styleConfig,
    request.customImagePrompt  // 커스텀 프롬프트 전달!
  );
  
  // 공통 함수로 프롬프트 정리
  const imagePrompts = cardPrompts.map(c => cleanImagePromptText(c.imagePrompt));
  onProgress(`✅ 카드뉴스 디자인 변환 완료 (${cardPrompts.length}장)`);
  
  return {
    content: htmlContent,
    imagePrompts,
    cardPrompts,
    title: script.title
  };
};

// [통합] 미니 에이전트 오케스트레이터 (기존 호환 유지)
export const generateCardNewsWithAgents = async (
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<{ content: string; imagePrompts: string[]; cardPrompts: CardPromptData[]; title: string; }> => {
  const slideCount = request.slideCount || 6;
  
  // 1단계: 스토리 기획
  onProgress('📝 [1/3] 스토리 기획 중...');
  const story = await storyPlannerAgent(
    request.topic,
    request.category,
    slideCount,
    request.writingStyle || 'empathy'
  );
  
  if (!story.slides || story.slides.length === 0) {
    throw new Error('스토리 기획 실패: 슬라이드가 생성되지 않았습니다.');
  }
  
  onProgress(`✅ 스토리 기획 완료 (${story.slides.length}장)`);
  
  // 2단계: HTML 조립
  onProgress('🏗️ [2/3] 카드 구조 생성 중...');
  
  // 스타일 분석 결과가 있으면 전체 스타일 적용
  let styleConfig: AnalyzedStyle | undefined;
  if (request.coverStyleImage || request.contentStyleImage) {
    try {
      const styleImage = request.coverStyleImage || request.contentStyleImage;
      onProgress('🎨 참고 이미지 스타일 분석 중...');
      const styleJson = await analyzeStyleReferenceImage(styleImage!, !!request.coverStyleImage);
      const parsed = JSON.parse(styleJson);
      
      // 전체 스타일 정보 전달 (색상뿐만 아니라 폰트, 레이아웃, 프레임 등 모두)
      styleConfig = {
        frameStyle: parsed.frameStyle,
        hasWindowButtons: parsed.hasWindowButtons,
        windowButtonColors: parsed.windowButtonColors,
        backgroundColor: parsed.backgroundColor,
        borderColor: parsed.borderColor,
        borderWidth: parsed.borderWidth,
        borderRadius: parsed.borderRadius,
        boxShadow: parsed.boxShadow,
        subtitleStyle: parsed.subtitleStyle,
        mainTitleStyle: parsed.mainTitleStyle,
        highlightStyle: parsed.highlightStyle,
        descStyle: parsed.descStyle,
        tagStyle: parsed.tagStyle,
        illustPosition: parsed.illustPosition,
        illustSize: parsed.illustSize,
        padding: parsed.padding,
        mood: parsed.mood,
        keyFeatures: parsed.keyFeatures
      };
      
      const features = parsed.keyFeatures?.slice(0, 3).join(', ') || '';
      onProgress(`✨ 스타일 적용: ${parsed.backgroundColor || '분석됨'} ${features ? `(${features})` : ''}`);
    } catch (e) {
      console.warn('스타일 분석 실패, 기본 스타일 사용:', e);
    }
  }
  
  const htmlContent = assembleCardNewsHtml(story, styleConfig);
  onProgress('✅ 카드 구조 생성 완료');
  
  // 3단계: 전체 이미지 카드 프롬프트 생성 (텍스트 + 이미지 통합)
  onProgress('🎨 [3/3] 카드 프롬프트 생성 중...');
  const cardPrompts = await fullImageCardPromptAgent(
    story.slides,
    request.imageStyle || 'illustration',
    request.category,
    styleConfig,
    request.customImagePrompt  // 커스텀 프롬프트 전달!
  );
  
  // 공통 함수로 프롬프트 정리
  const imagePrompts = cardPrompts.map(c => cleanImagePromptText(c.imagePrompt));
  onProgress(`✅ 카드 프롬프트 ${cardPrompts.length}개 생성 완료`);
  
  return {
    content: htmlContent,
    imagePrompts,
    cardPrompts, // 새로 추가: 텍스트+이미지 프롬프트 전체
    title: story.topic
  };
};

// ============================================
// 기존 블로그 포스트 생성 함수 (유지)
// ============================================

export const generateBlogPostText = async (request: GenerationRequest): Promise<{ 
    title: string; 
    content: string; 
    imagePrompts: string[];
    fact_check: FactCheckReport;
    analyzedStyle?: { backgroundColor?: string; borderColor?: string; };
}> => {
  const ai = getAiClient();
  const isCardNews = request.postType === 'card_news';
  const targetLength = request.textLength || 2000;
  const targetSlides = request.slideCount || 6;
  
  // 스타일 참고 이미지 분석 (카드뉴스일 때만 - 표지/본문 분리)
  let coverStyleAnalysis = '';
  let contentStyleAnalysis = '';
  let analyzedBgColor = '';
  
  if (isCardNews) {
    // 표지 스타일 분석
    if (request.coverStyleImage) {
      try {
        coverStyleAnalysis = await analyzeStyleReferenceImage(request.coverStyleImage, true);
      } catch (e) {
        console.warn('표지 스타일 분석 실패:', e);
      }
    }
    
    // 본문 스타일 분석
    if (request.contentStyleImage) {
      try {
        contentStyleAnalysis = await analyzeStyleReferenceImage(request.contentStyleImage, false);
      } catch (e) {
        console.warn('본문 스타일 분석 실패:', e);
      }
    }
    
    // 표지만 있으면 본문도 같은 스타일 적용
    if (coverStyleAnalysis && !contentStyleAnalysis) {
      contentStyleAnalysis = coverStyleAnalysis;
    }
  }
  
  // 스타일 분석 결과를 프롬프트에 적용
  let styleAnalysis = '';
  let coverStyle: any = {};
  let contentStyle: any = {};
  
  if (coverStyleAnalysis || contentStyleAnalysis) {
    // JSON 파싱 시도
    try {
      if (coverStyleAnalysis) coverStyle = JSON.parse(coverStyleAnalysis);
      if (contentStyleAnalysis) contentStyle = JSON.parse(contentStyleAnalysis);
      // 배경색 저장 (후처리용)
      analyzedBgColor = coverStyle.backgroundColor || contentStyle.backgroundColor || '';
    } catch (e) {
      // JSON 파싱 실패 시 원본 텍스트 사용
      console.warn('스타일 JSON 파싱 실패:', e);
    }
    
    // 브라우저 프레임 HTML 생성
    const windowButtonsHtml = (style: any) => {
      if (style.hasWindowButtons || style.frameStyle === 'browser-window') {
        const colors = style.windowButtonColors || ['#FF5F57', '#FFBD2E', '#28CA41'];
        return `<div class="browser-header" style="display:flex; gap:6px; padding:8px 12px; background:#f0f0f0; border-radius:12px 12px 0 0;">
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[0]};"></span>
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[1]};"></span>
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[2]};"></span>
        </div>`;
      }
      return '';
    };
    
    // inline CSS 스타일 생성 함수
    const generateInlineStyle = (style: any) => {
      const parts = [];
      if (style.backgroundColor) parts.push(`background-color: ${style.backgroundColor}`);
      if (style.borderColor && style.borderWidth) {
        parts.push(`border: ${style.borderWidth} solid ${style.borderColor}`);
      } else if (style.borderColor) {
        parts.push(`border: 2px solid ${style.borderColor}`);
      }
      if (style.borderRadius) parts.push(`border-radius: ${style.borderRadius}`);
      if (style.boxShadow) parts.push(`box-shadow: ${style.boxShadow}`);
      if (style.padding) parts.push(`padding: ${style.padding}`);
      return parts.join('; ');
    };
    
    // 제목 스타일 생성
    const generateTitleStyle = (style: any) => {
      if (!style.mainTitleStyle) return '';
      const s = style.mainTitleStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.fontSize) parts.push(`font-size: ${s.fontSize}`);
      if (s.fontWeight) parts.push(`font-weight: ${s.fontWeight}`);
      return parts.join('; ');
    };
    
    // 강조 스타일 생성
    const generateHighlightStyle = (style: any) => {
      if (!style.highlightStyle) return '';
      const s = style.highlightStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.backgroundColor && s.backgroundColor !== 'transparent') {
        parts.push(`background-color: ${s.backgroundColor}`);
        parts.push(`padding: 2px 6px`);
        parts.push(`border-radius: 4px`);
      }
      return parts.join('; ');
    };
    
    // 부제목 스타일 생성
    const generateSubtitleStyle = (style: any) => {
      if (!style.subtitleStyle) return '';
      const s = style.subtitleStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.fontSize) parts.push(`font-size: ${s.fontSize}`);
      if (s.fontWeight) parts.push(`font-weight: ${s.fontWeight}`);
      return parts.join('; ');
    };
    
    // 태그 스타일 생성
    const generateTagStyle = (style: any) => {
      if (!style.tagStyle) return '';
      const s = style.tagStyle;
      const parts = [];
      if (s.backgroundColor) parts.push(`background-color: ${s.backgroundColor}`);
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.borderRadius) parts.push(`border-radius: ${s.borderRadius}`);
      parts.push(`padding: 4px 12px`);
      return parts.join('; ');
    };
    
    const coverInlineStyle = generateInlineStyle(coverStyle);
    const contentInlineStyle = generateInlineStyle(contentStyle);
    const coverTitleStyle = generateTitleStyle(coverStyle);
    const coverHighlightStyle = generateHighlightStyle(coverStyle);
    const coverSubtitleStyle = generateSubtitleStyle(coverStyle);
    const coverTagStyle = generateTagStyle(coverStyle);
    const contentTitleStyle = generateTitleStyle(contentStyle);
    const contentHighlightStyle = generateHighlightStyle(contentStyle);
    const contentSubtitleStyle = generateSubtitleStyle(contentStyle);
    const contentTagStyle = generateTagStyle(contentStyle);
    
    // 분석된 배경색을 CSS로 변환
    const bgColor = coverStyle.backgroundColor || contentStyle.backgroundColor || '#E8F4FD';
    const bgGradient = bgColor.includes('gradient') ? bgColor : `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
    
    styleAnalysis = `
[🎨🎨🎨 카드뉴스 스타일 - 이 스타일을 반드시 그대로 적용하세요! 🎨🎨🎨]

**⚠️⚠️⚠️ 최우선 규칙 ⚠️⚠️⚠️**
**모든 카드에 반드시 style="background: ${bgGradient};" 적용!**
**기본 흰 배경(#f8fafc, #fff) 사용 금지!**

**필수 적용 배경색: ${bgColor}**

${coverStyleAnalysis ? `**📕 표지 (1장) HTML:**
<div class="card-slide" style="background: ${bgGradient}; border-radius: 24px; overflow: hidden;">
  ${windowButtonsHtml(coverStyle)}
  <div class="card-content-area" style="padding: 32px 28px;">
    <p class="card-subtitle" style="${coverSubtitleStyle || 'color: #3B82F6; font-size: 14px; font-weight: 700;'}">부제목 (10~15자)</p>
    <p class="card-main-title" style="${coverTitleStyle || 'color: #1E293B; font-size: 28px; font-weight: 900;'}">메인 제목<br/><span style="color: #3B82F6;">강조</span></p>
    <div class="card-img-container">[IMG_1]</div>
    <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.7;">30~50자의 구체적인 설명 문장을 작성하세요!</p>
  </div>
</div>
` : ''}

${contentStyleAnalysis ? `**📄 본문 (2장~) HTML:**
<div class="card-slide" style="background: ${bgGradient}; border-radius: 24px; overflow: hidden;">
  ${windowButtonsHtml(contentStyle)}
  <div class="card-content-area" style="padding: 32px 28px;">
    <p class="card-subtitle" style="${contentSubtitleStyle || 'color: #3B82F6; font-size: 14px; font-weight: 700;'}">부제목 (10~15자)</p>
    <p class="card-main-title" style="${contentTitleStyle || 'color: #1E293B; font-size: 28px; font-weight: 900;'}">메인 제목<br/><span style="color: #3B82F6;">강조</span></p>
    <div class="card-img-container">[IMG_N]</div>
    <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.7;">30~50자의 구체적인 설명 문장을 작성하세요!</p>
  </div>
</div>
` : ''}

**🚨 배경색 필수 적용: ${bgColor} 🚨**
style 속성에 background: ${bgGradient}; 반드시 포함!
`;
  }
  
  let benchmarkingInstruction = '';
  if (request.referenceUrl) {
    benchmarkingInstruction = `
    [🚨 벤치마킹 모드 활성화]
    Target URL: ${request.referenceUrl}
    Google Search 도구를 사용하여 위 URL의 페이지를 접속해 콘텐츠 구조를 분석하십시오.
    
    ${isCardNews 
      ? `[미션: 템플릿 구조 모방]
         - 입력된 URL은 '카드뉴스 템플릿'입니다.
         - 해당 카드뉴스의 [페이지별 구성(표지-목차-본론-결론)], [텍스트 밀도], [강조 문구 스타일]을 분석하십시오.
         - 분석한 특징을 아래 [HTML 구조 가이드]에 대입하여 내용을 작성하십시오.
         - 예: 레퍼런스가 'Q&A' 형식이면 본문도 'Q&A'로, 'O/X 퀴즈' 형식이면 'O/X 퀴즈'로 구성하십시오.`
      : `[미션: 블로그 스타일 모방]
         - 이 블로그의 말투, 문단 구조, 이모지 사용 패턴을 완벽히 모방하여 글을 작성하십시오.`}
    
    [⚠️ 의료법 절대 준수] 
    - 벤치마킹 대상이 과장/위법 표현을 쓰더라도 절대 따라하지 말고 안전한 표현으로 순화하십시오.
    `;
  }

  const targetImageCount = request.imageCount || 3;
  const imageMarkers = Array.from({length: targetImageCount}, (_, i) => `[IMG_${i+1}]`).join(', ');
  const writingStyle = request.writingStyle || 'empathy'; // 기본값: 공감형
  const writingStylePrompt = getWritingStylePrompts()[writingStyle];
  const imageStyle = request.imageStyle || 'illustration'; // 기본값: 3D 일러스트
  
  // 학습된 말투 스타일 적용
  let learnedStyleInstruction = '';
  if (request.learnedStyleId) {
    try {
      const { getStyleById, getStylePromptForGeneration } = await import('./writingStyleService');
      const learnedStyle = getStyleById(request.learnedStyleId);
      if (learnedStyle) {
        learnedStyleInstruction = `
[🎓🎓🎓 학습된 말투 적용 - 최우선 적용! 🎓🎓🎓]
${getStylePromptForGeneration(learnedStyle)}

⚠️ 위 학습된 말투를 반드시 적용하세요!
- 문장 끝 패턴을 정확히 따라하세요
- 자주 사용하는 표현을 자연스럽게 활용하세요
- 전체적인 어조와 분위기를 일관되게 유지하세요
`;
        console.log('📝 학습된 말투 적용:', learnedStyle.name);
      }
    } catch (e) {
      console.warn('학습된 말투 로드 실패:', e);
    }
  }
  
  // 현재 한국 시간 정보 (최신 정보 기반 글 작성용)
  const now = new Date();
  const koreaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const currentYear = koreaTime.getFullYear();
  const currentMonth = koreaTime.getMonth() + 1;
  const currentDay = koreaTime.getDate();
  const currentSeason = currentMonth >= 3 && currentMonth <= 5 ? '봄' 
    : currentMonth >= 6 && currentMonth <= 8 ? '여름'
    : currentMonth >= 9 && currentMonth <= 11 ? '가을' : '겨울';
  const timeContext = `현재 날짜: ${currentYear}년 ${currentMonth}월 ${currentDay}일 (${currentSeason})`;
  // 커스텀 이미지 프롬프트가 있으면 최우선 사용
  const customImagePrompt = request.customImagePrompt?.trim();
  const imageStyleGuide = customImagePrompt
    ? `커스텀 스타일: ${customImagePrompt}` // 커스텀 프롬프트 최우선!
    : imageStyle === 'illustration' 
    ? '3D 렌더 일러스트, Blender 스타일, 부드러운 스튜디오 조명, 파스텔 색상, 둥근 형태, 친근한 캐릭터, 깔끔한 배경 (⛔금지: 실사, 사진, DSLR)'
    : imageStyle === 'medical'
    ? '의학 3D 일러스트, 해부학적 렌더링, 해부학적 구조, 장기 단면도, 반투명 장기, 임상 조명, 의료 색상 팔레트 (⛔금지: 귀여운 만화, 실사 얼굴)'
    : '실사 DSLR 사진, 진짜 사진, 35mm 렌즈, 자연스러운 부드러운 조명, 얕은 피사계심도, 전문 병원 환경 (⛔금지: 3D 렌더, 일러스트, 만화, 애니메이션)';
  
  // 동적으로 최신 의료광고법 프롬프트 생성
  const medicalSafetyPrompt = getMedicalSafetyPrompt();
  
  const blogPrompt = `
    ${medicalSafetyPrompt}
    ${writingStylePrompt}
    ${getWritingStyleCommonRules()}
    ${learnedStyleInstruction}
    ${benchmarkingInstruction}
    
    [📅 현재 시점 정보 - 최신 정보 기반 작성 필수!]
    ${timeContext}
    
    🔎🔎🔎 **글 작성 전 필수 검색 단계 (반드시 수행!)** 🔎🔎🔎
    1️⃣ Google 검색: "${request.topic} site:pubmed.ncbi.nlm.nih.gov ${currentYear}"
       → 최신 논문/연구 결과 확인
    2️⃣ Google 검색: "${request.topic} 대한${request.category}학회 가이드라인 ${currentYear}"
       → 국내 학회 최신 지침 확인
    3️⃣ Google 검색: "${request.topic} site:kdca.go.kr OR site:mohw.go.kr"
       → 질병관리청/보건복지부 공식 자료 확인
    
    ⚠️ 검색 결과를 바탕으로 최신 정보만 사용하여 글 작성!
    ⚠️ 본문에 최소 3회 이상 공신력 있는 출처(학회/정부/논문) 인용 필수!
    ⚠️ 인용 시 반드시 연도 표기! (예: "대한OO학회(${currentYear})")
    
    - ${currentYear}년 최신 의학 가이드라인/연구 결과 반영
    - ${currentYear}년 최신 의료광고법 규정 준수
    - ${currentSeason}철 특성 고려 (계절성 질환, 생활 습관 등)
    - 오래된 정보(2년 이상)는 최신 정보로 업데이트하여 작성
    
    진료과: ${request.category}, 페르소나: ${request.persona}, 주제: ${request.topic}
    
    [🚨🚨🚨 글자 수 - 가장 중요한 요구사항!!! 🚨🚨🚨]
    ⚠️⚠️⚠️ 목표: 공백 포함 **정확히 ${targetLength}자 내외** 작성!!! ⚠️⚠️⚠️
    
    📏 허용 범위: **${Math.round(targetLength * 0.9)}자 ~ ${Math.round(targetLength * 1.1)}자** (±10% 이내)
    🚫 **${targetLength <= 2000 ? 2000 : Math.round(targetLength * 1.2)}자 초과 절대 금지!** 너무 길게 쓰지 마세요!
    
    📏 분량 가이드 (${targetLength}자 기준):
    ${targetLength >= 5000 ? `
    - 🔴 5000자 = 매우 긴 글!
    - 서론: 400자 (상황 묘사 + 문제 제기 + 공감)
    - 본론 섹션: 5~6개 섹션 (각 섹션 600자)
    - 각 섹션에 상세 설명 + 구체적 예시 + 통계/연구 결과 포함
    - 결론: 300자 (핵심 요약 + CTA)
    - 해시태그: 10~15개` : targetLength >= 4000 ? `
    - 🔴 4000자 = 긴 글!
    - 서론: 350자
    - 본론 섹션: 4~5개 섹션 (각 섹션 500자)
    - 각 섹션에 상세 설명 + 예시 포함
    - 결론: 250자
    - 해시태그: 10개` : targetLength >= 3000 ? `
    - 🟡 3000자 = 중간 길이 글
    - 서론: 300자
    - 본론 섹션: 3~4개 섹션 (각 섹션 450자)
    - 각 섹션에 설명 + 예시 포함
    - 결론: 200자
    - 해시태그: 10개` : `
    - 🟢 2000자 = 적당한 길이 (이 범위 내에서 작성!)
    - 서론: 150~200자
    - 본론 섹션: 2~3개 섹션 (각 섹션 300~350자)
    - 결론: 100~150자
    - 해시태그: 10개
    - ⚠️ 2500자 넘기지 마세요!`}
    
    ✅ 글자 수 늘리는 방법:
    1. 각 증상/원인을 더 상세히 설명 (왜? 어떻게? 언제?)
    2. 구체적인 사례/상황 예시 추가 ("예를 들어...", "실제로...")
    3. 통계나 연구 결과 인용 ("연구에 따르면...", "~% 환자가...")
    4. 비교/대조 설명 추가 ("반면에...", "~와 달리...")
    5. 독자 공감 문장 추가 ("이런 경험 있으시죠?", "많은 분들이...")
    6. 소제목(h3) 섹션 수 늘리기!
    
    ❌ 절대 금지:
    - ${Math.round(targetLength * 0.9)}자보다 적게 쓰는 것 (분량 미달!)
    - **${targetLength <= 2000 ? 2000 : Math.round(targetLength * 1.2)}자보다 많이 쓰는 것 (분량 초과! 너무 길어요!)**
    - 내용 없이 같은 말 반복하기
    - 해시태그로 글자 수 채우기
    - 불필요하게 길게 늘려쓰기
    
    이미지 개수: ${targetImageCount}장 (${imageMarkers} 마커 사용)
    
    [네이버 블로그 HTML 형식 작성 필수]
    🚨🚨🚨 **마크다운 문법 절대 사용 금지!!!** 🚨🚨🚨
    ❌ **굵은글씨** → ✅ <strong>굵은글씨</strong> 또는 <b>굵은글씨</b>
    ❌ *기울임* → ✅ <em>기울임</em>
    ❌ ### 제목 → ✅ <h3>제목</h3>
    ❌ - 목록 → ✅ <ul><li>목록</li></ul>
    ❌ [링크](url) → ✅ <a href="url">링크</a>
    
    ⛔ 특히 **단어** 이런 식으로 별표 두 개로 감싸는 거 절대 금지!
    ⛔ 반드시 <strong>단어</strong> 또는 <b>단어</b>로 작성!
    
    HTML 구조 (이미지 ${targetImageCount}장 배치, 글자 수 ${targetLength}자 기준):
    <div class="naver-post-container">
      <h3>🎯 서론 제목 (공감 유도)</h3>
      <p>서론 문단 (${targetLength >= 4000 ? '400자 이상' : targetLength >= 3000 ? '300자 이상' : '200자 이상'}) - ${writingStyle === 'expert' ? '의학적 인사이트나 논문/학회 인용으로 시작' : '구체적 상황 묘사로 시작! (예: "히터 켜고 자고 일어나면...")'}</p>
      <p>서론 추가 문단 - 왜 이 주제가 중요한지 설명</p>
      
      [IMG_1]
      
      <h3>📌 본론 1: 정의/개념 설명</h3>
      <p>핵심 개념 설명 (${targetLength >= 4000 ? '500자 이상' : '350자 이상'})</p>
      <p>추가 설명 + 예시</p>
      <ul>
        <li>포인트 1 - 상세 설명</li>
        <li>포인트 2 - 상세 설명</li>
        <li>포인트 3 - 상세 설명</li>
      </ul>
      
      ${targetImageCount >= 2 ? '[IMG_2]' : ''}
      
      <h3>⚠️ 본론 2: 원인/증상 상세</h3>
      <p>원인 설명 (${targetLength >= 4000 ? '500자 이상' : '350자 이상'})</p>
      <p>증상별 상세 설명 + 구체적 사례</p>
      <ul>
        <li>원인/증상 1 - "예를 들어..." 상세 설명</li>
        <li>원인/증상 2 - 구체적 상황 묘사</li>
        <li>원인/증상 3 - 주의사항</li>
      </ul>
      
      ${targetImageCount >= 3 ? '[IMG_3]' : ''}
      
      ${targetLength >= 3500 ? `
      <h3>🔬 본론 3: 진단/검사 방법</h3>
      <p>검사 방법 상세 설명 (400자 이상) - 어떤 검사를 하는지, 검사 과정은 어떤지</p>
      <p>검사 결과 해석 방법 + 주의사항</p>
      <ul>
        <li>검사 종류 1 설명</li>
        <li>검사 종류 2 설명</li>
      </ul>
      ` : ''}
      
      ${targetImageCount >= 4 ? '[IMG_4]' : ''}
      
      ${targetLength >= 4000 ? `
      <h3>💊 본론 4: 치료/관리 방법</h3>
      <p>치료 방법 상세 설명 (500자 이상)</p>
      <p>관리 방법 + 생활 습관 개선 팁</p>
      <ul>
        <li>치료법 1 - 장단점 설명</li>
        <li>치료법 2 - 적용 대상</li>
        <li>생활 관리법 - 구체적 방법</li>
      </ul>
      ` : ''}
      
      ${targetLength >= 4500 ? `
      <h3>🛡️ 본론 5: 예방법/주의사항</h3>
      <p>예방법 상세 설명 (400자 이상)</p>
      <p>일상에서 실천할 수 있는 구체적 방법들</p>
      <ul>
        <li>예방법 1 - 실천 방법</li>
        <li>예방법 2 - 실천 방법</li>
        <li>주의사항 - 이런 경우는 주의!</li>
      </ul>
      ` : ''}
      
      ${targetImageCount >= 5 ? '[IMG_5]' : ''}
      
      ${targetLength >= 5000 ? `
      <h3>❓ 자주 묻는 질문 (FAQ)</h3>
      <p><strong>Q1. [자주 묻는 질문 1]</strong></p>
      <p>A1. 상세한 답변 (150자 이상)</p>
      <p><strong>Q2. [자주 묻는 질문 2]</strong></p>
      <p>A2. 상세한 답변 (150자 이상)</p>
      <p><strong>Q3. [자주 묻는 질문 3]</strong></p>
      <p>A3. 상세한 답변 (150자 이상)</p>
      ` : ''}
      
      <h3>✅ 마무리: 핵심 정리</h3>
      <p>핵심 내용 요약 (${targetLength >= 4000 ? '300자 이상' : '200자 이상'}) - ${writingStyle === 'conversion' ? '행동을 하나로 집중! ("딱 하나만 기억하세요...")' : '핵심 정보 요약'}</p>
      
      <div class="cta-box">
        <p class="cta-title">💡 건강 체크 포인트</p>
        <p class="cta-text">심리학적 전환 문구 삽입 (아래 규칙 참조)</p>
      </div>
      
      <p>해시태그 10~15개</p>
    </div>
    
    ${PSYCHOLOGY_CTA_PROMPT}
    
    [🎯 마무리 CTA 박스 작성 규칙]
    1. 글의 주제와 연관된 심리학 기법 2-3개 조합
    2. 독자가 "다음 행동"을 자연스럽게 떠올리게 유도
    3. 직접적 권유 없이 간접적으로 행동 유도
    
    **CTA 박스 HTML 구조:**
    <div class="cta-box">
      <p class="cta-title">💡 [관련 이모지] [후킹 제목]</p>
      <p class="cta-text">[심리학 기반 전환 문구 2-3문장]</p>
      <p class="cta-subtext">[부드러운 마무리 한 줄]</p>
    </div>
    
    **예시:**
    <div class="cta-box">
      <p class="cta-title">💡 혹시 이런 증상, 그냥 넘기고 계신가요?</p>
      <p class="cta-text">
        작은 불편함도 초기에 확인하면 관리가 훨씬 수월해질 수 있습니다.<br/>
        많은 분들이 정기 검진으로 건강을 지키고 계세요.<br/>
        이번 기회에 내 몸 상태를 점검해 보시는 건 어떨까요?
      </p>
      <p class="cta-subtext">건강한 오늘이 행복한 내일을 만듭니다 😊</p>
    </div>
    
    주의사항:
    1. 모든 제목은 <h3> 태그 사용
    2. 모든 문단은 <p> 태그 사용
    3. 리스트는 <ul><li> 태그 사용
    4. 이미지 마커 ${imageMarkers}를 글 중간에 적절히 배치
    5. 해시태그는 마지막에 <p> 안에 작성
    6. **CTA 박스는 반드시 마지막 이미지 다음, 해시태그 전에 배치**
    
    **마무리 문단 필수 규칙:**
    - "방문하세요", "내원하세요" 같은 직접 권유 표현 절대 금지
    - "검진을 고려해 보시는 것도 좋습니다", "전문의와 상담이 필요할 수 있습니다" 등 간접 표현 사용
    - 병원 이름, 전화번호, 주소 절대 금지
    
    [📊 전환 점수(conversion_score) 평가 기준 - 0~100점]
    **의료법 100% 준수하면서 전환력을 측정합니다**
    
    평가 항목 (각 20점):
    1. **공감 도입부** (20점): 독자가 "이거 내 얘기네!" 느끼는 구체적 상황 묘사
       - 0점: 일반적인 서론 ("오늘은 ~에 대해...")
       - 10점: 보통 수준의 공감 ("~하신 분들 많으시죠?")
       - 20점: 구체적 상황 ("아침에 일어났을 때 손가락이 뻣뻣하고...")
    
    2. **정보 가치** (20점): 독자가 얻어가는 실질적 정보
       - 0점: 뻔한 정보만 나열
       - 10점: 기본적인 유용한 정보
       - 20점: "이건 몰랐네!" 싶은 전문적 인사이트
    
    3. **심리적 긴박감** (20점): 의료법 준수하면서 행동 필요성 인식
       - 0점: 긴박감 없음
       - 10점: 일반적인 중요성 언급
       - 20점: "지금 확인하느냐, 나중에 후회하느냐" 수준의 간접적 긴박감
    
    4. **CTA 품질** (20점): 자연스러운 행동 유도
       - 0점: CTA 없음 또는 직접적 권유 (의료법 위반)
       - 10점: 형식적인 마무리
       - 20점: 독자가 자연스럽게 "병원 가봐야겠다" 생각하게 만드는 심리적 CTA
    
    5. **전체 흐름** (20점): 도입→본론→CTA 자연스러운 연결
       - 0점: 내용이 뒤죽박죽
       - 10점: 기본적인 구조
       - 20점: 읽다 보면 자연스럽게 결론에 도달하는 흐름
    
    [⚖️ 의료법 준수 점수(safety_score) 평가 기준 - 0~100점]
    **의료광고법 위반 여부를 엄격하게 측정합니다**
    
    감점 항목:
    1. **직접 권유 표현** (-30점/건): "방문하세요", "내원하세요", "예약하세요", "상담하세요"
    2. **치료 효과 보장** (-25점/건): "완치", "100% 효과", "확실한", "보장"
    3. **과대 광고** (-20점/건): "최고", "유일", "1등", "최상급"
    4. **비교 광고** (-20점/건): 타 병원과 비교, "우리가 더 좋다"
    5. **공포 유발** (-15점/건): "지금 안하면 위험", "돌연사", "사망"
    6. **병원 정보 노출** (-10점/건): 병원명, 전화번호, 주소
    
    안전한 표현 (감점 없음):
    ✅ "검진을 고려해 보시는 것도 좋습니다"
    ✅ "전문의와 상담이 필요할 수 있습니다"
    ✅ "증상이 지속되면 확인이 필요합니다"
    ✅ 질환명, 증상명, 정보성 키워드
    
    **중요: conversion_score가 100점이어도 의료법은 반드시 준수해야 합니다!**
    - 직접적 내원/예약 권유 = 의료법 위반 = safety_score 감점
    - 전환력은 "간접적이지만 효과적인" 방식으로 달성
    
    [🤖 AI 냄새 점수(ai_smell_score) 평가 기준 v2.0 - 0~100점]
    **낮을수록 좋음! 15점 초과 시 재작성 필요**
    **🔄 v2.0: 중복 항목 제거, 배점 재조정, 심사숙고 평가**
    
    가점 항목 (점수가 높아질수록 AI 냄새가 심함):
    
    1. **문장 리듬 단조로움** (0~25점) ⭐ 가장 중요
       - 동일 종결어미 3회 이상 반복 → +7점
       - 문장 시작 패턴 3회 이상 반복 → +6점
       - 문단 길이가 ±20자 내로 균일 → +6점
       - 질문·감탄·짧은 문장 없이 설명만 연속 → +6점
    
    2. **판단 회피형 글쓰기** (0~20점)
       - 한 문단에 조건/가능성 종결 3회 이상 → +8점
       - 명확한 기준 없이 "확인 필요"만 반복 → +7점
       - 글 전체에서 저자 의견/판단 0회 → +5점
    
    3. **현장감 부재** (0~20점)
       - 시간/계절/상황 맥락 전무 → +7점
       - 실제 질문/고민 시나리오 없음 → +7점
       - 현장 용어(병원, 접수, 대기 등) 0회 → +6점
    
    4. **템플릿 구조** (0~15점)
       - 정의→원인→증상→치료 순서 그대로 → +6점
       - 독자 자가 체크 포인트 없음 → +5점
       - 문단 간 전환어 없이 나열만 → +4점
    
    5. **가짜 공감** (0~10점)
       - "걱정되실 수 있습니다" 류 범용 공감만 존재 → +4점
       - 구체적 상황·감정 지목 없음 → +3점
       - 공감 문장이 항상 문단 첫 줄에만 위치 → +3점
    
    6. **행동 유도 실패** (0~10점)
       - 매번 동일한 CTA 문구로 종결 → +4점
       - 시점·조건 없는 막연한 권유 → +3점
       - 독자 상황별 분기 없음 → +3점
    
    **판정 기준 (v2.0):**
    - 0~7점: ✅ 사람 글 → 그대로 발행
    - 8~15점: ⚠️ 경계선 → 부분 수정 후 발행
    - 16점 이상: 🚨 AI 확정 → 재작성 대상
    
    **심사숙고 평가 원칙:**
    - 각 항목을 꼼꼼히 체크하고 근거와 함께 점수 산정
    - 애매한 경우 보수적으로 (낮게) 평가
    - 관찰 문장 1줄만 있어도 현장감 점수 급감
    
    [🎨 이미지 프롬프트 작성 규칙 - 매우 중요!]
    **imagePrompts 배열에 들어갈 프롬프트는 반드시 한국어로 작성하세요!**
    이미지 스타일: ${customImagePrompt ? `커스텀: ${customImagePrompt}` : imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D 해부학' : '실사 사진'}
    
    **🚨 블로그 이미지 텍스트 규칙 (매우 중요!):**
    - ❌ 이미지에 텍스트 넣지 마세요! (글자, 숫자, 문구 모두 금지)
    - ❌ 로고, 워터마크, 간판, 표지판 금지
    - ✅ 순수한 일러스트/사진만 생성
    - ✅ 프롬프트에 "텍스트 없이", "글자 없이" 명시 필수!
    
    각 이미지 프롬프트에 반드시 포함할 스타일 키워드:
    ${imageStyleGuide}
    
    ${customImagePrompt ? `**⚠️ 커스텀 스타일 필수 적용!**
    사용자가 "${customImagePrompt}" 스타일을 요청했습니다.
    모든 이미지 프롬프트에 이 스타일 키워드를 반드시 포함하세요!
    예시: "[장면 묘사], ${customImagePrompt}, 텍스트 없이"` : `예시 (${imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D' : '실사 사진'} 스타일):
    ${imageStyle === 'illustration' 
      ? '- "밝은 병원 상담실에서 의사가 환자에게 설명하는 모습, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트, 텍스트 없이"'
      : imageStyle === 'medical'
      ? '- "인체 심장의 3D 단면도, 좌심실과 우심실이 보이는 해부학적 구조, 혈관과 판막이 보이는 의학 일러스트, 파란색 배경, 텍스트 없이"'
      : '- "깔끔한 병원 상담실에서 의사가 환자와 상담하는 모습, 실사 사진, DSLR 촬영, 자연스러운 조명, 텍스트 없이"'}`}
  `;

  const cardNewsPrompt = `
    **🚨🚨🚨 최우선 지침: 이것은 카드뉴스입니다! 🚨🚨🚨**
    - 블로그 포스팅 형식(긴 문단)으로 작성하면 안 됩니다!
    - 반드시 <div class="card-slide"> 구조의 슬라이드 형식으로 작성하세요!
    - 각 슬라이드는 짧은 텍스트(제목 12자, 설명 20자 이내)만 포함합니다!
    
    ${MEDICAL_SAFETY_SYSTEM_PROMPT}
    ${writingStylePrompt}
    ${getWritingStyleCommonRules()}
    ${benchmarkingInstruction}
    ${styleAnalysis}
    
    [📅 현재 시점 정보 - 최신 정보 기반 작성 필수!]
    ${timeContext}
    - ${currentYear}년 최신 의학 가이드라인/연구 결과 반영
    - ${currentSeason}철 특성 고려 (계절성 질환, 생활 습관 등)
    - Google 검색으로 ${currentYear}년 최신 정보 확인 후 작성
    
    진료과: ${request.category}, 주제: ${request.topic}
    총 ${targetSlides}장의 카드뉴스
    글 스타일: ${writingStyle === 'expert' ? '전문가형(신뢰·권위·논문 인용)' : writingStyle === 'empathy' ? '공감형(독자 공감 유도)' : '전환형(행동 유도)'}
    
    [🚨🚨🚨 핵심 주제 키워드 - 반드시 모든 카드에 반영하세요! 🚨🚨🚨]
    
    **주제: "${request.topic}"**
    - 이 주제가 모든 카드의 중심이 되어야 합니다!
    - "${request.topic}"과 직접 관련된 구체적인 내용만 작성하세요!
    - 일반적이고 추상적인 건강 정보는 ❌ 금지!
    - "${request.topic}"의 구체적인 증상, 원인, 특징을 다루세요!
    
    **⚠️ 질환명/증상명 사용 규칙:**
    - "${request.topic}"에 포함된 질환명(예: 혈액암, 당뇨병, 고혈압 등)은 그대로 사용하세요!
    - 의료 정보를 돌려말하지 마세요! 직접적으로 설명하세요!
    - "몸의 변화", "건강 이상 신호" 같은 모호한 표현 ❌
    - "${request.topic}"의 실제 증상명과 특징을 구체적으로 ✅
    
    [🚨🚨🚨 가장 중요: 스토리 연결성 - 반드시 읽고 적용하세요! 🚨🚨🚨]
    
    **카드뉴스는 반드시 "하나의 스토리"로 연결되어야 합니다!**
    - 각 슬라이드가 독립적인 내용이면 안 됩니다!
    - 1장부터 마지막 장까지 "${request.topic}"에 대해 깊이 있게 다루세요!
    - "표지 → 정의/개요 → 구체적 증상/특징들 → 마무리" 구조를 따르세요!
    
    **스토리 구조 (${targetSlides}장) - "${request.topic}" 기준:**
    
    📕 **1장 (표지)**: "${request.topic}" 주제 소개
    - 제목에 "${request.topic}" 키워드 필수 포함!
    - 예: "${request.topic}, 이런 신호를 놓치지 마세요"
    
    📘 **2장**: "${request.topic}"이란? (정의/개요)
    - "${request.topic}"가 무엇인지 직접적으로 설명
    - 모호하게 돌려말하지 않기!
    
    📗 **3~${targetSlides - 1}장**: "${request.topic}"의 구체적 증상/특징/방법
    - 각 슬라이드에 "${request.topic}"과 직접 관련된 하나의 구체적 내용
    - 실제 증상명, 특징, 원인 등을 명확하게!
    - 예시: 혈액암이라면 → "멍이 쉽게 드나요?", "잇몸 출혈", "만성 피로", "림프절 부종"
    
    📙 **${targetSlides}장 (마무리)**: 정리 + 행동 유도
    - "${request.topic}" 관련 핵심 메시지
    - 자가진단/전문의 상담 권유 등
    
    **✅ "${request.topic}" 주제 올바른 예시:**
    만약 주제가 "혈액암 초기증상"이라면:
    1장: "혈액암, 이 신호를 놓치고 있진 않나요?" (표지)
    2장: "혈액암이란?" - 혈액세포에 생기는 암의 종류 설명
    3장: "멍이 쉽게 드시나요?" - 혈소판 감소로 인한 증상
    4장: "잇몸에서 피가 자주 나나요?" - 출혈 경향 설명
    5장: "쉬어도 풀리지 않는 피로감" - 빈혈로 인한 피로
    6장: "조기 발견이 중요합니다" - 정기검진 권유
    
    **❌ 잘못된 예시 (주제와 동떨어진 일반론):**
    1장: "몸이 보내는 신호" (← 주제 키워드 없음!)
    2장: "피로의 원인" (← 너무 일반적!)
    3장: "건강관리의 중요성" (← 주제와 무관!)
    → "${request.topic}"을 직접 다루지 않으면 안 됩니다!
    
    ${PSYCHOLOGY_CTA_PROMPT}
    
    [🎯 마지막 슬라이드 (${targetSlides}장) 심리학적 전환 문구 규칙]
    마지막 카드는 독자가 "다음 행동"을 떠올리게 하는 심리학적 설득 기법을 사용합니다.
    
    **마지막 슬라이드 예시:**
    card-subtitle: "지금이 기회예요" / "함께 지켜요" / "시작해볼까요?"
    card-main-title: "작은 습관이<br/><span class='card-highlight'>생명</span>을 지킵니다"
    card-desc: "건강한 오늘이 행복한 내일을 만듭니다 😊"
    
    **심리학 기법 적용 예시 (마지막 카드):**
    - 손실회피: "미루면 놓칠 수 있어요"
    - 사회적증거: "많은 분들이 실천 중이에요"  
    - 시의성: "이맘때가 적기예요"
    - 감정호소: "소중한 일상, 오래 누리세요"
    
    ${request.referenceUrl ? '★벤치마킹 URL의 구성 방식도 참고하세요.' : ''}
    
    ${styleAnalysis ? `
    **⚠️⚠️⚠️ 중요: 스타일 참고 이미지가 있습니다! ⚠️⚠️⚠️**
    - 위에서 제공한 "표지/본문 HTML 템플릿"의 style 속성을 그대로 사용하세요!
    - 기본 HEALTH NOTE 스타일(주황색 테두리)을 사용하면 안 됩니다!
    - 분석된 색상(${coverStyle.backgroundColor || contentStyle.backgroundColor || '분석된 색상'})을 반드시 적용하세요!
    ` : `
    [HTML 구조 - 기본 스타일 (연한 하늘색 배경)]
    **⚠️ 중요: 아래 템플릿을 그대로 복사해서 사용하세요! style 속성 필수!**
    
    <div class="card-slide" style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%); border-radius: 24px; padding: 0; overflow: hidden;">
      <div style="padding: 32px 28px; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%;">
        <p class="card-subtitle" style="font-size: 14px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">질문형 부제목 (10~15자)</p>
        <p class="card-main-title" style="font-size: 28px; font-weight: 900; color: #1E293B; line-height: 1.3; margin: 0 0 16px 0;">메인 제목<br/><span style="color: #3B82F6;">강조 텍스트</span></p>
        <div class="card-img-container" style="width: 100%; margin: 16px 0;">[IMG_N]</div>
        <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.6; font-weight: 500; max-width: 90%;">여기에 30~50자의 구체적인 설명 문장을 작성하세요. 독자가 정보를 얻을 수 있도록 충분히!</p>
      </div>
    </div>
    
    **🚨 card-desc 부분이 가장 중요합니다! 반드시 30자 이상 작성하세요! 🚨**
    
    **배경색 필수: style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%);" 적용!**
    `}
    
    [🚫 절대 금지 표현 - 카드에 이런 텍스트 넣지 마세요!]
    ❌ "01.", "02.", "03." 같은 슬라이드 번호
    ❌ "해결책 1", "해결책 2", "마무리" 같은 구조 용어
    ❌ "첫 번째", "두 번째", "세 번째" 같은 순서 표현
    ❌ "후킹", "문제 제기", "원인/배경" 같은 프레임워크 용어
    
    [✅ 올바른 예시]
    card-subtitle: "알고 계셨나요?" / "왜 위험할까요?" / "이렇게 해보세요"
    card-main-title: "겨울철 심장마비<br/><span class='card-highlight'>3배</span> 증가" 
    
    [🚨🚨🚨 작성 규칙 - 매우 중요 🚨🚨🚨]
    1. 각 슬라이드에 [IMG_1]~[IMG_${targetSlides}] 마커 필수
    2. 이전 슬라이드와 내용이 자연스럽게 연결
    3. card-main-title은 **반드시 <p> 태그 사용** (h1 사용 금지!)
    4. card-main-title은 **15~20자**로 충분히 작성! 줄바꿈은 <br/> 사용
    5. card-subtitle은 **10~15자**의 질문형 또는 핵심 포인트
    6. **card-desc는 반드시 30~50자**의 구체적인 설명 문장 포함! (가장 중요!)
    7. 실제 독자가 볼 콘텐츠만 작성 (메타 정보 금지)
    8. **글씨가 너무 없으면 안 됨!** 각 카드에 충분한 정보 전달 필수!
    
    [📝 텍스트 분량 규칙 - 반드시 지키세요!]
    ❌ 잘못된 예 (텍스트 부족):
    - card-subtitle: "지금 알아야 해요" (8자)
    - card-main-title: "심정지<br/><span class='card-highlight'>4분</span>" (6자)
    - card-desc: "골든타임 사수" (6자) ← 너무 짧음!
    
    ✅ 올바른 예 (충분한 텍스트):
    - card-subtitle: "왜 4분이 중요할까요?" (12자)
    - card-main-title: "뇌세포 생존<br/><span class='card-highlight'>마지노선</span>" (12자)
    - card-desc: "4분이 지나면 뇌 손상이 급격히 진행돼요. 골든타임을 놓치지 마세요!" (40자) ← 이 정도는 되어야 함!
    
    [❌ 잘못된 예시 - 절대 이렇게 쓰지 마세요]
    <p class="card-main-title">스타틴 임의 중단은 금물! 전문의가 강조하는 만성질환 복약 순응도의 중요성</p>
    
    [✅ 올바른 예시]
    <p class="card-main-title">스타틴<br/><span class="card-highlight">중단 금지!</span></p>
    
    [🎨 이미지 프롬프트 작성 규칙 - 매우 중요!]
    **imagePrompts 배열에 들어갈 프롬프트는 반드시 한국어로 작성하세요!**
    이미지 스타일: ${customImagePrompt ? `커스텀: ${customImagePrompt}` : imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D 해부학' : '실사 사진'}
    
    **📝 카드뉴스 이미지 텍스트 규칙:**
    - 카드뉴스 이미지에는 제목, 설명 텍스트가 들어갈 수 있음
    - 한글, 숫자 위주로
    - 로고, 워터마크 금지
    
    각 이미지 프롬프트에 반드시 포함할 스타일 키워드:
    ${imageStyleGuide}
    
    ${customImagePrompt ? `**⚠️ 커스텀 스타일 필수 적용!**
    사용자가 "${customImagePrompt}" 스타일을 요청했습니다.
    모든 이미지 프롬프트에 이 스타일 키워드를 반드시 포함하세요!
    예시: "[장면 묘사], ${customImagePrompt}"` : `예시 (${imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D' : '실사 사진'} 스타일):
    ${imageStyle === 'illustration' 
      ? '- "밝은 병원 배경의 건강 인포그래픽, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트"'
      : imageStyle === 'medical'
      ? '- "인체 폐의 3D 단면도, 기관지와 폐포 구조가 보이는 해부학 일러스트, 투명 효과, 파란색 의료 배경"'
      : '- "깔끔한 병원 환경 이미지, 실사 사진, DSLR 촬영, 전문적인 분위기"'}`}
    
    [🚨🚨🚨 최종 검증 - 작성 후 반드시 확인하세요! 🚨🚨🚨]
    각 카드의 card-desc가 30자 이상인지 확인하세요!
    예: "심장이 멈춘 지 4분이 지나면 뇌세포가 마음대로 누설되기 시작해요" (이 정도 길이)
    텍스트가 너무 짧으면 독자가 정보를 얻을 수 없습니다!
  `;

  try {
    // AI Provider 설정 확인
    const providerSettings = getAiProviderSettings();
    let result: any;

    if (providerSettings.textGeneration === 'openai') {
      // 🔄 2단계 프로세스: Gemini 검색 → GPT 작성
      console.log('🔄 3-Stage Process: Dual Search (Gemini + GPT) → Cross-Check → GPT-5.2 Writing');
      console.log('📍 Step 1 시작 준비...');
      
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      // 📍 Step 1: 최신 정보 검색 (Gemini 우선, 실패 시 GPT)
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      console.log('📍 onProgress 호출 직전...');
      try {
        if (typeof onProgress === 'function') {
          onProgress('🔍 Step 1: 최신 정보를 검색하고 있습니다...');
        } else {
          console.warn('⚠️ onProgress가 함수가 아님:', typeof onProgress);
        }
      } catch (progressError) {
        console.error('❌ onProgress 호출 에러:', progressError);
      }
      console.log('📍 onProgress 호출 완료, searchPrompt 생성 시작...');
      
      const searchPrompt = `
당신은 의료 정보 검색 전문가입니다.
아래 주제에 대해 공신력 있는 최신 정보를 수집해주세요.

[검색 주제]
- 진료과: ${request.category}
- 주제: ${request.topic}
- 키워드: ${request.keywords}

[필수 검색 출처 - 반드시 이 출처들에서만 정보 수집!]
1. 대한OO학회 최신 가이드라인 (${getCurrentYear()}년 또는 ${getCurrentYear()-1}년)
2. 질병관리청(KDCA), 보건복지부 최신 자료
3. PubMed, JAMA, NEJM 최신 논문
4. 국민건강보험공단, 건강보험심사평가원 통계

[검색 지시]
- 현재 ${getCurrentYear()}년 기준 최신 자료 우선
- 블로그, 카페, SNS, 유튜브 정보는 절대 수집 금지
- 통계는 반드시 출처와 연도 포함

[JSON 응답 형식]
{
  "collected_facts": [
    {
      "fact": "수집한 사실 정보",
      "source": "출처 (학회/기관명)",
      "year": ${getCurrentYear()},
      "url": "참고 URL (있는 경우)"
    }
  ],
  "key_statistics": [
    {
      "stat": "통계 내용",
      "source": "출처",
      "year": ${getCurrentYear()}
    }
  ],
  "latest_guidelines": [
    {
      "guideline": "가이드라인 내용",
      "organization": "발표 기관",
      "year": ${getCurrentYear()}
    }
  ]
}`;

      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      // 🔄 듀얼 검색: Gemini + GPT 동시 검색 → 크로스체크
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      console.log('🔄 듀얼 검색 시작: Gemini + GPT 동시 검색');
      onProgress('🔍 Step 1: Gemini + GPT 동시 검색 중...');
      
      let geminiResults: any = null;
      let gptResults: any = null;
      let crossCheckedResults: any = {};
      
      // 🔵 Gemini 검색 (Promise)
      const geminiSearchPromise = (async () => {
        try {
          console.log('🔵 Gemini 검색 시작...');
          const ai = getAiClient();
          const searchResponse = await ai.models.generateContent({
            model: "gemini-3-pro-preview",
            contents: searchPrompt,
            config: {
              tools: [{ googleSearch: {} }],
              responseMimeType: "application/json"
            }
          });
          const result = JSON.parse(searchResponse.text || "{}");
          console.log('✅ Gemini 검색 완료');
          return { success: true, data: result, source: 'gemini' };
        } catch (error) {
          console.warn('⚠️ Gemini 검색 실패:', error);
          return { success: false, data: null, source: 'gemini', error };
        }
      })();
      
      // 🟢 GPT 검색 (Promise)
      const gptSearchPromise = (async () => {
        try {
          console.log('🟢 GPT 검색 시작...');
          const gptSearchResponse = await callOpenAI(
            searchPrompt, 
            '당신은 의료 정보 검색 전문가입니다. 반드시 JSON 형식으로 응답하세요. 최신 의료 정보를 검색하여 제공해주세요.'
          );
          const result = JSON.parse(gptSearchResponse);
          console.log('✅ GPT 검색 완료');
          return { success: true, data: result, source: 'gpt' };
        } catch (error) {
          console.warn('⚠️ GPT 검색 실패:', error);
          return { success: false, data: null, source: 'gpt', error };
        }
      })();
      
      // 동시 실행 및 결과 수집
      const [geminiResult, gptResult] = await Promise.all([geminiSearchPromise, gptSearchPromise]);
      
      geminiResults = geminiResult.success ? geminiResult.data : null;
      gptResults = gptResult.success ? gptResult.data : null;
      
      console.log('📊 검색 결과 - Gemini:', !!geminiResults, ', GPT:', !!gptResults);
      
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      // 🔀 크로스체크: 두 결과 병합 및 검증
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      onProgress('🔀 Step 1.5: 검색 결과 크로스체크 중...');
      
      if (geminiResults && gptResults) {
        // 🎯 둘 다 성공: 크로스체크 병합
        console.log('🎯 듀얼 검색 성공 - 크로스체크 병합 시작');
        
        crossCheckedResults = {
          collected_facts: [
            ...(geminiResults.collected_facts || []).map((f: any) => ({ ...f, verified_by: 'gemini' })),
            ...(gptResults.collected_facts || []).map((f: any) => ({ ...f, verified_by: 'gpt' }))
          ],
          key_statistics: [
            ...(geminiResults.key_statistics || []).map((s: any) => ({ ...s, verified_by: 'gemini' })),
            ...(gptResults.key_statistics || []).map((s: any) => ({ ...s, verified_by: 'gpt' }))
          ],
          latest_guidelines: [
            ...(geminiResults.latest_guidelines || []).map((g: any) => ({ ...g, verified_by: 'gemini' })),
            ...(gptResults.latest_guidelines || []).map((g: any) => ({ ...g, verified_by: 'gpt' }))
          ],
          cross_check_status: 'dual_verified',
          gemini_found: (geminiResults.collected_facts?.length || 0) + (geminiResults.key_statistics?.length || 0),
          gpt_found: (gptResults.collected_facts?.length || 0) + (gptResults.key_statistics?.length || 0)
        };
        
        // 중복 제거 (같은 fact/stat은 하나로 병합하고 'both'로 표시)
        const deduplicateFacts = (facts: any[]) => {
          const seen = new Map();
          return facts.filter(f => {
            const key = (f.fact || f.stat || f.guideline || '').substring(0, 50).toLowerCase();
            if (seen.has(key)) {
              // 이미 있으면 verified_by를 'both'로 업데이트
              const existing = seen.get(key);
              if (existing.verified_by !== f.verified_by) {
                existing.verified_by = 'both';
                existing.cross_verified = true;
              }
              return false;
            }
            seen.set(key, f);
            return true;
          });
        };
        
        crossCheckedResults.collected_facts = deduplicateFacts(crossCheckedResults.collected_facts);
        crossCheckedResults.key_statistics = deduplicateFacts(crossCheckedResults.key_statistics);
        crossCheckedResults.latest_guidelines = deduplicateFacts(crossCheckedResults.latest_guidelines);
        
        // 크로스 검증된 항목 수 계산
        const crossVerifiedCount = [
          ...crossCheckedResults.collected_facts,
          ...crossCheckedResults.key_statistics,
          ...crossCheckedResults.latest_guidelines
        ].filter((item: any) => item.cross_verified || item.verified_by === 'both').length;
        
        crossCheckedResults.cross_verified_count = crossVerifiedCount;
        
        console.log(`✅ 크로스체크 완료 - 총 ${crossCheckedResults.collected_facts.length}개 팩트, ${crossVerifiedCount}개 교차 검증됨`);
        onProgress(`✅ 듀얼 검색 완료: ${crossVerifiedCount}개 정보 교차 검증됨`);
        
      } else if (geminiResults) {
        // Gemini만 성공
        console.log('🔵 Gemini만 검색 성공');
        crossCheckedResults = {
          ...geminiResults,
          cross_check_status: 'gemini_only',
          warning: 'GPT 검색 실패로 단일 소스 검증'
        };
        onProgress('🔵 Gemini 검색 결과로 진행 (GPT 검색 실패)');
        
      } else if (gptResults) {
        // GPT만 성공
        console.log('🟢 GPT만 검색 성공');
        crossCheckedResults = {
          ...gptResults,
          cross_check_status: 'gpt_only',
          warning: 'Gemini 검색 실패로 단일 소스 검증'
        };
        onProgress('🟢 GPT 검색 결과로 진행 (Gemini 검색 실패)');
        
      } else {
        // 둘 다 실패
        console.error('❌ 듀얼 검색 모두 실패');
        crossCheckedResults = {
          collected_facts: [],
          key_statistics: [],
          latest_guidelines: [],
          search_failed: true,
          cross_check_status: 'both_failed'
        };
        onProgress('⚠️ 검색 실패 - AI 자체 지식 기반으로 작성');
      }
      
      // 최종 searchResults로 설정
      const searchResults = crossCheckedResults;
      
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      // 📍 Step 2: GPT-5.2가 검색 결과를 바탕으로 글 작성
      // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
      console.log('📍 Step 2 시작: GPT-5.2 글쓰기...');
      if (typeof onProgress === 'function') {
        onProgress('✍️ Step 2: GPT-5.2가 자연스러운 글을 작성하고 있습니다...');
      }
      
      const gptSystemPrompt = getGPT52ProPrompt();
      
      // 크로스체크 상태에 따른 신뢰도 안내
      const crossCheckGuide = searchResults.cross_check_status === 'dual_verified'
        ? `🎯 듀얼 검색 크로스체크 완료!
- Gemini 검색 결과: ${searchResults.gemini_found || 0}개 정보
- GPT 검색 결과: ${searchResults.gpt_found || 0}개 정보  
- 교차 검증된 정보: ${searchResults.cross_verified_count || 0}개 (가장 신뢰도 높음!)

⭐ 우선순위: cross_verified=true 또는 verified_by='both' 정보 > 단일 소스 정보`
        : searchResults.cross_check_status === 'gemini_only'
        ? '🔵 Gemini 단일 검색 결과입니다. GPT 검색이 실패하여 교차 검증되지 않았습니다.'
        : searchResults.cross_check_status === 'gpt_only'
        ? '🟢 GPT 단일 검색 결과입니다. Gemini 검색이 실패하여 교차 검증되지 않았습니다.'
        : '⚠️ 검색에 실패하여 AI 자체 지식으로 작성합니다.';
      
      const systemPrompt = `${gptSystemPrompt}

[🔍 듀얼 검색 + 크로스체크 결과]
${crossCheckGuide}

${searchResults.search_failed 
  ? '반드시 출처 규칙을 엄격히 준수하세요!' 
  : `아래는 Gemini + GPT 듀얼 검색으로 수집한 공신력 있는 최신 정보입니다.
교차 검증된 정보(cross_verified 또는 verified_by='both')를 최우선으로 사용하세요!

${JSON.stringify(searchResults, null, 2)}`}

[⚠️ 크로스체크 기반 작성 규칙]
1. ${searchResults.cross_check_status === 'dual_verified' 
    ? '🎯 교차 검증된 정보(cross_verified=true)를 최우선으로 사용하세요 - 가장 신뢰도 높음!' 
    : searchResults.search_failed
    ? '검색 실패로 자체 지식 사용 시, 출처 불명확한 정보는 일반화 표현으로 작성하세요'
    : '단일 소스 검색 결과이므로 출처 표기에 더욱 신경 쓰세요'}
2. 통계/수치 사용 시 반드시 출처와 연도를 함께 표기 (예: "질병관리청 ${getCurrentYear()}년 자료에 따르면...")
3. 교차 검증되지 않은 정보는 "~로 알려져 있습니다", "~할 수 있습니다" 등 완화 표현 사용
4. 두 소스에서 상충되는 정보가 있다면 더 공신력 있는 출처(학회, 정부기관) 우선

[📋 JSON 응답 형식]
{
  "title": "제목 (상태 점검형 질문)",
  "content": "HTML 형식의 본문 내용 (크로스체크된 정보 우선 사용)",
  "imagePrompts": ["이미지 프롬프트1", "이미지 프롬프트2", ...],
  "fact_check": {
    "fact_score": 0-100,
    "safety_score": 0-100,
    "conversion_score": 0-100,
    "ai_smell_score": 0-100,
    "verified_facts_count": 0,
    "issues": ["문제점1", "문제점2"],
    "recommendations": ["권장사항1", "권장사항2"]
  }
}`;

      console.log('📍 callOpenAI 호출 직전...');
      console.log('📍 프롬프트 길이:', (isCardNews ? cardNewsPrompt : blogPrompt).length);
      console.log('📍 시스템 프롬프트 길이:', systemPrompt.length);
      
      const responseText = await callOpenAI(isCardNews ? cardNewsPrompt : blogPrompt, systemPrompt);
      console.log('📍 callOpenAI 응답 받음, 길이:', responseText?.length);
      
      result = JSON.parse(responseText);
      
      console.log('✅ GPT-5.2 작성 완료');
      
    } else {
      // Gemini 사용 (기본값)
      console.log('🔵 Using Gemini for text generation');
      const response = await ai.models.generateContent({
        model: "gemini-3-pro-preview",
        contents: isCardNews ? cardNewsPrompt : blogPrompt,
        config: {
          tools: [{ googleSearch: {} }],
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: {
              title: { type: Type.STRING },
              content: { type: Type.STRING },
              imagePrompts: { type: Type.ARRAY, items: { type: Type.STRING } },
              fact_check: {
                type: Type.OBJECT,
                properties: {
                  fact_score: { type: Type.INTEGER },
                  safety_score: { type: Type.INTEGER },
                  conversion_score: { type: Type.INTEGER },
                  ai_smell_score: { type: Type.INTEGER },
                  verified_facts_count: { type: Type.INTEGER },
                  issues: { type: Type.ARRAY, items: { type: Type.STRING } },
                  recommendations: { type: Type.ARRAY, items: { type: Type.STRING } }
                },
                required: ["fact_score", "safety_score", "conversion_score", "ai_smell_score", "verified_facts_count", "issues", "recommendations"]
              }
            },
            required: ["title", "content", "imagePrompts", "fact_check"]
          }
        }
      });
      result = JSON.parse(response.text || "{}");
    }
    
    // AI가 content를 배열이나 객체로 반환한 경우 방어 처리
    if (result.content && typeof result.content !== 'string') {
      console.warn('AI returned non-string content, attempting to extract HTML...');
      if (Array.isArray(result.content)) {
        // 배열인 경우 각 항목에서 HTML 추출
        result.content = result.content.map((item: any) => {
          if (typeof item === 'string') return item;
          if (item?.content) return item.content;
          if (item?.html) return item.html;
          return '';
        }).join('');
      } else if (typeof result.content === 'object') {
        // 객체인 경우 content나 html 필드 추출
        result.content = result.content.content || result.content.html || JSON.stringify(result.content);
      }
    }
    
    // 분석된 스타일 정보 추가
    if (analyzedBgColor) {
      result.analyzedStyle = { backgroundColor: analyzedBgColor };
    }
    
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    // 🎯 SEO 자동 평가 + 90점 미만 시 재생성 (블로그만)
    // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    if (!isCardNews && result.content && result.title) {
      console.log('📊 SEO 자동 평가 시작...');
      if (typeof onProgress === 'function') {
        onProgress('📊 SEO 점수를 자동 평가하고 있습니다...');
      }
      
      const MAX_REGENERATE_ATTEMPTS = 2; // 최대 재생성 횟수
      let currentAttempt = 0;
      
      while (currentAttempt < MAX_REGENERATE_ATTEMPTS) {
        try {
          const seoReport = await evaluateSeoScore(
            result.content,
            result.title,
            request.topic,
            request.keywords || ''
          );
          
          console.log(`📊 SEO 평가 완료 - 총점: ${seoReport.total_score}점`);
          
          // SEO 점수를 결과에 추가
          result.seoScore = seoReport;
          
          if (seoReport.total_score >= 90) {
            console.log('✅ SEO 점수 90점 이상! 통과');
            if (typeof onProgress === 'function') {
              onProgress(`✅ SEO 점수 ${seoReport.total_score}점 - 통과!`);
            }
            break;
          } else {
            currentAttempt++;
            console.log(`⚠️ SEO 점수 ${seoReport.total_score}점 - 90점 미만! 재생성 시도 ${currentAttempt}/${MAX_REGENERATE_ATTEMPTS}`);
            
            if (currentAttempt >= MAX_REGENERATE_ATTEMPTS) {
              console.log('⚠️ 최대 재생성 횟수 도달, 현재 결과 사용');
              if (typeof onProgress === 'function') {
                onProgress(`⚠️ SEO 점수 ${seoReport.total_score}점 - 개선 권장`);
              }
              break;
            }
            
            if (typeof onProgress === 'function') {
              onProgress(`🔄 SEO 점수 ${seoReport.total_score}점 - 재생성 중... (${currentAttempt}/${MAX_REGENERATE_ATTEMPTS})`);
            }
            
            // SEO 개선 포인트를 포함한 재생성 프롬프트
            const improvementPrompt = `
[🚨 SEO 점수 개선 필수!]
이전 글의 SEO 점수: ${seoReport.total_score}점 (90점 이상 필요)

[개선이 필요한 항목]
${seoReport.recommendations?.join('\n') || '- 키워드 배치 최적화\n- 제목 개선\n- 구조화 강화'}

위 피드백을 반영하여 SEO 점수 90점 이상이 되도록 다시 작성해주세요.
특히:
1. 제목 앞 50%에 핵심 키워드 배치
2. 본문에 키워드 자연스럽게 5-8회 포함
3. 소제목(H3)에 키워드 변형 포함
4. 첫 3줄에 공감/질문으로 시작

${blogPrompt}`;

            // 재생성
            if (providerSettings.textGeneration === 'openai') {
              const newResponseText = await callOpenAI(improvementPrompt, systemPrompt);
              result = JSON.parse(newResponseText);
            } else {
              const newResponse = await ai.models.generateContent({
                model: "gemini-3-pro-preview",
                contents: improvementPrompt,
                config: {
                  tools: [{ googleSearch: {} }],
                  responseMimeType: "application/json"
                }
              });
              result = JSON.parse(newResponse.text || "{}");
            }
            
            console.log('🔄 재생성 완료, 다시 SEO 평가...');
          }
        } catch (seoError) {
          console.error('❌ SEO 평가 오류:', seoError);
          break;
        }
      }
    }
    
    return result;
  } catch (error) { throw error; }
};

// 🗞️ 보도자료 생성 함수
const generatePressRelease = async (request: GenerationRequest, onProgress: (msg: string) => void): Promise<GeneratedContent> => {
  const currentDate = new Date();
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth() + 1;
  const day = currentDate.getDate();
  const formattedDate = `${year}년 ${month}월 ${day}일`;
  
  const pressTypeLabels: Record<string, string> = {
    'achievement': '실적 달성',
    'new_service': '신규 서비스/장비 도입',
    'research': '연구/학술 성과',
    'event': '행사/이벤트',
    'award': '수상/인증 획득',
    'health_tips': '건강 조언/정보'
  };
  
  const pressTypeLabel = pressTypeLabels[request.pressType || 'achievement'] || '실적 달성';
  const hospitalName = request.hospitalName || 'OO병원';
  const doctorName = request.doctorName || '홍길동';
  const doctorTitle = request.doctorTitle || '원장';
  const maxLength = request.textLength || 1400;
  
  // 학습된 말투 스타일 적용
  let learnedStyleInstruction = '';
  if (request.learnedStyleId) {
    try {
      const { getStyleById, getStylePromptForGeneration } = await import('./writingStyleService');
      const learnedStyle = getStyleById(request.learnedStyleId);
      if (learnedStyle) {
        learnedStyleInstruction = `
[🎓 학습된 말투 적용 - 보도자료 스타일 유지하며 적용!]
${getStylePromptForGeneration(learnedStyle)}

⚠️ 위 학습된 말투를 보도자료 형식에 맞게 적용하세요:
- 전문적인 보도자료 어조는 유지
- 문장 끝 패턴과 표현 스타일만 반영
- 과도한 구어체는 지양
`;
        console.log('📝 보도자료에 학습된 말투 적용:', learnedStyle.name);
      }
    } catch (e) {
      console.warn('학습된 말투 로드 실패:', e);
    }
  }
  
  onProgress('🗞️ 보도자료 작성 중...');
  
  const pressPrompt = `
당신은 병원 홍보팀 보도자료 전문가입니다.
${learnedStyleInstruction}
아래 정보를 바탕으로 언론 배포용 보도자료를 작성해주세요.

[기본 정보]
- 작성일: ${formattedDate}
- 병원명: ${hospitalName}
- 진료과: ${request.category}
- 의료진: ${doctorName} ${doctorTitle}
- 보도 유형: ${pressTypeLabel}
- 주제: ${request.topic}
- 키워드: ${request.keywords}
- ⚠️ 최대 글자 수: ${maxLength}자 (반드시 이 글자 수를 넘지 마세요!)

[필수 포함 문구 - 반드시 보도자료 하단에 포함]
⚠️ 본 자료는 ${hospitalName}의 홍보 목적으로 작성된 보도자료입니다.
의학적 정보는 참고용이며, 정확한 진단과 치료는 반드시 전문의와 상담하시기 바랍니다.

[보도자료 형식 - 반드시 HTML로 작성]
<div class="press-release-container">
  <div class="press-header">
    <p class="press-date">${formattedDate}</p>
    <p class="press-embargo">즉시 보도 가능</p>
  </div>
  
  <h1 class="press-title">[제목: 임팩트 있는 한 줄 - 50자 이내]</h1>
  <h2 class="press-subtitle">[부제: 핵심 내용 요약 - 70자 이내]</h2>
  
  <div class="press-lead">
    <p>[리드문: 5W1H 원칙에 따라 핵심 내용 요약 - 150~200자]</p>
  </div>
  
  <div class="press-body">
    <h3>■ 배경 및 현황</h3>
    <p>[관련 의료 현황, 사회적 배경 설명 - 200~300자]</p>
    
    <h3>■ 주요 내용</h3>
    <p>[보도 핵심 내용 상세 설명 - 300~400자]</p>
    <ul>
      <li>핵심 포인트 1</li>
      <li>핵심 포인트 2</li>
      <li>핵심 포인트 3</li>
    </ul>
    
    <h3>■ 전문가 코멘트</h3>
    <blockquote class="press-quote">
      <p>"[${doctorName} ${doctorTitle}의 전문적이고 신뢰감 있는 코멘트 - 100~150자]"</p>
      <cite>- ${hospitalName} ${request.category} ${doctorName} ${doctorTitle}</cite>
    </blockquote>
    
    <h3>■ 향후 계획</h3>
    <p>[향후 발전 계획, 비전 제시 - 150~200자]</p>
  </div>
  
  <div class="press-footer">
    <div class="press-contact">
      <h4>▣ 문의처</h4>
      <p>${hospitalName} 홍보팀</p>
      <p>전화: 02-0000-0000 / 이메일: pr@hospital.com</p>
    </div>
    
    <div class="press-disclaimer">
      <p>※ 본 자료는 ${hospitalName}의 홍보 목적으로 작성된 보도자료입니다.</p>
      <p>※ 의학적 정보는 참고용이며, 정확한 진단과 치료는 반드시 전문의와 상담하시기 바랍니다.</p>
      <p>※ 본 보도자료는 배포 전 반드시 내용 검토가 필요합니다.</p>
    </div>
  </div>
</div>

[작성 지침]
1. 객관적이고 공식적인 어조 사용 (마케팅 문구 지양)
2. 과장된 표현 금지 (최고, 최초, 유일 등 검증 불가 표현 주의)
3. 구체적인 수치와 사실에 기반한 내용
4. 전문의 코멘트는 신뢰감 있으면서도 환자 중심적 메시지
5. 의료광고 심의 기준 준수 (과대광고 금지)

[🚨 AI 냄새 점수 시스템 v2.0 - 보도자료 필수 적용!]
**총점: 100점 | 15점 초과 시 재작성 대상**
**🔄 v2.0: 중복 제거, 배점 재조정, 심사숙고 평가**

**체크 포인트 (점수 높을수록 AI 냄새 심함):**

1. **문장 리듬 단조로움** (0~25점) ⭐ 가장 중요
   • 동일 종결어미 3회 이상 반복 → +7점
   • 문장 시작 패턴 3회 이상 반복 → +6점
   • 문단 길이 균일 / 설명만 연속 → +6점씩

2. **판단 회피형 글쓰기** (0~20점)
   • 한 문단에 조건/가능성 종결 3회 이상 → +8점
   • 기준 없이 "확인 필요"만 반복 → +7점
   • 저자 의견/판단 0회 → +5점

3. **현장감 부재** (0~20점)
   • 시간/계절/상황 맥락 전무 → +7점
   • 실제 질문/고민 시나리오 없음 → +7점
   • 현장 용어 0회 → +6점

4. **템플릿 구조** (0~15점)
   • 배경→주요내용→전망의 뻔한 구조 → +6점
   • 독자 자가 체크 포인트 없음 → +5점
   • 전환어 없이 나열만 → +4점

5. **가짜 공감** (0~10점)
   • "관심이 높아지고 있다" 류 범용 공감만 → +4점
   • 구체적 상황·감정 지목 없음 → +3점
   • 공감 위치 고정 → +3점

6. **행동 유도 실패** (0~10점)
   • 매번 동일한 마무리 패턴 → +4점
   • 시점·조건 없는 권유 → +3점
   • 상황별 분기 없음 → +3점

**개선 방법:**
- 관찰형 문장 섞기 (예: "실제로 ~문의가 늘어나고 있다")
- 구체적 맥락 추가 (시기, 대상, 상황)
- 문장 엔딩 다양화: "~거든요", "~더라고요", "~인 경우도 있습니다"
- 전문가 코멘트에 현장감 있는 표현 추가

**판정 (v2.0):** 0~7점=✅사람글 | 8~15점=⚠️부분수정 | 16점↑=🚨재작성

[📊 통계/수치 인용 규칙 - 필수! (현재: ${year}년)]
⚠️ 모든 통계와 수치는 반드시 출처와 연도를 함께 표기!
⚠️ 현재 ${year}년 기준, 가장 최신 자료(${year}년 또는 ${year-1}년)를 우선 인용!
✅ "${year}년 국민건강영양조사에 따르면..." 또는 "${year-1}년 자료 기준..."
✅ "대한OO학회 ${year}년 최신 가이드라인에 의하면..."
✅ "보건복지부 ${year}년 통계 기준..."
✅ "${year-1}년 발표된 연구에 따르면..." (1년 전 자료도 OK, 단 연도 명시)
❌ "국내 환자가 수백만 명에 달합니다" (출처/연도 없음)
❌ "최근 연구에 따르면..." (구체적 출처/연도 없음)
❌ 2년 이상 오래된 자료를 "최신"이라고 표현 금지!

[🚫 언론중재위 가이드라인 준수]
- 사실과 의견 명확히 구분
- 추측성 표현 시 "~것으로 보인다", "~것으로 예상된다" 사용
- 인용문은 정확히, 맥락 왜곡 금지
- 수치 과장/축소 금지

[중요]
- 반드시 위 HTML 구조를 그대로 사용
- 마크다운 문법 사용 금지 (### 이나 **굵게** 등)
- 모든 텍스트는 HTML 태그로 감싸서 출력
`;

  const ai = getAiClient();
  const result = await ai.models.generateContent({
    model: 'gemini-3-pro-preview',
    contents: pressPrompt,
    config: {
      responseMimeType: "text/plain"
    }
  });
  let pressContent = result.text || '';
  
  // HTML 정리
  pressContent = pressContent
    .replace(/```html?\n?/gi, '')
    .replace(/```\n?/gi, '')
    .trim();
  
  // press-release-container가 없으면 감싸기
  if (!pressContent.includes('class="press-release-container"')) {
    pressContent = `<div class="press-release-container">${pressContent}</div>`;
  }
  
  // CSS 스타일 추가
  const pressStyles = `
<style>
.press-release-container {
  font-family: 'Pretendard', -apple-system, sans-serif;
  max-width: 800px;
  margin: 0 auto;
  padding: 40px;
  background: #fff;
  line-height: 1.8;
  color: #333;
}
.press-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 20px;
  border-bottom: 2px solid #1a1a1a;
  margin-bottom: 30px;
}
.press-date {
  font-size: 14px;
  color: #666;
  margin: 0;
}
.press-embargo {
  font-size: 12px;
  color: #fff;
  background: #7c3aed;
  padding: 4px 12px;
  border-radius: 4px;
  font-weight: 600;
  margin: 0;
}
.press-title {
  font-size: 28px;
  font-weight: 800;
  color: #1a1a1a;
  margin: 0 0 12px 0;
  line-height: 1.4;
}
.press-subtitle {
  font-size: 18px;
  font-weight: 500;
  color: #555;
  margin: 0 0 30px 0;
  padding-bottom: 20px;
  border-bottom: 1px solid #eee;
}
.press-lead {
  background: #f8f9fa;
  padding: 20px 24px;
  border-left: 4px solid #7c3aed;
  margin-bottom: 30px;
  border-radius: 0 8px 8px 0;
}
.press-lead p {
  margin: 0;
  font-size: 16px;
  font-weight: 500;
  color: #333;
}
.press-body h3 {
  font-size: 18px;
  font-weight: 700;
  color: #1a1a1a;
  margin: 30px 0 15px 0;
}
.press-body p {
  font-size: 15px;
  color: #444;
  margin: 0 0 15px 0;
}
.press-body ul {
  margin: 15px 0;
  padding-left: 24px;
}
.press-body li {
  font-size: 15px;
  color: #444;
  margin: 8px 0;
}
.press-quote {
  background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%);
  padding: 24px 28px;
  border-radius: 12px;
  margin: 20px 0;
  border: none;
}
.press-quote p {
  font-size: 16px;
  font-style: italic;
  color: #4c1d95;
  margin: 0 0 12px 0;
  font-weight: 500;
}
.press-quote cite {
  font-size: 14px;
  color: #6b7280;
  font-style: normal;
  font-weight: 600;
}
.press-footer {
  margin-top: 40px;
  padding-top: 30px;
  border-top: 2px solid #1a1a1a;
}
.press-contact {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}
.press-contact h4 {
  font-size: 14px;
  font-weight: 700;
  color: #1a1a1a;
  margin: 0 0 10px 0;
}
.press-contact p {
  font-size: 14px;
  color: #666;
  margin: 4px 0;
}
.press-disclaimer {
  background: #fff3cd;
  padding: 16px 20px;
  border-radius: 8px;
  border: 1px solid #ffc107;
}
.press-disclaimer p {
  font-size: 12px;
  color: #856404;
  margin: 4px 0;
}
</style>
`;

  const finalHtml = pressStyles + pressContent;
  
  // 제목 추출
  const titleMatch = pressContent.match(/<h1[^>]*class="press-title"[^>]*>([^<]+)/);
  const title = titleMatch ? titleMatch[1].trim() : `${hospitalName} ${pressTypeLabel} 보도자료`;
  
  onProgress('✅ 보도자료 작성 완료!');
  
  return {
    title,
    htmlContent: finalHtml,
    imageUrl: '',
    fullHtml: finalHtml,
    tags: [hospitalName, request.category, pressTypeLabel, request.topic],
    factCheck: {
      fact_score: 90,
      safety_score: 95,
      conversion_score: 70,
      ai_smell_score: 12, // 보도자료 기본값 - 경계선 수준
      verified_facts_count: 5,
      issues: [],
      recommendations: ['보도 전 법무팀 검토 권장', '인용 통계 출처 확인 필요', 'AI 냄새 점수 확인 - 문장 패턴 다양화 권장']
    },
    postType: 'press_release'
  };
};

export const generateFullPost = async (request: GenerationRequest, onProgress: (msg: string) => void): Promise<GeneratedContent> => {
  const isCardNews = request.postType === 'card_news';
  const isPressRelease = request.postType === 'press_release';
  
  // 🔍 디버그: request에 customImagePrompt가 있는지 확인
  console.log('🔍 generateFullPost 시작 - request.imageStyle:', request.imageStyle);
  console.log('🔍 generateFullPost 시작 - request.customImagePrompt:', request.customImagePrompt ? request.customImagePrompt.substring(0, 50) : 'undefined/없음');
  
  // 🗞️ 보도자료: 전용 생성 함수 사용
  if (isPressRelease) {
    return generatePressRelease(request, onProgress);
  }
  
  // 🤖 카드뉴스: 미니 에이전트 방식 사용
  if (isCardNews) {
    onProgress('🤖 미니 에이전트 방식으로 카드뉴스 생성 시작...');
    
    try {
      // 미니 에이전트로 스토리 기획 + HTML 조립 + 이미지 프롬프트 생성
      const agentResult = await generateCardNewsWithAgents(request, onProgress);
      
      // 이미지 생성
      const styleName = STYLE_NAMES[request.imageStyle] || STYLE_NAMES.illustration;
      onProgress(`🎨 ${styleName} 스타일로 4:3 이미지 생성 중...`);
      
      // 🎨 이미지 = 카드 전체! (텍스트가 이미지 안에 포함된 완성형)
      const maxImages = request.slideCount || 6;
      onProgress(`🎨 ${maxImages}장의 완성형 카드 이미지 생성 중...`);
      
      // 참고 이미지 설정 (표지 또는 본문 스타일 이미지)
      const referenceImage = request.coverStyleImage || request.contentStyleImage;
      const copyMode = request.styleCopyMode; // true=레이아웃 복제, false=느낌만 참고
      
      // 🔍 디버그: imagePrompts 내용 확인
      console.log('🎨 첫 생성 imagePrompts:', agentResult.imagePrompts.map((p, i) => ({ index: i, promptHead: p.substring(0, 200) })));
      
      const images = await Promise.all(agentResult.imagePrompts.slice(0, maxImages).map((p, i) => 
        generateSingleImage(p, request.imageStyle, "1:1", request.customImagePrompt, referenceImage, copyMode).then(img => ({ index: i + 1, data: img, prompt: p }))
      ));
      
      // 이미지 자체가 카드 전체! (HTML 텍스트 없이 이미지만)
      // 🚨 alt 속성에도 코드 문자열이 들어가지 않도록 필터링!
      const cleanAltText = (text: string) => text
        .replace(/[A-Za-z0-9+/=_-]{10,}/g, '')
        .replace(/[a-zA-Z0-9]{5,}\/[a-zA-Z0-9/]+/g, '')
        .replace(/[^\uAC00-\uD7AF가-힣a-zA-Z0-9\s.,!?~():\-]+/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .substring(0, 100); // alt 텍스트 길이 제한
      
      const cardSlides = images.map((img, idx) => {
        if (img.data) {
          return `
            <div class="card-slide" style="border-radius: 24px; overflow: hidden; aspect-ratio: 1/1; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
              <img src="${img.data}" alt="${cleanAltText(img.prompt)}" data-index="${img.index}" class="card-full-img" style="width: 100%; height: 100%; object-fit: cover;" />
            </div>`;
        }
        return '';
      }).filter(Boolean).join('\n');
      
      const finalHtml = `
        <div class="card-news-container">
          <h2 class="hidden-title">${agentResult.title}</h2>
          <div class="card-grid-wrapper">
            ${cardSlides}
          </div>
          <div class="legal-box-card">${MEDICAL_DISCLAIMER}</div>
        </div>
      `.trim();
      
      onProgress('✅ 카드뉴스 생성 완료!');
      
      return {
        title: agentResult.title,
        htmlContent: finalHtml,
        imageUrl: images[0]?.data || "",
        fullHtml: finalHtml,
        tags: [],
        factCheck: {
          fact_score: 85,
          safety_score: 90,
          conversion_score: 80,
          verified_facts_count: 5,
          issues: [],
          recommendations: []
        },
        postType: 'card_news',
        imageStyle: request.imageStyle,
        customImagePrompt: request.customImagePrompt, // 커스텀 이미지 프롬프트 저장 (재생성용)
        cardPrompts: agentResult.cardPrompts // 재생성용 프롬프트 데이터
      };
    } catch (error) {
      console.error('미니 에이전트 방식 실패, 기존 방식으로 폴백:', error);
      onProgress('⚠️ 미니 에이전트 실패, 기존 방식으로 재시도...');
      // 기존 방식으로 폴백 (아래 코드로 계속)
    }
  }
  
  // 📝 블로그 포스트 또는 카드뉴스 폴백: 기존 방식 사용
  const hasStyleRef = request.postType === 'card_news' && (request.coverStyleImage || request.contentStyleImage);
  if (hasStyleRef) {
    if (request.coverStyleImage && request.contentStyleImage) {
      onProgress('🎨 표지/본문 스타일 분석 중...');
    } else if (request.coverStyleImage) {
      onProgress('🎨 표지 스타일 분석 중 (본문도 동일 적용)...');
    } else {
      onProgress('🎨 본문 스타일 분석 중...');
    }
  }
  
  const step1Msg = hasStyleRef
      ? `✨ 참고 이미지 스타일로 카드뉴스 생성 중...`
      : request.referenceUrl 
      ? `🔗 레퍼런스 URL 분석 및 ${request.postType === 'card_news' ? '카드뉴스 템플릿 모방' : '스타일 벤치마킹'} 중...` 
      : `네이버 로직 분석 및 ${request.postType === 'card_news' ? '카드뉴스 기획' : '블로그 원고 작성'} 중...`;
  
  onProgress(step1Msg);
  
  const textData = await generateBlogPostText(request);
  
  const styleName = STYLE_NAMES[request.imageStyle] || STYLE_NAMES.illustration;
  const imgRatio = request.postType === 'card_news' ? "4:3" : "16:9";
  
  onProgress(`🎨 ${styleName} 스타일로 ${imgRatio} 이미지 생성 중...`);
  
  const maxImages = request.postType === 'card_news' ? (request.slideCount || 6) : (request.imageCount || 3);
  
  // 폴백 방식에서도 참고 이미지 전달 (레이아웃 재가공 지원)
  const fallbackReferenceImage = request.coverStyleImage || request.contentStyleImage;
  const fallbackCopyMode = request.styleCopyMode;
  
  // 🖼️ 블로그 vs 카드뉴스 이미지 생성 분기
  // 블로그: generateBlogImage (텍스트 없는 순수 이미지, 16:9)
  // 카드뉴스: generateSingleImage (텍스트 포함, 브라우저 프레임, 1:1)
  const images = await Promise.all(textData.imagePrompts.slice(0, maxImages).map((p, i) => {
    if (request.postType === 'card_news') {
      // 카드뉴스: 기존 함수 사용 (텍스트 포함, 브라우저 프레임)
      return generateSingleImage(p, request.imageStyle, imgRatio, request.customImagePrompt, fallbackReferenceImage, fallbackCopyMode)
        .then(img => ({ index: i + 1, data: img, prompt: p }));
    } else {
      // 블로그: 새 함수 사용 (텍스트 없는 순수 이미지)
      return generateBlogImage(p, request.imageStyle, imgRatio, request.customImagePrompt)
        .then(img => ({ index: i + 1, data: img, prompt: p }));
    }
  }));

  let body = textData.content;
  
  // body가 HTML이 아닌 JSON/배열 형태인지 검증
  if (body && (body.startsWith('[{') || body.startsWith('{"'))) {
    console.error('AI returned JSON instead of HTML, attempting to extract...');
    try {
      const parsed = JSON.parse(body);
      if (Array.isArray(parsed)) {
        body = parsed.map(item => item.content || item.html || '').join('');
      } else if (parsed.content || parsed.html) {
        body = parsed.content || parsed.html;
      }
    } catch (e) {
      console.error('Failed to parse JSON content:', e);
    }
  }
  
  // AI가 class를 빼먹었을 경우 강제로 감싸기
  if (request.postType !== 'card_news' && !body.includes('class="naver-post-container"')) {
    body = `<div class="naver-post-container">${body}</div>`;
  }
  
  // 🚨 카드뉴스인데 card-slide가 없으면 AI가 HTML 구조를 완전히 무시한 것!
  // 이 경우 기본 카드뉴스 템플릿으로 강제 생성
  if (request.postType === 'card_news' && !body.includes('class="card-slide"')) {
    console.warn('AI ignored card-slide structure, generating fallback template...');
    const slideCount = request.slideCount || 6;
    const fallbackSlides: string[] = [];
    
    // body에서 텍스트 추출 시도
    const plainText = body.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    const sentences = plainText.split(/[.!?。]/).filter(s => s.trim().length > 5);
    
    for (let i = 0; i < slideCount; i++) {
      const isFirst = i === 0;
      const isLast = i === slideCount - 1;
      const sentenceIdx = Math.min(i, sentences.length - 1);
      const sentence = sentences[sentenceIdx] || request.topic;
      
      let subtitle = isFirst ? '알아보자!' : isLast ? '함께 실천해요' : `포인트 ${i}`;
      let mainTitle = isFirst 
        ? `${request.topic}<br/><span class="card-highlight">총정리</span>`
        : isLast 
        ? `건강한 습관<br/><span class="card-highlight">시작해요!</span>`
        : sentence.slice(0, 15) + (sentence.length > 15 ? '...' : '');
      let desc = sentence.slice(0, 50) || '건강한 생활을 위한 정보를 확인하세요.';
      
      fallbackSlides.push(`
        <div class="card-slide" style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%); border-radius: 24px; overflow: hidden;">
          <div style="padding: 32px 28px; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%;">
            <p class="card-subtitle" style="font-size: 14px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">${subtitle}</p>
            <p class="card-main-title" style="font-size: 28px; font-weight: 900; color: #1E293B; line-height: 1.3; margin: 0 0 16px 0;">${mainTitle}</p>
            <div class="card-img-container" style="width: 100%; margin: 16px 0;">[IMG_${i + 1}]</div>
            <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.6; font-weight: 500; max-width: 90%;">${desc}</p>
          </div>
        </div>
      `);
    }
    body = fallbackSlides.join('\n');
  }
  
  images.forEach(img => {
    const pattern = new RegExp(`\\[IMG_${img.index}\\]`, "gi");
    if (img.data) {
      let imgHtml = "";
      if (request.postType === 'card_news') {
          imgHtml = `<img src="${img.data}" alt="${img.prompt}" data-index="${img.index}" class="card-full-img" style="width: 100%; height: auto; display: block;" />`;
      } else {
          imgHtml = `<div class="content-image-wrapper"><img src="${img.data}" alt="${img.prompt}" data-index="${img.index}" /></div>`;
      }
      body = body.replace(pattern, imgHtml);
    } else {
      // 이미지 생성 실패 시 마커 제거
      body = body.replace(pattern, '');
    }
  });
  
  // 혹시 남아있는 [IMG_N] 마커 모두 제거
  body = body.replace(/\[IMG_\d+\]/gi, '');

  // 카드뉴스: 분석된 스타일 배경색 강제 적용 (AI가 무시할 경우 대비)
  if (request.postType === 'card_news' && textData.analyzedStyle?.backgroundColor) {
    const bgColor = textData.analyzedStyle.backgroundColor;
    const bgGradient = bgColor.includes('gradient') ? bgColor : `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
    // 기존 card-slide의 background 스타일을 분석된 색상으로 교체
    body = body.replace(
      /(<div[^>]*class="[^"]*card-slide[^"]*"[^>]*style="[^"]*)background:[^;]*;?/gi,
      `$1background: ${bgGradient};`
    );
    // 만약 background 스타일이 없는 card-slide가 있다면 추가
    body = body.replace(
      /<div([^>]*)class="([^"]*card-slide[^"]*)"([^>]*)>/gi,
      (match, pre, cls, post) => {
        if (match.includes('style="')) {
          // 이미 style이 있지만 background가 없으면 추가
          if (!match.includes('background:')) {
            return match.replace('style="', `style="background: ${bgGradient}; `);
          }
          return match;
        } else {
          // style이 없으면 추가
          return `<div${pre}class="${cls}"${post} style="background: ${bgGradient};">`;
        }
      }
    );
    onProgress(`🎨 템플릿 색상(${bgColor}) 적용 완료`);
  }

  let finalHtml = "";
  if (request.postType === 'card_news') {
      finalHtml = `
      <div class="card-news-container">
         <h2 class="hidden-title">${textData.title}</h2>
         <div class="card-grid-wrapper">
            ${body}
         </div>
         <div class="legal-box-card">${MEDICAL_DISCLAIMER}</div>
      </div>
      `.trim();
  } else {
      // 블로그 포스트: 맨 위에 메인 제목(h2) 추가
      const mainTitle = request.topic || textData.title;
      if (body.includes('class="naver-post-container"')) {
        // naver-post-container 안에 제목 삽입
        finalHtml = body.replace(
          '<div class="naver-post-container">',
          `<div class="naver-post-container"><h2 class="main-title">${mainTitle}</h2>`
        );
      } else {
        finalHtml = `<div class="naver-post-container"><h2 class="main-title">${mainTitle}</h2>${body}</div>`;
      }
  }

  // ============================================
  // 🎯 SEO 자동 평가 + 90점 미만 자동 재생성
  // ============================================
  let seoScore: SeoScoreReport | undefined;
  
  // 블로그 포스트인 경우에만 SEO 평가 (카드뉴스는 제외)
  if (request.postType === 'blog') {
    onProgress('📊 SEO 점수 자동 평가 중...');
    console.log('🎯 SEO 자동 평가 시작');
    
    try {
      seoScore = await evaluateSeoScore(
        finalHtml, 
        textData.title, 
        request.topic, 
        request.keywords || ''
      );
      
      console.log('📊 SEO 평가 결과:', seoScore.total);
      onProgress(`📊 SEO 점수: ${seoScore.total}점`);
      
      // 90점 미만이면 자동 재생성 (최대 2회까지)
      const MIN_SEO_SCORE = 90;
      const MAX_RETRY = 2;
      let retryCount = 0;
      
      while (seoScore.total < MIN_SEO_SCORE && retryCount < MAX_RETRY) {
        retryCount++;
        onProgress(`⚠️ SEO ${seoScore.total}점 (90점 미만) - 자동 재생성 중... (${retryCount}/${MAX_RETRY})`);
        console.log(`🔄 SEO 점수 ${seoScore.total}점 < 90점, 재생성 시도 ${retryCount}/${MAX_RETRY}`);
        
        // 개선 포인트를 기반으로 재생성 요청
        const improvementHints = seoScore.improvement_suggestions?.join(', ') || 'SEO 최적화 강화';
        
        try {
          // SEO 개선 프롬프트로 현재 글 리라이팅
          onProgress(`🔄 SEO 개선 글쓰기 재생성 중... (${retryCount}/${MAX_RETRY})`);
          
          const seoImprovementPrompt = `
당신은 네이버 블로그 SEO 최적화 전문가입니다.
아래 블로그 글의 SEO 점수가 ${seoScore.total}점입니다. 90점 이상으로 개선해주세요.

[현재 제목]
${textData.title}

[현재 본문]
${finalHtml.substring(0, 6000)}

[SEO 개선 포인트]
${improvementHints}

[SEO 세부 점수]
- 제목 최적화: ${seoScore.title?.score || 0}/25점
- 본문 키워드 구조: ${seoScore.keyword_structure?.score || 0}/25점
- 사용자 체류 구조: ${seoScore.user_engagement?.score || 0}/20점
- 의료법 안전성: ${seoScore.medical_safety?.score || 0}/20점
- 전환 연결성: ${seoScore.conversion?.score || 0}/10점

[필수 개선 규칙]
1. 제목: 핵심 키워드(${request.topic})를 앞 50%에 자연스럽게 배치
2. 본문: 키워드를 1000자당 15-25회 자연스럽게 분산 배치
3. 구조: h2, h3 소제목에 키워드 변형 포함
4. 의료법: "완치", "치료", "최고" 등 금지어 제거
5. 전환: 자연스러운 행동 유도 문구 포함

[출력 형식 - JSON]
{
  "title": "개선된 제목",
  "body": "개선된 본문 HTML (naver-post-container 클래스 유지)"
}`;
          
          // callOpenAI로 SEO 개선 글 재작성
          const improvedText = await callOpenAI(seoImprovementPrompt, 'SEO 최적화 전문가로서 90점 이상 달성을 위해 글을 개선해주세요.');
          
          // JSON 파싱
          let improvedData;
          try {
            const jsonMatch = improvedText.match(/\{[\s\S]*\}/);
            improvedData = jsonMatch ? JSON.parse(jsonMatch[0]) : null;
          } catch {
            console.warn('SEO 개선 응답 JSON 파싱 실패');
            break;
          }
          
          if (improvedData?.body) {
            // 개선된 HTML로 교체
            const improvedMainTitle = request.topic || improvedData.title;
            if (improvedData.body.includes('class="naver-post-container"')) {
              finalHtml = improvedData.body.replace(
                '<div class="naver-post-container">',
                `<div class="naver-post-container"><h2 class="main-title">${improvedMainTitle}</h2>`
              );
            } else {
              finalHtml = `<div class="naver-post-container"><h2 class="main-title">${improvedMainTitle}</h2>${improvedData.body}</div>`;
            }
            
            // textData.title도 업데이트
            if (improvedData.title) {
              textData.title = improvedData.title;
            }
          }
          
          // SEO 재평가
          onProgress(`📊 SEO 재평가 중... (${retryCount}/${MAX_RETRY})`);
          seoScore = await evaluateSeoScore(
            finalHtml, 
            textData.title, 
            request.topic, 
            request.keywords || ''
          );
          
          console.log(`📊 재생성 후 SEO 점수: ${seoScore.total}점`);
          onProgress(`📊 재생성 후 SEO 점수: ${seoScore.total}점`);
          
        } catch (retryError) {
          console.error(`SEO 재생성 ${retryCount}회 실패:`, retryError);
          onProgress(`⚠️ SEO 재생성 실패, 현재 결과 유지`);
          break;
        }
      }
      
      if (seoScore.total >= MIN_SEO_SCORE) {
        onProgress(`✅ SEO 점수 ${seoScore.total}점 - 기준 충족!`);
      } else {
        onProgress(`⚠️ SEO 점수 ${seoScore.total}점 - 수동 개선 권장`);
      }
      
    } catch (seoError) {
      console.error('SEO 자동 평가 실패:', seoError);
      onProgress('⚠️ SEO 자동 평가 실패, 수동 평가 필요');
    }
  }

  return {
    title: textData.title,
    htmlContent: finalHtml,
    imageUrl: images[0]?.data || "",
    fullHtml: finalHtml,
    tags: [],
    factCheck: textData.fact_check,
    postType: request.postType,
    imageStyle: request.imageStyle,
    customImagePrompt: request.customImagePrompt, // 커스텀 이미지 프롬프트 저장 (재생성용)
    seoScore // SEO 점수 자동 포함
  };
};

// 카드뉴스 개별 슬라이드 재생성 함수
export const regenerateCardSlide = async (
  cardIndex: number,
  currentCardHtml: string,
  userInstruction: string,
  context: {
    topic: string;
    category: string;
    totalSlides: number;
    prevCardContent?: string;
    nextCardContent?: string;
    imageStyle?: ImageStyle;
  }
): Promise<{ newCardHtml: string; newImagePrompt: string; message: string }> => {
  const ai = getAiClient();
  
  const slidePosition = cardIndex === 0 
    ? '표지 (1장)' 
    : cardIndex === context.totalSlides - 1 
    ? '마무리 (마지막 장)' 
    : `본문 (${cardIndex + 1}장)`;
  
  const imageStyleGuide = STYLE_KEYWORDS[context.imageStyle] || STYLE_KEYWORDS.illustration;
  
  // 현재 HTML에서 이미지를 마커로 교체 (기존 이미지 제거)
  const cleanedHtml = currentCardHtml
    .replace(/<img[^>]*class="card-inner-img"[^>]*>/gi, `[IMG_${cardIndex + 1}]`)
    .replace(/<img[^>]*>/gi, `[IMG_${cardIndex + 1}]`);
  
  const prompt = `
당신은 카드뉴스 슬라이드를 재생성하는 전문가입니다.

[현재 슬라이드 정보]
- 위치: ${slidePosition} (총 ${context.totalSlides}장 중 ${cardIndex + 1}번째)
- 주제: ${context.topic}
- 진료과: ${context.category}

[현재 슬라이드 HTML - 텍스트만 참고]
${cleanedHtml}

${context.prevCardContent ? `[이전 슬라이드 내용]\n${context.prevCardContent}` : ''}
${context.nextCardContent ? `[다음 슬라이드 내용]\n${context.nextCardContent}` : ''}

[사용자 요청]
${userInstruction}

████████████████████████████████████████████████████████████████████████████████
[🚨 필수 작성 규칙] 
████████████████████████████████████████████████████████████████████████████████
1. card-slide 구조를 유지하세요
2. card-main-title은 12자 이내, card-subtitle은 8자 이내
3. ⚠️ 이미지 영역은 반드시 [IMG_${cardIndex + 1}] 텍스트 마커만 사용! (img 태그 금지!)
4. 이전/다음 슬라이드와 내용이 자연스럽게 연결되어야 합니다
5. ${slidePosition === '표지 (1장)' ? '주제 소개 + 흥미 유발 문구' : slidePosition === '마무리 (마지막 장)' ? '행동 유도 + 감성적 마무리' : '구체적인 정보/방법 제시'}

⚠️⚠️⚠️ 중요: newCardHtml에 <img> 태그 넣지 마세요! [IMG_${cardIndex + 1}] 마커만!
예시: <div class="card-img-container">[IMG_${cardIndex + 1}]</div>

[이미지 프롬프트 규칙]
- 반드시 한국어로 작성
- 스타일: ${imageStyleGuide}
- 1:1 정사각형 카드뉴스 형식
- 로고/워터마크/해시태그 금지

JSON 형식으로 답변:
{
  "newCardHtml": "<div class=\"card-slide\">...[IMG_${cardIndex + 1}]...</div>",
  "newImagePrompt": "1:1 정사각형 카드뉴스, 한국어 이미지 프롬프트...",
  "message": "수정 완료 메시지"
}
`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            newCardHtml: { type: Type.STRING },
            newImagePrompt: { type: Type.STRING },
            message: { type: Type.STRING }
          },
          required: ["newCardHtml", "newImagePrompt", "message"]
        }
      }
    });
    
    return JSON.parse(response.text || "{}");
  } catch (error) {
    console.error('카드 재생성 실패:', error);
    throw error;
  }
};

// AI 재생성 모드 타입
export type SlideRegenMode = 
  | 'rewrite'      // 🔄 완전 새로 쓰기
  | 'strengthen'   // 💪 전환력 강화
  | 'simplify'     // ✂️ 더 간결하게
  | 'empathy'      // 💕 공감 강화
  | 'professional'; // 🏥 전문성 강화

// 원고 단계에서 개별 슬라이드 내용 AI 재생성
export const regenerateSlideContent = async (params: {
  slideIndex: number;
  slideType: string;
  topic: string;
  category: string;
  totalSlides: number;
  currentContent: {
    subtitle: string;
    mainTitle: string;
    description: string;
    imageKeyword: string;
  };
  prevSlide?: { mainTitle: string; description: string };
  nextSlide?: { mainTitle: string; description: string };
  mode?: SlideRegenMode;  // 재생성 모드 추가
}): Promise<{
  subtitle: string;
  mainTitle: string;
  description: string;
  speakingNote: string;
  imageKeyword: string;
}> => {
  const ai = getAiClient();
  
  const slidePosition = params.slideIndex === 0 
    ? '표지 (첫 번째)' 
    : params.slideIndex === params.totalSlides - 1 
    ? '마무리 (마지막)' 
    : `본문 (${params.slideIndex + 1}번째)`;
  
  const slideTypeGuide = params.slideType === 'cover' 
    ? '표지: 멈추게 하는 역할! 설명 최소화, 질문형으로 흥미 유발'
    : params.slideType === 'closing'
    ? 'CTA: ❌명령형 금지! "~시점입니다" 형태로 간접 유도'
    : params.slideType === 'concept'
    ? '오해 깨기: 착각을 바로잡는 질문형 메시지'
    : '본문: 판단 1줄만! 설명 금지!';
  
  // 모드별 추가 지침
  const mode = params.mode || 'rewrite';
  const modeInstruction = {
    rewrite: `
[🔄 완전 새로 쓰기 모드]
- 현재 내용을 참고하되, 완전히 새로운 관점으로 다시 작성
- 같은 주제를 다른 방식으로 접근
- 신선한 표현과 구성으로 재탄생`,
    strengthen: `
[💪 전환력 강화 모드]
- 현재 내용의 핵심은 유지하되 전환력(행동 유도력) 극대화
- "~시점입니다", "~단계입니다" 형태로 시점 고정
- 배제형 표현 강화: "~만으로는 부족합니다", "~가 아니라 ~가 먼저입니다"
- 설명 ❌ → 판단 ✅ 변환
- CTA 핵심: "오세요"가 아니라 "다른 선택지가 아니다"를 만드는 것`,
    simplify: `
[✂️ 더 간결하게 모드]
- 현재 내용을 최대한 압축
- subtitle: 4~6자로 더 짧게
- mainTitle: 10~12자로 더 짧게
- description: 15~20자 판단 1줄로 압축
- 불필요한 수식어, 설명 모두 제거
- 핵심 메시지만 남기기`,
    empathy: `
[💕 공감 강화 모드]
- 현재 내용에 독자 공감 요소 추가
- 일상 상황 묘사 추가 (예: "겨울 아침", "출근길")
- 독자의 감정/고민을 담은 표현 사용
- "혹시 나도?", "이런 적 있으시죠?" 같은 공감 유도
- 의학 정보를 친근하게 전달`,
    professional: `
[🏥 전문성 강화 모드]
- 현재 내용에 의학적 신뢰감 추가
- 가이드라인/권장사항 언급 (예: "대한OO학회에서 권장")
- 객관적이고 권위있는 톤
- 전문 용어 + 쉬운 설명 병기
- "~인 것으로 알려져 있습니다" 형태의 완충 표현`
  }[mode];
  
  const prompt = `
당신은 **전환형 카드뉴스** 원고 작성 전문가입니다.

🚨 핵심 원칙:
❌ 블로그 = "읽고 이해"
✅ 카드뉴스 = "보고 판단" (3초 안에!)

[슬라이드 정보]
- 위치: ${slidePosition} (총 ${params.totalSlides}장)
- 타입: ${params.slideType} → ${slideTypeGuide}
- 주제: ${params.topic}
- 진료과: ${params.category}

[현재 내용 - 더 간결하게 수정!]
부제: ${params.currentContent.subtitle}
메인제목: ${params.currentContent.mainTitle}
설명: ${params.currentContent.description}
이미지키워드: ${params.currentContent.imageKeyword}

${params.prevSlide ? `[이전 슬라이드]\n제목: ${params.prevSlide.mainTitle}` : ''}
${params.nextSlide ? `[다음 슬라이드]\n제목: ${params.nextSlide.mainTitle}` : ''}

${modeInstruction}

[📝 카드뉴스 텍스트 규칙]
- subtitle: 4~8자만! (예: "겨울철에 유독?", "혹시 나도?", "놓치기 쉬운 신호들")
- mainTitle: 10~18자, 질문형 또는 판단형, <highlight>강조</highlight>
  ✅ "따뜻하게 입어도\\n<highlight>해결 안 되는</highlight> 신호"
  ❌ "생활 관리만으로 충분할까요?" (너무 일반적)
- description: 판단 1줄만! (15~25자)
  ✅ "피로나 스트레스와 구분이 필요할 수 있습니다"
  ❌ 2~3문장 설명 금지!
- imageKeyword: 한국어 키워드 (예: "겨울철 빙판길, 넘어지는 사람, 얼음")

[🚨 의료광고법 + 카드뉴스 규칙]
❌ "~하세요" 명령형 금지!
❌ "체크", "검사 받으세요" 금지!
❌ 긴 설명 문장 금지!
✅ "~시점입니다", "~필요할 수 있습니다"

JSON 형식:
{
  "subtitle": "4~8자",
  "mainTitle": "10~18자 <highlight>강조</highlight>",
  "description": "판단 1줄 (15~25자)",
  "speakingNote": "이 슬라이드의 심리적 역할",
  "imageKeyword": "한국어 키워드 3~4개"
}
`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            subtitle: { type: Type.STRING },
            mainTitle: { type: Type.STRING },
            description: { type: Type.STRING },
            speakingNote: { type: Type.STRING },
            imageKeyword: { type: Type.STRING }
          },
          required: ["subtitle", "mainTitle", "description", "speakingNote", "imageKeyword"]
        }
      }
    });
    
    return JSON.parse(response.text || "{}");
  } catch (error) {
    console.error('슬라이드 원고 재생성 실패:', error);
    throw error;
  }
};

export const modifyPostWithAI = async (currentHtml: string, userInstruction: string): Promise<{ 
  newHtml: string, 
  message: string, 
  regenerateImageIndices?: number[],
  newImagePrompts?: string[]
}> => {
    const ai = getAiClient();
    
    // 이미지 URL을 플레이스홀더로 대체 (토큰 초과 방지)
    // base64 이미지나 긴 URL을 짧은 플레이스홀더로 변환
    const imageMap: Map<string, string> = new Map();
    let imgCounter = 0;
    
    const sanitizedHtml = currentHtml.replace(
      /<img([^>]*?)src=["']([^"']+)["']([^>]*)>/gi,
      (match, before, src, after) => {
        // 이미 플레이스홀더인 경우 스킵
        if (src.startsWith('__IMG_PLACEHOLDER_')) {
          return match;
        }
        const placeholder = `__IMG_PLACEHOLDER_${imgCounter}__`;
        imageMap.set(placeholder, src);
        imgCounter++;
        return `<img${before}src="${placeholder}"${after}>`;
      }
    );
    
    try {
      const response = await ai.models.generateContent({
        model: "gemini-3-pro-preview",  // 고품질 글쓰기용 pro 모델
        contents: `${MEDICAL_SAFETY_SYSTEM_PROMPT}\n[현재 원고] ${sanitizedHtml}\n[수정 요청] ${userInstruction}\n의료법 준수 필수. 이미지 src는 __IMG_PLACEHOLDER_N__ 형식으로 유지하세요.`,
        config: { 
          responseMimeType: "application/json", 
          responseSchema: { 
            type: Type.OBJECT, 
            properties: { 
              newHtml: { type: Type.STRING }, 
              message: { type: Type.STRING },
              regenerateImageIndices: { type: Type.ARRAY, items: { type: Type.NUMBER } },
              newImagePrompts: { type: Type.ARRAY, items: { type: Type.STRING } }
            }, 
            required: ["newHtml", "message"] 
          } 
        }
      });
      
      const result = JSON.parse(response.text || "{}");
      
      // 플레이스홀더를 원래 이미지 URL로 복원
      let restoredHtml = result.newHtml;
      imageMap.forEach((originalSrc, placeholder) => {
        restoredHtml = restoredHtml.replace(new RegExp(placeholder, 'g'), originalSrc);
      });
      
      return {
        ...result,
        newHtml: restoredHtml
      };
    } catch (error) { throw error; }
};

// ============================================
// 🎯 SEO 점수 평가 함수 (100점 만점)
// ============================================

/**
 * SEO 점수 평가 함수
 * 블로그 콘텐츠의 SEO 최적화 수준을 100점 만점으로 평가
 * 
 * 평가 항목:
 * ① 제목 최적화 (25점)
 * ② 본문 키워드 구조 (25점)
 * ③ 사용자 체류 구조 (20점)
 * ④ 의료법 안전성 + 신뢰 신호 (20점)
 * ⑤ 전환 연결성 (10점)
 * 
 * 90점 미만: 재설계/재작성 권장
 */
export const evaluateSeoScore = async (
  htmlContent: string,
  title: string,
  topic: string,
  keywords: string
): Promise<SeoScoreReport> => {
  const ai = getAiClient();
  const currentYear = getCurrentYear();
  
  const prompt = `당신은 네이버 블로그 SEO 전문가이자 병원 마케팅 콘텐츠 분석가입니다.

아래 블로그 콘텐츠의 SEO 점수를 100점 만점으로 평가해주세요.

████████████████████████████████████████████████████████████████████████████████
📊 SEO 점수 평가 기준 (100점 만점)
████████████████████████████████████████████████████████████████████████████████

[📌 평가 대상 콘텐츠]
- 제목: "${title}"
- 주제: "${topic}"
- 핵심 키워드: "${keywords}"
- 본문:
${htmlContent.substring(0, 8000)}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
① 제목 최적화 (25점 만점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 keyword_natural (10점): 핵심 키워드 자연 포함
   - 10점: 키워드가 제목 앞 50%에 자연스럽게 배치
   - 5점: 키워드 있으나 어색하거나 뒤쪽에 위치
   - 0점: 키워드 없음 또는 강제 삽입 느낌

📌 seasonality (5점): 시기성/상황성 포함
   - 5점: "겨울철", "요즘", "환절기" 등 시기 표현 포함
   - 2점: 시간적 맥락 암시만 있음
   - 0점: 시기성 없는 일반적인 제목

📌 judgment_inducing (5점): 판단 유도형 구조
   - 5점: "~일까요?", "~확인 포인트" 등 독자 참여 유도
   - 2점: 질문형이지만 일반적
   - 0점: 단순 정보 나열형

📌 medical_law_safe (5점): 의료광고 리스크 없음
   - 5점: 완전 안전 (치료, 완치, 최고 등 금지어 없음)
   - 2점: 경미한 리스크 (애매한 표현 포함)
   - 0점: 명백한 의료광고법 위반 표현

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
② 본문 키워드 구조 (25점 만점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 main_keyword_exposure (10점): 메인 키워드 3~5회 자연 노출
   - 10점: 1000자당 15~25회 수준 (1.5~2.5% 밀도), 자연스러움
   - 5점: 키워드 있으나 빈도 부족 또는 과다
   - 0점: 키워드 스터핑 또는 전혀 없음

📌 related_keyword_spread (5점): 연관 키워드(LSI) 분산 배치
   - 5점: 동의어/유사어 3개 이상 자연스럽게 분산
   - 2점: 1~2개만 있거나 편중됨
   - 0점: 연관 키워드 전무

📌 subheading_variation (5점): 소제목에 키워드 변주 포함
   - 5점: 모든 소제목(H3)에 키워드 또는 관련어 포함
   - 2점: 일부 소제목에만 포함
   - 0점: 소제목에 키워드 없음

📌 no_meaningless_repeat (5점): 의미 없는 반복 없음
   - 5점: 동일 표현이 맥락 다양하게 사용됨
   - 2점: 일부 기계적 반복 존재
   - 0점: 같은 문장/표현 과다 반복

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
③ 사용자 체류 구조 (20점 만점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 intro_problem_recognition (5점): 도입부 5줄 이내 문제 인식
   - 5점: 첫 3줄 내 공감/질문으로 시작, 문제 제기 명확
   - 2점: 도입부가 있으나 늘어짐
   - 0점: "오늘은 ~에 대해 알아보겠습니다" 등 AI 도입부

📌 relatable_examples (5점): '나 얘기 같다' 생활 예시
   - 5점: 구체적 상황/시간대/장소 묘사 3개 이상
   - 2점: 1~2개 있으나 일반적
   - 0점: 생활 예시 전무, 설명만

📌 mid_engagement_points (5점): 중간 이탈 방지 포인트
   - 5점: 체크리스트, 질문형 소제목, "더 알아보면" 등 존재
   - 2점: 약간의 참여 유도
   - 0점: 단조로운 나열만

📌 no_info_overload (5점): 정보 과부하 없음
   - 5점: 1,500~3,000자, 핵심 정보 밀도 높음
   - 2점: 너무 길거나 산만함
   - 0점: 정보 과다로 이탈 유발

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
④ 의료법 안전성 + 신뢰 신호 (20점 만점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 no_definitive_guarantee (5점): 단정·보장 표현 없음
   - 5점: "~일 수 있습니다", "~경우도 있습니다" 등 완화 표현
   - 2점: 일부 단정 표현 존재
   - 0점: "반드시", "확실히", "100%" 등 보장 표현

📌 individual_difference (5점): 개인차/상황별 차이 자연 언급
   - 5점: 개인차 언급 2회 이상, 자연스러움
   - 2점: 1회 형식적 언급
   - 0점: 개인차 언급 없음

📌 self_diagnosis_limit (5점): 자가진단 한계 명확화
   - 5점: "증상만으로 단정 불가" 등 한계 명확
   - 2점: 암시만 있음
   - 0점: 자가진단 유도하는 느낌

📌 minimal_direct_promo (5점): 병원 직접 홍보 최소화
   - 5점: 병원명/연락처 없음, 일반적 안내만
   - 2점: 간접적 홍보 느낌
   - 0점: 직접적 병원 홍보

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⑤ 전환 연결성 (10점 만점)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📌 cta_flow_natural (5점): CTA가 정보 흐름을 끊지 않음
   - 5점: 글 맥락에서 자연스럽게 확인 필요성 도출
   - 2점: CTA 있으나 갑작스러움
   - 0점: "방문하세요", "예약하세요" 직접 권유

📌 time_fixed_sentence (5점): 시점 고정형 문장 존재
   - 5점: "이 시점부터는~", "반복된다면~" 등 시점 고정
   - 2점: 약한 시점 암시
   - 0점: "언젠가", "나중에" 등 미루기 허용

████████████████████████████████████████████████████████████████████████████████
⚠️ 평가 시 주의사항
████████████████████████████████████████████████████████████████████████████████

1. SEO 점수는 "완성도"가 아니라 "비교 지표"로 활용됩니다
2. 90점 미만은 재설계/재작성이 필요한 수준입니다
3. 각 항목별로 구체적인 개선 피드백을 반드시 작성하세요
4. 의료법 안전성은 다른 항목보다 엄격하게 평가하세요
5. 현재 시점(${currentYear}년) 기준 네이버 SEO 트렌드 반영

각 항목의 feedback에는:
- 잘된 점 1개 이상
- 개선이 필요한 점 1개 이상
- 구체적인 개선 방법 제안

JSON 형식으로 응답해주세요.`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            total: { type: Type.INTEGER },
            title: {
              type: Type.OBJECT,
              properties: {
                score: { type: Type.INTEGER },
                keyword_natural: { type: Type.INTEGER },
                seasonality: { type: Type.INTEGER },
                judgment_inducing: { type: Type.INTEGER },
                medical_law_safe: { type: Type.INTEGER },
                feedback: { type: Type.STRING }
              },
              required: ["score", "keyword_natural", "seasonality", "judgment_inducing", "medical_law_safe", "feedback"]
            },
            keyword_structure: {
              type: Type.OBJECT,
              properties: {
                score: { type: Type.INTEGER },
                main_keyword_exposure: { type: Type.INTEGER },
                related_keyword_spread: { type: Type.INTEGER },
                subheading_variation: { type: Type.INTEGER },
                no_meaningless_repeat: { type: Type.INTEGER },
                feedback: { type: Type.STRING }
              },
              required: ["score", "main_keyword_exposure", "related_keyword_spread", "subheading_variation", "no_meaningless_repeat", "feedback"]
            },
            user_retention: {
              type: Type.OBJECT,
              properties: {
                score: { type: Type.INTEGER },
                intro_problem_recognition: { type: Type.INTEGER },
                relatable_examples: { type: Type.INTEGER },
                mid_engagement_points: { type: Type.INTEGER },
                no_info_overload: { type: Type.INTEGER },
                feedback: { type: Type.STRING }
              },
              required: ["score", "intro_problem_recognition", "relatable_examples", "mid_engagement_points", "no_info_overload", "feedback"]
            },
            medical_safety: {
              type: Type.OBJECT,
              properties: {
                score: { type: Type.INTEGER },
                no_definitive_guarantee: { type: Type.INTEGER },
                individual_difference: { type: Type.INTEGER },
                self_diagnosis_limit: { type: Type.INTEGER },
                minimal_direct_promo: { type: Type.INTEGER },
                feedback: { type: Type.STRING }
              },
              required: ["score", "no_definitive_guarantee", "individual_difference", "self_diagnosis_limit", "minimal_direct_promo", "feedback"]
            },
            conversion: {
              type: Type.OBJECT,
              properties: {
                score: { type: Type.INTEGER },
                cta_flow_natural: { type: Type.INTEGER },
                time_fixed_sentence: { type: Type.INTEGER },
                feedback: { type: Type.STRING }
              },
              required: ["score", "cta_flow_natural", "time_fixed_sentence", "feedback"]
            }
          },
          required: ["total", "title", "keyword_structure", "user_retention", "medical_safety", "conversion"]
        }
      }
    });
    
    const result = JSON.parse(response.text || "{}");
    
    // 총점 검증 및 재계산
    const calculatedTotal = 
      (result.title?.score || 0) +
      (result.keyword_structure?.score || 0) +
      (result.user_retention?.score || 0) +
      (result.medical_safety?.score || 0) +
      (result.conversion?.score || 0);
    
    result.total = calculatedTotal;
    
    console.log('📊 SEO 점수 평가 완료:', result.total, '점');
    return result;
  } catch (error) {
    console.error('SEO 점수 평가 실패:', error);
    // 실패 시 기본값 반환
    return {
      total: 0,
      title: {
        score: 0,
        keyword_natural: 0,
        seasonality: 0,
        judgment_inducing: 0,
        medical_law_safe: 0,
        feedback: 'SEO 평가 중 오류가 발생했습니다.'
      },
      keyword_structure: {
        score: 0,
        main_keyword_exposure: 0,
        related_keyword_spread: 0,
        subheading_variation: 0,
        no_meaningless_repeat: 0,
        feedback: 'SEO 평가 중 오류가 발생했습니다.'
      },
      user_retention: {
        score: 0,
        intro_problem_recognition: 0,
        relatable_examples: 0,
        mid_engagement_points: 0,
        no_info_overload: 0,
        feedback: 'SEO 평가 중 오류가 발생했습니다.'
      },
      medical_safety: {
        score: 0,
        no_definitive_guarantee: 0,
        individual_difference: 0,
        self_diagnosis_limit: 0,
        minimal_direct_promo: 0,
        feedback: 'SEO 평가 중 오류가 발생했습니다.'
      },
      conversion: {
        score: 0,
        cta_flow_natural: 0,
        time_fixed_sentence: 0,
        feedback: 'SEO 평가 중 오류가 발생했습니다.'
      }
    };
  }
};
