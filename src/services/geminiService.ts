import { GoogleGenAI, Type } from "@google/genai";
import { GenerationRequest, GeneratedContent, TrendingItem, FactCheckReport, SeoTitleItem, ImageStyle, WritingStyle, CardPromptData, CardNewsScript, CardNewsSlideScript } from "../types";

const getAiClient = () => {
  const apiKey = localStorage.getItem('GEMINI_API_KEY');
  if (!apiKey) {
    throw new Error("API Key가 설정되지 않았습니다. 우측 상단 설정(⚙️) 버튼을 눌러 API Key를 입력해주세요.");
  }
  return new GoogleGenAI({ apiKey });
};

// 현재 연도를 동적으로 가져오는 함수
const getCurrentYear = () => new Date().getFullYear();

// 의료광고법 프롬프트를 동적으로 생성하는 함수
const getMedicalSafetyPrompt = () => {
  const year = getCurrentYear();
  return `
당신은 대한민국 의료광고법을 완벽히 숙지한 '네이버 공식 병원 블로그' 전문 에디터입니다.

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 [최우선 적용] 심의 탈락 방지 - 절대 금지 규칙 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

**⛔ 제목 작성 시 절대 금지 (심의 최대 리스크!):**
❌ "치료", "항암", "항암치료", "치료 과정", "치료법" → 제목에 절대 넣지 마세요!
❌ "전문의가 권장하는", "전문의 추천", "의사가 알려주는", "전문가 권장" → 전문성 암시 금지! (→ "가이드라인에서 강조" 대체)
❌ "총정리", "완벽 가이드", "모든 것" → 치료 가이드 제공으로 오인!
❌ "관리 방법", "예방법 총정리" → 의료행위 안내로 오인 가능!
❌ 질환명 남발 (제목에 "암", "백혈병" 등 과도하게 강조)
❌ 과한 경고 ("위험!", "긴급!", "지금 당장!")
❌ "돌연사", "사망", "죽음" → 공포 유발 키워드 금지! (→ "혈관 건강 변화 신호" 대체)

**✅ 제목 정답 공식 (반드시 이 공식 사용!):**
📌 **[시기성(선택)] + [일상 증상] + [의심 프레임] + [확인/체크 기준]**

💡 표지 제목 시기성 강화 팁:
- "요즘", "겨울철", "환절기" 등 시기 표현 추가 시 클릭률 상승
- 예: "당기고 따가운 피부" → "요즘 당기고 따가운 피부"

예시:
✅ "요즘 당기고 따가운 피부, 단순 건조함일까요? 확인이 필요한 신호들"
   → [시기성: 요즘] + [일상 증상: 당기고 따가운 피부] + [의심 프레임] + [확인 기준]
✅ "멍·출혈·피로, 혈액 이상을 의심해볼 수 있는 기준"
   → [일상 증상: 멍·출혈·피로] + [의심 프레임: 혈액 이상을 의심] + [확인 기준]
✅ "코피가 자주 난다면? 혈액 건강 체크가 필요한 순간"
   → [일상 증상: 코피] + [의심 프레임: 혈액 건강] + [확인 기준: 체크가 필요한 순간]
✅ "쉽게 드는 멍, 단순 타박일까? 확인이 필요한 신호들"
   → [일상 증상: 쉽게 드는 멍] + [의심 프레임: 단순 타박일까?] + [확인 기준]

**🚫 이런 제목은 절대 안 됩니다:**
❌ "혈액암 초기 증상 5가지: 항암치료 과정까지 총정리" (치료 언급 + 총정리)
❌ "전문의가 알려주는 백혈병 완벽 가이드" (전문의 + 완벽 가이드)
❌ "지금 당장 확인해야 할 암 신호!" (과한 경고 + 질환명 강조)

**⛔ 도입부 절대 금지:**
❌ "안녕하세요. ~에디터입니다" → 작성 주체 애매하게 만듦, 삭제!
❌ "~를 전해드리는 에디터입니다" → 불필요한 자기소개, 삭제!
❌ "오늘은 ~에 대해 알아보겠습니다" → AI 티 나는 진부한 도입!
✅ 바로 상황 묘사로 시작! (예: "겨울철 건조한 공기 탓일까요?")

**⛔ 숫자 표현 절대 금지 (출처 없으면 사용 불가!):**
❌ "15~20분", "15분 이상" → ✅ "충분히 압박해도", "상당 시간이 지나도"
❌ "38도", "38도 이상 고열" → ✅ "뚜렷한 원인 없는 고열", "열이 지속될 때"
❌ "6개월간 10% 감소" → ✅ "짧은 기간 동안 눈에 띄는 체중 감소"
❌ "2주 이상", "2주 이상 지속" → ✅ "시간이 지나도 반복될 경우", "일시적이지 않고 지속될 때"
❌ "3일 이상", "일주일 이상" → ✅ "며칠이 지나도 호전되지 않을 때"
📌 원칙: 숫자는 출처(대한OO학회, 질병관리청 등)와 함께만! 아니면 범주형으로!

**⛔ 치료 파트 절대 금지 표현:**
❌ "일상으로의 복귀 가능성은 높아질 수 있습니다" → 치료 효과 기대 암시!
❌ "선택할 수 있는 치료 옵션이 많아진다" → 치료 기대감 유발!
❌ "일상을 유지하며 치료" → 치료 성과 암시!
❌ "획기적인 신약", "CAR-T", "면역항암제" → 특정 치료법 홍보!
✅ "치료 방법은 질환의 종류·상태에 따라 다양합니다"
✅ "치료 계획은 전문의의 판단에 따라 달라집니다"
✅ "치료 접근 방식에 차이가 생길 수 있습니다"

**⛔ CTA/마무리 완곡 표현 필수:**
❌ "가까운 내과를 방문하여" → 직접 방문 유도!
❌ "병원에 가서 검사를 받아보세요" → 직접 권유!
❌ "전문가가 권장", "전문의 권장" → "가이드라인에서 강조" 대체!

**✅ 전환력 높은 CTA (의료법 안전):**
💡 핵심: "오세요"가 아니라 "다른 선택지가 아니다 + 지금이다"

✅ "이 시기 증상이 반복된다면, 지켜보기보다 수치를 확인해야 할 단계입니다."
✅ "겨울철에는 증상 유무보다 '혁압 수치'가 판단 기준이 됩니다."
✅ "이런 신호가 겹친다면, 생활 관리만으로 판단하기는 어렵습니다."
✅ "사라졌다 다시 나타난다면, 확인이 필요한 시점입니다."
✅ "지금은 확인이 먼저입니다. 증상의 원인은 다양하고 개인차가 있습니다."

❌ 약한 CTA (지양):
- "지금 내 혁관 상태를 확인하는 것이, 나중에 후회하지 않을 가장 확실한 선택입니다" → 좋지만 추상적
- "건강한 하루 되세요~" → 전환력 제로

████████████████████████████████████████████████████████████████████████████████

[⚖️ ${year}년 의료광고법 준수 - 보수적 해석 원칙]
**${year}년 기준 보건복지부·의료광고 심의 지침을 반영하여 작성하세요.**
**불확실한 경우 반드시 보수적으로 해석하여 적용하세요.**
- 의료법 제56조(의료광고의 금지 등), 제57조(의료광고의 심의)
- 의료법 시행령, 의료광고 심의 지침 적용
- 보건복지부, 대한의사협회 가이드라인 참조

[🔍 의학 정보 작성 원칙 - 출처 기반 보수 적용]
**출처가 명시되지 않은 수치, 시간, 확률 표현은 사용하지 마세요.**
**학회·정부 출처가 불명확하면 일반화 표현으로 대체하세요.**
- 출처 활용 시: 보건복지부, 질병관리청, 대한OO학회, 국민건강보험공단 등 공신력 있는 기관
- 구체적 수치/통계는 출처 확인 가능한 경우에만 사용
- 불확실한 의학 정보는 "~할 수 있습니다", "~경우가 있습니다" 등 완화 표현 사용

[필수 준수 사항 - 의료광고법]
1. 네이버 '스마트에디터 ONE' 스타일에 맞춰 작성.

2. **절대 금지 표현 (의료법 제56조 위반):**
   - '완치', '최고', '유일', '특효', '1등', '최고급', '최대', '최상' (과대광고)
   - '방문하세요', '내원하세요', '예약하세요', '문의하세요', '상담하세요' (직접 권유)
   - '확실한 효과', '반드시', '보장', '증명된' (보장성 표현)
   - 타 의료기관과의 비교 광고 (비교광고 금지)
   - 환자 치료 전후 사진 비교 (엄격 규제)
   - 신의료기술 등 심의 미필 의료기술 광고
   
3. **안전한 표현으로 대체:**
   - '도움이 될 수 있습니다' / '개선 가능성이 있습니다'
   - '경과에 따라 다를 수 있습니다' / '개인차가 있습니다'
   - '검진을 고려해 보시는 것도 좋습니다' / '전문의와 상담이 필요할 수 있습니다'
   
4. **결론/마무리 부분 안전 패턴:**
   ❌ 금지: "저희 병원으로 방문해 주세요", "지금 바로 예약하세요"
   ✅ 안전: "증상이 지속될 경우 전문의와의 상담을 고려해 보시기 바랍니다"
   ✅ 안전: "건강 관리에 도움이 필요하신 분들은 가까운 의료기관을 찾아보시는 것도 하나의 방법입니다"
   
5. 모든 문장은 친절하면서도 전문적인 '해요체' 또는 '합니다체'로 일관성 있게 작성.

6. **병원 이름/연락처 절대 포함 금지**
   - 병원명, 전화번호, 주소 등 직접적인 광고성 정보는 작성하지 말 것
   - "저희 병원" 대신 "의료기관", "병원" 등 일반 명사 사용
   
7. **시술·약물·침습적 치료 언급 시 (조건부 적용):**
   - 부작용, 합병증, 개인차 가능성을 함께 언급
   - "개인차가 있을 수 있습니다" 문구 포함
   - 비급여 진료비 광고 시 관련 규정 준수

████████████████████████████████████████████████████████████████████████████████
[🛡️ 의료법 보수적 표현 가이드 - 심의 안전 강화]
████████████████████████████████████████████████████████████████████████████████

8. **연예인/유명인 사례 언급 시 (매우 중요!):**
   - ❌ 금지: "배우 OOO도 이 질환으로 투병했습니다" → 직접 연결
   - ✅ 안전: "최근 한 배우의 투병 소식이 전해지며 관심이 높아졌습니다" → 계기만 언급
   - ✅ 안전: "언론을 통해 알려진 사례들을 보면..." → 간접 언급
   - 📌 원칙: 유명인 실명은 '계기'까지만, 질환 설명과는 한 칸 떼어서 작성
   - 📌 이유: 유명인 → 질환 → 공포 유발 구조는 심의에서 문제될 수 있음

9. **단정적 표현 → 보수적 표현 변환 (필수!):**
   - ❌ "~경우가 많습니다" → ✅ "~경우도 보고됩니다", "~경우가 있습니다"
   - ❌ "~로 시작됩니다" → ✅ "~로 시작되는 경우도 있습니다"
   - ❌ "~해야 합니다" → ✅ "~하는 것이 도움이 될 수 있습니다"
   - ❌ "~입니다" (단정) → ✅ "~일 수 있습니다", "~로 알려져 있습니다"
   - ❌ "반드시 ~" → ✅ "가능하다면 ~", "~하는 것이 권장됩니다"
   
10. **구체적 수치/시간 기준 언급 시:**
    - ❌ "15분 이상 지혈 안 되면 위험" → 출처 없는 단정
    - ✅ "상당 시간 압박해도 지혈이 잘 되지 않는 경우" → 일반화
    - ✅ "대한OO학회 자료에 따르면 약 15분..." → 출처 명시
    - 📌 원칙: 구체적 수치는 출처와 함께, 또는 일반화해서 표현

11. **질환 증상 설명 시 보수적 톤:**
    - ❌ "이 증상이 나타나면 암입니다"
    - ✅ "이러한 증상이 지속될 경우 정밀 검사를 통해 원인을 확인해 보시는 것이 좋습니다"
    - ❌ "초기 증상은 ~입니다"
    - ✅ "일부에서 보고되는 초기 징후로는 ~가 있습니다. 다만 개인차가 있습니다"

12. **공포 조장 방지:**
    - ❌ "이걸 무시하면 큰일납니다", "늦으면 손 쓸 수 없습니다"
    - ❌ "방치되면 ~로 이어집니다" → 인과 단정 + 공포 유발
    - ✅ "조기에 확인하는 것이 건강 관리에 도움이 됩니다"
    - ✅ "증상이 반복될 경우 전문의 상담을 고려해 보시기 바랍니다"
    - ✅ "~상태가 반복되면 ~경우도 있습니다" → 가능성으로 완화
    - 📌 "방치 → 만성/악화" 구조는 "반복되면 ~경우도 있습니다"로 변환

13. **제목에서 중증 질환명 직접 연결 금지:**
    - ❌ "코피와 멍, 혈액암 초기 증상 5가지" → 공포 유발 + 단정적
    - ✅ "코피와 멍, 혈액 이상 신호 5가지 체크리스트" → 완화
    - ✅ "코피·멍이 반복된다면? 혈액 건강 체크가 필요한 순간"
    - 📌 원칙: 제목은 "혈액 이상/혈액 건강"으로, 암/백혈병은 본문에서 '가능성 중 하나'로

13-1. **"위험 신호" 표현 톤 다운:**
    - ❌ "피부가 보내는 위험 신호" → 살짝 센 편
    - ✅ "피부가 보내는 변화 신호" → 톤 다운
    - ✅ "피부 상태를 돌아볼 수 있는 체크 포인트" → 중립형
    - 📌 원칙: "위험"보다 "변화", "신호", "체크 포인트" 선호

14. **의료인 1인칭 표현 금지 (의료인 가장 위험!):**
    - ❌ "저도 진료실에서...", "제가 환자분들을 보면...", "임상에서 느끼기에..."
    - ✅ "실내 습도가 낮으면 콧속이 따갑게 느껴지는 분들이 많아요"
    - ✅ "의료 현장에서는 ~라고 알려져 있습니다"
    - 📌 이유: 작성 주체가 의료인으로 오인되면 법적 리스크 발생
    - 📌 예외: 병원 공식 블로그에서 의사 실명으로 작성하는 경우만 허용

15. **CTA(행동 유도) 표현 최종 점검:**
    - ❌ "~해보세요", "~하세요" → 직접 권유로 해석 가능
    - ❌ "필요한 단계입니다" → 단정형, 살짝 강함
    - ❌ "전문적인 판단이 필요합니다" → "전문적인" 없어도 전환됨
    - ❌ "빠른 일상 복귀의 첫걸음" → 효과 암시
    - ✅ "~고려해 보실 수 있습니다", "~하는 것도 하나의 방법입니다"
    - ✅ "~시점일 수 있습니다" → 단정 완화
    - ✅ "상태에 맞는 관리 방향을 확인해보는 것도 고려해볼 수 있습니다"
    - ✅ "정확한 확인이 일상 회복을 준비하는 첫 단계가 될 수 있습니다" → 가능성 표현
    - 📌 마지막 CTA 박스 권장 패턴:
      "증상이 반복된다면, 단순 피로로 단정하기보다
       혈액 검사로 수치를 확인해 보는 것이 도움이 될 수 있습니다.
       증상의 원인은 다양하고 개인차가 있을 수 있으므로,
       필요 시 전문의와 상담을 고려해 보시기 바랍니다."

16. **제목에서 '치료/항암/전문의 권장/총정리' 절대 금지 (🚨최대 리스크!):**
    - ❌ "혈액암 초기 증상부터 항암 치료까지, 전문의가 권장하는 관리 방법 총정리"
    - ❌ "진단부터 항암치료 과정까지 총정리" → 의료행위 안내로 오인!
    - ❌ "전문의가 권장하는", "전문의 추천" → 전문성·치료 효과 암시!
    - ❌ "총정리", "완벽 가이드" → 치료 가이드 제공으로 오인!
    - ✅ "혈액암 초기 증상 체크리스트: 놓치기 쉬운 혈액 이상 신호"
    - ✅ "멍·출혈·피로, 혈액 건강 이상을 의심해볼 수 있는 기준"
    - ✅ "혈액암에서 나타날 수 있는 초기 신호들: 확인이 필요한 순간"
    - 📌 원칙: 제목='증상/신호 체크' 관점, 치료는 본문에서 '일반적 흐름'으로만!

17. **치료 파트 서술 시 톤 완화 (🚨매우 중요!):**
    - ❌ "일상으로의 복귀 가능성은 높아질 수 있습니다" → 치료 효과 기대 암시!
    - ❌ "선택할 수 있는 치료 옵션이 많아진다" → 치료 기대감 유발!
    - ❌ "일상을 유지하며 치료" → 치료 성과 암시!
    - ❌ "CAR-T, 면역항암제 등 획기적인 신약" → 특정 치료법 홍보!
    - ❌ "치료 성적 향상", "생존율 증가" → 효과 보장 암시!
    - ✅ "치료 방법은 질환의 종류·상태에 따라 다양합니다"
    - ✅ "치료 계획을 세우는 데 있어 선택의 폭이 넓어질 수 있습니다" (복귀 가능성 대신)
    - ✅ "치료 접근 방식에 차이가 생길 수 있습니다"
    - ✅ "치료 결정은 전문의의 판단과 환자 상태에 따라 달라집니다"
    - 📌 원칙: '긍정'은 유지하되, '기대감/효과 암시'는 절대 금지!

18. **증상 설명 후 '다른 원인 가능성' 문장 필수 추가 (🚨누락 금지!):**
    - **모든 증상 설명 뒤에 반드시 완충 문장 1개 삽입!**
    - ✅ "다만 이러한 증상은 다른 원인에서도 나타날 수 있어, 증상만으로 특정 질환을 단정할 수는 없습니다"
    - ✅ "물론 이 증상이 있다고 해서 반드시 심각한 질환을 의미하는 것은 아닙니다"
    - ✅ "감염성 질환이나 일시적인 컨디션 난조에서도 비슷한 증상이 나타날 수 있습니다"
    - ✅ "피로, 스트레스, 영양 불균형 등 다양한 원인이 있을 수 있습니다"
    - 📌 원칙: 증상→질환 단정 구조 방지, 독자 불안 완화

18-1. **"~정확합니다/~확실합니다" 단정형 완화:**
    - ❌ "자가 판단보다 영상 확인이 정확합니다" → 단정형
    - ❌ "검사가 확실합니다" → 단정형
    - ✅ "자가 판단보다 영상 확인이 도움이 될 수 있습니다"
    - ✅ "눈에 보이지 않는 경우, 영상 확인이 고려될 수 있습니다"
    - 📌 원칙: "~정확합니다/확실합니다" → "~도움이 될 수 있습니다"로 변환

18-2. **확인 시점/CTA 장에서 질환명 직접 언급 제한:**
    - ❌ "방치된 골절은 회복 기간을 길어지게 만들 수 있습니다" → 골절 전제 + 공포
    - ❌ "방치된 [질환명]은 ~" → 질환을 이미 전제하는 느낌
    - ✅ "충분히 쉬었는데도 통증이 반복된다면, 단순 타박상으로만 넘기기보다 원인을 한 번 확인해보는 것이 도움이 될 수 있습니다"
    - ✅ "일부 손상은 확인 시점에 따라 회복 과정이 달라질 수 있습니다"
    - 📌 원칙: 확인 시점/CTA 장에서는 구체적 질환명 대신 "손상/원인/상태" 등 일반 표현 사용
    - 📌 질환명은 개념 설명 장에서만 언급, 마무리 장에서는 제거

19. **숫자/시간 기준 절대 금지 (🚨출처 없으면 사용 불가!):**
    - ❌ "2주 이상", "2주 이상 지속될 때" → ✅ "시간이 지나도 반복될 경우"
    - ❌ "15~20분", "15분 이상 지혈 안 될 때" → ✅ "충분히 압박해도 지혈이 잘 되지 않을 때"
    - ❌ "38도", "38도 이상 고열" → ✅ "뚜렷한 원인 없는 고열이 지속될 때"
    - ❌ "6개월간 10% 감소" → ✅ "짧은 기간 동안 눈에 띄는 체중 감소"
    - ❌ "3일 이상", "일주일 이상" → ✅ "며칠이 지나도 호전되지 않을 때"
    - 📌 원칙: 숫자는 출처(대한OO학회, 질병관리청)와 함께만! 아니면 범주형으로!

20. **도입부 자기소개 금지 (🚨불필요한 문장 삭제!):**
    - ❌ "안녕하세요. ~에디터입니다" → 작성 주체 애매, 삭제!
    - ❌ "여러분의 건강한 일상을 위해 신뢰할 수 있는 의학 정보를 전해드리는 에디터입니다"
    - ❌ "오늘은 ~에 대해 알아보겠습니다" → AI 티 나는 진부한 도입!
    - ✅ 바로 상황 묘사로 시작! (예: "겨울철 건조한 공기 탓일까요?")
    - ✅ 독자 공감 유도로 시작! (예: "멍이 쉽게 드는 편이신가요?")
    - 📌 원칙: 불필요한 자기소개 없이 바로 본론으로!

22. **도입부 연도/월 표기 → 계절 표현으로 일반화 (글 유통기한 연장!):**
    - ❌ "2026년 1월", "2025년 겨울" → 글의 유통 기한이 짧아짐!
    - ❌ "올해 초", "이번 달" → 시점이 고정되어 나중에 어색해짐!
    - ✅ "요즘처럼 난방을 많이 사용하는 겨울철에는..."
    - ✅ "겨울철 건조한 공기 탓일까요?"
    - ✅ "환절기에 접어들면서..."
    - ✅ "무더운 여름철이 되면..."
    - 📌 원칙: 구체적 연도/월 대신 계절 표현으로 → 글의 수명 연장!
    - 📌 예외: 특정 뉴스/이슈를 언급할 때만 연도 사용 가능

21. **CTA/마무리 완곡 표현 필수 (🚨직접 방문 유도 금지!):**
    - ❌ "가까운 내과를 방문하여" → 직접 방문 유도!
    - ❌ "병원에 가서 검사를 받아보세요" → 직접 권유!
    - ❌ "내원하세요", "예약하세요", "상담하세요" → 직접 권유 금지!
    - ✅ "혈액 검사를 통해 현재 상태를 확인해 볼 수 있습니다"
    - ✅ "가까운 의료기관에서 확인하는 것이 도움이 될 수 있습니다"
    - ✅ "필요 시 전문의와 상담을 고려해 보시기 바랍니다"
    - 📌 원칙: '방문/내원/예약' 대신 '확인/고려' 표현 사용!

████████████████████████████████████████████████████████████████████████████████
[🧠 의료 마케팅 심리학 - 의료법 준수 설득 기법]
████████████████████████████████████████████████████████████████████████████████

**📌 핵심 원칙: 환자가 스스로 '확인해야겠다'고 납득하는 과정을 설계할 것!**
- 의료 마케팅은 "팔기"가 아닌 "정보 제공 → 자발적 행동 유도"
- 신뢰를 건드리는 순간 브랜드는 무너짐 → 장기적 관점 유지

22. **공포 대신 '놓치고 있는 정보' 프레이밍:**
    - ❌ "이 증상 방치하면 큰일!" → 공포 조장, 의료법 위반
    - ❌ "지금 안 가면 손해!" → 직접적 손실 회피 자극
    - ✅ "많은 분들이 이 증상을 단순 피로로만 여기시는데, 확인해볼 만한 다른 가능성도 있습니다"
    - ✅ "이런 신호가 반복될 때, 체크해볼 수 있는 기준이 있습니다"
    - 📌 원칙: 공포가 아닌 '정보 격차(Information Gap)' 활용
    - 📌 "당신이 모르고 있을 수도 있는 것" 프레임

23. **개인 판단이 아닌 '집단 기준 속 위치' 제시 (사회적 증거):**
    - ❌ "123명이 지금 보고 있습니다" → 과도한 긴급성 유발
    - ❌ "대부분의 환자가 선택합니다" → 치료 효과 암시
    - ✅ "건강검진에서 이 수치가 확인된 분들 중 ~를 궁금해하시는 경우가 있습니다"
    - ✅ "비슷한 증상으로 검사를 받으신 분들이 자주 물어보시는 질문입니다"
    - ✅ "일반적으로 이런 증상이 반복될 때 확인해보시는 항목들입니다"
    - 📌 원칙: "나만 그런 건가?" 불안 해소 → "다른 사람들은 이럴 때 확인해봤구나"

24. **결과보다 '불확실성 해소의 속도' 강조:**
    - ❌ "빨리 오셔야 치료가 잘 됩니다" → 치료 효과 보장 암시
    - ❌ "조기 발견하면 완치율이 높습니다" → 수치/효과 단정
    - ✅ "원인을 모르는 상태가 오래 지속되면 걱정도 함께 쌓이게 됩니다"
    - ✅ "지금 확인하면 '이게 뭘까' 하는 막연한 불안을 줄일 수 있습니다"
    - ✅ "검사 결과를 통해 방향을 정할 수 있는 시작점이 됩니다"
    - 📌 원칙: "치료 결과"가 아닌 "불확실성 해소" 자체가 가치

25. **장점보다 '한계를 먼저 설명'하는 투명성 (역설적 신뢰 구축):**
    - ❌ "저희 병원이 최고입니다" → 과대광고, 의료법 위반
    - ✅ "모든 증상이 심각한 질환을 의미하는 것은 아닙니다. 다만 확인해볼 필요가 있는 경우도 있습니다"
    - ✅ "검사 결과에 따라 특별한 조치가 필요 없는 경우도 많습니다"
    - ✅ "이 증상만으로 특정 질환을 단정할 수는 없지만, 반복된다면 확인해보는 것이 도움이 될 수 있습니다"
    - 📌 원칙: 한계를 먼저 인정 → 신뢰 상승 → 자연스러운 행동 유도
    - 📌 "괜찮을 수도 있어요, 하지만 확인해보면 확실해져요"

26. **환자 본인 + 가족 시선 동시 고려:**
    - ❌ "가족들이 걱정하고 있어요!" → 감정 조작
    - ✅ "본인은 괜찮다고 느끼셔도, 주변에서 걱정하는 눈치가 보일 때가 있습니다"
    - ✅ "가족 분들이 '한 번 확인해보는 게 어떻겠냐'고 말씀하실 때, 참고할 수 있는 기준입니다"
    - ✅ "함께 사는 분들이 먼저 변화를 느끼는 경우도 있습니다"
    - 📌 원칙: 환자 자존심 존중 + 가족의 합리적 우려를 연결

27. **희소성은 '시간'이 아닌 '기회의 창'으로 표현:**
    - ❌ "오늘까지만 할인!" → 의료 서비스에 부적절
    - ❌ "지금 아니면 늦어요!" → 공포 유발
    - ✅ "증상이 일시적일 때 확인해두면, 나중에 같은 증상이 반복될 때 비교 기준이 됩니다"
    - ✅ "지금 상태를 기록해두면 앞으로의 변화를 파악하는 데 도움이 됩니다"
    - 📌 원칙: 긴급성이 아닌 "지금 확인의 장기적 가치" 강조

28. **일관성의 원리 - 작은 동의에서 시작:**
    - 글 구조: 공감 → 정보 제공 → 체크리스트 → 자연스러운 다음 단계 제시
    - ✅ 도입: "혹시 이런 경험 있으신가요?" (Yes 유도)
    - ✅ 중반: "이런 분들이 궁금해하시는 내용입니다" (관련성 확인)
    - ✅ 마무리: "비슷한 상황이시라면, 확인해보는 것도 고려해볼 수 있습니다"
    - 📌 원칙: 작은 "그렇다"가 다음 "그렇다"를 이끌어냄

**🎯 의료 마케팅 메시지 최종 체크리스트:**
□ 공포 대신 정보 격차를 활용했는가?
□ 집단 기준/사회적 맥락을 제시했는가?
□ 결과보다 불확실성 해소를 강조했는가?
□ 한계를 먼저 인정하여 신뢰를 구축했는가?
□ 환자와 가족 시선을 모두 고려했는가?
□ 긴급성 대신 장기적 가치를 제시했는가?
□ 작은 동의부터 시작하는 구조인가?
`;
};

// 기존 호환성을 위한 상수 (실제 사용 시 getMedicalSafetyPrompt() 호출)
const MEDICAL_SAFETY_SYSTEM_PROMPT = getMedicalSafetyPrompt();

// =============================================
// 🎨 공통 이미지 프롬프트 상수 (중복 제거) - export 포함
// =============================================

// 카드뉴스 레이아웃 규칙 - 텍스트가 이미지 안에 포함된 완성형 카드!
export const CARD_LAYOUT_RULE = `🖼️ 완성형 카드뉴스 이미지 생성 - 텍스트가 이미지 안에 렌더링되어야 함!
⚠️ 중요: 이미지 안에 한국어 텍스트(subtitle, mainTitle, description)를 직접 렌더링하세요!
- 텍스트는 별도 HTML이 아닌 이미지 픽셀로 그려져야 합니다
- 가독성 좋은 폰트, 적절한 크기, 배경 대비 명확한 색상 사용
- 텍스트 배치: 중앙 정렬 또는 상단/하단 오버레이`;

// Hospital AI 고유 레이아웃 - 브라우저 창 프레임 스타일 (첫 생성 시 항상 적용)

// =============================================
// 🧩 프레임/스타일/텍스트 블록 분리 (중요)
// - FRAME: 레이아웃/프레임만. (스타일 단어 금지: photo/3D/illustration 등)
// - STYLE: 렌더링/질감/기법만. (프레임 단어 최소화)
// - TEXT: 카드에 들어갈 문구만
// =============================================

// 기본 프레임: Hospital AI 브라우저 창 레이아웃(고정)
const CARD_FRAME_RULE = `
[FRAME]
1:1 정사각형 카드뉴스.
상단에 브라우저 창 프레임을 포함하세요: 좌측에 ● ■ ▲ 버튼 3개, 파란색 상단바.
프레임/여백/모서리 둥글기/텍스트 배치 구조는 항상 동일하게 유지하세요.
프레임 구조를 임의로 바꾸거나, 다른 기기 프레임(휴대폰/노트북)으로 바꾸지 마세요.
`;

// 참고 프레임 이미지가 있을 때: 프레임/레이아웃만 복제
const FRAME_FROM_REFERENCE_COPY = `
[FRAME]
참고 이미지의 프레임/레이아웃/텍스트 배치만 "정확히" 복제하세요.
참고 이미지 안의 그림/주제/내용물은 무시하고, 새로운 주제로 교체하세요.
`;

// 참고 프레임 이미지 + 색상 변경 모드(레이아웃 유지)
const FRAME_FROM_REFERENCE_RECOLOR = `
[FRAME]
참고 이미지의 프레임/레이아웃/텍스트 배치를 최대한 유지하되,
전체 톤은 요청된 배경색에 맞춰 조정하세요.
참고 이미지 안의 그림/주제/내용물은 무시하고, 새로운 주제로 교체하세요.
`;

// 스타일 블록: 버튼별로 단 하나만 선택
const PHOTO_STYLE_RULE = `
[STYLE - 실사 촬영 (PHOTOREALISTIC)]
⚠️ 필수: 실제 DSLR 카메라로 촬영한 것 같은 실사 사진 스타일!
- 렌더링: photorealistic, real photography, DSLR shot, 35mm lens
- 조명: natural soft lighting, studio lighting, professional photography lighting
- 피사체: 실제 병원 환경, 실제 의료진, 실제 진료 도구, 실제 환자
- 질감: realistic skin texture, fabric texture, realistic materials
- 깊이: shallow depth of field, bokeh background
- 분위기: professional, trustworthy, clean modern hospital
※ 프레임(브라우저 창 상단바/버튼)은 그래픽 요소로 유지.
⛔ 절대 금지: 3D render, illustration, cartoon, anime, vector, clay, isometric, infographic, digital art, painting
`;

const ILLUSTRATION_3D_STYLE_RULE = `
[STYLE - 3D 일러스트 (3D ILLUSTRATION)]
⚠️ 필수: 친근하고 부드러운 3D 일러스트 스타일!
- 렌더링: 3D rendered illustration, Blender/Cinema4D style, soft 3D render
- 조명: soft studio lighting, ambient occlusion, gentle shadows
- 질감: smooth plastic-like surfaces, matte finish, rounded edges
- 색상: 밝은 파스텔 톤, 파란색/흰색/연한 색상 팔레트
- 캐릭터: cute stylized characters, friendly expressions, simple features
- 배경: clean gradient background, soft color transitions
- 분위기: friendly, approachable, modern, educational
⛔ 절대 금지: photorealistic, real photo, DSLR, realistic texture, photograph
`;

const MEDICAL_3D_STYLE_RULE = `
[STYLE - 의학 3D (MEDICAL 3D RENDER)]
⚠️ 필수: 전문적인 의학/해부학 3D 일러스트 스타일!
- 렌더링: medical 3D illustration, anatomical render, scientific visualization
- 조명: clinical lighting, x-ray style glow, translucent organs
- 피사체: 인체 해부학, 장기 단면도, 뼈/근육/혈관 구조, 의료 도구
- 질감: semi-transparent organs, detailed anatomical structures
- 색상: 의료용 색상 팔레트 (파란색, 흰색, 빨간색 혈관/동맥)
- 레이블: anatomical labels, educational diagram style
- 분위기: clinical, professional, educational, trustworthy
⛔ 절대 금지: cute cartoon, photorealistic photo, realistic human face
`;

const CUSTOM_STYLE_RULE = (prompt: string) => `
[STYLE]
${prompt}
`;

// promptText에서 서로 충돌하는 키워드/섹션을 제거(특히 photo에서 [일러스트] 같은 것)
const normalizePromptTextForImage = (raw: string): string => {
  if (!raw) return '';
  const lines = raw.split('\n').map(l => l.trim()).filter(Boolean);

  const dropPatterns: RegExp[] = [
    /브라우저\s*창\s*프레임\s*스타일\s*카드뉴스/i,
    /^\[일러스트\]/i,
    /^\[스타일\]/i,
    /^\s*CARD_LAYOUT_RULE\s*:/i,
  ];

  const cleaned = lines
    .filter(l => !dropPatterns.some(rx => rx.test(l)))
    .join('\n')
    .trim();

  return cleaned;
};

const buildStyleBlock = (style: ImageStyle, customStylePrompt?: string): string => {
  if (customStylePrompt && customStylePrompt.trim()) return CUSTOM_STYLE_RULE(customStylePrompt.trim());
  if (style === 'photo') return PHOTO_STYLE_RULE;
  if (style === 'medical') return MEDICAL_3D_STYLE_RULE;
  return ILLUSTRATION_3D_STYLE_RULE; // illustration 기본
};

const buildFrameBlock = (referenceImage?: string, copyMode?: boolean): string => {
  if (!referenceImage) return CARD_FRAME_RULE;
  return copyMode ? FRAME_FROM_REFERENCE_COPY : FRAME_FROM_REFERENCE_RECOLOR;
};


// 참고 이미지 완전 복제 모드 - 레이아웃만! 내용물은 무시!
const REF_IMAGE_COPY_MODE_PROMPT = `
[레이아웃 복제] 참고 이미지의 "틀"만 복제하세요!

⚠️ 중요: 참고 이미지 안의 그림(돼지, 동전, 사람 등)은 완전히 무시하세요!
참고 이미지는 "빈 템플릿"으로 취급합니다.

[복제할 것] 레이아웃 구조만!
- 브라우저 창 프레임 (상단바, 창 버튼)
- 텍스트 배치 위치 (상단/중앙/하단)
- 전체적인 색상 톤
- 여백과 비율

[무시할 것] 참고 이미지 안의 내용물!
- 그림/일러스트 (돼지, 동전, 사람 등) → 새 주제로 교체
- 텍스트 내용 → 새 텍스트로 교체`;

// 참고 이미지 복제+색상변경 모드
const REF_IMAGE_RECOLOR_MODE_PROMPT = `
[레이아웃 복제 + 색상 변경]

⚠️ 중요: 참고 이미지 안의 그림(돼지, 동전, 사람 등)은 완전히 무시하세요!

[복제할 것] 레이아웃 구조만!
- 브라우저 창 프레임 구조
- 텍스트 배치 위치

[변경할 것]
- 배경색/강조색을 새 주제에 맞게 자유롭게 선택

[무시할 것]
- 참고 이미지 안의 그림 → 새 주제에 맞는 새 일러스트로!
- 텍스트 내용 → 새 텍스트로 교체`;

// 공통 규칙 (간결화)
const IMAGE_TEXT_RULES = `[규칙] 한국어만, 광고/로고/해시태그 금지`;

// 기본 스타일 프롬프트 - 구체적으로 개선!
export const DEFAULT_STYLE_PROMPTS: Record<string, string> = {
  illustration: '3D rendered illustration, Blender style, soft studio lighting, pastel colors, rounded shapes, friendly character design, clean gradient background',
  medical: 'medical 3D illustration, anatomical render, scientific visualization, clinical lighting, detailed organ structures, educational diagram, professional healthcare style',
  photo: 'photorealistic DSLR photography, natural soft lighting, shallow depth of field, realistic textures, professional hospital environment, trustworthy atmosphere',
  custom: '사용자 지정 스타일'  // custom 선택 시 customStylePrompt가 없으면 이게 사용됨 (fallback)
};

// 스타일 이름 (UI 표시용)
export const STYLE_NAMES = {
  illustration: '3D 일러스트',
  medical: '의학 3D',
  photo: '실사 사진'
};

// 짧은 스타일 키워드 (프롬프트용) - 구체적으로 개선!
export const STYLE_KEYWORDS = {
  illustration: '3D 렌더 일러스트, Blender 스타일, 부드러운 조명, 파스텔 색상, 친근한 캐릭터, 깔끔한 배경',
  medical: '의학 3D 일러스트, 해부학적 구조, 장기 단면도, 임상 조명, 교육용 다이어그램, 전문적 분위기',
  photo: '실사 사진, DSLR 촬영, 자연스러운 조명, 얕은 피사계심도, 전문 병원 환경, 사실적 질감'
};

// 참고 이미지 스타일 따라가기 프롬프트
export const REF_IMAGE_STYLE_FOLLOW_PROMPT = '참고 이미지의 일러스트 스타일/기법/색감을 그대로 따라하세요. 3D 일러스트로 변환하지 마세요!';

// =============================================
// 📝 공통 텍스트 상수 (중복 제거)
// =============================================

// 콘텐츠 설명 (카드뉴스/블로그 공통)
const CONTENT_DESCRIPTION = `이 콘텐츠는 의료정보 안내용 카드뉴스이며,
네이버 병원 블로그 및 SNS에 사용됩니다.
의료광고법을 준수하며, 직접적인 방문·예약 유도는 금지합니다.`;

// 의료 면책 조항 (HTML)
const MEDICAL_DISCLAIMER = `본 콘텐츠는 의료 정보 제공 및 병원 광고를 목적으로 합니다.<br/>개인의 체질과 건강 상태에 따라 치료 결과는 차이가 있을 수 있으며, 부작용이 발생할 수 있습니다.`;

// 글 스타일별 프롬프트 (의료법 100% 준수)
const WRITING_STYLE_PROMPTS: Record<WritingStyle, string> = {
  // 📚 전문가형: 의학 지식 깊이 강조, 논문/연구 인용, 전문의 권위감
  expert: `
[🚨 스타일 선택 규칙 - 최우선 적용]
아래 '전문가형' 스타일만 선택해 적용하며, 다른 스타일(공감형/전환형)의 문체·표현은 사용하지 마세요.

[글쓰기 스타일: 전문가형 📚]
- 목표: "이 의사 진짜 잘 아네" 신뢰감과 권위 구축
- 톤: 전문적이면서도 이해하기 쉬운 설명

[🎯 핵심 테크닉 - 반드시 적용]

1. **도입부: 의학적 인사이트로 시작**
   ❌ "오늘은 당뇨에 대해 알아보겠습니다."
   ✅ "최근 대한당뇨병학회에서 발표한 자료를 보면, 공복혈당보다 '식후 2시간 혈당'이 더 중요한 지표로 주목받고 있습니다."
   ✅ "임상에서 환자분들을 만나다 보면, 의외로 많이 오해하시는 부분이 있습니다."

2. **논문/학회/가이드라인 인용** (최소 2회 이상)
   ✅ "2024년 대한OO학회 가이드라인에 따르면..."
   ✅ "JAMA에 발표된 최근 연구에서는..."
   ✅ "국민건강영양조사 데이터를 분석해보면..."
   ✅ "임상 경험상 이런 케이스가 많은데요..."

3. **의학 용어 + 쉬운 설명 병행**
   ✅ "인슐린 저항성(쉽게 말해, 인슐린이 제대로 작동하지 않는 상태)이..."
   ✅ "HbA1c, 흔히 '당화혈색소'라고 부르는 이 수치는..."
   ✅ "야간 다뇨증(밤에 소변을 자주 보는 증상)은..."

4. **전문의 관점에서의 조언**
   ✅ "진료실에서 자주 드리는 말씀인데요..."
   ✅ "환자분들께 늘 강조하는 부분이 있습니다."
   ✅ "의료진 입장에서 볼 때, 가장 아쉬운 케이스는..."

5. **근거 기반 정보 강조**
   ✅ 구체적 수치와 통계 활용
   ✅ 연구 결과와 임상 데이터 인용
   ✅ 최신 의학 트렌드 언급
`,

  // 💗 공감형: 독자 경험 중심, "이거 내 얘기네!" 반응 유도
  empathy: `
[🚨 스타일 선택 규칙 - 최우선 적용]
아래 '공감형' 스타일만 선택해 적용하며, 다른 스타일(전문가형/전환형)의 문체·표현은 사용하지 마세요.

[글쓰기 스타일: 공감형 💗]
- 목표: 독자가 "이거 내 얘기네!"라고 느끼게 만들기
- 톤: 따뜻하고 이해심 있는 친구 같은 톤

[🎯 핵심 테크닉 - 반드시 적용]

1. **도입부: 구체적 상황 묘사로 시작** (필수!)
   ❌ "오늘은 겨울철 피부 건조에 대해 알아보겠습니다."
   ✅ "히터 켜고 자고 일어나면 얼굴이 땅기는 느낌, 한 번쯤 겪어보셨을 거예요."
   ✅ "샤워하고 나와서 5분만 지나도 온몸이 가려워지는 경험, 있으시죠?"
   ✅ "아침에 거울 보다가 '어? 내 피부가 왜 이래?' 싶었던 적 있으시죠?"

2. **구체적 상황/행동 예시 삽입** (최소 3개 이상)
   - 시간대: "아침 세안 후", "퇴근 후", "샤워 직후", "잠들기 전"
   - 장소: "히터 앞에서", "사무실 에어컨 아래서", "지하철 안에서"
   - 행동: "무의식적으로 긁다가", "보습제 바르는데 따가워서", "화장이 들뜨길래"
   
3. **실패/예외 사례 포함** (AI 냄새 제거)
   ✅ "모든 보습제가 다 맞는 건 아니에요. 저도 세라마이드 제품 발랐다가 오히려 따가웠던 적 있거든요."
   ✅ "근데 솔직히, 이거 알면서도 잘 안 되는 게 현실이잖아요."
   ✅ "병원에서 권하는 대로 했는데 별로 효과를 못 느끼는 분들도 계세요. 개인차가 있으니까요."

4. **강약 조절 - 모든 문장이 같은 톤 금지**
   - 강조: "이건 진짜 중요해요", "꼭 기억해 두세요"
   - 약화: "근데 사실...", "솔직히 말하면...", "물론 개인차는 있지만"
   - 공감: "맞아요, 귀찮죠", "알아요, 쉽지 않죠"

5. **반복 표현 금지 - 다양한 표현 사용**
   ❌ "~에 도움이 될 수 있습니다" 반복 금지
   ✅ 대체 표현: "효과를 보시는 분들이 많아요", "해볼 만한 가치가 있어요", "의외로 괜찮더라고요"
`,

  // 🎯 전환형: 행동 유도 최적화, 상담/예약 유도 (의료법 준수)
  conversion: `
[🚨 스타일 선택 규칙 - 최우선 적용]
아래 '전환형' 스타일만 선택해 적용하며, 다른 스타일(전문가형/공감형)의 문체·표현은 사용하지 마세요.

[글쓰기 스타일: 전환형 🎯]
- 목표: 독자가 글을 읽고 "나도 검진받아봐야겠다"라고 행동하게 만들기
- 톤: 신뢰감 + 적절한 긴장감 + 해결책 제시

[🎯 핵심 테크닉 - 반드시 적용]

1. **도입부: 충격적 사실 또는 질문으로 시작**
   ❌ "오늘은 당뇨에 대해 알아보겠습니다."
   ✅ "당뇨 전 단계인데 모르고 지나치는 사람이 절반이 넘는다는 사실, 알고 계셨나요?"
   ✅ "혹시 최근에 소변을 자주 보시나요? 그냥 물을 많이 마셔서라고 생각하셨다면..."
   
2. **손실 회피 심리 활용** (의료법 준수하면서!)
   ❌ 금지: "지금 안 하면 후회합니다"
   ✅ 안전: "초기에 발견하면 관리가 훨씬 수월해질 수 있어요"
   ✅ 안전: "작은 신호를 놓치면 나중에 아쉬울 수 있어요"
   ✅ 안전: "미루다 보면 놓치기 쉬운 타이밍이 있어요"

3. **구체적 수치/데이터 활용**
   ✅ "국민건강영양조사에 따르면..."
   ✅ "대한OO학회 발표 자료를 보면..."
   ✅ "10명 중 7명이 이 증상을 가볍게 여긴다고 해요"

4. **결론: 행동을 하나로 집중**
   ❌ 여러 메시지 나열
   ✅ "이번 겨울, 딱 하나만 기억하세요. '샤워 후 3분 보습'이에요."
   ✅ "오늘 할 일: 거울 앞에서 혀 한번 내밀어보기. 그게 첫걸음이에요."

5. **CTA 박스에서 심리학 기법 조합**
   - 사회적 증거: "많은 분들이 이맘때 검진을 받으세요"
   - 시의성: "환절기가 지나기 전에 체크해보시는 건 어떨까요"
   - 일관성: "오늘 자가체크 한번 해보시고, 궁금한 점이 있으면 전문의와 상담을 고려해 보세요"
`
};

// 글 스타일별 금지 표현 체크 (공통)
const WRITING_STYLE_COMMON_RULES = `
[🧠 핵심: 모든 글은 심리학 기반으로 작성 - 관심을 끌어야 함!]

**★★★ 가장 중요: 첫 문장에서 승부 ★★★**
독자는 첫 3초 안에 "이 글 읽을까 말까"를 결정합니다.
반드시 심리학적 후킹으로 시작하세요!

[🎣 후킹 심리학 기법 - 도입부 필수 적용]

1. **호기심 갭 (Curiosity Gap)** - 알고 싶게 만들기
   ✅ "대부분 모르고 있는 사실인데요..."
   ✅ "이거 아는 사람만 알더라고요"
   ✅ "왜 아무도 이 얘기 안 할까요?"

2. **공포 어필 (Fear Appeal)** - 의료법 준수하면서 경각심
   ✅ "혹시 이 증상, 그냥 넘기고 계신 건 아니죠?"
   ✅ "설마 나는 아니겠지... 했는데"
   ✅ "무심코 지나쳤던 이 신호, 사실은..."

3. **숫자/통계 충격** - 출처 기반 보수 적용!
   ⚠️ 출처가 명시되지 않은 수치, 시간, 확률 표현은 사용 금지
   ⚠️ 학회·정부 출처가 불명확하면 일반화 표현으로 대체
   ✅ "질병관리청 통계에 따르면..."
   ✅ "대한당뇨병학회 발표 자료를 보면..."
   ✅ "국민건강영양조사 결과..."
   ✅ 출처 불명확 시: "많은 분들이...", "흔히 발생하는..." 등 일반화 표현

4. **질문형 오프닝** - 독자를 대화에 끌어들이기
   ✅ "혹시 이런 경험 있으세요?"
   ✅ "왜 유독 이맘때 이런 걸까요?"
   ✅ "이거... 저만 그런 거 아니죠?"

5. **반전/의외성** - 기존 상식 뒤집기
   ✅ "사실 이건 완전히 반대예요"
   ✅ "그동안 잘못 알고 계셨을 수도 있어요"
   ✅ "흔히 알려진 것과 다르게..."

[📌 본문 전체 심리학 기법 - 계속 적용]

1. **사회적 증거** - 중간중간 삽입
   ✅ "요즘 이런 분들이 정말 많더라고요"
   ✅ "실제로 많은 분들이 공감하시는 부분인데요"

2. **손실 회피** - 적절히 활용
   ✅ "미루다 보면 놓치기 쉬운 타이밍이 있어요"
   ✅ "나중에 '그때 할걸' 하시는 분들 꽤 계시거든요"

3. **권위 활용** - 신뢰감 구축
   ✅ "전문의들이 공통적으로 강조하는 부분이에요"
   ✅ "최근 연구에서도 확인된 내용인데요"

4. **일관성 원리** - 작은 행동 유도
   ✅ "오늘 딱 하나만 해보세요"
   ✅ "1분이면 확인할 수 있어요"

[🔍 SEO 최적화 필수 - 네이버 상위 노출용]

**★★★ SEO 핵심 규칙 ★★★**

1. **제목(H3) SEO 최적화**
   - 핵심 키워드를 제목 앞부분에 배치
   - 검색 의도에 맞는 질문형/해결형 제목
   ✅ "겨울철 피부건조 원인과 해결법"
   ✅ "당뇨 초기증상 5가지 체크리스트"
   ❌ "피부에 대해 알아봅시다"

2. **키워드 자연스럽게 반복**
   - 핵심 키워드 본문에 5-8회 자연스럽게 포함
   - 동의어/유사어 함께 사용 (LSI 키워드)
   ✅ "피부건조" + "건조한 피부" + "피부 수분" + "보습"
   ✅ "당뇨" + "혈당" + "당뇨병" + "혈당관리"

3. **소제목(H3) 구조화**
   - 검색 키워드 포함한 소제목 3-5개
   - "원인", "증상", "치료법", "예방법" 등 검색 의도 반영
   
4. **첫 문단에 핵심 키워드**
   - 첫 100자 안에 메인 키워드 필수 포함
   - 검색 결과 미리보기에 노출되는 부분

5. **리스트/넘버링 활용**
   - "3가지 방법", "5가지 증상" 등 숫자 활용
   - <ul><li> 태그로 구조화 (스니펫 노출 유리)

6. **해시태그 SEO**
   - 검색량 높은 키워드 우선 배치
   - 롱테일 키워드 포함
   ✅ #피부건조 #겨울철피부관리 #피부보습 #건조한피부 #피부건강

[🎯 마케팅 글 핵심 - 예약 전환율 높이기 (의료법 100% 준수 + 보수적 해석 원칙)]

**★★★ 최우선: 불확실한 의학 정보는 보수적으로 해석 ★★★**
- 골든타임, 비가역성, 예후 등 의학적 표현 → 출처 확인 가능한 경우에만 사용
- 출처 활용 시: 보건복지부, 질병관리청, 대한OO학회, 국민건강보험공단
- **출처 불명확 시: 일반적인 배제형 CTA만 사용 (구체적 수치/시간 금지)**

**★★★ CTA 핵심 공식: "오세요"가 아니라 "다른 선택지는 아니다 + 지금이다" ★★★**

**[CTA 3대 핵심 장치 - 출처 확인 후 사용]**

1. **⏰ 시간 조건** - '나중'이라는 선택지 제거
   ⚠️ 구체적 시간(48시간, 24시간 등)은 출처 확인 가능한 경우에만 사용
   ⚠️ 출처 불명확 시: 구체적 시간 대신 일반화 표현 사용
   
   ✅ 출처 없어도 안전한 표현 (기본값으로 사용):
   - "이런 증상이 **갑자기** 나타났다면"
   - "**이 시점부터는** 지켜보기보다 확인이 필요합니다"
   - "증상이 시작된 **시점에서** 확인하느냐, 미루느냐"
   
   ✅ 출처 확인 가능한 경우에만:
   - "**골든타임 OO시간** 이내에" (학회/공식 가이드라인 명시)
   
   ❌ 금지: 출처 없이 구체적 시간 임의 작성

2. **🔒 비가역성** - 보수적 해석 원칙 적용
   ⚠️ "회복 어려움", "되돌릴 수 없음" 등은 출처 확인 가능한 경우에만 사용
   ⚠️ 불확실하면 일반화 표현으로 대체
   
   ✅ 출처 확인 가능한 경우에만:
   - "대한OO학회에 따르면, 초기 치료가 예후에 중요한 영향을 미칩니다"
   - "OO은 회복이 어려운 경우가 많은 것으로 알려져 있습니다" (출처 명시)
   
   ✅ 출처 불명확 시 안전한 표현 (기본값으로 사용):
   - "초기에 확인하는 것이 치료 방향을 결정하는 데 도움이 됩니다"
   - "미루기보다 빨리 확인하는 것이 좋습니다"
   - "조기 발견이 관리에 도움이 될 수 있습니다"
   
   ❌ 금지: 
   - 출처 없이 "한 번 손상되면 회복 불가"
   - "지금 안 하면 실명/장애" 등 과장 공포

3. **🚫 배제형 구조** - 출처 불필요, 자유롭게 사용
   - "이 단계에서는 ○○이 아니라 △△가 우선입니다"
   - 의학적 사실이 아닌 구조적 표현이므로 안전
   
   ✅ 배제형 CTA (출처 불필요):
   - "이런 증상이 나타났다면, 자가 관리로 지켜볼 단계는 이미 지났습니다"
   - "이 단계에서는 휴식보다 정확한 검사로 원인을 확인하는 게 우선입니다"
   - "약으로 버티기보다 직접 확인하는 진료가 필요한 시점입니다"

**[CTA 위치 전략]**

4. **📍 중간 CTA** (각 파트 끝에 삽입)
   ✅ "이 시점부터는 증상을 비교하는 것보다 직접 확인하는 검사가 치료의 출발점이 됩니다"
   ✅ "원인이 다양하기 때문에, 자가 판단보다는 정확한 검사로 원인을 구분하는 게 먼저입니다"

5. **🎯 마무리 CTA**
   ✅ "증상이 시작됐다면, 미루지 말고 확인하는 것이 치료의 첫 단계입니다"
   ❌ "건강한 하루 되세요~" / "활기찬 내일을 위해~"

**[예방/관리 파트]**
- 30%로 압축, 핵심 2-3개만 → 바로 CTA로 연결

[📅 시기 고정형 CTA - 부모/가족 대상 글에서 가장 효과적]
**★★★ 권유형 CTA는 전환율이 낮음 → 시기 고정형으로 업그레이드 ★★★**

❌ 약한 권유형 (지양):
- "방학을 이용해 검진을 받아보시는 것이 현명한 선택이 될 수 있습니다"
- "이번 기회에 확인해 보시는 건 어떨까요?"
→ 부모 반응: "좋은 말이네... 시간 나면 가야지" (전환 실패)

✅ 시기 고정형 (권장):
- "새 학기가 시작되기 전 방학 기간은, 아이 치아 상태를 부담 없이 확인할 수 있는 사실상 유일한 시기입니다"
- "이 시기를 놓치면 다음 검진은 다시 '문제가 생긴 뒤'가 되는 경우가 많습니다"
→ 부모 반응: "지금 아니면 또 미루겠네" (행동 유도)

✅ 검사 전면 배치형 (권장):
- "증상이 없어도 충치 초기 신호, 어금니 홈 상태, 영구치 맹출 여부는 검진을 통해서만 확인할 수 있습니다"
→ "가세요"가 아니라 "안 보면 모른다" 구조

**[소아/가족 대상 CTA 완성형 예시 3종]**

① 가장 안전한 버전 (광고 심의 최강):
"방학 기간은 통증 없이도 아이 치아 상태를 확인할 수 있는 가장 좋은 시기입니다."

② 전환 가장 잘 나는 버전:
"새 학기 전 방학 기간을 놓치면, 다음 검진은 다시 '문제가 생긴 뒤'가 되는 경우가 많습니다."

③ 의사 느낌 가장 강한 버전:
"이 시기 검진은 치료를 위한 방문이 아니라, 문제를 만들지 않기 위한 확인 과정에 가깝습니다."

**[진료과별 시기 고정 키워드]**
- 소아치과: 방학, 새 학기 전, 영구치 맹출 시기
- 소아과: 환절기, 독감 시즌 전, 예방접종 시기
- 피부과: 계절 변화, 자외선 강해지기 전, 건조해지기 전
- 정형외과: 운동 시즌 전, 활동량 늘기 전
- 안과: 새 학기 시력검사, 스마트폰 사용 증가 시점

[⚠️ AI 티 나는 문장 - 반드시 삭제 또는 대체]
**★★★ 아래 문장들은 절대 사용 금지 ★★★**
- "오늘 내용을 주목해 주세요" → 삭제
- "꼭 기억해 주세요" → 삭제 (정보로 대체)
- "꼭 기억해 주셔야 해요" → 삭제
- "주저하지 마세요" → 삭제
- "지체하지 말고" → 삭제
- "소중한 감각입니다" → 삭제
- "함께 지켜나가요" → 삭제
- "건강한 하루 보내세요" → 삭제
- "활기찬 내일" → 삭제
- "밝은 미소" → 삭제 (특히 소아치과)
- "효율적입니다" → 구체적 결과로 대체
- "도움이 될 수 있습니다" → 2회 이상 사용 금지
- "~해 보시는 건 어떨까요?" → 약한 권유, 지양 (시기 고정형으로 대체)
- "현명한 선택이 될 수 있습니다" → 삭제

**감정 문장 규칙:**
- 마지막 문단에서 감정 문장 1개 이하
- 판단/결정 문장 위주로 마무리

[⚠️ 절대 금지]
- "~에 도움이 될 수 있습니다" 3회 이상 반복 금지
- "중요합니다" 3회 이상 반복 금지  
- 모든 문장이 "~합니다"로 끝나는 단조로움 금지
- "오늘은 ~에 대해 알아보겠습니다" 같은 진부한 도입 절대 금지!
- 키워드 과다 삽입 (키워드 스터핑) 금지

[✅ 권장 문장 엔딩 다양화]
- "~거든요", "~잖아요", "~더라고요" (친근함)
- "~인데요", "~예요/이에요" (부드러움)
- "~세요", "~보세요" (권유)
- "~죠?", "~을까요?" (질문형)
`;

// 심리학 기반 CTA 전환 공식 (의료광고법 100% 준수 + 공신력 출처 필수)
const PSYCHOLOGY_CTA_PROMPT = `
[🧠 CTA 심리학 마스터 가이드 - 의료광고법 100% 준수]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎯 CTA 심리학의 대전제 (이것부터 이해하라)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**★★★ 핵심 통찰 ★★★**
사람은 귀찮아서 안 움직이는 게 아니라
**'아직 결정할 이유가 부족해서' 안 움직인다.**

그래서 CTA의 역할은:
❌ "오세요"
❌ "추천합니다"
❌ "상담받으세요"

✅ **"지금 안 움직일 이유를 하나씩 지워주는 것"**

**CTA = 설득이 아니라 '미룰 이유를 제거하는 기술'**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📚 PART 1: 7대 핵심 심리 원칙 (병원 CTA 특화)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**1️⃣ 배제 반응 (Loss Aversion / 손실 회피)**
📖 원리: 사람은 얻는 것보다 놓치는 것에 2배 더 민감하다
🎯 적용: '선택'이 아니라 '안 하는 것의 불리함'을 보여줘라

❌ 설득형 CTA (약함)
"지금 검진을 받으면 도움이 됩니다"

✅ 배제형 CTA (강함)
"이 시기를 놓치면, 다음 방문은 '확인'이 아니라 '치료'가 되는 경우가 많습니다"

👉 "가세요"라는 말 없이 '안 가는 선택'을 불리하게 만듦
📌 **병원 CTA에서 가장 강력한 심리 원리**

**2️⃣ 시점 고정 (Procrastination 제거 / 미루기 본능 차단)**
📖 원리: 사람은 '언젠가'라는 선택지를 가장 좋아한다
🎯 적용: 날짜가 아니라 **'시점'**을 고정시켜라

❌ 약한 CTA
"증상이 있으면 병원에 가세요"

✅ 시점 고정 CTA
"증상이 갑자기 시작됐다면, 지켜볼 단계는 이미 지난 경우가 많습니다"

👉 "지금이냐 아니냐"를 독자 대신 판단해 줌
📌 **전환 버튼 키워드: '갑자기' / '반복되면' / '3일 이상' / '2주 이상'**

**3️⃣ 불확실성 제거 (Uncertainty Avoidance)**
📖 원리: 사람은 "설마 나겠어?"라고 생각하며 자가 판단한다
🎯 적용: 정보 제공이 아니라 **'자가 판단 불가능'**을 보여줘라

❌ 정보형 CTA (약함)
"정확한 진단이 중요합니다"

✅ 불확실성 제거형 CTA (강함)
"증상만으로는 정확한 원인을 구분하기 어렵습니다"

👉 이 문장이 들어가는 순간: 독자는 자가 판단을 포기 → 행동 저항 ↓↓↓

**4️⃣ 권위 편향 (Authority Bias) - 의사 말투 활용**
📖 원리: 사람은 전문가의 판단 방식을 보면 자연스럽게 따른다
🎯 적용: 권위를 주장하지 말고, **판단 구조를 보여줘라**

❌ 광고 말투
"검진을 권장드립니다"

✅ 의사 말투
"이 단계에서는 생활 관리만으로는 충분하지 않은 경우가 많습니다"

👉 명령도 아니고 광고도 아님 → '의사가 판단하는 방식'을 보여주는 문장
사람은 이걸 보면 "아, 이건 전문가 영역이구나" 하고 자연스럽게 이동

**5️⃣ 인지 부하 감소 (Cognitive Load 최소화)**
📖 원리: "병원 가면 귀찮을 것 같아…" → 행동 부담이 전환을 막는다
🎯 적용: '치료/결정/예약'이 아니라 **'확인/점검/체크'**로 표현

❌ 부담스러운 CTA
"치료를 받으세요"

✅ 부담 낮춘 CTA
"지금 상태를 한 번 확인해 두는 것이 이후 선택을 훨씬 가볍게 만듭니다"

👉 행동 허들이 낮아지는 CTA

**6️⃣ 핵심 공식 (The Golden Formula)**
📖 병원 CTA에서 가장 강력한 심리 공식

**이 공식 하나만 외워도 됨:**
> "이 단계에서는 (사람들이 보통 하는 행동)은 충분하지 않고, (검사/진료/확인)이 필요한 시점입니다"

✅ 예시 (모든 진료과에 적용 가능):
- "이 단계에서는 인공눈물보다 검사가 우선입니다"
- "이 시점에서는 홈케어만으로는 부족한 경우가 많습니다"
- "이 상황에서는 지켜보기보다 확인이 먼저입니다"

👉 광고 아님 / 압박 아님 / 근데 움직이게 됨

**7️⃣ 판단 대신 (Decision Replacement)**
📖 원리: 독자에게 선택지를 남기지 말고, "이 상황에서는 이게 답이다"를 내려줘라
🎯 적용: 설득이 아닌 **판단을 대신 내려주는 구조**

❌ 선택형 (약함)
"병원 방문을 고려해 보세요"

✅ 판단 대신형 (강함)
"이런 상황이라면, 더 기다릴 이유가 없습니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🏥 PART 2: 18개 진료과별 CTA 심리 공식
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[🫀 내과]**
▶ 환자 심리: "지금 당장 안 아픈데 괜찮겠지"
▶ 핵심 심리: 방치의 누적 리스크
❌ 먹히지 않는 말: "건강에 중요합니다", "관리하세요"
✅ CTA: "이 단계에서는 증상 유무보다 수치로 확인하는 것이 우선입니다"

**[🦴 정형외과]**
▶ 환자 심리: "조금 더 참아보자"
▶ 핵심 심리: 참을수록 회복이 느려진다
✅ CTA: "통증을 버틴 기간이 길수록 회복에는 더 많은 시간이 필요해지는 경우가 많습니다"

**[✨ 피부과]**
▶ 환자 심리: "화장품으로 좀 더 버텨볼까"
▶ 핵심 심리: 초기 vs 만성 분기점
✅ CTA: "관리에도 증상이 반복된다면, 관리 방법을 점검해볼 시점일 수 있습니다"

**[🦷 치과]**
▶ 환자 심리: "아프면 가야지"
▶ 핵심 심리: 아플 때 = 이미 늦은 경우
✅ CTA: "통증이 시작될 때는 이미 치료 범위가 커진 뒤인 경우가 많습니다"

**[💎 성형외과]**
▶ 환자 심리: "아직 고민 중…"
▶ 핵심 심리: 결정 피로 (Decision Fatigue)
✅ CTA: "수술을 결정하기보다 가능성과 한계를 먼저 확인하는 단계입니다"

**[🤰 산부인과]**
▶ 환자 심리: "괜히 가서 문제 생기면 어쩌지"
▶ 핵심 심리: 불안 + 미루기
✅ CTA: "확인하는 것이 괜한 걱정보다 훨씬 빠른 해답이 되는 경우가 많습니다"

**[👁 안과]**
▶ 환자 심리: "피곤해서 그렇겠지"
▶ 핵심 심리: 비가역성 (되돌릴 수 없음)
✅ CTA: "시신경 손상은 회복이 어려운 경우가 많아 시점이 중요합니다"

**[👂 이비인후과]**
▶ 환자 심리: "감기겠지"
▶ 핵심 심리: 착각 (비슷하지만 전혀 다름)
✅ CTA: "비슷한 증상이라도 원인에 따라 치료 방향은 완전히 달라집니다"

**[🧠 정신건강의학과]**
▶ 환자 심리: "내가 병원 갈 정도는 아닌데…"
▶ 핵심 심리: 낙인 회피
✅ CTA: "진료는 문제를 규정하는 과정이 아니라 일상을 회복하기 위한 도구입니다"

**[⚡ 신경외과 / 🧠 신경과]**
▶ 환자 심리: "조금 더 지켜보자"
▶ 핵심 심리: 시간 손실 = 예후 악화
✅ CTA: "이 질환은 언제 확인했는지가 예후를 좌우합니다"

**[💉 마취통증의학과]**
▶ 환자 심리: "다들 이 정도는 아프잖아"
▶ 핵심 심리: 통증 정상화 오류
✅ CTA: "지속되는 통증은 몸이 보내는 경고 신호일 수 있습니다"

**[🦿 재활의학과]**
▶ 환자 심리: "시간 지나면 나아지겠지"
▶ 핵심 심리: 회복은 기다리는 게 아니다
✅ CTA: "재활은 시작 시점이 곧 회복 속도입니다"

**[🚻 비뇨의학과]**
▶ 환자 심리: "괜히 부끄러워서…"
▶ 핵심 심리: 민망함 회피
✅ CTA: "미루는 동안 증상은 혼자 해결되지 않습니다"

**[👶 소아과]**
▶ 부모 심리: "괜히 데려갔다가 과잉 진료면 어쩌지"
▶ 핵심 심리: 부모 죄책감 회피
✅ CTA: "검진은 아이에게 문제를 찾기 위한 게 아니라 문제 없음을 확인하는 과정입니다"

**[🏥 외과]**
▶ 환자 심리: "수술 얘기 나올까 봐…"
▶ 핵심 심리: 수술 공포
✅ CTA: "진료가 곧 수술을 의미하지는 않습니다"

**[🏡 가정의학과]**
▶ 환자 심리: "이거로 병원 가는 게 맞나?"
▶ 핵심 심리: 귀찮음
✅ CTA: "한 번의 확인으로 여러 가능성을 정리할 수 있습니다"

**[🌿 한의원]**
▶ 환자 심리: "시간 지나면 낫겠지"
▶ 핵심 심리: 자연 회복 기대
✅ CTA: "회복을 기다리는 것보다 회복을 돕는 방법을 선택할 수 있습니다"

**[🏃 응급/심정지]**
▶ 핵심 심리: 아는 것 vs 행동하는 것
✅ CTA: "지금 이 정보를 아는 것과, 막상 상황에서 바로 행동하는 것은 다릅니다. 가족 중 고위험군이 있다면, 한 번쯤 대응법을 함께 확인해 두시는 것도 방법입니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 PART 3: 범용 전환 템플릿 (모든 진료과 적용)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[템플릿 A: 배제형]** ⭐ 가장 강력
"이 단계에서는 ○○이 아니라 △△가 우선입니다"

**[템플릿 B: 시점 고정형]**
"증상이 갑자기/반복되기/2주 이상 지속된다면, 지켜볼 단계는 이미 지났습니다"

**[템플릿 C: 불확실성 제거형]**
"증상만으로는 정확한 원인을 구분하기 어렵습니다"

**[템플릿 D: 인지부하 감소형]**
"지금 상태를 한 번 확인해 두는 것이 이후 선택을 훨씬 가볍게 만듭니다"

**[템플릿 E: 핵심 공식형]**
"이 단계에서는 (보통 하는 행동)은 충분하지 않고, (검사/확인)이 필요한 시점입니다"

**[템플릿 F: 판단 대신형]**
"이런 상황이라면, 더 기다릴 이유가 없습니다"

**[템플릿 G: 비교형]**
"○○으로 버티는 것과 △△로 확인하는 것은 결과가 다릅니다"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🚫 PART 4: 절대 금지 사항 (의료광고법)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**[직접 내원/예약 권유]**
❌ "방문하세요", "예약하세요", "상담하세요", "문의하세요"
❌ "저희 병원으로 오세요", "지금 바로 전화하세요"

**[공포 유발 표현]**
❌ "지금 안 하면 악화됩니다", "늦으면 후회합니다"
❌ "실명할 수 있습니다", "걷지 못할 수 있습니다" (과장)
❌ 출처 없는 의학 정보 (골든타임, 비가역성 임의 작성)

**[단정적/보장성 표현]**
❌ "100% 회복됩니다", "반드시 완치됩니다"
❌ "확실한 효과", "최고의 결과"

**[상업적 표현]**
❌ 병원명, 전화번호, 주소
❌ "오늘만 할인", "선착순", "이벤트"
❌ 타 병원과의 비교

**[약한 정보형 - 전환력 없음]**
❌ "고려해 보세요" (애매함)
❌ "상담을 받아보세요" (직접 권유)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
✅ PART 5: 의료법 준수 필수 조건
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

**모든 의학적 표현 사용 전:**
- Google 검색으로 해당 질환 정보 확인 필수
- 출처: 보건복지부, 질병관리청, 대한OO학회, 국민건강보험공단 등
- 검증되지 않은 의학 정보, 과장된 표현 절대 금지
- 팩트체크 85점 이상 목표
`;

export const recommendImagePrompt = async (blogContent: string, currentImageAlt: string, imageStyle: ImageStyle = 'illustration'): Promise<string> => {
  const ai = getAiClient();
  
  // 스타일에 따른 프롬프트 가이드 (구체적으로 개선!)
  const styleGuide = imageStyle === 'illustration' 
    ? `**중요: 3D 렌더 일러스트 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "3D rendered illustration", "Blender style", "soft 3D render"
       - 조명: 부드러운 스튜디오 조명, 은은한 그림자
       - 질감: 매끄러운 플라스틱 느낌, 무광 마감, 둥근 모서리
       - 색상: 밝은 파스텔 톤, 파란색/흰색/연한 색상 팔레트
       - 캐릭터: 친근한 표정, 단순화된 디자인
       - 배경: 깔끔한 그라데이션 배경
       ⛔ 금지: photorealistic, real photo, DSLR, realistic texture`
    : imageStyle === 'medical'
    ? `**중요: 의학 3D 일러스트 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "medical 3D illustration", "anatomical render", "scientific visualization"
       - 피사체: 인체 해부학, 장기 단면도, 뼈/근육/혈관 구조
       - 조명: 임상적 조명, X-ray 스타일 글로우, 반투명 장기
       - 질감: semi-transparent organs, detailed anatomical structures
       - 색상: 의료용 팔레트 (파란색, 흰색, 빨간색 혈관)
       - 분위기: clinical, professional, educational
       ⛔ 금지: cute cartoon, photorealistic human face`
    : `**중요: 실사 사진 스타일로 생성해야 합니다!**
       - 렌더링 스타일: "photorealistic", "real photography", "DSLR shot", "35mm lens"
       - 피사체: 실제 병원 환경, 실제 의료진, 실제 진료 도구
       - 조명: 자연스러운 소프트 조명, 스튜디오 조명, 전문 사진 조명
       - 질감: realistic skin texture, fabric texture, realistic materials
       - 깊이: shallow depth of field, bokeh background
       - 분위기: professional, trustworthy, clean modern hospital
       ⛔ 금지: 3D render, illustration, cartoon, anime, vector, clay`;
  
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: `다음은 병원 블로그 글 내용입니다:

${blogContent.substring(0, 3000)}

현재 이미지 설명: "${currentImageAlt}"

${styleGuide}

이 글의 맥락과 주제에 맞는 이미지 프롬프트를 **딱 1개만** 추천해주세요.

요구사항:
1. 글의 핵심 주제와 연관성 높은 장면
2. 한국 병원 환경에 적합
3. 전문적이고 신뢰감 있는 분위기
4. 구체적인 요소 (인물, 배경, 분위기 등) 포함
5. **텍스트 규칙**: 진짜 필요할 때만 한글/숫자 사용, 영어는 가급적 자제
6. 로고는 절대 포함하지 말 것
7. **위에서 지정한 스타일 키워드를 반드시 프롬프트에 포함할 것!**

**중요: 프롬프트 1개만 출력하세요! 여러 개 출력 금지!**
설명 없이 프롬프트 문장만 **한국어**로 답변하세요.

예시 (1개만):
${imageStyle === 'illustration' 
  ? '"밝은 병원 진료실에서 의사가 환자에게 설명하는 모습, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트"'
  : imageStyle === 'medical'
  ? '"인체 심장의 3D 단면도, 좌심실과 우심실이 보이는 해부학적 구조, 혈관과 판막이 표시된 의학 일러스트, 파란색 배경, 교육용 전문 이미지"'
  : '"깔끔한 병원 진료실에서 의사가 환자와 상담하는 모습, 실사 사진, DSLR 촬영, 자연스러운 조명, 전문적인 분위기"'}:`,
      config: {
        responseMimeType: "text/plain"
      }
    });
    
    return response.text?.trim() || currentImageAlt;
  } catch (error) {
    console.error('프롬프트 추천 실패:', error);
    return currentImageAlt;
  }
};

// 🧹 공통 프롬프트 정리 함수 - base64/코드 문자열만 제거, 의미있는 텍스트는 유지!
const cleanImagePromptText = (prompt: string): string => {
  let cleaned = prompt
    // 1. base64 데이터 URI 제거
    .replace(/data:[^;]+;base64,[A-Za-z0-9+/=]+/g, '')
    // 2. URL 제거
    .replace(/https?:\/\/[^\s]+/g, '')
    // 3. base64 스타일 긴 문자열 제거 (12자 이상, 대소문자+숫자+/+=가 섞인 패턴)
    .replace(/[A-Za-z0-9+/=]{12,}/g, '')
    // 4. 경로 패턴 제거 (영숫자/영숫자/... 형태)
    .replace(/[a-zA-Z0-9]{2,}\/[a-zA-Z0-9/]+/g, '')
    // 5. 연속 특수문자 정리
    .replace(/[,.\s]{3,}/g, ', ')
    .replace(/\s+/g, ' ')
    .trim();
  
  // 너무 짧으면 기본값으로 대체 (완전히 비어있는 경우만)
  if (cleaned.length < 5) {
    console.warn('⚠️ 필터링 후 프롬프트가 너무 짧음, 기본값으로 대체:', cleaned);
    cleaned = '의료 건강 정보 카드뉴스, 깔끔한 인포그래픽, 파란색 흰색 배경';
  }
  return cleaned;
};

export const generateSingleImage = async (
  promptText: string,
  style: ImageStyle,
  aspectRatio: string,
  customStylePrompt?: string,
  referenceImage?: string,
  copyMode?: boolean
): Promise<string> => {
  const ai = getAiClient();

  // 1) 입력 정리: 충돌 문구 제거
  const cleanPromptText = normalizePromptTextForImage(promptText);

  // 2) 프레임/스타일 블록 분리 (프레임은 레이아웃, 스타일은 렌더링)
  const frameBlock = buildFrameBlock(referenceImage, copyMode);
  const styleBlock = buildStyleBlock(style, customStylePrompt);

  // 3) 최종 프롬프트 조립: 완성형 카드 이미지 (텍스트가 이미지 픽셀로 렌더링!)
  const finalPrompt = `
Generate a complete social media card image with Korean text rendered directly into the image pixels.

🚨 CRITICAL: The Korean text MUST be rendered as part of the image itself, not as separate HTML/overlay!

${frameBlock}
${styleBlock}

[CARD CONTENT TO RENDER]
${cleanPromptText}

[DESIGN SPECIFICATIONS]
- Aspect ratio: 1:1 square
- Background: Soft gradient (#E8F4FD to #F0F9FF) or as specified in content
- Typography: Clean, readable Korean fonts (Noto Sans KR style)
- Text must be BURNED INTO the image pixels

[MANDATORY REQUIREMENTS]
✅ Render ALL Korean text directly into the image
✅ Text should be clearly readable with good contrast
✅ Professional card news design like Instagram infographic
✅ Full-bleed design - illustration/background fills entire canvas
✅ Text overlaid on top with subtle shadow or semi-transparent backing for readability

⛔ FORBIDDEN:
- Do NOT generate image without text
- Do NOT use placeholders like [TEXT] or [TITLE]
- No hashtags, watermarks, or logos
- No separate text layer - text must be part of the image

[OUTPUT]
A single complete card image with Korean text visually rendered inside.
`.trim();

  // 🔍 디버그
  console.log('🧩 generateSingleImage prompt blocks:', {
    style,
    hasCustomStyle: !!(customStylePrompt && customStylePrompt.trim()),
    hasReferenceImage: !!referenceImage,
    copyMode: !!copyMode,
    finalPromptHead: finalPrompt.slice(0, 200),
  });

  // 🔄 재시도 로직: 최대 2회 시도 (빠른 실패 유도)
  const MAX_RETRIES = 2;
  let lastError: any = null;

  // 참고 이미지 파트 준비
  const refImagePart = referenceImage && referenceImage.startsWith('data:') 
    ? (() => {
        const [meta, base64] = referenceImage.split(',');
        const mimeType = (meta.match(/data:(.*?);base64/) || [])[1] || 'image/png';
        return { inlineData: { data: base64, mimeType } };
      })()
    : null;

  for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
    try {
      console.log(`🎨 이미지 생성 시도 ${attempt}/${MAX_RETRIES} (gemini-3-pro-image)...`);
      
      // Gemini 3 Pro Image - 이미지 생성 전용 모델
      const contents: any[] = refImagePart 
        ? [refImagePart, { text: finalPrompt }]
        : [{ text: finalPrompt }];

      const result = await ai.models.generateContent({
        model: "gemini-3-pro-image",
        contents: contents,
        config: {
          responseModalities: ["IMAGE", "TEXT"],
          temperature: 0.7 + (attempt * 0.1), // 재시도마다 온도 약간 증가
        },
      });

      // 안전 필터 등으로 인한 차단 확인
      const finishReason = result?.candidates?.[0]?.finishReason;
      if (finishReason && finishReason !== 'STOP' && finishReason !== 'MAX_TOKENS') {
        console.warn(`⚠️ 이미지 생성 중단됨 (이유: ${finishReason})`);
        if (finishReason === 'SAFETY' || finishReason === 'RECITATION') {
           throw new Error(`이미지 생성이 안전 정책에 의해 차단되었습니다. (${finishReason})`);
        }
      }

      // 응답에서 이미지 데이터 추출
      const parts = result?.candidates?.[0]?.content?.parts || [];
      const imagePart = parts.find((p: any) => p.inlineData?.data);
      
      if (imagePart) {
        const mimeType = imagePart.inlineData.mimeType || 'image/png';
        const data = imagePart.inlineData.data;
        console.log(`✅ 이미지 생성 성공 (시도 ${attempt}/${MAX_RETRIES})`);
        return `data:${mimeType};base64,${data}`;
      }
      
      // 텍스트 응답만 온 경우 (거절 메시지 등)
      const textPart = parts.find((p: any) => p.text)?.text;
      if (textPart) {
        console.warn(`⚠️ 이미지 대신 텍스트 응답 수신: "${textPart.substring(0, 100)}..."`);
      }

      // inlineData가 없으면 재시도
      console.warn(`⚠️ 이미지 데이터 없음, 재시도 중... (${attempt}/${MAX_RETRIES})`);
      lastError = new Error('이미지 데이터를 받지 못했습니다.');
      
      // 재시도 전 짧은 대기
      if (attempt < MAX_RETRIES) {
        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
      }
      
    } catch (error: any) {
      lastError = error;
      console.error(`❌ 이미지 생성 에러 (시도 ${attempt}/${MAX_RETRIES}):`, error?.message || error);
      
      // 재시도 전 짧은 대기 (지수 백오프)
      if (attempt < MAX_RETRIES) {
        const waitTime = 1000 * Math.pow(2, attempt - 1); // 1초, 2초, 4초
        console.log(`⏳ ${waitTime/1000}초 후 재시도...`);
        await new Promise(resolve => setTimeout(resolve, waitTime));
      }
    }
  }

  // 모든 재시도 실패 시 - 플레이스홀더 이미지 반환 (에러 방지)
  console.error('❌ 이미지 생성 최종 실패 (재시도 후):', lastError?.message || lastError);
  console.error('📝 사용된 프롬프트 (앞 250자):', finalPrompt.slice(0, 250));
  
  // 플레이스홀더 SVG 이미지 (빈 문자열 대신 반환하여 UI 오류 방지)
  const placeholderSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800" viewBox="0 0 800 800">
    <rect fill="#E8F4FD" width="800" height="800"/>
    <rect fill="#fff" x="40" y="40" width="720" height="720" rx="24"/>
    <text x="400" y="380" text-anchor="middle" font-family="Arial,sans-serif" font-size="24" fill="#64748b">이미지 생성에 실패했습니다</text>
    <text x="400" y="420" text-anchor="middle" font-family="Arial,sans-serif" font-size="16" fill="#94a3b8">카드를 클릭하여 재생성해주세요</text>
  </svg>`;
  const base64Placeholder = btoa(unescape(encodeURIComponent(placeholderSvg)));
  return `data:image/svg+xml;base64,${base64Placeholder}`;
};


export const getTrendingTopics = async (category: string): Promise<TrendingItem[]> => {
  const ai = getAiClient();
  const now = new Date();
  const koreaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const year = koreaTime.getFullYear();
  const month = koreaTime.getMonth() + 1;
  const day = koreaTime.getDate();
  const hour = koreaTime.getHours();
  const dateStr = `${year}년 ${month}월 ${day}일 ${hour}시`;
  
  // 1단계: 네이버 뉴스 API로 실시간 뉴스 수집
  let newsData: any = null;
  try {
    const newsResponse = await fetch(`/api/naver/news?query=${encodeURIComponent(category + ' 건강')}&display=30&sort=date`);
    if (newsResponse.ok) {
      newsData = await newsResponse.json();
    }
  } catch (e) {
    console.warn('네이버 뉴스 API 호출 실패, Gemini 분석으로 대체:', e);
  }
  
  // 2단계: 뉴스 데이터를 Gemini로 분석
  let newsContext = '';
  if (newsData?.items?.length > 0) {
    newsContext = `[네이버 뉴스 실시간 검색 결과 - ${dateStr} 기준]
${newsData.items.slice(0, 20).map((item: any, i: number) => 
  `${i+1}. ${item.title.replace(/<[^>]*>/g, '')} (${item.pubDate})`
).join('\n')}

위 실시간 뉴스를 기반으로 `;
  }
  
  const response = await ai.models.generateContent({
    model: 'gemini-3-pro-preview',
    contents: `[현재 시각: ${dateStr} (한국 표준시)]

${newsContext}'${category}' 진료과와 관련된 건강/의료 트렌드 5가지를 분석해주세요.

[점수 산정 기준]
1. SEO 적합도 점수(0~100): 뉴스 보도량 + 대중적 관심도가 높을수록, 블로그 경쟁도가 낮을수록 높은 점수
2. 점수 높은 순서대로 정렬

[제약조건]
1. 실제 '질병명', '증상', '치료법', '건강 뉴스' 내용만 추출
2. seasonal_factor에는 "왜 지금 이 주제가 뜨는지" 근거를 짧게 작성
3. ${month}월 계절적 특성 반영 (예: 1월=독감/동상, 7월=열사병/식중독 등)`,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            topic: { type: Type.STRING },
            keywords: { type: Type.STRING },
            score: { type: Type.NUMBER },
            seasonal_factor: { type: Type.STRING }
          },
          required: ["topic", "keywords", "score", "seasonal_factor"]
        }
      }
    }
  });
  return JSON.parse(response.text || "[]");
};

export const recommendSeoTitles = async (topic: string, keywords: string): Promise<SeoTitleItem[]> => {
  const ai = getAiClient();
  
  const prompt = `너는 대한민국 의료광고법을 숙지한 '네이버 공식 병원 블로그' 전문 에디터다.

[🎯 미션]
의료광고법을 100% 준수하면서 네이버 검색 클릭률이 높은 블로그 제목을 생성한다.

[📌 주제] ${topic}
[📌 SEO 키워드] ${keywords}

████████████████████████████████████████████████████████████████████████████████
[🚨 제목 생성 원칙 - 필수 준수!]
████████████████████████████████████████████████████████████████████████████████

1️⃣ 과장·보장·공포 조장 표현 금지
   ❌ 완치, 예방, 최고, 1등, 돌연사, 반드시, 특효, 100%, 확실히
   ❌ 골든타임, 48시간 내, 즉시 등 시간 압박 표현

2️⃣ 특정 병원명·의원명·브랜드명 절대 금지
   ❌ "XX병원", "OO의원", "△△클리닉" 등 고유명사 금지
   ❌ 제목에 병원/의원/클리닉 이름을 넣지 마세요!
   ✅ 일반적인 의료 정보 제목만 작성

3️⃣ 직접 행동 유도 금지
   ❌ 방문하세요, 예약하세요, 상담하세요, 확인하세요, 검사받으세요
   ❌ ~하세요 명령형 전부 금지!

4️⃣ 제목 형식: '질문형' 또는 '판단 유도형'으로 작성
   ✅ "~일까요?"
   ✅ "~이유"
   ✅ "~시점"
   ✅ "~구분법"
   ✅ "~체크 포인트" (단, "체크하세요" 금지)

5️⃣ 질환명은 단정하지 말고 가능성 구조 사용
   ✅ "~증상일 수 있는"
   ✅ "~의심될 수 있는"
   ✅ "~구분이 필요한"
   ❌ "당신은 ~입니다" (단정 금지)

6️⃣ 계절·상황·행동 맥락을 포함해 검색 의도 정확히 겨냥
   ✅ 겨울철, 아침, 반복되는, 씻고 나서, 밤마다, 식후에 등

7️⃣ 메인 키워드는 제목 앞부분에 배치 (네이버 SEO 기준)
   ✅ "피부건조 원인, 겨울철에 심해지는 이유"
   ❌ "겨울철에 심해지는 피부건조 원인"

8️⃣ 제목 길이: 28~38자 이내 (모바일 최적화)

9️⃣ 감정 어휘는 사용하되 자극적으로 쓰지 않는다
   ✅ 답답한, 찝찝한, 불편한, 반복되는 (허용)
   ❌ 무섭다, 위험하다, 심각하다 (금지)

████████████████████████████████████████████████████████████████████████████████
[🎨 출력 요구사항]
████████████████████████████████████████████████████████████████████████████████

- 제목 5개 제안
- 각 제목은 서로 다른 심리 트리거 사용:
  1. 호기심형 (궁금증 유발)
  2. 공감형 (독자 상황 공감)
  3. 판단유도형 (스스로 판단하게)
  4. 시기고정형 (특정 시점/상황)
  5. 구분구조형 (A vs B, 차이점)

- SEO 점수: 70~95점 사이로 현실적으로 평가
- type: 위 5가지 트리거 중 하나 (호기심/공감/판단유도/시기고정/구분구조)`;
  
  const response = await ai.models.generateContent({
    model: 'gemini-3-pro-preview',
    contents: prompt,
    config: {
      responseMimeType: "application/json",
      responseSchema: {
        type: Type.ARRAY,
        items: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            score: { type: Type.NUMBER },
            type: { type: Type.STRING, enum: ['호기심', '공감', '판단유도', '시기고정', '구분구조'] }
          },
          required: ["title", "score", "type"]
        }
      }
    }
  });
  return JSON.parse(response.text || "[]");
};

// 카드뉴스 스타일 참고 이미지 분석 함수 (표지/본문 구분)
export const analyzeStyleReferenceImage = async (base64Image: string, isCover: boolean = false): Promise<string> => {
  const ai = getAiClient();
  
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: [
        {
          role: 'user',
          parts: [
            {
              inlineData: {
                mimeType: base64Image.includes('png') ? 'image/png' : 'image/jpeg',
                data: base64Image.split(',')[1] // base64 데이터만 추출
              }
            },
            {
              text: `이 카드뉴스/인포그래픽 이미지의 **디자인 스타일과 일러스트 그림체**를 매우 상세히 분석해주세요.

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 최우선 목표: "같은 시리즈"로 보이게 할 일관된 스타일만 추출! 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

⚠️ [중요] 이 분석은 "스타일/프레임"만 추출합니다. 이미지 속 "내용물"은 분석하지 마세요!
- ❌ 이미지 속 일러스트가 "무엇인지" (돼지, 사람, 돈 등) → 분석 불필요!
- ❌ 이미지 속 텍스트가 "무슨 내용인지" → 분석 불필요!
- ✅ 일러스트의 "그리는 방식/기법" (3D, 플랫, 수채화 등) → 분석 필요!
- ✅ 색상 팔레트, 프레임 형태, 레이아웃 구조 → 분석 필요!

**이 이미지는 ${isCover ? '표지(1장)' : '본문(2장 이후)'} 스타일 참고용입니다.**

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🎨 [1단계] 일러스트/그림체 DNA 분석 (가장 중요!)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. **그림체 종류** (정확히 하나만 선택):
   - 3D 클레이/점토 렌더링 (Blender/Cinema4D 느낌)
   - 3D 아이소메트릭 일러스트
   - 플랫 벡터 일러스트 (미니멀)
   - 수채화/손그림 스타일
   - 캐릭터 일러스트 (귀여운/키치)
   - 실사 사진 / 포토리얼
   - 선화+채색 일러스트
   - 그라데이션 글래스모피즘

2. **렌더링 특징**:
   - 조명: 부드러운 스튜디오 조명 / 강한 그림자 / 플랫 조명
   - 질감: 광택 있는 / 무광 매트 / 반투명
   - 외곽선: 없음 / 가는 선 / 굵은 선
   - 깊이감: 얕은 피사계심도 / 등각투영 / 완전 플랫

3. **색상 팔레트** (정확한 HEX 코드 5개):
   - 주 배경색: #______
   - 주 강조색: #______
   - 보조색 1: #______
   - 보조색 2: #______
   - 텍스트색: #______

4. **캐릭터/오브젝트 스타일** (있다면):
   - 얼굴 표현: 심플한 점 눈 / 큰 눈 / 없음
   - 비율: 2등신 귀여움 / 리얼 비율 / 아이콘형
   - 표정: 미소 / 무표정 / 다양함

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📐 [2단계] 레이아웃/프레임 분석
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
5. **프레임 스타일**: 
   - 브라우저 창 모양? (빨강/노랑/초록 버튼)
   - 둥근 테두리 카드?
   - 테두리 색상(HEX)과 굵기(px)

6. **텍스트 스타일**:
   - 부제목: 색상, 굵기
   - 메인 제목: 색상, 굵기, 강조 방식
   - 설명: 색상

7. **일러스트 배치**: top / center / bottom, 크기 비율(%)

**반드시 JSON 형식으로 답변 (illustStyle 필드 필수!):**
{
  "illustStyle": {
    "type": "3D 클레이 렌더링 / 플랫 벡터 / 아이소메트릭 / 수채화 / 실사",
    "lighting": "부드러운 스튜디오 조명 / 플랫 / 강한 그림자",
    "texture": "광택 매끄러움 / 무광 매트 / 반투명",
    "outline": "없음 / 가는 선 / 굵은 선",
    "characterStyle": "2등신 귀여움 / 리얼 비율 / 심플 아이콘",
    "colorPalette": ["#주배경", "#강조색", "#보조1", "#보조2", "#텍스트"],
    "promptKeywords": "이 스타일을 재현하기 위한 영어 키워드 5-8개 (예: 3D clay render, soft shadows, pastel colors, rounded shapes, studio lighting)"
  },
  "frameStyle": "browser-window / rounded-card / rectangle",
  "hasWindowButtons": true,
  "windowButtonColors": ["#FF5F57", "#FFBD2E", "#28CA41"],
  "backgroundColor": "#E8F4FD",
  "borderColor": "#3B82F6",
  "borderWidth": "2px",
  "borderRadius": "16px",
  "boxShadow": "0 4px 12px rgba(0,0,0,0.1)",
  "subtitleStyle": { "color": "#6B7280", "fontSize": "14px", "fontWeight": "500" },
  "mainTitleStyle": { "color": "#1F2937", "fontSize": "28px", "fontWeight": "700" },
  "highlightStyle": { "color": "#3B82F6", "backgroundColor": "transparent" },
  "descStyle": { "color": "#4B5563", "fontSize": "16px" },
  "tagStyle": { "backgroundColor": "#EBF5FF", "color": "#3B82F6", "borderRadius": "20px" },
  "illustPosition": "bottom",
  "illustSize": "60%",
  "padding": "24px",
  "mood": "밝고 친근한 / 전문적인 / 따뜻한 등",
  "keyFeatures": ["3D 클레이 렌더링", "파스텔 색상", "둥근 형태", "부드러운 그림자"],
  "styleReproductionPrompt": "이 이미지 스타일을 정확히 재현하기 위한 완전한 영어 프롬프트 1-2문장"
}`
            }
          ]
        }
      ],
      config: {
        responseMimeType: "application/json"
      }
    });
    
    return response.text || '{}';
  } catch (error) {
    console.error('스타일 분석 실패:', error);
    return '{}';
  }
};

// ============================================
// 🤖 미니 에이전트 방식 카드뉴스 생성 시스템
// ============================================

// 슬라이드 스토리 타입 정의
interface SlideStory {
  slideNumber: number;
  slideType: 'cover' | 'concept' | 'content' | 'closing';
  subtitle: string;      // 4-8자 (짧고 임팩트있게!)
  mainTitle: string;     // 10-18자 (강조 부분 <highlight>로 표시)
  description: string;   // 15-25자 (판단 1줄! 설명 아님!)
  tags: string[];        // 해시태그 2-3개
  imageKeyword: string;  // 이미지 핵심 키워드
}

interface CardNewsStory {
  topic: string;
  totalSlides: number;
  slides: SlideStory[];
  overallTheme: string;
}

// [1단계] 스토리 기획 에이전트
const storyPlannerAgent = async (
  topic: string, 
  category: string, 
  slideCount: number,
  writingStyle: WritingStyle
): Promise<CardNewsStory> => {
  const ai = getAiClient();
  const currentYear = getCurrentYear();
  
  const prompt = `당신은 **전환형 카드뉴스** 스토리 기획 전문가입니다.

[🎯 미션] "${topic}" 주제로 ${slideCount}장짜리 **전환형** 카드뉴스를 기획하세요.

${CONTENT_DESCRIPTION}

[📅 현재: ${currentYear}년 - 보수적 해석 원칙]
- ${currentYear}년 기준 보건복지부·의료광고 심의 지침을 반영
- **불확실한 경우 반드시 보수적으로 해석**
- 출처 없는 수치/시간/확률 표현 금지

[진료과] ${category}
[글 스타일] ${writingStyle === 'expert' ? '전문가형(신뢰·권위)' : writingStyle === 'empathy' ? '공감형(독자 공감)' : '전환형(정보→확인 유도)'}

🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨
[📱 카드뉴스 핵심 원칙 - 블로그와 완전히 다름!]
🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨🚨

❌ 블로그 = "읽고 이해"
✅ 카드뉴스 = "보고 판단" (3초 안에!)

[🔑 카드뉴스 황금 공식]
❌ 설명 70% → ✅ 판단 70%
❌ "왜냐하면..." → ✅ "이때는..."
❌ 문장 2~3줄 설명 → ✅ 판단 1줄로 끝

[🧠 심리 구조: 질문 → 끊기 → 판단 → 다음카드]
- 각 카드는 "멈춤 → 판단 → 넘김"을 유도해야 함
- 설명하면 스크롤 멈춤력이 떨어짐!

[🚨🚨🚨 카드별 심리적 역할 - ${slideCount}장 기준 🚨🚨🚨]

**1장 - 표지 (멈추게 하는 역할만!)**
- subtitle: 4~8자 (예: "겨울철에 유독?", "혹시 나도?")
- mainTitle: 10~15자, 질문형 (예: "겨울철 혈관 신호일까요?")
- description: "" ← 🚨 표지는 description 완전히 비워두세요! 빈 문자열 ""로!
- 💡 표지는 제목+부제만! 설명 없음!

**2장 - 오해 깨기 (판단 유도)**
- subtitle: 4~8자 (예: "단순한 추위 때문?")
- mainTitle: 질문형으로 착각 깨기 (예: "생활 관리만으로 충분할까요?")
- description: ❌ 긴 설명 금지! 판단 1줄만 (예: "따뜻하게 입어도 해결되지 않는 신호가 있습니다")

${slideCount >= 5 ? `**3장 - 증상 명확화 (핵심만)**
- subtitle: 4~8자 (예: "놓치기 쉬운 신호들")
- mainTitle: 증상 나열 (예: "반복되는 두통\\n숨이 차는 느낌이 계속된다면")
- description: 한 줄 판단 (예: "피로나 스트레스와 구분이 필요할 수 있습니다")` : ''}

${slideCount >= 6 ? `**4장 - 자가 판단의 한계**
- subtitle: 4~8자 (예: "자가 판단의 한계")  
- mainTitle: 핵심 메시지만 (예: "증상만으로는 원인을 구분하기 어렵습니다")
- description: ❌ 설명 삭제 또는 최소화` : ''}

${slideCount >= 7 ? `**5~${slideCount-2}장 - 시점 고정 (🔥 핵심! 🔥)**
- 추가 정보보다 "시점 고정"에 집중
- 생활습관 카드는 최대 1장만!` : ''}

**${slideCount-1}장 - 시점 고정**
- subtitle: 4~8자 (예: "확인이 필요한 순간")
- mainTitle: (예: "사라졌다 다시 나타난다면\\n확인이 필요한 시점입니다")
- description: 최소화

**${slideCount}장 - 마지막 표지/CTA (명령형 금지! + 전환력 강화!)**
- subtitle: 4~8자 (예: "미루지 않는 습관", "지금이 그때")
- mainTitle: "왜 지금이어야 하는지" 이유를 담아라!
  ✅ "지켜보기보다 관리 방향을 정할 시점"
  ✅ "이 단계에서는 넘기기보다 살펴볼 때입니다"
  ✅ "반복된다면 기준이 필요합니다"
  ❌ "~하세요" 명령형 금지!
  ❌ "가장 빠른 첫걸음" (너무 착함, 전환력 약함)
- description: "" ← 🚨 마지막 장도 description 완전히 비워두세요! 빈 문자열 ""로!
- 💡 마지막 장은 표지처럼 제목+부제만! 설명 없음!
- ❌ "혈액 검사로 확인하세요" 같은 명령형 금지!
- ❌ "의료기관을 찾아..." 문장 금지!
- 🔥 핵심: "왜 지금?" + "미루면 어떻게?" 두 메시지 중 하나 포함!

[📝 텍스트 분량 규칙 - 카드뉴스용!]
- subtitle: 4~8자 (질문/상황 표현)
  ✅ "겨울철에 유독?", "혹시 나도?", "놓치기 쉬운 신호들"
  ❌ "왜 중요할까요?" (너무 일반적)
  
- mainTitle: 10~18자, 줄바꿈 포함, <highlight>로 강조
  ✅ "가슴 답답함·두통\\n<highlight>혈관 신호</highlight>일까요?"
  ❌ "혈관 건강 체크 신호일까요?" (체크=행동유도 느낌)
  
- description: 15~25자의 판단 1줄! (설명 아님!)
  ✅ "따뜻하게 입어도 해결되지 않는 신호가 있습니다"
  ✅ "피로나 컨디션 변화 등 다른 원인에서도 나타날 수 있습니다"
  ✅ "식습관과 생활 습관에 따라 개인차가 큽니다"
  ❌ "기온 변화에 따른 혈관 수축은 자가 관리 영역을 넘어 전문적인 확인이 필요한 경우가..." (너무 긺)
  ❌ "매년 건강보험 혜택을 통해 비용 부담을 줄인 확인이 가능합니다..." (너무 긺)

[🔄 단어 반복 금지 - 리듬 유지!]
⚠️ 같은 단어가 2회 이상 나오면 카드뉴스 리듬이 죽습니다!
- "확인" 대신 → 점검, 살피다, 상태 보기, 파악
- "관리" 대신 → 케어, 돌봄, 유지, 습관
- "필요" 대신 → 중요, 의미있는, 시점
- "시점" 대신 → 순간, 타이밍, 때, 단계
👉 의미는 유지하고 단어는 분산!

[🚨🚨🚨 의료법 준수 - 최우선! 🚨🚨🚨]

**절대 금지 표현:**
❌ "즉시 상담", "바로 상담", "지금 상담"
❌ "전문의 상담", "전문의와 상담하세요"
❌ "병원 방문", "내원하세요", "예약하세요"
❌ "검진 받으세요", "진료 받으세요", "검사 받으세요"
❌ "~하세요" 명령형 전부!
❌ "완치", "최고", "보장", "확실히", "체크"
❌ "골든타임", "48시간 내" 등 구체적 시간 표현

**안전한 대체 표현:**
✅ "확인이 필요한 시점입니다"
✅ "지켜보기보다 확인이 먼저입니다"
✅ "전문적인 판단이 필요할 수 있습니다"
✅ "개인차가 있을 수 있습니다"
❌ "~를 고려해볼 수 있어요" (너무 약함)

[⚠️ 생활습관 카드 제한]
- 생활습관(운동, 식단, 금연 등) 카드는 **최대 1장**만
- 생활습관이 핵심 메시지(확인 시점)를 대체하면 안 됨!

[❌ 금지]
- "01.", "첫 번째" 등 번호 표현
- "해결책 1", "마무리" 등 프레임워크 용어
- 출처 없는 구체적 수치/시간/확률 표현

[✅ 슬라이드 연결]
- 이전 슬라이드와 자연스럽게 이어지도록
- **심리 흐름**: 주의환기 → 오해깨기 → 증상명확화 → 자가판단한계 → 시점고정 → CTA

[🎯 최종 체크리스트]
1. 🚨 1장(표지)의 description이 비어있는가? → 반드시 "" 빈 문자열로!
2. 🚨 마지막 장의 description이 비어있는가? → 반드시 "" 빈 문자열로!
3. 각 카드 description이 2줄 이상인가? → 1줄(15~25자)로 줄여라!
4. "~하세요" 명령형이 있는가? → "~시점입니다", "~단계입니다"로 바꿔라!
5. 설명이 판단보다 많은가? → '이유 설명' 삭제, 판단만 남겨라!
6. "확인/점검" 같은 단어가 2번 이상 반복되는가? → 분산시켜라! (살피다, 상태보기, 파악 등)
7. CTA가 너무 착한가? → "왜 지금이어야 하는지" 이유 추가!
8. CTA에 시술명(스킨부스터 등)이 있는가? → "관리 방향", "관리 기준"으로 대체!
9. "맞춤형", "개인맞춤" 표현이 있는가? → "상태에 맞는"으로 대체!

[💡 CTA 카드 모범 답안 - 전환력 강화 버전!]
✅ mainTitle 예시 (왜 지금인지 이유 포함!):
  - "지켜보기보다\\n관리 방향을 정할 시점"
  - "반복된다면\\n기준이 필요합니다"
  - "이 단계에서는\\n넘기기보다 살펴볼 때입니다"
  - "지금의 불편함을 넘기면\\n더 긴 관리가 필요해질 수 있습니다"
✅ description: "" (빈 문자열 - 표지처럼!)
→ 명령 ❌ / 판단 ⭕
→ "왜 지금?" 이유 필수!

[📋 출력 필드]
- topic: 주제 (한국어)
- totalSlides: 총 슬라이드 수
- overallTheme: 전체 구조 설명 (한국어 20자 이내)
  예: "오해 깨기 → 증상 체크 → 확인 시점 안내"
- slides: 슬라이드 배열`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        tools: [{ googleSearch: {} }],
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            topic: { type: Type.STRING },
            totalSlides: { type: Type.INTEGER },
            overallTheme: { type: Type.STRING },
            slides: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  slideNumber: { type: Type.INTEGER },
                  slideType: { type: Type.STRING },
                  subtitle: { type: Type.STRING },
                  mainTitle: { type: Type.STRING },
                  description: { type: Type.STRING },
                  tags: { type: Type.ARRAY, items: { type: Type.STRING } },
                  imageKeyword: { type: Type.STRING }
                },
                required: ["slideNumber", "slideType", "subtitle", "mainTitle", "description", "tags", "imageKeyword"]
              }
            }
          },
          required: ["topic", "totalSlides", "slides", "overallTheme"]
        }
      }
    });
    
    const result = JSON.parse(response.text || "{}");
    
    // 🚨 후처리: 1장(표지)과 마지막 장의 description 강제로 빈 문자열로!
    if (result.slides && result.slides.length > 0) {
      // 1장 (표지) description 제거
      result.slides[0].description = "";
      
      // 마지막 장 description 제거
      if (result.slides.length > 1) {
        result.slides[result.slides.length - 1].description = "";
      }
      
      console.log('🚨 표지/마지막 장 description 강제 제거 완료');
    }
    
    return result;
  } catch (error) {
    console.error('스토리 기획 에이전트 실패:', error);
    throw error;
  }
};

// 분석된 스타일 전체 인터페이스
interface AnalyzedStyle {
  frameStyle?: string;
  hasWindowButtons?: boolean;
  windowButtonColors?: string[];
  backgroundColor?: string;
  borderColor?: string;
  borderWidth?: string;
  borderRadius?: string;
  boxShadow?: string;
  subtitleStyle?: { color?: string; fontSize?: string; fontWeight?: string; };
  mainTitleStyle?: { color?: string; fontSize?: string; fontWeight?: string; };
  highlightStyle?: { color?: string; backgroundColor?: string; };
  descStyle?: { color?: string; fontSize?: string; };
  tagStyle?: { backgroundColor?: string; color?: string; borderRadius?: string; };
  illustPosition?: string;
  illustSize?: string;
  padding?: string;
  mood?: string;
  keyFeatures?: string[];
}

// [2단계] HTML 조립 함수 (분석된 스타일 전체 적용)
const assembleCardNewsHtml = (
  story: CardNewsStory,
  styleConfig?: AnalyzedStyle
): string => {
  const bgColor = styleConfig?.backgroundColor || '#E8F4FD';
  const bgGradient = `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
  const accentColor = styleConfig?.borderColor || '#3B82F6';
  
  // 분석된 스타일 적용 (기본값 포함)
  const borderRadius = styleConfig?.borderRadius || '24px';
  const boxShadow = styleConfig?.boxShadow || '0 4px 16px rgba(0,0,0,0.08)';
  const borderWidth = styleConfig?.borderWidth || '0';
  const padding = styleConfig?.padding || '32px 28px';
  
  const subtitle = {
    color: styleConfig?.subtitleStyle?.color || accentColor,
    fontSize: styleConfig?.subtitleStyle?.fontSize || '14px',
    fontWeight: styleConfig?.subtitleStyle?.fontWeight || '700'
  };
  
  const mainTitle = {
    color: styleConfig?.mainTitleStyle?.color || '#1E293B',
    fontSize: styleConfig?.mainTitleStyle?.fontSize || '26px',
    fontWeight: styleConfig?.mainTitleStyle?.fontWeight || '900'
  };
  
  const highlight = {
    color: styleConfig?.highlightStyle?.color || accentColor,
    backgroundColor: styleConfig?.highlightStyle?.backgroundColor || 'transparent'
  };
  
  const desc = {
    color: styleConfig?.descStyle?.color || '#475569',
    fontSize: styleConfig?.descStyle?.fontSize || '15px'
  };
  
  const tag = {
    backgroundColor: styleConfig?.tagStyle?.backgroundColor || `${accentColor}15`,
    color: styleConfig?.tagStyle?.color || accentColor,
    borderRadius: styleConfig?.tagStyle?.borderRadius || '20px'
  };
  
  // 브라우저 윈도우 버튼 HTML (분석된 스타일에 있으면 적용)
  const windowButtonsHtml = styleConfig?.hasWindowButtons ? `
    <div class="window-buttons" style="display: flex; gap: 8px; padding: 12px 16px;">
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[0] || '#FF5F57'};"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[1] || '#FFBD2E'};"></span>
      <span style="width: 12px; height: 12px; border-radius: 50%; background: ${styleConfig?.windowButtonColors?.[2] || '#28CA41'};"></span>
    </div>` : '';
  
  const slides = story.slides.map((slide, idx) => {
    // mainTitle에서 <highlight> 태그를 실제 span으로 변환 (분석된 highlight 스타일 적용)
    const highlightBg = highlight.backgroundColor !== 'transparent' 
      ? `background: ${highlight.backgroundColor}; padding: 2px 6px; border-radius: 4px;` 
      : '';
    const formattedTitle = slide.mainTitle
      .replace(/<highlight>/g, `<span class="card-highlight" style="color: ${highlight.color}; ${highlightBg}">`)
      .replace(/<\/highlight>/g, '</span>')
      .replace(/\n/g, '<br/>');
    
    // 프레임 스타일에 따른 border 적용
    const borderStyle = borderWidth !== '0' ? `border: ${borderWidth} solid ${accentColor};` : '';
    
    return `
      <div class="card-slide" style="background: ${bgGradient}; border-radius: ${borderRadius}; ${borderStyle} box-shadow: ${boxShadow}; overflow: hidden; aspect-ratio: 1/1;">
        ${windowButtonsHtml}
        <div class="card-content-area" style="padding: ${padding}; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%; justify-content: center; gap: 12px;">
          <p class="card-subtitle" style="font-size: ${subtitle.fontSize}; font-weight: ${subtitle.fontWeight}; color: ${subtitle.color}; margin-bottom: 4px;">${slide.subtitle}</p>
          <p class="card-main-title" style="font-size: ${mainTitle.fontSize}; font-weight: ${mainTitle.fontWeight}; color: ${mainTitle.color}; line-height: 1.3; margin: 0; word-break: keep-all;">${formattedTitle}</p>
          <div class="card-img-container" style="width: 100%; display: flex; justify-content: center; padding: 16px 0;">[IMG_${idx + 1}]</div>
          <p class="card-desc" style="font-size: ${desc.fontSize}; color: ${desc.color}; line-height: 1.7; font-weight: 500; max-width: 90%;">${slide.description}</p>
        </div>
      </div>`;
  });
  
  return slides.join('\n');
};

// 카드별 프롬프트 데이터는 types.ts에서 import

// [3단계] 전체 이미지 카드용 프롬프트 생성 에이전트
const fullImageCardPromptAgent = async (
  slides: SlideStory[],
  imageStyle: ImageStyle,
  category: string,
  styleConfig?: AnalyzedStyle,
  customImagePrompt?: string  // 커스텀 이미지 프롬프트 추가!
): Promise<CardPromptData[]> => {
  const ai = getAiClient();
  
  // 커스텀 프롬프트가 있으면 최우선 적용! (기본 스타일 완전 대체!)
  const hasCustomStyle = customImagePrompt?.trim();
  const styleGuide = hasCustomStyle
    ? customImagePrompt!.trim()
    : STYLE_KEYWORDS[imageStyle] || STYLE_KEYWORDS.illustration;
  
  // 🎨 스타일 참고 이미지가 있으면 해당 색상 사용, 없으면 기본값
  const bgColor = styleConfig?.backgroundColor || '#E8F4FD';
  const accentColor = styleConfig?.borderColor || '#3B82F6';
  const hasWindowButtons = styleConfig?.hasWindowButtons || false;
  const mood = styleConfig?.mood || '밝고 친근한';
  const keyFeatures = styleConfig?.keyFeatures?.join(', ') || '';
  
  // 슬라이드 정보 (description이 비어있으면 생략!)
  const slideSummaries = slides.map((s, i) => {
    const isFirst = i === 0;
    const isLast = i === slides.length - 1;
    const label = isFirst ? ' (표지)' : isLast ? ' (마지막)' : '';
    const hasDescription = s.description && s.description.trim().length > 0;
    
    // description이 없거나 비어있으면 생략!
    if (!hasDescription) {
      return `${i + 1}장${label}: subtitle="${s.subtitle}" mainTitle="${s.mainTitle.replace(/<\/?highlight>/g, '')}" ⚠️description 없음 - 설명 텍스트 넣지 마세요! 이미지="${s.imageKeyword}"`;
    }
    return `${i + 1}장${label}: subtitle="${s.subtitle}" mainTitle="${s.mainTitle.replace(/<\/?highlight>/g, '')}" description="${s.description}" 이미지="${s.imageKeyword}"`;
  }).join('\n');

  // 🎨 스타일 참고 이미지가 있으면 핵심 요소만 전달
  const styleRefInfo = styleConfig ? `
[🎨 디자인 프레임 참고]
- 배경색: ${bgColor}
- 강조색: ${accentColor}
- 프레임: ${hasWindowButtons ? '브라우저 창 버튼(빨/노/초) 필수' : '둥근 카드'}
- 분위기: ${mood}
${keyFeatures ? `- 특징: ${keyFeatures}` : ''}
` : '';

  // 커스텀 스타일 강조 (있으면 최우선 적용! + 기본 3D 스타일 금지!)
  const customStyleInfo = hasCustomStyle ? `
████████████████████████████████████████████████████████████████████████████████
🎯🎯🎯 [최우선] 커스텀 스타일 필수 적용! 🎯🎯🎯
████████████████████████████████████████████████████████████████████████████████

스타일: "${customImagePrompt}"

⛔ 절대 금지: 3D 일러스트, 클레이 렌더, 아이소메트릭 등 기본 스타일 사용 금지!
✅ 필수: 위에 명시된 "${customImagePrompt}" 스타일만 사용하세요!
` : '';

  const prompt = `당신은 소셜미디어 카드뉴스 디자이너입니다. 이미지 1장 = 완성된 카드뉴스 1장!
${customStyleInfo}
${styleRefInfo}
[스타일] ${styleGuide}
[진료과] ${category}

[슬라이드별 텍스트]
${slideSummaries}

████████████████████████████████████████████████████████████████████████████████
🚨🚨🚨 [최우선] 레이아웃 규칙 - 반드시 지켜야 함! 🚨🚨🚨
████████████████████████████████████████████████████████████████████████████████

⛔⛔⛔ 절대 금지되는 레이아웃 ⛔⛔⛔
- 상단에 흰색/단색 텍스트 영역 + 하단에 일러스트 영역 = 2분할 = 금지!
- 텍스트 박스와 이미지 박스가 나뉘어 보이는 디자인 = 금지!
- 위아래로 2등분된 듯한 구성 = 금지!

✅✅✅ 반드시 이렇게 만드세요 ✅✅✅
- 일러스트/배경이 전체 화면(100%)을 채움!
- 그 위에 텍스트가 오버레이 (반투명 배경 또는 그림자 효과로 가독성 확보)
- 영화 포스터, 앨범 커버, 인스타그램 카드처럼 하나의 통합 디자인!

[imagePrompt 작성법]
- "전체 화면을 채우는 [일러스트 묘사], 그 위에 [텍스트] 오버레이" 형식
- 예: "전체 화면을 채우는 비오는 창가 일러스트, 그 위에 '무릎 쑤심' 텍스트 오버레이, 파스텔톤"

[카드 레이아웃]
- 1번(표지)/마지막(CTA): 제목+부제+일러스트만! 🚨description 절대 금지!
${hasWindowButtons ? '- 브라우저 창 버튼(빨/노/초) 포함' : ''}

[필수 규칙]
- 1:1 정사각형, 배경색 ${bgColor}
- ⚠️ imagePrompt는 반드시 한국어로!
- 해시태그 금지
- "⚠️description 없음"이면 설명 텍스트 넣지 마세요!

[의료법] 금지: 상담하세요, 방문하세요, 완치, 보장 / 허용: 증상명, 질환명, 질문형`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            cards: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  imagePrompt: { type: Type.STRING },
                  textPrompt: {
                    type: Type.OBJECT,
                    properties: {
                      subtitle: { type: Type.STRING },
                      mainTitle: { type: Type.STRING },
                      description: { type: Type.STRING },
                      tags: { type: Type.ARRAY, items: { type: Type.STRING } }
                    },
                    required: ["subtitle", "mainTitle", "description", "tags"]
                  }
                },
                required: ["imagePrompt", "textPrompt"]
              }
            }
          },
          required: ["cards"]
        }
      }
    });
    
    const result = JSON.parse(response.text || '{"cards":[]}');
    
    // 🚨🚨🚨 AI가 생성한 imagePrompt는 무시하고, 슬라이드 정보 + 사용자 스타일로 직접 조합!
    // AI가 멋대로 다른 텍스트/스타일을 넣는 문제 해결
    const cards = slides.map((s, idx) => {
      const isFirst = idx === 0;
      const isLast = idx === slides.length - 1;
      const mainTitleClean = s.mainTitle.replace(/<\/?highlight>/g, '');
      
      // 표지/마지막은 description 없음
      const descPart = (isFirst || isLast) ? '' : (s.description ? `, "${s.description}"` : '');
      
      // 🔧 imagePrompt: 텍스트가 이미지 안에 렌더링되는 완성형 카드!
      // 스타일은 generateSingleImage에서 결정 (중복 방지)
      const imagePrompt = `${CARD_LAYOUT_RULE}

🎯 이 카드에 들어갈 텍스트 (이미지 안에 직접 렌더링해야 함!):
- 부제목: "${s.subtitle}"
- 메인 제목: "${mainTitleClean}"${descPart ? `\n- 설명: ${descPart.replace(', "', '').replace('"', '')}` : ''}

🖼️ 배경/일러스트: ${s.imageKeyword}
🎨 배경색: ${bgColor}

⚠️ 필수 규칙:
- 1:1 정사각형 카드
- 위 텍스트를 이미지 안에 한국어로 직접 렌더링 (별도 HTML 아님!)
- 폰트는 깔끔하고 가독성 좋게, 배경과 대비되는 색상
- 해시태그/워터마크/로고 금지`;
      
      // textPrompt는 AI 결과 사용 (있으면) 또는 슬라이드 정보 사용
      const aiCard = result.cards?.[idx];
      const textPrompt = aiCard?.textPrompt || {
        subtitle: s.subtitle,
        mainTitle: s.mainTitle,
        description: (isFirst || isLast) ? '' : s.description,
        tags: s.tags
      };
      
      // 표지/마지막은 description 강제 제거
      if (isFirst || isLast) {
        textPrompt.description = '';
      }
      
      return { imagePrompt, textPrompt };
    });
    
    console.log('🎨 카드 프롬프트 직접 생성 완료:', cards.length, '장, 스타일:', hasCustomStyle ? '커스텀' : '기본');
    return cards;
  } catch (error) {
    console.error('전체 이미지 카드 프롬프트 실패:', error);
    // 🔧 fallback도 동일하게: 스타일은 generateSingleImage에서 결정!
    const fallbackCards = slides.map((s, idx) => {
      const isFirst = idx === 0;
      const isLast = idx === slides.length - 1;
      const mainTitleClean = s.mainTitle.replace(/<\/?highlight>/g, '');
      const descPart = (isFirst || isLast) ? '' : (s.description ? `, "${s.description}"` : '');
      return {
        imagePrompt: `${CARD_LAYOUT_RULE}

🎯 이 카드에 들어갈 텍스트 (이미지 안에 직접 렌더링해야 함!):
- 부제목: "${s.subtitle}"
- 메인 제목: "${mainTitleClean}"${descPart ? `\n- 설명: ${descPart.replace(', "', '').replace('"', '')}` : ''}

🖼️ 배경/일러스트: ${s.imageKeyword}
🎨 배경색: ${bgColor}

⚠️ 필수 규칙:
- 1:1 정사각형 카드
- 위 텍스트를 이미지 안에 한국어로 직접 렌더링 (별도 HTML 아님!)
- 폰트는 깔끔하고 가독성 좋게, 배경과 대비되는 색상
- 해시태그/워터마크/로고 금지`,
        textPrompt: { 
          subtitle: s.subtitle, 
          mainTitle: s.mainTitle, 
          description: (isFirst || isLast) ? '' : s.description, 
          tags: s.tags 
        }
      };
    });
    console.log('🚨 [fullImageCardPromptAgent fallback] 직접 생성, 스타일:', hasCustomStyle ? '커스텀' : '기본');
    return fallbackCards;
  }
};

// [기존 호환] 이미지만 생성하는 프롬프트 에이전트
const imagePromptAgent = async (
  slides: SlideStory[],
  imageStyle: ImageStyle,
  category: string
): Promise<string[]> => {
  const ai = getAiClient();
  
  const styleGuide = STYLE_KEYWORDS[imageStyle] || STYLE_KEYWORDS.illustration;
  
  const slideSummaries = slides.map((s, i) => `${i + 1}장: ${s.slideType} - ${s.imageKeyword}`).join('\n');
  
  const prompt = `당신은 의료/건강 이미지 프롬프트 전문가입니다.

[미션] 각 슬라이드에 맞는 이미지 프롬프트를 한국어로 작성하세요.
[스타일] ${styleGuide}
[진료과] ${category}
[슬라이드] ${slideSummaries}

[규칙]
- 한국어로 작성
- 4:3 비율 적합
- 로고/워터마크 금지
- 의료법 위반 문구 금지 (상담/방문/예약/완치/보장)
- 허용: 증상명, 질환명, 정보성 키워드, 질문형, 숫자

예시: "가슴 통증을 느끼는 중년 남성, 3D 일러스트, 파란색 배경, 밝은 톤"`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: { prompts: { type: Type.ARRAY, items: { type: Type.STRING } } },
          required: ["prompts"]
        }
      }
    });
    
    const result = JSON.parse(response.text || '{"prompts":[]}');
    return result.prompts || [];
  } catch (error) {
    console.error('이미지 프롬프트 에이전트 실패:', error);
    return slides.map(s => `${s.imageKeyword}, ${styleGuide}`);
  }
};

// ============================================
// 🎯 2단계 워크플로우: 원고 생성 → 사용자 확인 → 카드뉴스 디자인
// ============================================

// [1단계] 원고 생성 함수 - 블로그와 동일한 검증된 프롬프트 사용
export const generateCardNewsScript = async (
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<CardNewsScript> => {
  const ai = getAiClient();
  const slideCount = request.slideCount || 6;
  const writingStyle = request.writingStyle || 'empathy';
  const writingStylePrompt = WRITING_STYLE_PROMPTS[writingStyle];
  
  // 블로그와 동일한 검증된 프롬프트 구조 사용
  const medicalSafetyPrompt = getMedicalSafetyPrompt();
  
  onProgress('📝 [1단계] 원고 기획 중...');
  
  const prompt = `
${medicalSafetyPrompt}
${writingStylePrompt}
${WRITING_STYLE_COMMON_RULES}
${PSYCHOLOGY_CTA_PROMPT}

████████████████████████████████████████████████████████████████████████████████
🎯 카드뉴스 원고 작성 미션
████████████████████████████████████████████████████████████████████████████████

[미션] "${request.topic}" 주제로 ${slideCount}장짜리 **카드뉴스 원고**를 작성하세요.
[진료과] ${request.category}
[글 스타일] ${writingStyle === 'expert' ? '전문가형(신뢰·권위)' : writingStyle === 'empathy' ? '공감형(독자 공감)' : '전환형(정보→확인 유도)'}

${CONTENT_DESCRIPTION}

[🧠 핵심 원칙: 카드뉴스는 "정보 나열"이 아니라 "심리 흐름"이다!]
- 카드뉴스는 슬라이드형 설득 구조
- 각 카드는 **서로 다른 심리적 역할**을 가져야 함
- 생활습관(운동, 식단, 금연 등)은 **보조 정보로만** (최대 1장)
- 마지막 2장은 반드시 "시점 고정" + "안전한 CTA"

████████████████████████████████████████████████████████████████████████████████
📝 각 슬라이드별 작성 내용
████████████████████████████████████████████████████████████████████████████████

1. **subtitle** (10-15자): 질문형 또는 핵심 포인트
   예: "왜 중요할까요?", "혹시 이런 증상?"

2. **mainTitle** (15-25자): 핵심 메시지, 줄바꿈(\\n) 포함 가능
   예: "이 신호를\\n놓치지 마세요"
   - 강조할 부분은 <highlight>태그</highlight>로 감싸기

3. **description** (40-80자): 구체적인 설명문
   - 독자가 얻어갈 정보가 있어야 함!
   - 너무 짧으면 안 됨 (최소 40자)
   - 위 의료법 준수 규칙 적용 필수!

4. **speakingNote** (50-100자): 이 슬라이드에서 전달하고 싶은 핵심 메시지
   - 편집자/작성자가 참고할 내부 메모
   - 왜 이 내용이 필요한지, 독자에게 어떤 감정을 유발해야 하는지
   - 예: "독자가 '나도 그런 증상 있는데?' 하고 공감하게 만들어야 함"

5. **imageKeyword** (10-20자): 이미지 생성을 위한 핵심 키워드
   예: "심장 들고 있는 의사", "피로한 직장인"

████████████████████████████████████████████████████████████████████████████████
🎭 카드별 심리적 역할 - ${slideCount}장 기준
████████████████████████████████████████████████████████████████████████████████

**1장 - 주의 환기 (표지)**
- slideType: "cover"
- 위험 인식 유도, 흥미 유발
- 공포 조장 금지, 질문형 또는 반전형 문구
- speakingNote: "독자의 관심을 끌어야 함. '어? 나도?' 반응 유도"

**2장 - 오해 깨기 (개념 정리)**
- slideType: "concept"
- 착각을 바로잡는 메시지
- speakingNote: "잘못된 상식을 깨고 올바른 정보 제공"

${slideCount >= 5 ? `**3장 - 변화 신호 체크 (증상 체크)**
- slideType: "content"
- 대표적 증상 2-3가지 명확히
- ⚠️ 제목: "위험 신호"보다 "변화 신호", "체크 포인트" 선호
- ⚠️ 증상 설명 후 "다른 원인 가능성" 완충 문장 필수!
- speakingNote: "구체적 증상을 나열해 '자가 체크' 느낌"` : ''}

${slideCount >= 6 ? `**4장 - 자가 판단의 한계**
- slideType: "content"
- 검사·의학적 확인 필요성 강조
- speakingNote: "혼자 판단하면 안 되는 이유 설명"` : ''}

${slideCount >= 7 ? `**5~${slideCount-2}장 - 추가 정보/사례**
- slideType: "content"
- 구체적 증상 설명, 관련 정보
- 생활습관은 최대 1장만!` : ''}

**${slideCount-1}장 - 시점 고정 (🔥 핵심! 🔥)**
- slideType: "content"
- "이런 증상이 나타났다면" → "지켜보기보다 확인 시점일 수 있어요"
- ⚠️ 구체적 시간(2주, 48시간 등) 절대 금지! 범주형으로!
- speakingNote: "지금이 확인할 타이밍이라는 것을 인식시키기"

**${slideCount}장 - 안전한 CTA**
- slideType: "closing"
- ⚠️ 위 CTA 심리학 가이드 참조하여 작성!
- "불편함이 반복된다면 전문적인 확인을 고려해볼 수 있어요"
- speakingNote: "직접 권유 없이 행동을 유도하는 부드러운 마무리"

████████████████████████████████████████████████████████████████████████████████
⚠️ 최종 체크리스트
████████████████████████████████████████████████████████████████████████████████
□ 제목에 '치료/항암/전문의 권장/총정리' 없는지?
□ 도입부에 자기소개('에디터입니다') 없는지?
□ 숫자/시간이 범주형으로 표현되었는지?
□ 증상 설명 후 '다른 원인 가능성' 문장 있는지?
□ CTA가 직접 권유 없이 완곡하게 작성되었는지?
□ 연도/월이 계절 표현으로 일반화되었는지?`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        tools: [{ googleSearch: {} }],
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            topic: { type: Type.STRING },
            totalSlides: { type: Type.INTEGER },
            overallTheme: { type: Type.STRING },
            slides: {
              type: Type.ARRAY,
              items: {
                type: Type.OBJECT,
                properties: {
                  slideNumber: { type: Type.INTEGER },
                  slideType: { type: Type.STRING },
                  subtitle: { type: Type.STRING },
                  mainTitle: { type: Type.STRING },
                  description: { type: Type.STRING },
                  speakingNote: { type: Type.STRING },
                  imageKeyword: { type: Type.STRING }
                },
                required: ["slideNumber", "slideType", "subtitle", "mainTitle", "description", "speakingNote", "imageKeyword"]
              }
            }
          },
          required: ["title", "topic", "totalSlides", "slides", "overallTheme"]
        }
      }
    });
    
    const result = JSON.parse(response.text || "{}");
    
    // 🚨 후처리: 1장(표지)과 마지막 장의 description 강제로 빈 문자열로!
    if (result.slides && result.slides.length > 0) {
      // 1장 (표지) description 제거
      result.slides[0].description = "";
      
      // 마지막 장 description 제거
      if (result.slides.length > 1) {
        result.slides[result.slides.length - 1].description = "";
      }
      
      console.log('🚨 [generateCardNewsScript] 표지/마지막 장 description 강제 제거 완료');
    }
    
    onProgress(`✅ 원고 생성 완료 (${result.slides?.length || 0}장)`);
    
    return result as CardNewsScript;
  } catch (error) {
    console.error('원고 생성 실패:', error);
    throw error;
  }
};

// [2단계] 원고를 카드뉴스로 변환하는 함수
export const convertScriptToCardNews = async (
  script: CardNewsScript,
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<{ content: string; imagePrompts: string[]; cardPrompts: CardPromptData[]; title: string; }> => {
  onProgress('🎨 [2단계] 카드뉴스 디자인 변환 중...');
  
  // 스토리를 SlideStory 형식으로 변환 (기존 함수와 호환)
  const slides: SlideStory[] = script.slides.map(s => ({
    slideNumber: s.slideNumber,
    slideType: s.slideType as 'cover' | 'concept' | 'content' | 'closing',
    subtitle: s.subtitle,
    mainTitle: s.mainTitle,
    description: s.description,
    tags: [], // 태그는 프롬프트 생성 시 추가됨
    imageKeyword: s.imageKeyword
  }));
  
  // 스타일 분석 (참고 이미지가 있는 경우)
  let styleConfig: AnalyzedStyle | undefined;
  if (request.coverStyleImage || request.contentStyleImage) {
    try {
      const styleImage = request.coverStyleImage || request.contentStyleImage;
      onProgress('🎨 참고 이미지 스타일 분석 중...');
      const styleJson = await analyzeStyleReferenceImage(styleImage!, !!request.coverStyleImage);
      styleConfig = JSON.parse(styleJson);
      const features = styleConfig?.keyFeatures?.slice(0, 3).join(', ') || '';
      onProgress(`✨ 스타일 적용: ${styleConfig?.backgroundColor || '분석됨'} ${features ? `(${features})` : ''}`);
    } catch (e) {
      console.warn('스타일 분석 실패, 기본 스타일 사용:', e);
    }
  }
  
  // HTML 조립
  onProgress('🏗️ 카드 구조 생성 중...');
  const htmlContent = assembleCardNewsHtml({ ...script, slides }, styleConfig);
  
  // 카드 프롬프트 생성 (커스텀 이미지 프롬프트 전달!)
  onProgress('🎨 카드 이미지 프롬프트 생성 중...');
  const cardPrompts = await fullImageCardPromptAgent(
    slides,
    request.imageStyle || 'illustration',
    request.category,
    styleConfig,
    request.customImagePrompt  // 커스텀 프롬프트 전달!
  );
  
  // 공통 함수로 프롬프트 정리
  const imagePrompts = cardPrompts.map(c => cleanImagePromptText(c.imagePrompt));
  onProgress(`✅ 카드뉴스 디자인 변환 완료 (${cardPrompts.length}장)`);
  
  return {
    content: htmlContent,
    imagePrompts,
    cardPrompts,
    title: script.title
  };
};

// [통합] 미니 에이전트 오케스트레이터 (기존 호환 유지)
export const generateCardNewsWithAgents = async (
  request: GenerationRequest,
  onProgress: (msg: string) => void
): Promise<{ content: string; imagePrompts: string[]; cardPrompts: CardPromptData[]; title: string; }> => {
  const slideCount = request.slideCount || 6;
  
  // 1단계: 스토리 기획
  onProgress('📝 [1/3] 스토리 기획 중...');
  const story = await storyPlannerAgent(
    request.topic,
    request.category,
    slideCount,
    request.writingStyle || 'empathy'
  );
  
  if (!story.slides || story.slides.length === 0) {
    throw new Error('스토리 기획 실패: 슬라이드가 생성되지 않았습니다.');
  }
  
  onProgress(`✅ 스토리 기획 완료 (${story.slides.length}장)`);
  
  // 2단계: HTML 조립
  onProgress('🏗️ [2/3] 카드 구조 생성 중...');
  
  // 스타일 분석 결과가 있으면 전체 스타일 적용
  let styleConfig: AnalyzedStyle | undefined;
  if (request.coverStyleImage || request.contentStyleImage) {
    try {
      const styleImage = request.coverStyleImage || request.contentStyleImage;
      onProgress('🎨 참고 이미지 스타일 분석 중...');
      const styleJson = await analyzeStyleReferenceImage(styleImage!, !!request.coverStyleImage);
      const parsed = JSON.parse(styleJson);
      
      // 전체 스타일 정보 전달 (색상뿐만 아니라 폰트, 레이아웃, 프레임 등 모두)
      styleConfig = {
        frameStyle: parsed.frameStyle,
        hasWindowButtons: parsed.hasWindowButtons,
        windowButtonColors: parsed.windowButtonColors,
        backgroundColor: parsed.backgroundColor,
        borderColor: parsed.borderColor,
        borderWidth: parsed.borderWidth,
        borderRadius: parsed.borderRadius,
        boxShadow: parsed.boxShadow,
        subtitleStyle: parsed.subtitleStyle,
        mainTitleStyle: parsed.mainTitleStyle,
        highlightStyle: parsed.highlightStyle,
        descStyle: parsed.descStyle,
        tagStyle: parsed.tagStyle,
        illustPosition: parsed.illustPosition,
        illustSize: parsed.illustSize,
        padding: parsed.padding,
        mood: parsed.mood,
        keyFeatures: parsed.keyFeatures
      };
      
      const features = parsed.keyFeatures?.slice(0, 3).join(', ') || '';
      onProgress(`✨ 스타일 적용: ${parsed.backgroundColor || '분석됨'} ${features ? `(${features})` : ''}`);
    } catch (e) {
      console.warn('스타일 분석 실패, 기본 스타일 사용:', e);
    }
  }
  
  const htmlContent = assembleCardNewsHtml(story, styleConfig);
  onProgress('✅ 카드 구조 생성 완료');
  
  // 3단계: 전체 이미지 카드 프롬프트 생성 (텍스트 + 이미지 통합)
  onProgress('🎨 [3/3] 카드 프롬프트 생성 중...');
  const cardPrompts = await fullImageCardPromptAgent(
    story.slides,
    request.imageStyle || 'illustration',
    request.category,
    styleConfig,
    request.customImagePrompt  // 커스텀 프롬프트 전달!
  );
  
  // 공통 함수로 프롬프트 정리
  const imagePrompts = cardPrompts.map(c => cleanImagePromptText(c.imagePrompt));
  onProgress(`✅ 카드 프롬프트 ${cardPrompts.length}개 생성 완료`);
  
  return {
    content: htmlContent,
    imagePrompts,
    cardPrompts, // 새로 추가: 텍스트+이미지 프롬프트 전체
    title: story.topic
  };
};

// ============================================
// 기존 블로그 포스트 생성 함수 (유지)
// ============================================

export const generateBlogPostText = async (request: GenerationRequest): Promise<{ 
    title: string; 
    content: string; 
    imagePrompts: string[];
    fact_check: FactCheckReport;
    analyzedStyle?: { backgroundColor?: string; borderColor?: string; };
}> => {
  const ai = getAiClient();
  const isCardNews = request.postType === 'card_news';
  const targetLength = request.textLength || 2000;
  const targetSlides = request.slideCount || 6;
  
  // 스타일 참고 이미지 분석 (카드뉴스일 때만 - 표지/본문 분리)
  let coverStyleAnalysis = '';
  let contentStyleAnalysis = '';
  let analyzedBgColor = '';
  
  if (isCardNews) {
    // 표지 스타일 분석
    if (request.coverStyleImage) {
      try {
        coverStyleAnalysis = await analyzeStyleReferenceImage(request.coverStyleImage, true);
      } catch (e) {
        console.warn('표지 스타일 분석 실패:', e);
      }
    }
    
    // 본문 스타일 분석
    if (request.contentStyleImage) {
      try {
        contentStyleAnalysis = await analyzeStyleReferenceImage(request.contentStyleImage, false);
      } catch (e) {
        console.warn('본문 스타일 분석 실패:', e);
      }
    }
    
    // 표지만 있으면 본문도 같은 스타일 적용
    if (coverStyleAnalysis && !contentStyleAnalysis) {
      contentStyleAnalysis = coverStyleAnalysis;
    }
  }
  
  // 스타일 분석 결과를 프롬프트에 적용
  let styleAnalysis = '';
  let coverStyle: any = {};
  let contentStyle: any = {};
  
  if (coverStyleAnalysis || contentStyleAnalysis) {
    // JSON 파싱 시도
    try {
      if (coverStyleAnalysis) coverStyle = JSON.parse(coverStyleAnalysis);
      if (contentStyleAnalysis) contentStyle = JSON.parse(contentStyleAnalysis);
      // 배경색 저장 (후처리용)
      analyzedBgColor = coverStyle.backgroundColor || contentStyle.backgroundColor || '';
    } catch (e) {
      // JSON 파싱 실패 시 원본 텍스트 사용
      console.warn('스타일 JSON 파싱 실패:', e);
    }
    
    // 브라우저 프레임 HTML 생성
    const windowButtonsHtml = (style: any) => {
      if (style.hasWindowButtons || style.frameStyle === 'browser-window') {
        const colors = style.windowButtonColors || ['#FF5F57', '#FFBD2E', '#28CA41'];
        return `<div class="browser-header" style="display:flex; gap:6px; padding:8px 12px; background:#f0f0f0; border-radius:12px 12px 0 0;">
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[0]};"></span>
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[1]};"></span>
          <span style="width:12px; height:12px; border-radius:50%; background:${colors[2]};"></span>
        </div>`;
      }
      return '';
    };
    
    // inline CSS 스타일 생성 함수
    const generateInlineStyle = (style: any) => {
      const parts = [];
      if (style.backgroundColor) parts.push(`background-color: ${style.backgroundColor}`);
      if (style.borderColor && style.borderWidth) {
        parts.push(`border: ${style.borderWidth} solid ${style.borderColor}`);
      } else if (style.borderColor) {
        parts.push(`border: 2px solid ${style.borderColor}`);
      }
      if (style.borderRadius) parts.push(`border-radius: ${style.borderRadius}`);
      if (style.boxShadow) parts.push(`box-shadow: ${style.boxShadow}`);
      if (style.padding) parts.push(`padding: ${style.padding}`);
      return parts.join('; ');
    };
    
    // 제목 스타일 생성
    const generateTitleStyle = (style: any) => {
      if (!style.mainTitleStyle) return '';
      const s = style.mainTitleStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.fontSize) parts.push(`font-size: ${s.fontSize}`);
      if (s.fontWeight) parts.push(`font-weight: ${s.fontWeight}`);
      return parts.join('; ');
    };
    
    // 강조 스타일 생성
    const generateHighlightStyle = (style: any) => {
      if (!style.highlightStyle) return '';
      const s = style.highlightStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.backgroundColor && s.backgroundColor !== 'transparent') {
        parts.push(`background-color: ${s.backgroundColor}`);
        parts.push(`padding: 2px 6px`);
        parts.push(`border-radius: 4px`);
      }
      return parts.join('; ');
    };
    
    // 부제목 스타일 생성
    const generateSubtitleStyle = (style: any) => {
      if (!style.subtitleStyle) return '';
      const s = style.subtitleStyle;
      const parts = [];
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.fontSize) parts.push(`font-size: ${s.fontSize}`);
      if (s.fontWeight) parts.push(`font-weight: ${s.fontWeight}`);
      return parts.join('; ');
    };
    
    // 태그 스타일 생성
    const generateTagStyle = (style: any) => {
      if (!style.tagStyle) return '';
      const s = style.tagStyle;
      const parts = [];
      if (s.backgroundColor) parts.push(`background-color: ${s.backgroundColor}`);
      if (s.color) parts.push(`color: ${s.color}`);
      if (s.borderRadius) parts.push(`border-radius: ${s.borderRadius}`);
      parts.push(`padding: 4px 12px`);
      return parts.join('; ');
    };
    
    const coverInlineStyle = generateInlineStyle(coverStyle);
    const contentInlineStyle = generateInlineStyle(contentStyle);
    const coverTitleStyle = generateTitleStyle(coverStyle);
    const coverHighlightStyle = generateHighlightStyle(coverStyle);
    const coverSubtitleStyle = generateSubtitleStyle(coverStyle);
    const coverTagStyle = generateTagStyle(coverStyle);
    const contentTitleStyle = generateTitleStyle(contentStyle);
    const contentHighlightStyle = generateHighlightStyle(contentStyle);
    const contentSubtitleStyle = generateSubtitleStyle(contentStyle);
    const contentTagStyle = generateTagStyle(contentStyle);
    
    // 분석된 배경색을 CSS로 변환
    const bgColor = coverStyle.backgroundColor || contentStyle.backgroundColor || '#E8F4FD';
    const bgGradient = bgColor.includes('gradient') ? bgColor : `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
    
    styleAnalysis = `
[🎨🎨🎨 카드뉴스 스타일 - 이 스타일을 반드시 그대로 적용하세요! 🎨🎨🎨]

**⚠️⚠️⚠️ 최우선 규칙 ⚠️⚠️⚠️**
**모든 카드에 반드시 style="background: ${bgGradient};" 적용!**
**기본 흰 배경(#f8fafc, #fff) 사용 금지!**

**필수 적용 배경색: ${bgColor}**

${coverStyleAnalysis ? `**📕 표지 (1장) HTML:**
<div class="card-slide" style="background: ${bgGradient}; border-radius: 24px; overflow: hidden;">
  ${windowButtonsHtml(coverStyle)}
  <div class="card-content-area" style="padding: 32px 28px;">
    <p class="card-subtitle" style="${coverSubtitleStyle || 'color: #3B82F6; font-size: 14px; font-weight: 700;'}">부제목 (10~15자)</p>
    <p class="card-main-title" style="${coverTitleStyle || 'color: #1E293B; font-size: 28px; font-weight: 900;'}">메인 제목<br/><span style="color: #3B82F6;">강조</span></p>
    <div class="card-img-container">[IMG_1]</div>
    <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.7;">30~50자의 구체적인 설명 문장을 작성하세요!</p>
  </div>
</div>
` : ''}

${contentStyleAnalysis ? `**📄 본문 (2장~) HTML:**
<div class="card-slide" style="background: ${bgGradient}; border-radius: 24px; overflow: hidden;">
  ${windowButtonsHtml(contentStyle)}
  <div class="card-content-area" style="padding: 32px 28px;">
    <p class="card-subtitle" style="${contentSubtitleStyle || 'color: #3B82F6; font-size: 14px; font-weight: 700;'}">부제목 (10~15자)</p>
    <p class="card-main-title" style="${contentTitleStyle || 'color: #1E293B; font-size: 28px; font-weight: 900;'}">메인 제목<br/><span style="color: #3B82F6;">강조</span></p>
    <div class="card-img-container">[IMG_N]</div>
    <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.7;">30~50자의 구체적인 설명 문장을 작성하세요!</p>
  </div>
</div>
` : ''}

**🚨 배경색 필수 적용: ${bgColor} 🚨**
style 속성에 background: ${bgGradient}; 반드시 포함!
`;
  }
  
  let benchmarkingInstruction = '';
  if (request.referenceUrl) {
    benchmarkingInstruction = `
    [🚨 벤치마킹 모드 활성화]
    Target URL: ${request.referenceUrl}
    Google Search 도구를 사용하여 위 URL의 페이지를 접속해 콘텐츠 구조를 분석하십시오.
    
    ${isCardNews 
      ? `[미션: 템플릿 구조 모방]
         - 입력된 URL은 '카드뉴스 템플릿'입니다.
         - 해당 카드뉴스의 [페이지별 구성(표지-목차-본론-결론)], [텍스트 밀도], [강조 문구 스타일]을 분석하십시오.
         - 분석한 특징을 아래 [HTML 구조 가이드]에 대입하여 내용을 작성하십시오.
         - 예: 레퍼런스가 'Q&A' 형식이면 본문도 'Q&A'로, 'O/X 퀴즈' 형식이면 'O/X 퀴즈'로 구성하십시오.`
      : `[미션: 블로그 스타일 모방]
         - 이 블로그의 말투, 문단 구조, 이모지 사용 패턴을 완벽히 모방하여 글을 작성하십시오.`}
    
    [⚠️ 의료법 절대 준수] 
    - 벤치마킹 대상이 과장/위법 표현을 쓰더라도 절대 따라하지 말고 안전한 표현으로 순화하십시오.
    `;
  }

  const targetImageCount = request.imageCount || 3;
  const imageMarkers = Array.from({length: targetImageCount}, (_, i) => `[IMG_${i+1}]`).join(', ');
  const writingStyle = request.writingStyle || 'empathy'; // 기본값: 공감형
  const writingStylePrompt = WRITING_STYLE_PROMPTS[writingStyle];
  const imageStyle = request.imageStyle || 'illustration'; // 기본값: 3D 일러스트
  
  // 현재 한국 시간 정보 (최신 정보 기반 글 작성용)
  const now = new Date();
  const koreaTime = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const currentYear = koreaTime.getFullYear();
  const currentMonth = koreaTime.getMonth() + 1;
  const currentDay = koreaTime.getDate();
  const currentSeason = currentMonth >= 3 && currentMonth <= 5 ? '봄' 
    : currentMonth >= 6 && currentMonth <= 8 ? '여름'
    : currentMonth >= 9 && currentMonth <= 11 ? '가을' : '겨울';
  const timeContext = `현재 날짜: ${currentYear}년 ${currentMonth}월 ${currentDay}일 (${currentSeason})`;
  // 커스텀 이미지 프롬프트가 있으면 최우선 사용
  const customImagePrompt = request.customImagePrompt?.trim();
  const imageStyleGuide = customImagePrompt
    ? `커스텀 스타일: ${customImagePrompt}` // 커스텀 프롬프트 최우선!
    : imageStyle === 'illustration' 
    ? '3D rendered illustration, Blender style, soft studio lighting, 파스텔 색상, 둥근 형태, 친근한 캐릭터, 깔끔한 배경 (⛔금지: photorealistic, real photo, DSLR)'
    : imageStyle === 'medical'
    ? 'medical 3D illustration, anatomical render, 해부학적 구조, 장기 단면도, semi-transparent organs, clinical lighting, 의료 색상 팔레트 (⛔금지: cute cartoon, realistic face)'
    : 'photorealistic DSLR photography, real photo, 35mm lens, natural soft lighting, shallow depth of field, 전문 병원 환경 (⛔금지: 3D render, illustration, cartoon, anime)';
  
  // 동적으로 최신 의료광고법 프롬프트 생성
  const medicalSafetyPrompt = getMedicalSafetyPrompt();
  
  const blogPrompt = `
    ${medicalSafetyPrompt}
    ${writingStylePrompt}
    ${WRITING_STYLE_COMMON_RULES}
    ${benchmarkingInstruction}
    
    [📅 현재 시점 정보 - 최신 정보 기반 작성 필수!]
    ${timeContext}
    - ${currentYear}년 최신 의학 가이드라인/연구 결과 반영
    - ${currentYear}년 최신 의료광고법 규정 준수 (Google 검색으로 "${currentYear}년 의료광고법" 확인)
    - ${currentSeason}철 특성 고려 (계절성 질환, 생활 습관 등)
    - 오래된 정보(2년 이상)는 최신 정보로 업데이트하여 작성
    - Google 검색으로 ${currentYear}년 최신 정보 확인 후 작성
    
    진료과: ${request.category}, 페르소나: ${request.persona}, 주제: ${request.topic}
    
    [🚨🚨🚨 글자 수 - 가장 중요한 요구사항!!! 🚨🚨🚨]
    ⚠️⚠️⚠️ 목표: 공백 포함 **최소 ${targetLength}자 이상** 작성 필수!!! ⚠️⚠️⚠️
    
    📏 분량 가이드 (${targetLength}자 기준):
    ${targetLength >= 5000 ? `
    - 🔴 5000자 이상 = 매우 긴 글!
    - 서론: 400자 이상 (상황 묘사 + 문제 제기 + 공감)
    - 본론 섹션: 최소 5~6개 섹션 필요! (각 섹션 600자 이상)
    - 각 섹션에 상세 설명 + 구체적 예시 + 통계/연구 결과 포함
    - 결론: 300자 이상 (핵심 요약 + CTA)
    - 해시태그: 10~15개` : targetLength >= 4000 ? `
    - 🔴 4000자 이상 = 긴 글!
    - 서론: 350자 이상
    - 본론 섹션: 최소 4~5개 섹션 필요! (각 섹션 500자 이상)
    - 각 섹션에 상세 설명 + 예시 포함
    - 결론: 250자 이상
    - 해시태그: 10개` : targetLength >= 3000 ? `
    - 🟡 3000자 이상 = 중간 길이 글
    - 서론: 300자 이상
    - 본론 섹션: 최소 3~4개 섹션 필요! (각 섹션 450자 이상)
    - 각 섹션에 설명 + 예시 포함
    - 결론: 200자 이상
    - 해시태그: 10개` : `
    - 🟢 2000자 내외 = 적당한 길이
    - 서론: 200자 이상
    - 본론 섹션: 2~3개 섹션 (각 섹션 350자 이상)
    - 결론: 150자 이상
    - 해시태그: 10개`}
    
    ✅ 글자 수 늘리는 방법:
    1. 각 증상/원인을 더 상세히 설명 (왜? 어떻게? 언제?)
    2. 구체적인 사례/상황 예시 추가 ("예를 들어...", "실제로...")
    3. 통계나 연구 결과 인용 ("연구에 따르면...", "~% 환자가...")
    4. 비교/대조 설명 추가 ("반면에...", "~와 달리...")
    5. 독자 공감 문장 추가 ("이런 경험 있으시죠?", "많은 분들이...")
    6. 소제목(h3) 섹션 수 늘리기!
    
    ❌ 절대 금지:
    - ${targetLength}자보다 적게 쓰는 것 (최소 분량 미달 시 다시 작성!)
    - 내용 없이 같은 말 반복하기
    - 해시태그로 글자 수 채우기
    
    이미지 개수: ${targetImageCount}장 (${imageMarkers} 마커 사용)
    
    [네이버 블로그 HTML 형식 작성 필수]
    **중요: 반드시 HTML 태그로 작성하세요. 마크다운(###, **, -) 절대 사용 금지!**
    
    HTML 구조 (이미지 ${targetImageCount}장 배치, 글자 수 ${targetLength}자 기준):
    <div class="naver-post-container">
      <h3>🎯 서론 제목 (공감 유도)</h3>
      <p>서론 문단 (${targetLength >= 4000 ? '400자 이상' : targetLength >= 3000 ? '300자 이상' : '200자 이상'}) - ${writingStyle === 'expert' ? '의학적 인사이트나 논문/학회 인용으로 시작' : '구체적 상황 묘사로 시작! (예: "히터 켜고 자고 일어나면...")'}</p>
      <p>서론 추가 문단 - 왜 이 주제가 중요한지 설명</p>
      
      [IMG_1]
      
      <h3>📌 본론 1: 정의/개념 설명</h3>
      <p>핵심 개념 설명 (${targetLength >= 4000 ? '500자 이상' : '350자 이상'})</p>
      <p>추가 설명 + 예시</p>
      <ul>
        <li>포인트 1 - 상세 설명</li>
        <li>포인트 2 - 상세 설명</li>
        <li>포인트 3 - 상세 설명</li>
      </ul>
      
      ${targetImageCount >= 2 ? '[IMG_2]' : ''}
      
      <h3>⚠️ 본론 2: 원인/증상 상세</h3>
      <p>원인 설명 (${targetLength >= 4000 ? '500자 이상' : '350자 이상'})</p>
      <p>증상별 상세 설명 + 구체적 사례</p>
      <ul>
        <li>원인/증상 1 - "예를 들어..." 상세 설명</li>
        <li>원인/증상 2 - 구체적 상황 묘사</li>
        <li>원인/증상 3 - 주의사항</li>
      </ul>
      
      ${targetImageCount >= 3 ? '[IMG_3]' : ''}
      
      ${targetLength >= 3500 ? `
      <h3>🔬 본론 3: 진단/검사 방법</h3>
      <p>검사 방법 상세 설명 (400자 이상) - 어떤 검사를 하는지, 검사 과정은 어떤지</p>
      <p>검사 결과 해석 방법 + 주의사항</p>
      <ul>
        <li>검사 종류 1 설명</li>
        <li>검사 종류 2 설명</li>
      </ul>
      ` : ''}
      
      ${targetImageCount >= 4 ? '[IMG_4]' : ''}
      
      ${targetLength >= 4000 ? `
      <h3>💊 본론 4: 치료/관리 방법</h3>
      <p>치료 방법 상세 설명 (500자 이상)</p>
      <p>관리 방법 + 생활 습관 개선 팁</p>
      <ul>
        <li>치료법 1 - 장단점 설명</li>
        <li>치료법 2 - 적용 대상</li>
        <li>생활 관리법 - 구체적 방법</li>
      </ul>
      ` : ''}
      
      ${targetLength >= 4500 ? `
      <h3>🛡️ 본론 5: 예방법/주의사항</h3>
      <p>예방법 상세 설명 (400자 이상)</p>
      <p>일상에서 실천할 수 있는 구체적 방법들</p>
      <ul>
        <li>예방법 1 - 실천 방법</li>
        <li>예방법 2 - 실천 방법</li>
        <li>주의사항 - 이런 경우는 주의!</li>
      </ul>
      ` : ''}
      
      ${targetImageCount >= 5 ? '[IMG_5]' : ''}
      
      ${targetLength >= 5000 ? `
      <h3>❓ 자주 묻는 질문 (FAQ)</h3>
      <p><strong>Q1. [자주 묻는 질문 1]</strong></p>
      <p>A1. 상세한 답변 (150자 이상)</p>
      <p><strong>Q2. [자주 묻는 질문 2]</strong></p>
      <p>A2. 상세한 답변 (150자 이상)</p>
      <p><strong>Q3. [자주 묻는 질문 3]</strong></p>
      <p>A3. 상세한 답변 (150자 이상)</p>
      ` : ''}
      
      <h3>✅ 마무리: 핵심 정리</h3>
      <p>핵심 내용 요약 (${targetLength >= 4000 ? '300자 이상' : '200자 이상'}) - ${writingStyle === 'conversion' ? '행동을 하나로 집중! ("딱 하나만 기억하세요...")' : '핵심 정보 요약'}</p>
      
      <div class="cta-box">
        <p class="cta-title">💡 건강 체크 포인트</p>
        <p class="cta-text">심리학적 전환 문구 삽입 (아래 규칙 참조)</p>
      </div>
      
      <p>해시태그 10~15개</p>
    </div>
    
    ${PSYCHOLOGY_CTA_PROMPT}
    
    [🎯 마무리 CTA 박스 작성 규칙]
    1. 글의 주제와 연관된 심리학 기법 2-3개 조합
    2. 독자가 "다음 행동"을 자연스럽게 떠올리게 유도
    3. 직접적 권유 없이 간접적으로 행동 유도
    
    **CTA 박스 HTML 구조:**
    <div class="cta-box">
      <p class="cta-title">💡 [관련 이모지] [후킹 제목]</p>
      <p class="cta-text">[심리학 기반 전환 문구 2-3문장]</p>
      <p class="cta-subtext">[부드러운 마무리 한 줄]</p>
    </div>
    
    **예시:**
    <div class="cta-box">
      <p class="cta-title">💡 혹시 이런 증상, 그냥 넘기고 계신가요?</p>
      <p class="cta-text">
        작은 불편함도 초기에 확인하면 관리가 훨씬 수월해질 수 있습니다.<br/>
        많은 분들이 정기 검진으로 건강을 지키고 계세요.<br/>
        이번 기회에 내 몸 상태를 점검해 보시는 건 어떨까요?
      </p>
      <p class="cta-subtext">건강한 오늘이 행복한 내일을 만듭니다 😊</p>
    </div>
    
    주의사항:
    1. 모든 제목은 <h3> 태그 사용
    2. 모든 문단은 <p> 태그 사용
    3. 리스트는 <ul><li> 태그 사용
    4. 이미지 마커 ${imageMarkers}를 글 중간에 적절히 배치
    5. 해시태그는 마지막에 <p> 안에 작성
    6. **CTA 박스는 반드시 마지막 이미지 다음, 해시태그 전에 배치**
    
    **마무리 문단 필수 규칙:**
    - "방문하세요", "내원하세요" 같은 직접 권유 표현 절대 금지
    - "검진을 고려해 보시는 것도 좋습니다", "전문의와 상담이 필요할 수 있습니다" 등 간접 표현 사용
    - 병원 이름, 전화번호, 주소 절대 금지
    
    [📊 전환 점수(conversion_score) 평가 기준 - 0~100점]
    **의료법 100% 준수하면서 전환력을 측정합니다**
    
    평가 항목 (각 20점):
    1. **공감 도입부** (20점): 독자가 "이거 내 얘기네!" 느끼는 구체적 상황 묘사
       - 0점: 일반적인 서론 ("오늘은 ~에 대해...")
       - 10점: 보통 수준의 공감 ("~하신 분들 많으시죠?")
       - 20점: 구체적 상황 ("아침에 일어났을 때 손가락이 뻣뻣하고...")
    
    2. **정보 가치** (20점): 독자가 얻어가는 실질적 정보
       - 0점: 뻔한 정보만 나열
       - 10점: 기본적인 유용한 정보
       - 20점: "이건 몰랐네!" 싶은 전문적 인사이트
    
    3. **심리적 긴박감** (20점): 의료법 준수하면서 행동 필요성 인식
       - 0점: 긴박감 없음
       - 10점: 일반적인 중요성 언급
       - 20점: "지금 확인하느냐, 나중에 후회하느냐" 수준의 간접적 긴박감
    
    4. **CTA 품질** (20점): 자연스러운 행동 유도
       - 0점: CTA 없음 또는 직접적 권유 (의료법 위반)
       - 10점: 형식적인 마무리
       - 20점: 독자가 자연스럽게 "병원 가봐야겠다" 생각하게 만드는 심리적 CTA
    
    5. **전체 흐름** (20점): 도입→본론→CTA 자연스러운 연결
       - 0점: 내용이 뒤죽박죽
       - 10점: 기본적인 구조
       - 20점: 읽다 보면 자연스럽게 결론에 도달하는 흐름
    
    [⚖️ 의료법 준수 점수(safety_score) 평가 기준 - 0~100점]
    **의료광고법 위반 여부를 엄격하게 측정합니다**
    
    감점 항목:
    1. **직접 권유 표현** (-30점/건): "방문하세요", "내원하세요", "예약하세요", "상담하세요"
    2. **치료 효과 보장** (-25점/건): "완치", "100% 효과", "확실한", "보장"
    3. **과대 광고** (-20점/건): "최고", "유일", "1등", "최상급"
    4. **비교 광고** (-20점/건): 타 병원과 비교, "우리가 더 좋다"
    5. **공포 유발** (-15점/건): "지금 안하면 위험", "돌연사", "사망"
    6. **병원 정보 노출** (-10점/건): 병원명, 전화번호, 주소
    
    안전한 표현 (감점 없음):
    ✅ "검진을 고려해 보시는 것도 좋습니다"
    ✅ "전문의와 상담이 필요할 수 있습니다"
    ✅ "증상이 지속되면 확인이 필요합니다"
    ✅ 질환명, 증상명, 정보성 키워드
    
    **중요: conversion_score가 100점이어도 의료법은 반드시 준수해야 합니다!**
    - 직접적 내원/예약 권유 = 의료법 위반 = safety_score 감점
    - 전환력은 "간접적이지만 효과적인" 방식으로 달성
    
    [🎨 이미지 프롬프트 작성 규칙 - 매우 중요!]
    **imagePrompts 배열에 들어갈 프롬프트는 반드시 한국어로 작성하세요!**
    이미지 스타일: ${customImagePrompt ? `커스텀: ${customImagePrompt}` : imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D 해부학' : '실사 사진'}
    
    **🚨 블로그 이미지 텍스트 규칙 (매우 중요!):**
    - ❌ 이미지에 텍스트 넣지 마세요! (글자, 숫자, 문구 모두 금지)
    - ❌ 로고, 워터마크, 간판, 표지판 금지
    - ✅ 순수한 일러스트/사진만 생성
    - ✅ 프롬프트에 "텍스트 없이", "글자 없이" 명시 필수!
    
    각 이미지 프롬프트에 반드시 포함할 스타일 키워드:
    ${imageStyleGuide}
    
    ${customImagePrompt ? `**⚠️ 커스텀 스타일 필수 적용!**
    사용자가 "${customImagePrompt}" 스타일을 요청했습니다.
    모든 이미지 프롬프트에 이 스타일 키워드를 반드시 포함하세요!
    예시: "[장면 묘사], ${customImagePrompt}, 텍스트 없이"` : `예시 (${imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D' : '실사 사진'} 스타일):
    ${imageStyle === 'illustration' 
      ? '- "밝은 병원 진료실에서 의사가 환자에게 설명하는 모습, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트, 텍스트 없이"'
      : imageStyle === 'medical'
      ? '- "인체 심장의 3D 단면도, 좌심실과 우심실이 보이는 해부학적 구조, 혈관과 판막이 보이는 의학 일러스트, 파란색 배경, 텍스트 없이"'
      : '- "깔끔한 병원 진료실에서 의사가 환자와 상담하는 모습, 실사 사진, DSLR 촬영, 자연스러운 조명, 텍스트 없이"'}`}
  `;

  const cardNewsPrompt = `
    **🚨🚨🚨 최우선 지침: 이것은 카드뉴스입니다! 🚨🚨🚨**
    - 블로그 포스팅 형식(긴 문단)으로 작성하면 안 됩니다!
    - 반드시 <div class="card-slide"> 구조의 슬라이드 형식으로 작성하세요!
    - 각 슬라이드는 짧은 텍스트(제목 12자, 설명 20자 이내)만 포함합니다!
    
    ${MEDICAL_SAFETY_SYSTEM_PROMPT}
    ${writingStylePrompt}
    ${WRITING_STYLE_COMMON_RULES}
    ${benchmarkingInstruction}
    ${styleAnalysis}
    
    [📅 현재 시점 정보 - 최신 정보 기반 작성 필수!]
    ${timeContext}
    - ${currentYear}년 최신 의학 가이드라인/연구 결과 반영
    - ${currentSeason}철 특성 고려 (계절성 질환, 생활 습관 등)
    - Google 검색으로 ${currentYear}년 최신 정보 확인 후 작성
    
    진료과: ${request.category}, 주제: ${request.topic}
    총 ${targetSlides}장의 카드뉴스
    글 스타일: ${writingStyle === 'expert' ? '전문가형(신뢰·권위·논문 인용)' : writingStyle === 'empathy' ? '공감형(독자 공감 유도)' : '전환형(행동 유도)'}
    
    [🚨🚨🚨 핵심 주제 키워드 - 반드시 모든 카드에 반영하세요! 🚨🚨🚨]
    
    **주제: "${request.topic}"**
    - 이 주제가 모든 카드의 중심이 되어야 합니다!
    - "${request.topic}"과 직접 관련된 구체적인 내용만 작성하세요!
    - 일반적이고 추상적인 건강 정보는 ❌ 금지!
    - "${request.topic}"의 구체적인 증상, 원인, 특징을 다루세요!
    
    **⚠️ 질환명/증상명 사용 규칙:**
    - "${request.topic}"에 포함된 질환명(예: 혈액암, 당뇨병, 고혈압 등)은 그대로 사용하세요!
    - 의료 정보를 돌려말하지 마세요! 직접적으로 설명하세요!
    - "몸의 변화", "건강 이상 신호" 같은 모호한 표현 ❌
    - "${request.topic}"의 실제 증상명과 특징을 구체적으로 ✅
    
    [🚨🚨🚨 가장 중요: 스토리 연결성 - 반드시 읽고 적용하세요! 🚨🚨🚨]
    
    **카드뉴스는 반드시 "하나의 스토리"로 연결되어야 합니다!**
    - 각 슬라이드가 독립적인 내용이면 안 됩니다!
    - 1장부터 마지막 장까지 "${request.topic}"에 대해 깊이 있게 다루세요!
    - "표지 → 정의/개요 → 구체적 증상/특징들 → 마무리" 구조를 따르세요!
    
    **스토리 구조 (${targetSlides}장) - "${request.topic}" 기준:**
    
    📕 **1장 (표지)**: "${request.topic}" 주제 소개
    - 제목에 "${request.topic}" 키워드 필수 포함!
    - 예: "${request.topic}, 이런 신호를 놓치지 마세요"
    
    📘 **2장**: "${request.topic}"이란? (정의/개요)
    - "${request.topic}"가 무엇인지 직접적으로 설명
    - 모호하게 돌려말하지 않기!
    
    📗 **3~${targetSlides - 1}장**: "${request.topic}"의 구체적 증상/특징/방법
    - 각 슬라이드에 "${request.topic}"과 직접 관련된 하나의 구체적 내용
    - 실제 증상명, 특징, 원인 등을 명확하게!
    - 예시: 혈액암이라면 → "멍이 쉽게 드나요?", "잇몸 출혈", "만성 피로", "림프절 부종"
    
    📙 **${targetSlides}장 (마무리)**: 정리 + 행동 유도
    - "${request.topic}" 관련 핵심 메시지
    - 자가진단/전문의 상담 권유 등
    
    **✅ "${request.topic}" 주제 올바른 예시:**
    만약 주제가 "혈액암 초기증상"이라면:
    1장: "혈액암, 이 신호를 놓치고 있진 않나요?" (표지)
    2장: "혈액암이란?" - 혈액세포에 생기는 암의 종류 설명
    3장: "멍이 쉽게 드시나요?" - 혈소판 감소로 인한 증상
    4장: "잇몸에서 피가 자주 나나요?" - 출혈 경향 설명
    5장: "쉬어도 풀리지 않는 피로감" - 빈혈로 인한 피로
    6장: "조기 발견이 중요합니다" - 정기검진 권유
    
    **❌ 잘못된 예시 (주제와 동떨어진 일반론):**
    1장: "몸이 보내는 신호" (← 주제 키워드 없음!)
    2장: "피로의 원인" (← 너무 일반적!)
    3장: "건강관리의 중요성" (← 주제와 무관!)
    → "${request.topic}"을 직접 다루지 않으면 안 됩니다!
    
    ${PSYCHOLOGY_CTA_PROMPT}
    
    [🎯 마지막 슬라이드 (${targetSlides}장) 심리학적 전환 문구 규칙]
    마지막 카드는 독자가 "다음 행동"을 떠올리게 하는 심리학적 설득 기법을 사용합니다.
    
    **마지막 슬라이드 예시:**
    card-subtitle: "지금이 기회예요" / "함께 지켜요" / "시작해볼까요?"
    card-main-title: "작은 습관이<br/><span class='card-highlight'>생명</span>을 지킵니다"
    card-desc: "건강한 오늘이 행복한 내일을 만듭니다 😊"
    
    **심리학 기법 적용 예시 (마지막 카드):**
    - 손실회피: "미루면 놓칠 수 있어요"
    - 사회적증거: "많은 분들이 실천 중이에요"  
    - 시의성: "이맘때가 적기예요"
    - 감정호소: "소중한 일상, 오래 누리세요"
    
    ${request.referenceUrl ? '★벤치마킹 URL의 구성 방식도 참고하세요.' : ''}
    
    ${styleAnalysis ? `
    **⚠️⚠️⚠️ 중요: 스타일 참고 이미지가 있습니다! ⚠️⚠️⚠️**
    - 위에서 제공한 "표지/본문 HTML 템플릿"의 style 속성을 그대로 사용하세요!
    - 기본 HEALTH NOTE 스타일(주황색 테두리)을 사용하면 안 됩니다!
    - 분석된 색상(${coverStyle.backgroundColor || contentStyle.backgroundColor || '분석된 색상'})을 반드시 적용하세요!
    ` : `
    [HTML 구조 - 기본 스타일 (연한 하늘색 배경)]
    **⚠️ 중요: 아래 템플릿을 그대로 복사해서 사용하세요! style 속성 필수!**
    
    <div class="card-slide" style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%); border-radius: 24px; padding: 0; overflow: hidden;">
      <div style="padding: 32px 28px; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%;">
        <p class="card-subtitle" style="font-size: 14px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">질문형 부제목 (10~15자)</p>
        <p class="card-main-title" style="font-size: 28px; font-weight: 900; color: #1E293B; line-height: 1.3; margin: 0 0 16px 0;">메인 제목<br/><span style="color: #3B82F6;">강조 텍스트</span></p>
        <div class="card-img-container" style="width: 100%; margin: 16px 0;">[IMG_N]</div>
        <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.6; font-weight: 500; max-width: 90%;">여기에 30~50자의 구체적인 설명 문장을 작성하세요. 독자가 정보를 얻을 수 있도록 충분히!</p>
      </div>
    </div>
    
    **🚨 card-desc 부분이 가장 중요합니다! 반드시 30자 이상 작성하세요! 🚨**
    
    **배경색 필수: style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%);" 적용!**
    `}
    
    [🚫 절대 금지 표현 - 카드에 이런 텍스트 넣지 마세요!]
    ❌ "01.", "02.", "03." 같은 슬라이드 번호
    ❌ "해결책 1", "해결책 2", "마무리" 같은 구조 용어
    ❌ "첫 번째", "두 번째", "세 번째" 같은 순서 표현
    ❌ "후킹", "문제 제기", "원인/배경" 같은 프레임워크 용어
    
    [✅ 올바른 예시]
    card-subtitle: "알고 계셨나요?" / "왜 위험할까요?" / "이렇게 해보세요"
    card-main-title: "겨울철 심장마비<br/><span class='card-highlight'>3배</span> 증가" 
    
    [🚨🚨🚨 작성 규칙 - 매우 중요 🚨🚨🚨]
    1. 각 슬라이드에 [IMG_1]~[IMG_${targetSlides}] 마커 필수
    2. 이전 슬라이드와 내용이 자연스럽게 연결
    3. card-main-title은 **반드시 <p> 태그 사용** (h1 사용 금지!)
    4. card-main-title은 **15~20자**로 충분히 작성! 줄바꿈은 <br/> 사용
    5. card-subtitle은 **10~15자**의 질문형 또는 핵심 포인트
    6. **card-desc는 반드시 30~50자**의 구체적인 설명 문장 포함! (가장 중요!)
    7. 실제 독자가 볼 콘텐츠만 작성 (메타 정보 금지)
    8. **글씨가 너무 없으면 안 됨!** 각 카드에 충분한 정보 전달 필수!
    
    [📝 텍스트 분량 규칙 - 반드시 지키세요!]
    ❌ 잘못된 예 (텍스트 부족):
    - card-subtitle: "지금 알아야 해요" (8자)
    - card-main-title: "심정지<br/><span class='card-highlight'>4분</span>" (6자)
    - card-desc: "골든타임 사수" (6자) ← 너무 짧음!
    
    ✅ 올바른 예 (충분한 텍스트):
    - card-subtitle: "왜 4분이 중요할까요?" (12자)
    - card-main-title: "뇌세포 생존<br/><span class='card-highlight'>마지노선</span>" (12자)
    - card-desc: "4분이 지나면 뇌 손상이 급격히 진행돼요. 골든타임을 놓치지 마세요!" (40자) ← 이 정도는 되어야 함!
    
    [❌ 잘못된 예시 - 절대 이렇게 쓰지 마세요]
    <p class="card-main-title">스타틴 임의 중단은 금물! 전문의가 강조하는 만성질환 복약 순응도의 중요성</p>
    
    [✅ 올바른 예시]
    <p class="card-main-title">스타틴<br/><span class="card-highlight">중단 금지!</span></p>
    
    [🎨 이미지 프롬프트 작성 규칙 - 매우 중요!]
    **imagePrompts 배열에 들어갈 프롬프트는 반드시 한국어로 작성하세요!**
    이미지 스타일: ${customImagePrompt ? `커스텀: ${customImagePrompt}` : imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D 해부학' : '실사 사진'}
    
    **📝 카드뉴스 이미지 텍스트 규칙:**
    - 카드뉴스 이미지에는 제목, 설명 텍스트가 들어갈 수 있음
    - 한글, 숫자 위주로
    - 로고, 워터마크 금지
    
    각 이미지 프롬프트에 반드시 포함할 스타일 키워드:
    ${imageStyleGuide}
    
    ${customImagePrompt ? `**⚠️ 커스텀 스타일 필수 적용!**
    사용자가 "${customImagePrompt}" 스타일을 요청했습니다.
    모든 이미지 프롬프트에 이 스타일 키워드를 반드시 포함하세요!
    예시: "[장면 묘사], ${customImagePrompt}"` : `예시 (${imageStyle === 'illustration' ? '3D 일러스트' : imageStyle === 'medical' ? '의학 3D' : '실사 사진'} 스타일):
    ${imageStyle === 'illustration' 
      ? '- "밝은 병원 배경의 건강 인포그래픽, 3D 일러스트, 아이소메트릭 뷰, 클레이 렌더, 파란색 흰색 팔레트"'
      : imageStyle === 'medical'
      ? '- "인체 폐의 3D 단면도, 기관지와 폐포 구조가 보이는 해부학 일러스트, 투명 효과, 파란색 의료 배경"'
      : '- "깔끔한 병원 환경 이미지, 실사 사진, DSLR 촬영, 전문적인 분위기"'}`}
    
    [🚨🚨🚨 최종 검증 - 작성 후 반드시 확인하세요! 🚨🚨🚨]
    각 카드의 card-desc가 30자 이상인지 확인하세요!
    예: "심장이 멈춘 지 4분이 지나면 뇌세포가 마음대로 누설되기 시작해요" (이 정도 길이)
    텍스트가 너무 짧으면 독자가 정보를 얻을 수 없습니다!
  `;

  try {
    const response = await ai.models.generateContent({
      model: "gemini-3-pro-preview",
      contents: isCardNews ? cardNewsPrompt : blogPrompt,
      config: {
        tools: [{ googleSearch: {} }],
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            title: { type: Type.STRING },
            content: { type: Type.STRING },
            imagePrompts: { type: Type.ARRAY, items: { type: Type.STRING } },
            fact_check: {
              type: Type.OBJECT,
              properties: {
                fact_score: { type: Type.INTEGER },
                safety_score: { type: Type.INTEGER },
                conversion_score: { type: Type.INTEGER },
                verified_facts_count: { type: Type.INTEGER },
                issues: { type: Type.ARRAY, items: { type: Type.STRING } },
                recommendations: { type: Type.ARRAY, items: { type: Type.STRING } }
              },
              required: ["fact_score", "safety_score", "conversion_score", "verified_facts_count", "issues", "recommendations"]
            }
          },
          required: ["title", "content", "imagePrompts", "fact_check"]
        }
      }
    });
    const result = JSON.parse(response.text || "{}");
    
    // AI가 content를 배열이나 객체로 반환한 경우 방어 처리
    if (result.content && typeof result.content !== 'string') {
      console.warn('AI returned non-string content, attempting to extract HTML...');
      if (Array.isArray(result.content)) {
        // 배열인 경우 각 항목에서 HTML 추출
        result.content = result.content.map((item: any) => {
          if (typeof item === 'string') return item;
          if (item?.content) return item.content;
          if (item?.html) return item.html;
          return '';
        }).join('');
      } else if (typeof result.content === 'object') {
        // 객체인 경우 content나 html 필드 추출
        result.content = result.content.content || result.content.html || JSON.stringify(result.content);
      }
    }
    
    // 분석된 스타일 정보 추가
    if (analyzedBgColor) {
      result.analyzedStyle = { backgroundColor: analyzedBgColor };
    }
    return result;
  } catch (error) { throw error; }
};

export const generateFullPost = async (request: GenerationRequest, onProgress: (msg: string) => void): Promise<GeneratedContent> => {
  const isCardNews = request.postType === 'card_news';
  
  // 🔍 디버그: request에 customImagePrompt가 있는지 확인
  console.log('🔍 generateFullPost 시작 - request.imageStyle:', request.imageStyle);
  console.log('🔍 generateFullPost 시작 - request.customImagePrompt:', request.customImagePrompt ? request.customImagePrompt.substring(0, 50) : 'undefined/없음');
  
  // 🤖 카드뉴스: 미니 에이전트 방식 사용
  if (isCardNews) {
    onProgress('🤖 미니 에이전트 방식으로 카드뉴스 생성 시작...');
    
    try {
      // 미니 에이전트로 스토리 기획 + HTML 조립 + 이미지 프롬프트 생성
      const agentResult = await generateCardNewsWithAgents(request, onProgress);
      
      // 이미지 생성
      const styleName = STYLE_NAMES[request.imageStyle] || STYLE_NAMES.illustration;
      onProgress(`🎨 ${styleName} 스타일로 4:3 이미지 생성 중...`);
      
      // 🎨 이미지 = 카드 전체! (텍스트가 이미지 안에 포함된 완성형)
      const maxImages = request.slideCount || 6;
      onProgress(`🎨 ${maxImages}장의 완성형 카드 이미지 생성 중...`);
      
      // 참고 이미지 설정 (표지 또는 본문 스타일 이미지)
      const referenceImage = request.coverStyleImage || request.contentStyleImage;
      const copyMode = request.styleCopyMode; // true=레이아웃 복제, false=느낌만 참고
      
      const images = await Promise.all(agentResult.imagePrompts.slice(0, maxImages).map((p, i) => 
        generateSingleImage(p, request.imageStyle, "1:1", request.customImagePrompt, referenceImage, copyMode).then(img => ({ index: i + 1, data: img, prompt: p }))
      ));
      
      // 이미지 자체가 카드 전체! (HTML 텍스트 없이 이미지만)
      // 🚨 alt 속성에도 코드 문자열이 들어가지 않도록 필터링!
      const cleanAltText = (text: string) => text
        .replace(/[A-Za-z0-9+/=_-]{10,}/g, '')
        .replace(/[a-zA-Z0-9]{5,}\/[a-zA-Z0-9/]+/g, '')
        .replace(/[^\uAC00-\uD7AF가-힣a-zA-Z0-9\s.,!?~():\-]+/g, '')
        .replace(/\s+/g, ' ')
        .trim()
        .substring(0, 100); // alt 텍스트 길이 제한
      
      const cardSlides = images.map((img, idx) => {
        if (img.data) {
          return `
            <div class="card-slide" style="border-radius: 24px; overflow: hidden; aspect-ratio: 1/1; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
              <img src="${img.data}" alt="${cleanAltText(img.prompt)}" data-index="${img.index}" class="card-full-img" style="width: 100%; height: 100%; object-fit: cover;" />
            </div>`;
        }
        return '';
      }).filter(Boolean).join('\n');
      
      const finalHtml = `
        <div class="card-news-container">
          <h2 class="hidden-title">${agentResult.title}</h2>
          <div class="card-grid-wrapper">
            ${cardSlides}
          </div>
          <div class="legal-box-card">${MEDICAL_DISCLAIMER}</div>
        </div>
      `.trim();
      
      onProgress('✅ 카드뉴스 생성 완료!');
      
      return {
        title: agentResult.title,
        htmlContent: finalHtml,
        imageUrl: images[0]?.data || "",
        fullHtml: finalHtml,
        tags: [],
        factCheck: {
          fact_score: 85,
          safety_score: 90,
          conversion_score: 80,
          verified_facts_count: 5,
          issues: [],
          recommendations: []
        },
        postType: 'card_news',
        imageStyle: request.imageStyle,
        customImagePrompt: request.customImagePrompt, // 커스텀 이미지 프롬프트 저장 (재생성용)
        cardPrompts: agentResult.cardPrompts // 재생성용 프롬프트 데이터
      };
    } catch (error) {
      console.error('미니 에이전트 방식 실패, 기존 방식으로 폴백:', error);
      onProgress('⚠️ 미니 에이전트 실패, 기존 방식으로 재시도...');
      // 기존 방식으로 폴백 (아래 코드로 계속)
    }
  }
  
  // 📝 블로그 포스트 또는 카드뉴스 폴백: 기존 방식 사용
  const hasStyleRef = request.postType === 'card_news' && (request.coverStyleImage || request.contentStyleImage);
  if (hasStyleRef) {
    if (request.coverStyleImage && request.contentStyleImage) {
      onProgress('🎨 표지/본문 스타일 분석 중...');
    } else if (request.coverStyleImage) {
      onProgress('🎨 표지 스타일 분석 중 (본문도 동일 적용)...');
    } else {
      onProgress('🎨 본문 스타일 분석 중...');
    }
  }
  
  const step1Msg = hasStyleRef
      ? `✨ 참고 이미지 스타일로 카드뉴스 생성 중...`
      : request.referenceUrl 
      ? `🔗 레퍼런스 URL 분석 및 ${request.postType === 'card_news' ? '카드뉴스 템플릿 모방' : '스타일 벤치마킹'} 중...` 
      : `네이버 로직 분석 및 ${request.postType === 'card_news' ? '카드뉴스 기획' : '블로그 원고 작성'} 중...`;
  
  onProgress(step1Msg);
  
  const textData = await generateBlogPostText(request);
  
  const styleName = STYLE_NAMES[request.imageStyle] || STYLE_NAMES.illustration;
  const imgRatio = request.postType === 'card_news' ? "4:3" : "16:9";
  
  onProgress(`🎨 ${styleName} 스타일로 ${imgRatio} 이미지 생성 중...`);
  
  const maxImages = request.postType === 'card_news' ? (request.slideCount || 6) : (request.imageCount || 3);
  
  // 폴백 방식에서도 참고 이미지 전달 (레이아웃 재가공 지원)
  const fallbackReferenceImage = request.coverStyleImage || request.contentStyleImage;
  const fallbackCopyMode = request.styleCopyMode;
  
  const images = await Promise.all(textData.imagePrompts.slice(0, maxImages).map((p, i) => 
     generateSingleImage(p, request.imageStyle, imgRatio, request.customImagePrompt, fallbackReferenceImage, fallbackCopyMode).then(img => ({ index: i + 1, data: img, prompt: p }))
  ));

  let body = textData.content;
  
  // body가 HTML이 아닌 JSON/배열 형태인지 검증
  if (body && (body.startsWith('[{') || body.startsWith('{"'))) {
    console.error('AI returned JSON instead of HTML, attempting to extract...');
    try {
      const parsed = JSON.parse(body);
      if (Array.isArray(parsed)) {
        body = parsed.map(item => item.content || item.html || '').join('');
      } else if (parsed.content || parsed.html) {
        body = parsed.content || parsed.html;
      }
    } catch (e) {
      console.error('Failed to parse JSON content:', e);
    }
  }
  
  // AI가 class를 빼먹었을 경우 강제로 감싸기
  if (request.postType !== 'card_news' && !body.includes('class="naver-post-container"')) {
    body = `<div class="naver-post-container">${body}</div>`;
  }
  
  // 🚨 카드뉴스인데 card-slide가 없으면 AI가 HTML 구조를 완전히 무시한 것!
  // 이 경우 기본 카드뉴스 템플릿으로 강제 생성
  if (request.postType === 'card_news' && !body.includes('class="card-slide"')) {
    console.warn('AI ignored card-slide structure, generating fallback template...');
    const slideCount = request.slideCount || 6;
    const fallbackSlides: string[] = [];
    
    // body에서 텍스트 추출 시도
    const plainText = body.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim();
    const sentences = plainText.split(/[.!?。]/).filter(s => s.trim().length > 5);
    
    for (let i = 0; i < slideCount; i++) {
      const isFirst = i === 0;
      const isLast = i === slideCount - 1;
      const sentenceIdx = Math.min(i, sentences.length - 1);
      const sentence = sentences[sentenceIdx] || request.topic;
      
      let subtitle = isFirst ? '알아보자!' : isLast ? '함께 실천해요' : `포인트 ${i}`;
      let mainTitle = isFirst 
        ? `${request.topic}<br/><span class="card-highlight">총정리</span>`
        : isLast 
        ? `건강한 습관<br/><span class="card-highlight">시작해요!</span>`
        : sentence.slice(0, 15) + (sentence.length > 15 ? '...' : '');
      let desc = sentence.slice(0, 50) || '건강한 생활을 위한 정보를 확인하세요.';
      
      fallbackSlides.push(`
        <div class="card-slide" style="background: linear-gradient(180deg, #E8F4FD 0%, #F0F9FF 100%); border-radius: 24px; overflow: hidden;">
          <div style="padding: 32px 28px; display: flex; flex-direction: column; align-items: center; text-align: center; height: 100%;">
            <p class="card-subtitle" style="font-size: 14px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">${subtitle}</p>
            <p class="card-main-title" style="font-size: 28px; font-weight: 900; color: #1E293B; line-height: 1.3; margin: 0 0 16px 0;">${mainTitle}</p>
            <div class="card-img-container" style="width: 100%; margin: 16px 0;">[IMG_${i + 1}]</div>
            <p class="card-desc" style="font-size: 15px; color: #475569; line-height: 1.6; font-weight: 500; max-width: 90%;">${desc}</p>
          </div>
        </div>
      `);
    }
    body = fallbackSlides.join('\n');
  }
  
  images.forEach(img => {
    const pattern = new RegExp(`\\[IMG_${img.index}\\]`, "gi");
    if (img.data) {
      let imgHtml = "";
      if (request.postType === 'card_news') {
          imgHtml = `<img src="${img.data}" alt="${img.prompt}" data-index="${img.index}" class="card-full-img" style="width: 100%; height: auto; display: block;" />`;
      } else {
          imgHtml = `<div class="content-image-wrapper"><img src="${img.data}" alt="${img.prompt}" data-index="${img.index}" /></div>`;
      }
      body = body.replace(pattern, imgHtml);
    } else {
      // 이미지 생성 실패 시 마커 제거
      body = body.replace(pattern, '');
    }
  });
  
  // 혹시 남아있는 [IMG_N] 마커 모두 제거
  body = body.replace(/\[IMG_\d+\]/gi, '');

  // 카드뉴스: 분석된 스타일 배경색 강제 적용 (AI가 무시할 경우 대비)
  if (request.postType === 'card_news' && textData.analyzedStyle?.backgroundColor) {
    const bgColor = textData.analyzedStyle.backgroundColor;
    const bgGradient = bgColor.includes('gradient') ? bgColor : `linear-gradient(180deg, ${bgColor} 0%, ${bgColor}dd 100%)`;
    // 기존 card-slide의 background 스타일을 분석된 색상으로 교체
    body = body.replace(
      /(<div[^>]*class="[^"]*card-slide[^"]*"[^>]*style="[^"]*)background:[^;]*;?/gi,
      `$1background: ${bgGradient};`
    );
    // 만약 background 스타일이 없는 card-slide가 있다면 추가
    body = body.replace(
      /<div([^>]*)class="([^"]*card-slide[^"]*)"([^>]*)>/gi,
      (match, pre, cls, post) => {
        if (match.includes('style="')) {
          // 이미 style이 있지만 background가 없으면 추가
          if (!match.includes('background:')) {
            return match.replace('style="', `style="background: ${bgGradient}; `);
          }
          return match;
        } else {
          // style이 없으면 추가
          return `<div${pre}class="${cls}"${post} style="background: ${bgGradient};">`;
        }
      }
    );
    onProgress(`🎨 템플릿 색상(${bgColor}) 적용 완료`);
  }

  let finalHtml = "";
  if (request.postType === 'card_news') {
      finalHtml = `
      <div class="card-news-container">
         <h2 class="hidden-title">${textData.title}</h2>
         <div class="card-grid-wrapper">
            ${body}
         </div>
         <div class="legal-box-card">${MEDICAL_DISCLAIMER}</div>
      </div>
      `.trim();
  } else {
      // 블로그 포스트: 맨 위에 메인 제목(h2) 추가
      const mainTitle = request.topic || textData.title;
      if (body.includes('class="naver-post-container"')) {
        // naver-post-container 안에 제목 삽입
        finalHtml = body.replace(
          '<div class="naver-post-container">',
          `<div class="naver-post-container"><h2 class="main-title">${mainTitle}</h2>`
        );
      } else {
        finalHtml = `<div class="naver-post-container"><h2 class="main-title">${mainTitle}</h2>${body}</div>`;
      }
  }

  return {
    title: textData.title,
    htmlContent: finalHtml,
    imageUrl: images[0]?.data || "",
    fullHtml: finalHtml,
    tags: [],
    factCheck: textData.fact_check,
    postType: request.postType,
    imageStyle: request.imageStyle,
    customImagePrompt: request.customImagePrompt // 커스텀 이미지 프롬프트 저장 (재생성용)
  };
};

// 카드뉴스 개별 슬라이드 재생성 함수
export const regenerateCardSlide = async (
  cardIndex: number,
  currentCardHtml: string,
  userInstruction: string,
  context: {
    topic: string;
    category: string;
    totalSlides: number;
    prevCardContent?: string;
    nextCardContent?: string;
    imageStyle?: ImageStyle;
  }
): Promise<{ newCardHtml: string; newImagePrompt: string; message: string }> => {
  const ai = getAiClient();
  
  const slidePosition = cardIndex === 0 
    ? '표지 (1장)' 
    : cardIndex === context.totalSlides - 1 
    ? '마무리 (마지막 장)' 
    : `본문 (${cardIndex + 1}장)`;
  
  const imageStyleGuide = STYLE_KEYWORDS[context.imageStyle] || STYLE_KEYWORDS.illustration;
  
  // 현재 HTML에서 이미지를 마커로 교체 (기존 이미지 제거)
  const cleanedHtml = currentCardHtml
    .replace(/<img[^>]*class="card-inner-img"[^>]*>/gi, `[IMG_${cardIndex + 1}]`)
    .replace(/<img[^>]*>/gi, `[IMG_${cardIndex + 1}]`);
  
  const prompt = `
당신은 카드뉴스 슬라이드를 재생성하는 전문가입니다.

[현재 슬라이드 정보]
- 위치: ${slidePosition} (총 ${context.totalSlides}장 중 ${cardIndex + 1}번째)
- 주제: ${context.topic}
- 진료과: ${context.category}

[현재 슬라이드 HTML - 텍스트만 참고]
${cleanedHtml}

${context.prevCardContent ? `[이전 슬라이드 내용]\n${context.prevCardContent}` : ''}
${context.nextCardContent ? `[다음 슬라이드 내용]\n${context.nextCardContent}` : ''}

[사용자 요청]
${userInstruction}

████████████████████████████████████████████████████████████████████████████████
[🚨 필수 작성 규칙] 
████████████████████████████████████████████████████████████████████████████████
1. card-slide 구조를 유지하세요
2. card-main-title은 12자 이내, card-subtitle은 8자 이내
3. ⚠️ 이미지 영역은 반드시 [IMG_${cardIndex + 1}] 텍스트 마커만 사용! (img 태그 금지!)
4. 이전/다음 슬라이드와 내용이 자연스럽게 연결되어야 합니다
5. ${slidePosition === '표지 (1장)' ? '주제 소개 + 흥미 유발 문구' : slidePosition === '마무리 (마지막 장)' ? '행동 유도 + 감성적 마무리' : '구체적인 정보/방법 제시'}

⚠️⚠️⚠️ 중요: newCardHtml에 <img> 태그 넣지 마세요! [IMG_${cardIndex + 1}] 마커만!
예시: <div class="card-img-container">[IMG_${cardIndex + 1}]</div>

[이미지 프롬프트 규칙]
- 반드시 한국어로 작성
- 스타일: ${imageStyleGuide}
- 1:1 정사각형 카드뉴스 형식
- 로고/워터마크/해시태그 금지

JSON 형식으로 답변:
{
  "newCardHtml": "<div class=\"card-slide\">...[IMG_${cardIndex + 1}]...</div>",
  "newImagePrompt": "1:1 정사각형 카드뉴스, 한국어 이미지 프롬프트...",
  "message": "수정 완료 메시지"
}
`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            newCardHtml: { type: Type.STRING },
            newImagePrompt: { type: Type.STRING },
            message: { type: Type.STRING }
          },
          required: ["newCardHtml", "newImagePrompt", "message"]
        }
      }
    });
    
    return JSON.parse(response.text || "{}");
  } catch (error) {
    console.error('카드 재생성 실패:', error);
    throw error;
  }
};

// AI 재생성 모드 타입
export type SlideRegenMode = 
  | 'rewrite'      // 🔄 완전 새로 쓰기
  | 'strengthen'   // 💪 전환력 강화
  | 'simplify'     // ✂️ 더 간결하게
  | 'empathy'      // 💕 공감 강화
  | 'professional'; // 🏥 전문성 강화

// 원고 단계에서 개별 슬라이드 내용 AI 재생성
export const regenerateSlideContent = async (params: {
  slideIndex: number;
  slideType: string;
  topic: string;
  category: string;
  totalSlides: number;
  currentContent: {
    subtitle: string;
    mainTitle: string;
    description: string;
    imageKeyword: string;
  };
  prevSlide?: { mainTitle: string; description: string };
  nextSlide?: { mainTitle: string; description: string };
  mode?: SlideRegenMode;  // 재생성 모드 추가
}): Promise<{
  subtitle: string;
  mainTitle: string;
  description: string;
  speakingNote: string;
  imageKeyword: string;
}> => {
  const ai = getAiClient();
  
  const slidePosition = params.slideIndex === 0 
    ? '표지 (첫 번째)' 
    : params.slideIndex === params.totalSlides - 1 
    ? '마무리 (마지막)' 
    : `본문 (${params.slideIndex + 1}번째)`;
  
  const slideTypeGuide = params.slideType === 'cover' 
    ? '표지: 멈추게 하는 역할! 설명 최소화, 질문형으로 흥미 유발'
    : params.slideType === 'closing'
    ? 'CTA: ❌명령형 금지! "~시점입니다" 형태로 간접 유도'
    : params.slideType === 'concept'
    ? '오해 깨기: 착각을 바로잡는 질문형 메시지'
    : '본문: 판단 1줄만! 설명 금지!';
  
  // 모드별 추가 지침
  const mode = params.mode || 'rewrite';
  const modeInstruction = {
    rewrite: `
[🔄 완전 새로 쓰기 모드]
- 현재 내용을 참고하되, 완전히 새로운 관점으로 다시 작성
- 같은 주제를 다른 방식으로 접근
- 신선한 표현과 구성으로 재탄생`,
    strengthen: `
[💪 전환력 강화 모드]
- 현재 내용의 핵심은 유지하되 전환력(행동 유도력) 극대화
- "~시점입니다", "~단계입니다" 형태로 시점 고정
- 배제형 표현 강화: "~만으로는 부족합니다", "~가 아니라 ~가 먼저입니다"
- 설명 ❌ → 판단 ✅ 변환
- CTA 핵심: "오세요"가 아니라 "다른 선택지가 아니다"를 만드는 것`,
    simplify: `
[✂️ 더 간결하게 모드]
- 현재 내용을 최대한 압축
- subtitle: 4~6자로 더 짧게
- mainTitle: 10~12자로 더 짧게
- description: 15~20자 판단 1줄로 압축
- 불필요한 수식어, 설명 모두 제거
- 핵심 메시지만 남기기`,
    empathy: `
[💕 공감 강화 모드]
- 현재 내용에 독자 공감 요소 추가
- 일상 상황 묘사 추가 (예: "겨울 아침", "출근길")
- 독자의 감정/고민을 담은 표현 사용
- "혹시 나도?", "이런 적 있으시죠?" 같은 공감 유도
- 의학 정보를 친근하게 전달`,
    professional: `
[🏥 전문성 강화 모드]
- 현재 내용에 의학적 신뢰감 추가
- 가이드라인/권장사항 언급 (예: "대한OO학회에서 권장")
- 객관적이고 권위있는 톤
- 전문 용어 + 쉬운 설명 병기
- "~인 것으로 알려져 있습니다" 형태의 완충 표현`
  }[mode];
  
  const prompt = `
당신은 **전환형 카드뉴스** 원고 작성 전문가입니다.

🚨 핵심 원칙:
❌ 블로그 = "읽고 이해"
✅ 카드뉴스 = "보고 판단" (3초 안에!)

[슬라이드 정보]
- 위치: ${slidePosition} (총 ${params.totalSlides}장)
- 타입: ${params.slideType} → ${slideTypeGuide}
- 주제: ${params.topic}
- 진료과: ${params.category}

[현재 내용 - 더 간결하게 수정!]
부제: ${params.currentContent.subtitle}
메인제목: ${params.currentContent.mainTitle}
설명: ${params.currentContent.description}
이미지키워드: ${params.currentContent.imageKeyword}

${params.prevSlide ? `[이전 슬라이드]\n제목: ${params.prevSlide.mainTitle}` : ''}
${params.nextSlide ? `[다음 슬라이드]\n제목: ${params.nextSlide.mainTitle}` : ''}

${modeInstruction}

[📝 카드뉴스 텍스트 규칙]
- subtitle: 4~8자만! (예: "겨울철에 유독?", "혹시 나도?", "놓치기 쉬운 신호들")
- mainTitle: 10~18자, 질문형 또는 판단형, <highlight>강조</highlight>
  ✅ "따뜻하게 입어도\\n<highlight>해결 안 되는</highlight> 신호"
  ❌ "생활 관리만으로 충분할까요?" (너무 일반적)
- description: 판단 1줄만! (15~25자)
  ✅ "피로나 스트레스와 구분이 필요할 수 있습니다"
  ❌ 2~3문장 설명 금지!
- imageKeyword: 한국어 키워드 (예: "겨울철 빙판길, 넘어지는 사람, 얼음")

[🚨 의료광고법 + 카드뉴스 규칙]
❌ "~하세요" 명령형 금지!
❌ "체크", "검사 받으세요" 금지!
❌ 긴 설명 문장 금지!
✅ "~시점입니다", "~필요할 수 있습니다"

JSON 형식:
{
  "subtitle": "4~8자",
  "mainTitle": "10~18자 <highlight>강조</highlight>",
  "description": "판단 1줄 (15~25자)",
  "speakingNote": "이 슬라이드의 심리적 역할",
  "imageKeyword": "한국어 키워드 3~4개"
}
`;

  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-pro-preview',
      contents: prompt,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            subtitle: { type: Type.STRING },
            mainTitle: { type: Type.STRING },
            description: { type: Type.STRING },
            speakingNote: { type: Type.STRING },
            imageKeyword: { type: Type.STRING }
          },
          required: ["subtitle", "mainTitle", "description", "speakingNote", "imageKeyword"]
        }
      }
    });
    
    return JSON.parse(response.text || "{}");
  } catch (error) {
    console.error('슬라이드 원고 재생성 실패:', error);
    throw error;
  }
};

export const modifyPostWithAI = async (currentHtml: string, userInstruction: string): Promise<{ 
  newHtml: string, 
  message: string, 
  regenerateImageIndices?: number[],
  newImagePrompts?: string[]
}> => {
    const ai = getAiClient();
    
    // 이미지 URL을 플레이스홀더로 대체 (토큰 초과 방지)
    // base64 이미지나 긴 URL을 짧은 플레이스홀더로 변환
    const imageMap: Map<string, string> = new Map();
    let imgCounter = 0;
    
    const sanitizedHtml = currentHtml.replace(
      /<img([^>]*?)src=["']([^"']+)["']([^>]*)>/gi,
      (match, before, src, after) => {
        // 이미 플레이스홀더인 경우 스킵
        if (src.startsWith('__IMG_PLACEHOLDER_')) {
          return match;
        }
        const placeholder = `__IMG_PLACEHOLDER_${imgCounter}__`;
        imageMap.set(placeholder, src);
        imgCounter++;
        return `<img${before}src="${placeholder}"${after}>`;
      }
    );
    
    try {
      const response = await ai.models.generateContent({
        model: "gemini-3-pro-preview",  // 고품질 글쓰기용 pro 모델
        contents: `${MEDICAL_SAFETY_SYSTEM_PROMPT}\n[현재 원고] ${sanitizedHtml}\n[수정 요청] ${userInstruction}\n의료법 준수 필수. 이미지 src는 __IMG_PLACEHOLDER_N__ 형식으로 유지하세요.`,
        config: { 
          responseMimeType: "application/json", 
          responseSchema: { 
            type: Type.OBJECT, 
            properties: { 
              newHtml: { type: Type.STRING }, 
              message: { type: Type.STRING },
              regenerateImageIndices: { type: Type.ARRAY, items: { type: Type.NUMBER } },
              newImagePrompts: { type: Type.ARRAY, items: { type: Type.STRING } }
            }, 
            required: ["newHtml", "message"] 
          } 
        }
      });
      
      const result = JSON.parse(response.text || "{}");
      
      // 플레이스홀더를 원래 이미지 URL로 복원
      let restoredHtml = result.newHtml;
      imageMap.forEach((originalSrc, placeholder) => {
        restoredHtml = restoredHtml.replace(new RegExp(placeholder, 'g'), originalSrc);
      });
      
      return {
        ...result,
        newHtml: restoredHtml
      };
    } catch (error) { throw error; }
};
